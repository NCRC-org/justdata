-- Populate 1071_1k_lenders table
-- This query identifies lenders with >= 1000 loans in consecutive years
-- Includes all lenders and marks credit card lenders (average loan amount < $10,000 per year)
-- Note: Includes 2017 data for qualification checks (to determine 2018 status), but only outputs 2018-2024

CREATE OR REPLACE TABLE `hdma1-242116.misc.1071_1k_lenders` AS
WITH 
-- Calculate average loan amount PER YEAR per lender for ALL lenders
-- Note: amounts in disclosure table are in thousands (000s)
lender_avg_loan_amount_by_year AS (
  SELECT 
    d.respondent_id,
    CAST(d.year AS INT64) AS year,
    -- Calculate average loan amount per lender for THIS YEAR
    -- Amounts are in thousands, so result is also in thousands
    SAFE_DIVIDE(
      SUM(COALESCE(d.amt_under_100k, 0) + 
          COALESCE(d.amt_100k_250k, 0) + 
          COALESCE(d.amt_250k_1m, 0)),
      NULLIF(SUM(COALESCE(d.num_under_100k, 0) + 
                 COALESCE(d.num_100k_250k, 0) + 
                 COALESCE(d.num_250k_1m, 0)), 0)
    ) AS avg_loan_amount_thousands
  FROM `hdma1-242116.sb.disclosure` d
  WHERE d.year IS NOT NULL
    AND d.respondent_id IS NOT NULL
    AND CAST(d.year AS INT64) IN (2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024)
  GROUP BY d.respondent_id, CAST(d.year AS INT64)
),
loan_counts AS (
  SELECT 
    d.respondent_id,
    CAST(d.year AS INT64) AS year,
    -- Sum loan counts across all size categories
    SUM(COALESCE(d.num_under_100k, 0) + 
        COALESCE(d.num_100k_250k, 0) + 
        COALESCE(d.num_250k_1m, 0)) AS loans_in_year
  FROM `hdma1-242116.sb.disclosure` d
  LEFT JOIN lender_avg_loan_amount_by_year lavg
    ON d.respondent_id = lavg.respondent_id
    AND CAST(d.year AS INT64) = lavg.year
  WHERE d.year IS NOT NULL
    AND d.respondent_id IS NOT NULL
    AND CAST(d.year AS INT64) IN (2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024)
  GROUP BY d.respondent_id, CAST(d.year AS INT64)
),
qualified AS (
  SELECT 
    curr.respondent_id,
    curr.year
  FROM loan_counts curr
  INNER JOIN loan_counts prev
    ON curr.respondent_id = prev.respondent_id 
    AND curr.year = prev.year + 1
  WHERE curr.loans_in_year >= 1000 
    AND prev.loans_in_year >= 1000
)
SELECT 
  d.*,
  l.sb_lender as lender_name,
  g.county as county_name,
  g.state as state_name,
  -- Credit card lender flag (1 = credit card lender, 0 = not credit card lender)
  CASE 
    WHEN lavg.avg_loan_amount_thousands IS NULL THEN 1
    WHEN lavg.avg_loan_amount_thousands < 10 THEN 1
    ELSE 0
  END AS is_credit_card_lender,
  -- Mark credit card lenders (average loan amount < $10,000 for that year)
  CASE 
    WHEN lavg.avg_loan_amount_thousands IS NULL THEN 'Credit Card Lender'
    WHEN lavg.avg_loan_amount_thousands < 10 THEN 'Credit Card Lender'
    ELSE 'Not Credit Card Lender'
  END AS lender_type,
  -- Qualification status (only for non-credit card lenders)
  CASE 
    WHEN lavg.avg_loan_amount_thousands IS NULL OR lavg.avg_loan_amount_thousands < 10 THEN 'N/A (Credit Card)'
    WHEN q.respondent_id IS NOT NULL THEN 'Qualifies'
    ELSE 'Does Not Qualify'
  END AS qualification_status
FROM `hdma1-242116.sb.disclosure` d
LEFT JOIN `hdma1-242116.sb.lenders` l 
  ON d.respondent_id = l.sb_resid
LEFT JOIN `hdma1-242116.geo.cbsa_to_county` g 
  ON LPAD(CAST(d.geoid5 AS STRING), 5, '0') = LPAD(CAST(g.geoid5 AS STRING), 5, '0')
LEFT JOIN qualified q
  ON d.respondent_id = q.respondent_id 
  AND CAST(d.year AS INT64) = q.year
LEFT JOIN lender_avg_loan_amount_by_year lavg
  ON d.respondent_id = lavg.respondent_id
  AND CAST(d.year AS INT64) = lavg.year
WHERE d.year IS NOT NULL
  AND d.respondent_id IS NOT NULL
  -- Include 2017 for qualification checks, but only output 2018-2024
  AND CAST(d.year AS INT64) IN (2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024)
  -- Filter final output to 2018-2024 only
  AND CAST(d.year AS INT64) >= 2018
ORDER BY d.respondent_id, d.year, g.county_state

