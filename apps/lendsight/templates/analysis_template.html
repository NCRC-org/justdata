<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LendSight - AI-Powered Mortgage Insights</title>
    <meta name="description" content="AI-powered mortgage lending data analyzer with BigQuery integration. Generate comprehensive mortgage market analysis reports from HMDA data.">
    <meta name="keywords" content="LendSight, mortgage, lending analysis, HMDA, AI, BigQuery, market intelligence">
    <meta name="author" content="JustData - National Community Reinvestment Coalition">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://justdata.app/lendsight/">
    <meta property="og:title" content="LendSight - AI-Powered Mortgage Insights">
    <meta property="og:description" content="Generate comprehensive mortgage market analysis reports with AI-powered insights from HMDA data.">
    <meta property="og:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://justdata.app/lendsight/">
    <meta property="twitter:title" content="LendSight - AI-Powered Mortgage Insights">
    <meta property="twitter:description" content="Generate comprehensive mortgage market analysis reports with AI-powered insights from HMDA data.">
    <meta property="twitter:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Intro.js for onboarding tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
</head>
<body style="background: var(--ncrc-gray-light); min-height: 100vh;">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-layout">
                <div class="logo">
                    <img src="{{ url_for('static', filename='img/ncrc-logo.png') }}" alt="NCRC Logo" style="max-height: 90px; width: auto;" onerror="this.style.display='none';">
                </div>
                <div class="header-title-section">
                    <h1>LendSight</h1>
                    <p class="just-data-subtitle">A Just Data Tool by NCRC</p>
                </div>
                <div class="header-tagline">
                    <div class="tagline-box">
                        <p>Data drives the <em>movement</em></p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Main Content -->
        <div class="content-wrapper">
        <main class="main-content">
            <div class="analysis-card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> Generate Local Market Mortgage Analysis</h2>
                    <p>Enter the state and county to analyze mortgage lending</p>
                    <button id="startTourBtn" class="tour-btn" style="margin-top: 10px; padding: 8px 16px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        <i class="fas fa-question-circle"></i> Take a Tour
                    </button>
                </div>

                <form id="analysisForm" class="analysis-form">
                    <!-- State Selection (Required) -->
                    <div class="form-group" data-intro="Select a state to begin your analysis." data-step="1">
                        <label for="state-filter-select" data-tooltip="Select a state to filter counties. Counties from the selected state will appear below.">
                            <i class="fas fa-map"></i>
                            State <span style="color: red;">*</span>
                        </label>
                        <select id="state-filter-select" name="state_code" required style="width: 100%; margin-bottom: 15px;" placeholder="Select a state...">
                            <option value="">Select a state...</option>
                        </select>
                        <small class="help-text" style="margin-bottom: 15px; display: block;">
                            <i class="fas fa-info-circle"></i>
                            Select a state to filter counties. Counties from the selected state will appear below.
                        </small>
                    </div>

                    <!-- County Selection (Single county from selected state) -->
                    <div class="form-group" id="county-selection-group" data-intro="Select a single county from the selected state to analyze." data-step="2">
                        <label for="county-select" data-tooltip="Select a single county from the selected state. You can search by typing county names.">
                            <i class="fas fa-map-marker-alt"></i>
                            County <span style="color: red;">*</span>
                        </label>
                        <select id="county-select" name="counties" required disabled style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select a state first...</option>
                        </select>
                        <small class="help-text">
                            <i class="fas fa-info-circle"></i>
                            Select a single county from the selected state. You must select a state first.
                        </small>
                    </div>

                    <!-- Loan Purpose Selection -->
                    <div class="form-group" data-intro="Select the type of loans to analyze. You can select multiple loan purposes by checking the boxes." data-step="3">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; font-size: 1rem;">
                            <i class="fas fa-home" style="margin-right: 8px; color: var(--ncrc-dark-blue);"></i>
                            Loan Purpose
                        </label>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                            <label class="loan-purpose-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                <input type="checkbox" name="loan_purpose" id="loan_purpose_purchase" value="purchase" checked style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">Home Purchase</div>
                                    <div style="font-size: 0.85rem; color: #666;">Primary residence purchases</div>
                                </div>
                            </label>
                            
                            <label class="loan-purpose-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                <input type="checkbox" name="loan_purpose" id="loan_purpose_refinance" value="refinance" style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">Refinance & Cash-Out</div>
                                    <div style="font-size: 0.85rem; color: #666;">Refinancing and cash-out loans</div>
                                </div>
                            </label>
                            
                            <label class="loan-purpose-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                <input type="checkbox" name="loan_purpose" id="loan_purpose_equity" value="equity" style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">Home Equity</div>
                                    <div style="font-size: 0.85rem; color: #666;">Home equity lines and loans</div>
                                </div>
                            </label>
                            
                            <!-- Filter Information Card (matches loan purpose card style, positioned below Refinance) -->
                            <div class="filter-info-card-container">
                                <div id="toggleFiltersInfoBtn" class="filter-info-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                    <i class="fas fa-filter" style="margin-right: 12px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--ncrc-secondary-blue); font-size: 1.1rem; flex-shrink: 0;"></i>
                                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                        <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">View Applied Data Filters</div>
                                        <div style="font-size: 0.85rem; color: #666; height: 16px; line-height: 16px;">&nbsp;</div>
                                    </div>
                                    <i class="fas fa-chevron-down" id="filtersChevron" style="margin-left: 12px; transition: transform 0.2s ease; color: #666; flex-shrink: 0;"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expanded Filter Content (appears below the grid when expanded) -->
                        <div id="filtersInfoContent" style="display: none; margin-top: 12px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 12px; color: var(--ncrc-gray-dark);">
                                All analyses automatically include these filters:
                            </div>
                            <div id="filtersList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px 20px; font-size: 0.9rem; line-height: 1.6;">
                                <!-- Filters will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Year Range (Fixed to 2018-2024) -->
                    <div class="form-group" data-intro="The report will analyze data from 2018 to 2024 (all available years)." data-step="3">
                        <div style="padding: 15px; background: var(--ncrc-light-blue); border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #333;">
                                <i class="fas fa-calendar-alt"></i>
                                <strong>Year Range:</strong> This report will analyze data from <strong>2018 to 2024</strong> (all available years).
                            </p>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn" data-intro="Click here to start your analysis! The process typically takes 2-5 minutes depending on your selections. You'll see progress updates as it runs." data-step="5" data-tooltip="Click to generate your analysis. Make sure you've selected counties and a year range first.">
                        <i class="fas fa-magic"></i>
                        <span>Generate Analysis</span>
                    </button>
                    <small class="submit-info">
                        <i class="fas fa-clock"></i>
                        Analysis typically takes a few minutes
                    </small>
                </form>

                <!-- Progress Section -->
                <div id="progressSection" class="progress-section" style="display: none;">
                    <div class="progress-card">
                        <div class="progress-header">
                            <i class="fas fa-cog fa-spin"></i>
                            <h3>Analyzing Data...</h3>
                        </div>
                        <div class="progress-steps" id="progressSteps" style="margin-bottom: 15px; text-align: left;">
                            <!-- Progress steps will be populated by JavaScript -->
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p class="progress-text" id="progressText">Initializing analysis...</p>
                        <div class="progress-info">
                            <i class="fas fa-clock"></i>
                            <small>Analysis typically takes a few minutes depending on the number of counties and years selected.</small>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="results-section" style="display: none;">
                    <div class="results-card">
                        <div class="results-header">
                            <i class="fas fa-check-circle"></i>
                            <h3>Analysis Complete!</h3>
                        </div>
                        <div class="results-content">
                            <p>Your mortgage lending analysis has been generated successfully.</p>
                            <div class="download-options">
                                <button class="download-btn" id="viewReportBtn">
                                    <i class="fas fa-chart-bar"></i>
                                    View Web Report
                                </button>
                                <button class="download-btn secondary" id="downloadBtn">
                                    <i class="fas fa-download"></i>
                                    Export Data
                                </button>
                                <small class="download-info">
                                    <i class="fas fa-globe"></i>
                                    Interactive web report with export options
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="error-section" style="display: none;">
                    <div class="error-card">
                        <div class="error-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Analysis Failed</h3>
                        </div>
                        <div class="error-content">
                            <p id="errorMessage"></p>
                            <button class="retry-btn" onclick="resetForm()">
                                <i class="fas fa-redo"></i>
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </main>
        </div> <!-- End content-wrapper -->
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <h3><i class="fas fa-star"></i> What You'll Get</h3>
            <div class="sidebar-features">
                <div class="feature-card" data-tooltip="Access state and county-level data on mortgage lending from the Home Mortgage Disclosure Act (HMDA), including which lenders operate in each market and their loan volume market share. See the percentage of mortgage originations to low-to-moderate income borrowers, in majority-minority census tracts, or areas that are both. Track changes in origination counts and market concentration over time to identify lending patterns in specific geographies and community types.">
                    <i class="fas fa-chart-bar"></i>
                    <h4>Comprehensive Data</h4>
                    <p>Detailed HMDA mortgage origination statistics, market share analysis, and growth trends</p>
                </div>
                <div class="feature-card" data-tooltip="AI-generated narrative analysis of mortgage lending patterns, market concentration trends, and demographic lending coverage based on NCRC's curated HMDA datasets. All data points, statistics, and figures are pulled directly from NCRC staff-maintained databases—AI is used only to interpret patterns and generate written summaries. Verify specific claims and data points using the Excel Export, which contains the complete underlying data compiled by NCRC research staff.">
                    <i class="fas fa-robot"></i>
                    <h4>AI Insights</h4>
                    <p>Claude AI-powered analysis of lending strategies and market dynamics</p>
                </div>
                <div class="feature-card" data-tooltip="Download structured data tables showing mortgage origination counts, loan volume market shares, and demographic breakdowns by lender, state, and county from HMDA data. Use this file to conduct custom analysis, create additional visualizations, or verify findings from the AI-generated insights and web reports.">
                    <i class="fas fa-file-excel"></i>
                    <h4>Excel Export</h4>
                    <p>Structured HMDA data in Excel format for further analysis and reporting</p>
                </div>
                <div class="feature-card" data-tooltip="View formatted tables and charts showing mortgage origination distributions, market concentration metrics, and demographic lending coverage statistics from HMDA data. Export individual tables or charts as needed. For detailed analysis or data verification, use the Excel Export option to access the complete underlying dataset.">
                    <i class="fas fa-globe"></i>
                    <h4>Web Report</h4>
                    <p>Interactive web-based report with charts, tables, and export options</p>
                </div>
            </div>
            
            <div class="feature-card" style="margin-top: 40px;" data-tooltip="Current version of LendSight.">
                <i class="fas fa-code-branch"></i>
                <h4>Version</h4>
                <p>{{ version }}</p>
            </div>
        </aside>
    </div> <!-- End container -->

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-col">
                <h4>LendSight</h4>
                <p>AI-powered mortgage market intelligence platform</p>
            </div>
            <div class="footer-col">
                <h4>Developed by</h4>
                <p>NCRC - National Community Reinvestment Coalition<br>
                Jad Edlebi &amp; Jason Richardson</p>
            </div>
            <div class="footer-col">
                <h4>Links</h4>
                <p>
                    <a href="https://github.com/jadedlebi/justdata" target="_blank"><i class="fab fa-github"></i> GitHub</a><br>
                    <a href="https://ncrc.org" target="_blank"><i class="fas fa-globe"></i> NCRC Website</a>
                </p>
            </div>
            <div class="footer-col footer-logo">
                <img src="{{ url_for('static', filename='img/ncrc-logo.png') }}" alt="NCRC Logo" class="footer-logo-img" onerror="this.style.display='none';">
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 JustData - LendSight. Powered by AI and BigQuery.<br>
            <span class="version-text">Version {{ version }}</span>
        </div>
    </footer>

    <!-- jQuery (must be first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Intro.js for onboarding tour -->
    <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
    <!-- app.js is loaded later after all overrides are set up (see line 991) -->
    <!-- LendSight-specific form handler will be attached after shared app.js loads -->
    <script>
        // LendSight-specific customizations
        $(document).ready(function() {
            // Populate loan purpose filters information
            function populateFiltersInfo() {
                const filtersList = document.getElementById('filtersList');
                if (!filtersList) return;
                
                const filters = [
                    'Originations only (action taken = 1)',
                    'Site-built properties (construction method = 1)',
                    'Owner-occupied properties (occupancy type = 1)',
                    'Forward loans (excludes reverse mortgages)',
                    '1-4 unit properties'
                ];
                
                filtersList.innerHTML = filters.map((filter) => 
                    `<div style="display: flex; align-items: flex-start;">
                        <span style="margin-right: 8px; color: var(--ncrc-secondary-blue); font-weight: bold;">•</span>
                        <span>${filter}</span>
                    </div>`
                ).join('');
            }
            
            // Add interactive styles for loan purpose cards
            $(document).ready(function() {
                // Toggle filters info visibility with hover effects matching loan purpose cards
                const filterCard = $('#toggleFiltersInfoBtn');
                const content = $('#filtersInfoContent');
                
                filterCard.on('click', function() {
                    const chevron = $('#filtersChevron');
                    const isCurrentlyHidden = content.is(':hidden');
                    
                    if (isCurrentlyHidden) {
                        content.slideDown(200);
                        chevron.css('transform', 'rotate(180deg)');
                        filterCard.css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa',
                            'box-shadow': '0 2px 4px rgba(0,0,0,0.1)'
                        });
                    } else {
                        content.slideUp(200);
                        chevron.css('transform', 'rotate(0deg)');
                        filterCard.css({
                            'border-color': '#e0e0e0',
                            'background': 'white',
                            'box-shadow': 'none'
                        });
                    }
                });
                
                // Add hover effects for filter info card (only when not expanded)
                filterCard.on('mouseenter', function() {
                    if (content.is(':hidden')) {
                        $(this).css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa',
                            'box-shadow': '0 2px 4px rgba(0,0,0,0.1)'
                        });
                    }
                }).on('mouseleave', function() {
                    if (content.is(':hidden')) {
                        $(this).css({
                            'border-color': '#e0e0e0',
                            'background': 'white',
                            'box-shadow': 'none'
                        });
                    }
                });
                
                $('.loan-purpose-card').on('mouseenter', function() {
                    $(this).css({
                        'border-color': 'var(--ncrc-secondary-blue)',
                        'background': '#f0f7fa',
                        'box-shadow': '0 2px 4px rgba(0,0,0,0.1)'
                    });
                }).on('mouseleave', function() {
                    const checkbox = $(this).find('input[type="checkbox"]');
                    if (checkbox.is(':checked')) {
                        $(this).css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa'
                        });
                    } else {
                        $(this).css({
                            'border-color': '#e0e0e0',
                            'background': 'white',
                            'box-shadow': 'none'
                        });
                    }
                });
                
                // Update card style when checkbox is toggled
                $('.loan-purpose-card input[type="checkbox"]').on('change', function() {
                    const card = $(this).closest('.loan-purpose-card');
                    if ($(this).is(':checked')) {
                        card.css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa'
                        });
                    } else {
                        card.css({
                            'border-color': '#e0e0e0',
                            'background': 'white'
                        });
                    }
                });
                
                // Initialize card styles based on checked state
                $('.loan-purpose-card input[type="checkbox"]:checked').each(function() {
                    $(this).closest('.loan-purpose-card').css({
                        'border-color': 'var(--ncrc-secondary-blue)',
                        'background': '#f0f7fa'
                    });
                });
            });
            
            // Call on page load
            populateFiltersInfo();
            
            // Note: loadStates() is defined in the jQuery ready block below
            // This prevents duplicate loading and Select2 initialization conflicts
            
            // Load counties on page load (if not already loaded by shared app.js)
            function loadCountiesForLendSight() {
                const countySelect = document.getElementById('county-select');
                if (!countySelect) return;
                
                // Check if counties are already loaded
                if ($(countySelect).find('option').length > 0) {
                    console.log('Counties already loaded');
                    return;
                }
                
                fetch('/counties')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load counties');
                        }
                        return response.json();
                    })
                    .then(counties => {
                        if (!Array.isArray(counties)) {
                            throw new Error('Invalid response format');
                        }
                        
                        // Clear and populate
                        $(countySelect).empty();
                        counties.forEach(county => {
                            $(countySelect).append(new Option(county, county));
                        });
                        
                        // No Select2 needed - using plain HTML select like BizSight
                        
                        console.log(`Loaded ${counties.length} counties`);
                    })
                    .catch(error => {
                        console.error('Error loading counties:', error);
                    });
            }
            
            // Load counties after a short delay to ensure DOM is ready
            setTimeout(loadCountiesForLendSight, 200);
            
            // Override validation for LendSight (single county, fixed years)
            // This must run BEFORE app.js loads to override the shared validation
            window.validateInput = function(input, type) {
                // Override county-select validation for single county
                if (type === 'county-select') {
                    const countySelect = document.getElementById('county-select');
                    if (!countySelect) return true;
                    
                    const selectedCounty = countySelect.value;
                    if (!selectedCounty || selectedCounty === '') {
                        showValidationMessage(countySelect, 'Please select a county to analyze.', 'error');
                        countySelect.setCustomValidity('Please select a county.');
                        return false;
                    } else {
                        hideValidationMessage(countySelect);
                        countySelect.setCustomValidity('');
                        showValidationMessage(countySelect, 'County selected successfully.', 'success');
                        return true;
                    }
                }
                // For other types, check if original exists and use it
                if (window.originalValidateInput) {
                    return window.originalValidateInput.call(this, input, type);
                }
                return true;
            };
            
            // Override tour initialization for LendSight
            if (typeof window.initializeTour === 'function') {
                const originalInitializeTour = window.initializeTour;
                window.initializeTour = function() {
                    const hasSeenTour = localStorage.getItem('lendsight_tour_completed');
                    const startTourBtn = document.getElementById('startTourBtn');
                    
                    if (!startTourBtn) return;
                    
                    // Set up tour button click handler
                    startTourBtn.addEventListener('click', function() {
                        startTour();
                    });
                    
                    // Show welcome message if user hasn't seen tour
                    if (!hasSeenTour) {
                        setTimeout(() => {
                            const shouldStart = confirm('Welcome to LendSight! Would you like to take a quick tour to learn how to use the tool?');
                            if (shouldStart) {
                                startTour();
                            } else {
                                localStorage.setItem('lendsight_tour_completed', 'true');
                            }
                        }, 1000);
                    }
                };
            } else {
                // If initializeTour doesn't exist, create it
                window.initializeTour = function() {
                    const hasSeenTour = localStorage.getItem('lendsight_tour_completed');
                    const startTourBtn = document.getElementById('startTourBtn');
                    
                    if (!startTourBtn) return;
                    
                    startTourBtn.addEventListener('click', function() {
                        startTour();
                    });
                    
                    if (!hasSeenTour) {
                        setTimeout(() => {
                            const shouldStart = confirm('Welcome to LendSight! Would you like to take a quick tour to learn how to use the tool?');
                            if (shouldStart) {
                                startTour();
                            } else {
                                localStorage.setItem('lendsight_tour_completed', 'true');
                            }
                        }, 1000);
                    }
                };
            }
            
            // Function to move skip button into button container
            function moveSkipButton() {
                var skipButton = document.querySelector('.introjs-skipbutton');
                var buttonContainer = document.querySelector('.introjs-tooltipbuttons');
                
                if (!skipButton || !buttonContainer) {
                    return false;
                }
                
                // If skip button is already in the container, we're done
                if (skipButton.parentNode === buttonContainer) {
                    return true;
                }
                
                // Move skip button to the end of the button container (after Next button)
                try {
                    buttonContainer.appendChild(skipButton);
                    // Force a reflow to ensure the button is visible
                    skipButton.offsetHeight;
                    return true;
                } catch (e) {
                    console.error('Error moving skip button:', e);
                    return false;
                }
            }
            
            // Set up a MutationObserver to watch for skip button creation
            var skipButtonObserver = null;
            function setupSkipButtonObserver() {
                if (skipButtonObserver) {
                    skipButtonObserver.disconnect();
                }
                
                skipButtonObserver = new MutationObserver(function(mutations) {
                    var skipButton = document.querySelector('.introjs-skipbutton');
                    var buttonContainer = document.querySelector('.introjs-tooltipbuttons');
                    
                    if (skipButton && buttonContainer && skipButton.parentNode !== buttonContainer) {
                        moveSkipButton();
                    }
                });
                
                // Observe the tooltip for changes
                var tooltip = document.querySelector('.introjs-tooltip');
                if (tooltip) {
                    skipButtonObserver.observe(tooltip, {
                        childList: true,
                        subtree: true
                    });
                }
            }
            
            // Override startTour for LendSight
            if (typeof window.startTour === 'function') {
                const originalStartTour = window.startTour;
                window.startTour = function() {
                    if (typeof introJs === 'undefined') {
                        console.error('Intro.js not loaded');
                        return;
                    }
                    
                    var intro = introJs().setOptions({
                        nextLabel: 'Next →',
                        prevLabel: '← Back',
                        skipLabel: 'Skip Tour',
                        doneLabel: 'Got it!',
                        showProgress: true,
                        showBullets: true,
                        exitOnOverlayClick: false,
                        exitOnEsc: true,
                        tooltipClass: 'customTooltip',
                        highlightClass: 'customHighlight',
                        buttonClass: 'introjs-button',
                        scrollToElement: true,
                        scrollPadding: 100,
                        disableInteraction: false
                    });
                    
                    // Move skip button on each step change
                    intro.onchange(function(targetElement) {
                        // Try multiple times with increasing delays to ensure it works
                        setTimeout(moveSkipButton, 50);
                        setTimeout(moveSkipButton, 150);
                        setTimeout(moveSkipButton, 300);
                    });
                    
                    // Move skip button when tour starts
                    intro.onstart(function() {
                        setupSkipButtonObserver();
                        setTimeout(moveSkipButton, 50);
                        setTimeout(moveSkipButton, 100);
                        setTimeout(moveSkipButton, 200);
                        setTimeout(moveSkipButton, 300);
                        setTimeout(moveSkipButton, 500);
                    });
                    
                    intro.oncomplete(function() {
                        if (skipButtonObserver) {
                            skipButtonObserver.disconnect();
                        }
                        localStorage.setItem('lendsight_tour_completed', 'true');
                    });
                    
                    intro.onexit(function() {
                        if (skipButtonObserver) {
                            skipButtonObserver.disconnect();
                        }
                        // Don't mark as completed if they exit early
                    });
                    
                    intro.start();
                    
                    // Also try multiple times after tour starts
                    setTimeout(moveSkipButton, 200);
                    setTimeout(moveSkipButton, 400);
                    setTimeout(moveSkipButton, 600);
                    setTimeout(moveSkipButton, 800);
                };
            } else {
                // If startTour doesn't exist, create it
                window.startTour = function() {
                    if (typeof introJs === 'undefined') {
                        console.error('Intro.js not loaded');
                        return;
                    }
                    
                    var intro = introJs().setOptions({
                        nextLabel: 'Next →',
                        prevLabel: '← Back',
                        skipLabel: 'Skip Tour',
                        doneLabel: 'Got it!',
                        showProgress: true,
                        showBullets: true,
                        exitOnOverlayClick: false,
                        exitOnEsc: true,
                        tooltipClass: 'customTooltip',
                        highlightClass: 'customHighlight',
                        buttonClass: 'introjs-button',
                        scrollToElement: true,
                        scrollPadding: 100,
                        disableInteraction: false
                    });
                    
                    // Move skip button on each step change
                    intro.onchange(function(targetElement) {
                        setTimeout(moveSkipButton, 50);
                        setTimeout(moveSkipButton, 150);
                        setTimeout(moveSkipButton, 300);
                    });
                    
                    // Move skip button when tour starts
                    intro.onstart(function() {
                        setupSkipButtonObserver();
                        setTimeout(moveSkipButton, 50);
                        setTimeout(moveSkipButton, 100);
                        setTimeout(moveSkipButton, 200);
                        setTimeout(moveSkipButton, 300);
                        setTimeout(moveSkipButton, 500);
                    });
                    
                    intro.oncomplete(function() {
                        if (skipButtonObserver) {
                            skipButtonObserver.disconnect();
                        }
                        localStorage.setItem('lendsight_tour_completed', 'true');
                    });
                    
                    intro.onexit(function() {
                        if (skipButtonObserver) {
                            skipButtonObserver.disconnect();
                        }
                        // Don't mark as completed if they exit early
                    });
                    
                    intro.start();
                    
                    // Also try multiple times after tour starts
                    setTimeout(moveSkipButton, 200);
                    setTimeout(moveSkipButton, 400);
                    setTimeout(moveSkipButton, 600);
                    setTimeout(moveSkipButton, 800);
                };
            }
            
            // Initialize tour after a short delay to ensure everything is loaded
            setTimeout(function() {
                if (typeof window.initializeTour === 'function') {
                    window.initializeTour();
                }
            }, 500);
        });
    </script>
    
    <!-- jQuery (must be first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Intro.js for onboarding tour -->
    <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
    <!-- Override progress steps for LendSight BEFORE app.js loads -->
    <script>
        // Override progress steps for LendSight (use lending terminology)
        window.PROGRESS_STEPS = [
            { id: 'initializing', label: 'Initializing analysis', icon: 'fa-cog' },
            { id: 'parsing_params', label: 'Parsing parameters', icon: 'fa-check-circle' },
            { id: 'preparing_data', label: 'Preparing data', icon: 'fa-database' },
            { id: 'connecting_db', label: 'Connecting to database', icon: 'fa-plug' },
            { id: 'fetching_data', label: 'Fetching mortgage data', icon: 'fa-download' },
            { id: 'fetching_census_data', label: 'Fetching Census demographic data', icon: 'fa-users' },
            { id: 'processing_data', label: 'Processing data', icon: 'fa-cogs' },
            { id: 'generating_ai', label: 'Generating AI insights', icon: 'fa-brain' },
            { id: 'completed', label: 'Analysis complete', icon: 'fa-check' }
        ];
        
        // LendSight-specific state and county loading
        $(document).ready(function() {
            // Guard to prevent multiple simultaneous calls to loadStates
            let isLoadingStates = false;
            let statesLoaded = false;
            
            // Load states on page load
            function loadStates() {
                // Prevent multiple simultaneous calls
                if (isLoadingStates) {
                    console.log('[DEBUG] loadStates: Already loading, skipping...');
                    return;
                }
                
                const stateSelect = $('#state-filter-select');
                if (!stateSelect.length) {
                    console.warn('State select element not found');
                    return;
                }
                
                // Preserve current selection if any
                const currentValue = stateSelect.val();
                console.log(`[DEBUG] loadStates: Current value before load: ${currentValue}`);
                
                isLoadingStates = true;
                
                fetch('/states')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load states');
                        }
                        return response.json();
                    })
                    .then(states => {
                        // Destroy Select2 if it exists to prevent conflicts
                        if (stateSelect.hasClass('select2-hidden-accessible')) {
                            stateSelect.select2('destroy');
                        }
                        
                        stateSelect.empty();
                        stateSelect.append('<option value="">Select a state...</option>');
                        
                        states.forEach(state => {
                            const stateName = state.name || state;
                            const stateCode = state.code || state;
                            // Store both name and code as data attributes, but use name as value
                            const option = new Option(stateName, stateName);
                            $(option).data('code', stateCode);
                            stateSelect.append(option);
                        });
                        
                        // Reinitialize Select2 for state dropdown
                        stateSelect.select2({
                            placeholder: 'Select a state...',
                            allowClear: true,
                            width: '100%'
                        });
                        
                        // DON'T restore previous selection - this was causing automatic Arizona loads
                        // Users should select their state fresh each time
                        // if (currentValue && stateSelect.find(`option[value="${currentValue}"]`).length > 0) {
                        //     console.log(`[DEBUG] loadStates: Restoring previous selection: ${currentValue}`);
                        //     // Use setTimeout to ensure Select2 is fully initialized before setting value
                        //     setTimeout(() => {
                        //         stateSelect.val(currentValue).trigger('change');
                        //     }, 100);
                        // }
                        
                        statesLoaded = true;
                        isLoadingStates = false;
                    })
                    .catch(error => {
                        console.error('Error loading states:', error);
                        isLoadingStates = false;
                    });
            }
            
            // Load counties for selected state
            function loadCountiesForState(stateIdentifier) {
                // STRICT GUARD: Only allow this function to run if explicitly called from user interaction
                // Block any automatic calls
                if (!loadCountiesForState._userInitiated) {
                    console.warn('[DEBUG] Blocked automatic loadCountiesForState call - not user initiated');
                    return;
                }
                // Reset the flag after use
                loadCountiesForState._userInitiated = false;
                
                const countySelect = document.getElementById('county-select');
                if (!countySelect) {
                    console.warn('[DEBUG] County select element not found');
                    return;
                }
                
                if (!stateIdentifier) {
                    countySelect.innerHTML = '<option value="">Select a state first...</option>';
                    countySelect.disabled = true;
                    return;
                }
                
                // GUARD: Verify state is actually selected in dropdown before loading
                const stateSelect = $('#state-filter-select');
                const actualSelectedState = stateSelect.val();
                const actualSelectedOption = stateSelect.find('option:selected');
                const actualStateCode = actualSelectedOption.data('code');
                
                // If stateIdentifier is a state name, verify it matches what's actually selected
                if (!stateIdentifier.match(/^\d{1,2}$/)) {
                    // It's a state name - must match the selected state
                    if (actualSelectedState !== stateIdentifier) {
                        console.warn(`[DEBUG] Blocked county load - stateIdentifier "${stateIdentifier}" doesn't match selected state "${actualSelectedState}"`);
                        return;
                    }
                } else {
                    // It's a state code - must match the selected state's code
                    if (actualStateCode !== stateIdentifier) {
                        console.warn(`[DEBUG] Blocked county load - stateCode "${stateIdentifier}" doesn't match selected state code "${actualStateCode}"`);
                        return;
                    }
                }
                
                // If we can't find the code from the dropdown, don't make the request
                if (!actualStateCode) {
                    console.warn(`[DEBUG] Could not find state code for selected state, blocking request`);
                    return;
                }
                
                // Use the actual state code from the dropdown, not the parameter
                const stateCode = actualStateCode;
                
                console.log(`[DEBUG] loadCountiesForState called with identifier: ${stateIdentifier}, using verified code: ${stateCode}`);
                fetch(`/counties-by-state/${encodeURIComponent(stateCode)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load counties');
                        }
                        return response.json();
                    })
                    .then(counties => {
                        const countySelect = document.getElementById('county-select');
                        
                        // Clear and enable the select
                        countySelect.disabled = false;
                        countySelect.innerHTML = '<option value="">Select a county...</option>';
                        
                        // Handle both old format (strings) and new format (objects with FIPS codes)
                        counties.forEach(county => {
                            const option = document.createElement('option');
                            if (typeof county === 'string') {
                                // Old format: just county name string
                                option.value = county;
                                option.textContent = county;
                            } else if (county && county.name) {
                                // New format: county object with name, geoid5, state_fips, county_fips
                                option.value = county.name;
                                option.textContent = county.name;
                                option.dataset.county = JSON.stringify(county); // Store full county object
                            }
                            countySelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading counties:', error);
                    });
            }
            
            // Handle state selection change - use event delegation to prevent duplicate handlers
            $(document).off('change', '#state-filter-select').on('change', '#state-filter-select', function(e) {
                // Prevent automatic triggers during initialization
                if (e.originalEvent && e.originalEvent.isTrusted === false) {
                    console.log('[DEBUG] Blocked programmatic state change event');
                    return;
                }
                
                const selectedState = $(this).val();
                const selectedOption = $(this).find('option:selected');
                const stateCode = selectedOption.data('code'); // Get state FIPS code from data attribute
                
                console.log(`[DEBUG] State filter changed to: ${selectedState}, type: ${typeof selectedState}`);
                console.log(`[DEBUG] State code: ${stateCode}`);
                console.log(`[DEBUG] Selected option data:`, selectedOption.data());
                
                // Only load counties if a state is actually selected AND we have a valid state code
                // Use state code (FIPS) instead of state name for more reliable querying
                if (selectedState && selectedState.trim() !== '' && stateCode) {
                    // Mark as user-initiated before calling
                    loadCountiesForState._userInitiated = true;
                    // Enable county select and load counties
                    $('#county-select').prop('disabled', false);
                    loadCountiesForState(stateCode); // Pass state code instead of name
                } else {
                    // Clear counties if state is cleared
                    const countySelect = document.getElementById('county-select');
                    countySelect.disabled = true;
                    countySelect.innerHTML = '<option value="">Select a state first...</option>';
                }
            });
            
            // Load states on page load - only once
            if (!statesLoaded) {
                loadStates();
            }
        });
    </script>
    <!-- Your app.js (after dependencies and progress steps override) -->
    <script>
        // Set flag to tell shared app.js to skip state management for LendSight
        window.LENDSIGHT_MODE = true;
        
        // Override loadCounties BEFORE app.js loads to prevent Select2 initialization
        // This prevents the shared app.js from initializing Select2 on county select
        window.loadCounties = function(stateCode = null) {
            // For LendSight, we use our own loadCountiesForState function
            // This override prevents the shared app.js from initializing Select2
            console.log('[LendSight] loadCounties called but overridden - using loadCountiesForState instead');
            // Do nothing - our custom loadCountiesForState will handle it
        };
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}?v={{ version }}&t={{ cache_buster }}"></script>
    <script>
        // Override shared app.js functions for LendSight (single county, no Select2)
        $(document).ready(function() {
            // CRITICAL: Remove the shared app.js form submission handler and state change handler
            // The shared app.js attaches handlers that don't work for LendSight's single-county setup
            $('#analysisForm').off('submit'); // Remove shared app.js form handler
            $('#state-filter-select').off('change'); // Remove shared app.js state change handler
            console.log('[LendSight] Removed shared app.js handlers');
            
            // Re-attach our LendSight-specific form handler
            // Use setTimeout to ensure this runs after shared app.js has finished
            let retryCount = 0;
            const maxRetries = 50; // Wait up to 5 seconds (50 * 100ms)
            
            function attachFormHandler() {
                // Verify required functions are available
                if ((typeof showProgress !== 'function' || typeof disableForm !== 'function' || typeof listenForProgress !== 'function') && retryCount < maxRetries) {
                    retryCount++;
                    setTimeout(attachFormHandler, 100);
                    return;
                }
                
                if (retryCount >= maxRetries) {
                    console.error('[LendSight] Functions not available after waiting, attaching handler anyway');
                }
                
                // Functions are available (or we've given up waiting), attach the handler
                $('#analysisForm').off('submit').on('submit', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Clear all previous validation messages first
                document.querySelectorAll('.validation-message').forEach(msg => msg.remove());
                
                const formData = new FormData(this);
                const selectionType = formData.get('selection_type') || 'county';
                
                // Collect all checked loan purpose checkboxes using jQuery
                const loanPurposeCheckboxes = $('input[name="loan_purpose"]:checked').map(function() {
                    return $(this).val();
                }).get();
                
                // Enhanced validation with helpful messages
                let hasErrors = false;
                
                // Validate loan purpose selection
                if (!loanPurposeCheckboxes || loanPurposeCheckboxes.length === 0) {
                    // Find the first loan purpose card to show error
                    const firstCard = document.querySelector('.loan-purpose-card');
                    if (firstCard) {
                        showValidationMessage(firstCard.querySelector('input[type="checkbox"]'), 'Please select at least one loan purpose.', 'error');
                    }
                    hasErrors = true;
                }
                
                // State selection is required
                const selectedState = $('#state-filter-select').val();
                
                // Validate state selection (required)
                if (!selectedState || selectedState.trim() === '') {
                    showValidationMessage(document.getElementById('state-filter-select'), 'Please select a state.', 'error');
                    hasErrors = true;
                }
                
                // Validate county selection (required, single county)
                const countySelect = document.getElementById('county-select');
                const selectedCounty = countySelect ? countySelect.value : '';
                if (!selectedCounty || selectedCounty === '') {
                    showValidationMessage(countySelect, 'Please select a county to analyze.', 'error');
                    hasErrors = true;
                }
                
                if (hasErrors) {
                    const firstError = document.querySelector('.validation-message.error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return false;
                }
                
                // Build request data
                let requestData = {
                    selection_type: 'county',
                    state_code: selectedState,  // Always include state_code
                    years: '2018,2019,2020,2021,2022,2023,2024',  // Fixed years
                    loan_purpose: loanPurposeCheckboxes.length > 0 ? loanPurposeCheckboxes : ['purchase']  // Default to purchase only
                };
                
                // Single county selection
                requestData.counties = selectedCounty;  // Single county, not array
                
                // Also include counties_data with GEOID5 information for BigQuery queries
                const countiesData = [];
                const selectedOption = countySelect.options[countySelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.county) {
                    try {
                        const countyData = JSON.parse(selectedOption.dataset.county);
                        // Include GEOID5, state_fips, and county_fips for BigQuery
                        countiesData.push({
                            name: countyData.name || selectedCounty,
                            geoid5: countyData.geoid5,
                            state_fips: countyData.state_fips,
                            county_fips: countyData.county_fips
                        });
                    } catch (e) {
                        // Fallback: if parsing fails, just use the name
                        countiesData.push({
                            name: selectedCounty
                        });
                    }
                } else {
                    // Fallback: if no county data, just use the name
                    countiesData.push({
                        name: selectedCounty
                    });
                }
                requestData.counties_data = countiesData;
                
                // Show progress and disable form
                // Use fallback implementations if shared functions aren't available
                if (typeof showProgress === 'function') {
                    showProgress();
                } else {
                    // Fallback: Show progress manually
                    const progressSection = document.getElementById('progressSection');
                    const submitBtn = document.getElementById('submitBtn');
                    if (progressSection) progressSection.style.display = 'block';
                    if (submitBtn) submitBtn.disabled = true;
                    console.log('[LendSight] Using fallback showProgress');
                }
                if (typeof disableForm === 'function') {
                    disableForm();
                } else {
                    // Fallback: Disable form manually
                    const form = document.getElementById('analysisForm');
                    if (form) {
                        const inputs = form.querySelectorAll('input, select, button');
                        inputs.forEach(input => {
                            if (input.id !== 'submitBtn') input.disabled = true;
                        });
                    }
                    console.log('[LendSight] Using fallback disableForm');
                }
                
                try {
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Analysis failed');
                    }
                    const jobId = result.job_id;
                    if (typeof listenForProgress === 'function') {
                        listenForProgress(jobId);
                    } else {
                        // Fallback: Redirect to report page
                        console.log('[LendSight] Using fallback - redirecting to report page');
                        window.location.href = `/?job_id=${jobId}`;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    if (typeof showError === 'function') {
                        showError(error.message || 'Network error. Please check your connection and try again.');
                    } else {
                        alert('Error: ' + (error.message || 'Network error. Please check your connection and try again.'));
                    }
                    // Fallback: Hide progress and enable form manually
                    if (typeof hideProgress === 'function') {
                        hideProgress();
                    } else {
                        const progressSection = document.getElementById('progressSection');
                        if (progressSection) progressSection.style.display = 'none';
                    }
                    if (typeof enableForm === 'function') {
                        enableForm();
                    } else {
                        const form = document.getElementById('analysisForm');
                        if (form) {
                            const inputs = form.querySelectorAll('input, select, button');
                            inputs.forEach(input => input.disabled = false);
                        }
                    }
                }
                
                return false;
                });
                console.log('[LendSight] Attached LendSight-specific form handler');
            }
            
            // Start trying to attach the handler
            setTimeout(attachFormHandler, 100);
            
            // Also attach a click handler to the submit button as a fallback
            $('#submitBtn').off('click').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('[LendSight] Submit button clicked - triggering form submit');
                $('#analysisForm').trigger('submit');
                return false;
            });
            
            // Make sure Select2 is NOT initialized on county select
            // Destroy any existing Select2 instance immediately
            const countySelectElForLendSight = document.getElementById('county-select');
            if (countySelectElForLendSight) {
                const $countySelect = $('#county-select');
                // Destroy Select2 if it exists
                if ($countySelect.hasClass('select2-hidden-accessible')) {
                    console.log('[LendSight] Destroying Select2 on county select');
                    $countySelect.select2('destroy');
                }
                // Remove multiple attribute if it exists
                countySelectElForLendSight.removeAttribute('multiple');
                // Ensure it's a plain select
                if (countySelectElForLendSight.hasAttribute('multiple')) {
                    countySelectElForLendSight.removeAttribute('multiple');
                }
            }
            
            // Override the validateInput function to handle single county selection
            const originalValidateInput = window.validateInput;
            window.validateInput = function(input, type) {
                // Override county-select validation for single county (LendSight)
                if (type === 'county-select') {
                    const countySelect = document.getElementById('county-select');
                    if (!countySelect) return true;
                    
                    // Get value directly from DOM element (plain select returns string, not array)
                    const selectedCounty = countySelect.value;
                    
                    // Hide any existing validation messages first
                    if (typeof hideValidationMessage === 'function') {
                        hideValidationMessage(countySelect);
                    }
                    
                    if (!selectedCounty || selectedCounty === '') {
                        showValidationMessage(countySelect, 'Please select a county to analyze.', 'error');
                        countySelect.setCustomValidity('Please select a county.');
                        return false;
                    } else {
                        countySelect.setCustomValidity('');
                        // Don't show any message for single county - just clear errors
                        return true;
                    }
                }
                // For other types, use original validation
                if (originalValidateInput) {
                    return originalValidateInput.call(this, input, type);
                }
                return true;
            };
            
            // Remove any existing change handlers from shared app.js and add our own
            $('#county-select').off('change').on('change', function() {
                validateInput(this, 'county-select');
            });
            
            // Monitor for any Select2 initialization attempts and destroy them
            const observer = new MutationObserver(function(mutations) {
                const $countySelect = $('#county-select');
                if ($countySelect.hasClass('select2-hidden-accessible')) {
                    console.log('[LendSight] Select2 detected on county select - destroying it');
                    $countySelect.select2('destroy');
                    const countySelectEl = document.getElementById('county-select');
                    if (countySelectEl) {
                        countySelectEl.removeAttribute('multiple');
                    }
                }
            });
            
            if (countySelectElForLendSight) {
                observer.observe(countySelectElForLendSight, {
                    attributes: true,
                    attributeFilter: ['class']
                });
            }
        });
    </script>
</body>
</html>

