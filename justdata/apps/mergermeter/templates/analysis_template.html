<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MergerMeter - Two-Bank Merger Impact Analyzer</title>
    <meta name="description" content="AI-powered bank merger analysis tool with BigQuery integration. Generate comprehensive community benefits merger analysis reports.">
    <meta name="keywords" content="MergerMeter, merger analysis, bank merger, community benefits, CRA, AI, BigQuery, market intelligence">
    <meta name="author" content="JustData - National Community Reinvestment Coalition">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://justdata.app/mergermeter/">
    <meta property="og:title" content="MergerMeter - Two-Bank Merger Impact Analyzer">
    <meta property="og:description" content="Generate comprehensive bank merger analysis reports with AI-powered insights for community benefits assessment.">
    <meta property="og:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://justdata.app/mergermeter/">
    <meta property="twitter:title" content="MergerMeter - Two-Bank Merger Impact Analyzer">
    <meta property="twitter:description" content="Generate comprehensive bank merger analysis reports with AI-powered insights for community benefits assessment.">
    <meta property="twitter:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <style>
        /* Ensure feature cards have relative positioning for tooltips */
    </style>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body style="background: var(--ncrc-gray-light); min-height: 100vh;">
    {% include "shared_header.html" %}

    <div class="container">
        <!-- Main Content -->
        <div class="content-wrapper">
        <main class="main-content">
            <div class="analysis-card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> Generate Merger Impact Analysis</h2>
                    <p>Upload merger research ticket and assessment area documents to analyze two-bank merger</p>
                </div>

                <form id="analysisForm" class="analysis-form">
                    <!-- Bank Information Section -->
                    <div class="form-group">
                        <h3 style="margin-bottom: 20px; color: var(--ncrc-dark-blue);">
                            <i class="fas fa-building"></i> Bank Information
                        </h3>
                        
                        <!-- Bulk Import Section -->
                        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bee5eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: var(--ncrc-dark-blue); font-size: 1rem;">
                                    <i class="fas fa-paste"></i> Bulk Import Banks
                                </h4>
                                <button type="button" id="toggleBulkImport" class="btn-link" style="background: none; border: none; color: var(--ncrc-secondary-blue); cursor: pointer; text-decoration: underline; font-size: 0.9rem;">
                                    <i class="fas fa-chevron-down"></i> Show
                                </button>
                            </div>
                            <div id="bulkImportSection" style="display: none;">
                                <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                                    <p style="margin: 0 0 8px 0; font-weight: bold; color: #155724; font-size: 0.9rem;">
                                        <i class="fas fa-check-circle"></i> Recommended Format (Most Reliable)
                                    </p>
                                    <p style="margin: 0; font-size: 0.85rem; color: #155724;">
                                        Use <strong>tab-separated format</strong> with 4 columns in this exact order: <strong>Bank Name, LEI, RSSD, ResID</strong>
                                    </p>
                                </div>
                                
                                <p style="font-size: 0.9rem; color: #333; margin-bottom: 10px; font-weight: 600;">
                                    <strong>Format:</strong>
                                </p>
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; margin-bottom: 10px; font-family: monospace; font-size: 0.85rem; overflow-x: auto; border: 2px solid #dee2e6;">
                                    <div style="color: #666; margin-bottom: 8px;">Header row (optional but recommended):</div>
                                    <div style="background: #e9ecef; padding: 4px 8px; margin-bottom: 4px; border-radius: 3px;">
                                        Bank Name<span style="color: #999;">[TAB]</span>LEI<span style="color: #999;">[TAB]</span>RSSD<span style="color: #999;">[TAB]</span>ResID
                                    </div>
                                    <div style="color: #666; margin: 12px 0 8px 0;">Data rows (one bank per row):</div>
                                    <div style="background: white; padding: 4px 8px; margin-bottom: 4px; border-radius: 3px; border-left: 3px solid #28a745;">
                                        1ST MERCHANTS BANK<span style="color: #999;">[TAB]</span>S0Q3AHZRL5K6VQE35M07<span style="color: #999;">[TAB]</span>17147<span style="color: #999;">[TAB]</span>0000004365
                                    </div>
                                    <div style="background: white; padding: 4px 8px; margin-bottom: 4px; border-radius: 3px; border-left: 3px solid #28a745;">
                                        1ST<span style="color: #999;">[TAB]</span>WKN6AF1FCL7BBYGTGI83<span style="color: #999;">[TAB]</span>785473<span style="color: #999;">[TAB]</span>0000785473
                                    </div>
                                </div>
                                
                                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                                    <strong>Instructions:</strong>
                                </p>
                                <ol style="font-size: 0.85rem; color: #666; margin-left: 20px; margin-bottom: 15px; line-height: 1.6;">
                                    <li>In Excel, create a table with exactly 4 columns: <strong>Bank Name, LEI, RSSD, ResID</strong> (in that order)</li>
                                    <li>Enter your bank data - one bank per row</li>
                                    <li>Select all rows (including header if you have one), copy (Ctrl+C)</li>
                                    <li>Paste into the text area below</li>
                                    <li>Click "Parse and Import Banks"</li>
                                </ol>
                                
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
                                    <p style="margin: 0; font-size: 0.85rem; color: #856404;">
                                        <strong>Note:</strong> The system expects tab-separated values (TSV). When you copy from Excel, it automatically uses tabs. If you're typing manually, use the Tab key between columns, not spaces.
                                    </p>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <a href="/api/download-bank-identifiers-template" download="bank_identifiers_template.csv" style="padding: 6px 12px; background: var(--ncrc-secondary-blue); color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;">
                                        <i class="fas fa-download"></i> Download Bank Identifiers Template
                                    </a>
                                </div>
                                <textarea id="bulkImportText" placeholder="Paste your tab-separated bank data here (Ctrl+V from Excel)&#10;&#10;Example format:&#10;Bank Name	LEI	RSSD	ResID&#10;1ST MERCHANTS BANK	S0Q3AHZRL5K6VQE35M07	17147	0000004365&#10;1ST	WKN6AF1FCL7BBYGTGI83	785473	0000785473&#10;&#10;Note: Use Tab key between columns (not spaces). Headers are optional." style="width: 100%; min-height: 140px; padding: 10px; border: 2px solid #28a745; border-radius: 4px; font-family: monospace; font-size: 0.85rem; margin-bottom: 10px;"></textarea>
                                <button type="button" id="parseBulkImportBtn" class="submit-btn" style="width: auto; padding: 8px 16px; font-size: 0.9rem;">
                                    <i class="fas fa-upload"></i> Parse and Import Banks
                                </button>
                                <div id="bulkImportResults" style="margin-top: 10px; display: none;"></div>
                            </div>
                        </div>
                        
                        <!-- Bank A (Acquirer) -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--ncrc-secondary-blue);">
                            <h4 style="margin-bottom: 15px; color: var(--ncrc-dark-blue);">
                                <i class="fas fa-hand-holding"></i> Bank A (Acquirer)
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label for="acquirer_lei">
                                        <i class="fas fa-id-card"></i>
                                        LEI Number <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="acquirer_lei" name="acquirer_lei" placeholder="Enter LEI (20 characters)" maxlength="20" required>
                                </div>
                                <div>
                                    <label for="acquirer_rssd">
                                        <i class="fas fa-database"></i>
                                        RSSD Number
                                    </label>
                                    <input type="text" id="acquirer_rssd" name="acquirer_rssd" placeholder="Enter RSSD (6+ digits)" pattern="[0-9]+">
                                </div>
                                <div>
                                    <label for="acquirer_sb_id">
                                        <i class="fas fa-briefcase"></i>
                                        Res ID
                                    </label>
                                    <input type="text" id="acquirer_sb_id" name="acquirer_sb_id" placeholder="Enter Res ID">
                                </div>
                            </div>
                            <div id="acquirer_confirmation" style="display: none; padding: 12px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; margin-top: 10px;">
                                <strong><i class="fas fa-check-circle"></i> Confirmed:</strong> 
                                <span id="acquirer_name_display"></span>
                            </div>
                        </div>

                        <!-- Bank B (Target) -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--ncrc-secondary-blue);">
                            <h4 style="margin-bottom: 15px; color: var(--ncrc-dark-blue);">
                                <i class="fas fa-bullseye"></i> Bank B (Target)
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label for="target_lei">
                                        <i class="fas fa-id-card"></i>
                                        LEI Number <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" id="target_lei" name="target_lei" placeholder="Enter LEI (20 characters)" maxlength="20" required>
                                </div>
                                <div>
                                    <label for="target_rssd">
                                        <i class="fas fa-database"></i>
                                        RSSD Number
                                    </label>
                                    <input type="text" id="target_rssd" name="target_rssd" placeholder="Enter RSSD (6+ digits)" pattern="[0-9]+">
                                </div>
                                <div>
                                    <label for="target_sb_id">
                                        <i class="fas fa-briefcase"></i>
                                        Res ID
                                    </label>
                                    <input type="text" id="target_sb_id" name="target_sb_id" placeholder="Enter Res ID">
                                </div>
                            </div>
                            <div id="target_confirmation" style="display: none; padding: 12px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; margin-top: 10px;">
                                <strong><i class="fas fa-check-circle"></i> Confirmed:</strong> 
                                <span id="target_name_display"></span>
                            </div>
                        </div>

                        <button type="button" id="loadBanksBtn" class="submit-btn" style="width: auto; margin-bottom: 20px;">
                            <i class="fas fa-search"></i>
                            Load Bank Names
                        </button>
                        <small class="help-text" style="display: block; margin-top: -15px; margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i>
                            <strong>Required:</strong> Enter the LEI number for each bank and click "Load" to fetch and confirm bank names. The system uses the LEI number to look up the bank name from the database. RSSD and SB Respondent ID are optional.
                        </small>
                    </div>

                    <!-- Assessment Area Upload Section -->
                    <div class="form-group" id="assessmentAreaSection" style="display: none;">
                        <h3 style="margin-bottom: 20px; color: var(--ncrc-dark-blue);">
                            <i class="fas fa-upload"></i> Assessment Area Documents
                        </h3>
                        <small class="help-text" style="display: block; margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i>
                            Assessment areas are built from combining one or more counties. Upload PDF or Text files defining which counties are in each bank's assessment areas.
                        </small>
                        
                        <!-- Bank A Assessment Areas -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--ncrc-secondary-blue);">
                            <h4 style="margin-bottom: 15px; color: var(--ncrc-dark-blue);">
                                <i class="fas fa-hand-holding"></i> Bank A (Acquirer) Assessment Areas
                            </h4>
                            
                            <!-- Toggle between upload, manual input, and branch generation -->
                            <div style="margin-bottom: 15px; display: flex; gap: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                                <button type="button" class="aa-toggle-btn" data-bank="acquirer" data-mode="upload" style="flex: 1; padding: 8px; background: #e0e0e0; color: #333; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-upload"></i> Upload JSON
                                </button>
                                <button type="button" class="aa-toggle-btn active" data-bank="acquirer" data-mode="manual" style="flex: 1; padding: 8px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-keyboard"></i> Manual Entry
                                </button>
                                <button type="button" class="aa-toggle-btn" data-bank="acquirer" data-mode="branches" style="flex: 1; padding: 8px; background: #e0e0e0; color: #333; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-map-marker-alt"></i> Auto Generate
                                </button>
                            </div>
                            
                            <!-- Generate from Branches Option -->
                            <div id="acquirer_branches_section" class="aa-input-section" style="display: none;">
                                <div style="margin-bottom: 15px; padding: 15px; background: #e8f4f8; border: 1px solid #bee5eb; border-radius: 8px;">
                                    <p style="margin: 0 0 15px 0; color: #0c5460; font-weight: 600;">
                                        <i class="fas fa-info-circle"></i>
                                        Generate assessment areas automatically from branch locations
                                    </p>
                                    <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9rem;">
                                        Select a method to generate assessment areas. Only counties where the bank has branches are included.
                                    </p>
                                    <div style="margin-bottom: 15px;">
                                        <label for="acquirer_aa_method" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                            <i class="fas fa-cog"></i> Generation Method:
                                        </label>
                                        <select id="acquirer_aa_method" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95rem; background: white;">
                                            <option value="all_branches">All CBSAs where bank has branches</option>
                                            <option value="deposits">CBSAs with ≥1% of bank's branch deposits</option>
                                            <option value="loans">CBSAs with ≥1% of bank's loan applications</option>
                                        </select>
                                        <small style="display: block; margin-top: 5px; color: #666; font-size: 0.85rem;">
                                            <span id="acquirer_method_description">Includes all CBSAs where the bank has at least one branch. All counties in those CBSAs are included.</span>
                                        </small>
                                    </div>
                                    <button type="button" class="generate-from-branches-btn" data-bank="acquirer" style="padding: 10px 20px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600;">
                                        <i class="fas fa-magic"></i> Auto Generate
                                    </button>
                                    <small class="help-text" style="display: block; margin-top: 10px; color: #666;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Requires RSSD number. Assessment areas will be grouped by metro area (CBSA).
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Upload Option -->
                            <div id="acquirer_upload_section" class="aa-input-section" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <label for="acquirer_assessment_areas">
                                        <i class="fas fa-file-code"></i>
                                        Upload Assessment Area File (JSON or CSV)
                                    </label>
                                    <input type="file" id="acquirer_assessment_areas" name="acquirer_assessment_areas" accept=".json,.csv" style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; background: white;">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px; margin-bottom: 5px; flex-wrap: wrap;">
                                        <a href="/api/download-assessment-area-template" download="assessment_area_template.csv" style="padding: 6px 12px; background: var(--ncrc-secondary-blue); color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;">
                                            <i class="fas fa-download"></i> Download CSV Template
                                        </a>
                                    </div>
                                    <details style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                        <summary style="cursor: pointer; font-weight: 600; color: var(--ncrc-dark-blue);">JSON File Format (Recommended: Use GEOIDs for fastest processing)</summary>
                                        <div style="margin-top: 10px;">
                                            <p style="margin-bottom: 10px; font-weight: 600; color: #034ea0;">⚡ Fastest Format (Recommended - No BigQuery lookup needed):</p>
                                            <pre style="margin-top: 5px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; overflow-x: auto;">[
  {
    "cbsa_name": "Denver-Aurora-Lakewood, CO",
    "cbsa_code": "19740",
    "geoids": ["08001", "08005", "08013", "08014", "08031", "08035", "08039", "08059"]
  },
  {
    "cbsa_name": "Boulder, CO",
    "cbsa_code": "14500",
    "geoids": ["08013"]
  }
]</pre>
                                            <p style="margin-top: 15px; margin-bottom: 10px; font-weight: 600; color: #666;">Alternative Format (with state/county codes - also fast):</p>
                                            <pre style="margin-top: 5px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; overflow-x: auto;">[
  {
    "cbsa_name": "Assessment Area Name",
    "counties": [
      {"state_code": "08", "county_code": "001"},
      {"state_code": "08", "county_code": "005"}
    ]
  }
]</pre>
                                            <p style="margin-top: 15px; margin-bottom: 10px; font-weight: 600; color: #999;">Legacy Format (requires BigQuery lookup - slower):</p>
                                            <pre style="margin-top: 5px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; overflow-x: auto;">[
  {
    "cbsa_name": "Assessment Area Name",
    "counties": [
      "County Name, State",
      "Another County, State"
    ]
  }
]</pre>
                                        </div>
                                    </details>
                                </div>
                            </div>
                            
                            <!-- Manual Entry Option -->
                            <div id="acquirer_manual_section" class="aa-input-section">
                                <div style="margin-bottom: 15px;">
                                    <label>
                                        <i class="fas fa-keyboard"></i>
                                        Enter Assessment Areas Manually
                                    </label>
                                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                        <div id="acquirer_manual_areas" style="margin-bottom: 10px;">
                                            <!-- Assessment areas will be added here dynamically -->
                                        </div>
                                        <button type="button" class="add-aa-btn" data-bank="acquirer" style="padding: 8px 16px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                            <i class="fas fa-plus"></i> Add Assessment Area
                                        </button>
                                    </div>
                                    <small class="help-text" style="display: block; margin-top: 5px;">
                                        <i class="fas fa-info-circle"></i>
                                        Enter assessment area name and list counties (one per line). You can also enter MSA codes like "MSA 14500, 19740" or MSA names like "Denver-Aurora-Lakewood, CO" and counties will be looked up automatically.
                                    </small>
                                </div>
                            </div>
                            <div id="acquirer_aa_status" style="display: none; padding: 12px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 6px; margin-top: 10px;">
                                <strong><i class="fas fa-info-circle"></i> Status:</strong> 
                                <span id="acquirer_aa_status_text"></span>
                            </div>
                            <div id="acquirer_aa_preview" style="display: none; margin-top: 15px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 6px;">
                                <strong>Parsed Assessment Areas:</strong>
                                <div id="acquirer_aa_list" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>

                        <!-- Bank B Assessment Areas -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--ncrc-secondary-blue);">
                            <h4 style="margin-bottom: 15px; color: var(--ncrc-dark-blue);">
                                <i class="fas fa-bullseye"></i> Bank B (Target) Assessment Areas
                            </h4>
                            
                            <!-- Toggle between upload, manual input, and branch generation -->
                            <div style="margin-bottom: 15px; display: flex; gap: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                                <button type="button" class="aa-toggle-btn" data-bank="target" data-mode="upload" style="flex: 1; padding: 8px; background: #e0e0e0; color: #333; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-upload"></i> Upload JSON
                                </button>
                                <button type="button" class="aa-toggle-btn active" data-bank="target" data-mode="manual" style="flex: 1; padding: 8px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-keyboard"></i> Manual Entry
                                </button>
                                <button type="button" class="aa-toggle-btn" data-bank="target" data-mode="branches" style="flex: 1; padding: 8px; background: #e0e0e0; color: #333; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-map-marker-alt"></i> Auto Generate
                                </button>
                            </div>
                            
                            <!-- Generate from Branches Option -->
                            <div id="target_branches_section" class="aa-input-section" style="display: none;">
                                <div style="margin-bottom: 15px; padding: 15px; background: #e8f4f8; border: 1px solid #bee5eb; border-radius: 8px;">
                                    <p style="margin: 0 0 15px 0; color: #0c5460; font-weight: 600;">
                                        <i class="fas fa-info-circle"></i>
                                        Generate assessment areas automatically from branch locations
                                    </p>
                                    <p style="margin: 0 0 15px 0; color: #666; font-size: 0.9rem;">
                                        Select a method to generate assessment areas. Only counties where the bank has branches are included.
                                    </p>
                                    <div style="margin-bottom: 15px;">
                                        <label for="target_aa_method" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                            <i class="fas fa-cog"></i> Generation Method:
                                        </label>
                                        <select id="target_aa_method" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.95rem; background: white;">
                                            <option value="all_branches">All CBSAs where bank has branches</option>
                                            <option value="deposits">CBSAs with ≥1% of bank's branch deposits</option>
                                            <option value="loans">CBSAs with ≥1% of bank's loan applications</option>
                                        </select>
                                        <small style="display: block; margin-top: 5px; color: #666; font-size: 0.85rem;">
                                            <span id="target_method_description">Includes all CBSAs where the bank has at least one branch. All counties in those CBSAs are included.</span>
                                        </small>
                                    </div>
                                    <button type="button" class="generate-from-branches-btn" data-bank="target" style="padding: 10px 20px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600;">
                                        <i class="fas fa-magic"></i> Auto Generate
                                    </button>
                                    <small class="help-text" style="display: block; margin-top: 10px; color: #666;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Requires RSSD number. Assessment areas will be grouped by metro area (CBSA).
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Upload Option -->
                            <div id="target_upload_section" class="aa-input-section" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <label for="target_assessment_areas">
                                        <i class="fas fa-file-code"></i>
                                        Upload Assessment Area File (JSON or CSV)
                                    </label>
                                    <input type="file" id="target_assessment_areas" name="target_assessment_areas" accept=".json,.csv" style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 8px; background: white;">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px; margin-bottom: 5px; flex-wrap: wrap;">
                                        <a href="/api/download-assessment-area-template" download="assessment_area_template.csv" style="padding: 6px 12px; background: var(--ncrc-secondary-blue); color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;">
                                            <i class="fas fa-download"></i> Download CSV Template
                                        </a>
                                    </div>
                                    <details style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                        <summary style="cursor: pointer; font-weight: 600; color: var(--ncrc-dark-blue);">JSON File Format (Recommended: Use GEOIDs for fastest processing)</summary>
                                        <div style="margin-top: 10px;">
                                            <p style="margin-bottom: 10px; font-weight: 600; color: #034ea0;">⚡ Fastest Format (Recommended - No BigQuery lookup needed):</p>
                                            <pre style="margin-top: 5px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; overflow-x: auto;">[
  {
    "cbsa_name": "Denver-Aurora-Lakewood, CO",
    "cbsa_code": "19740",
    "geoids": ["08001", "08005", "08013", "08014", "08031", "08035", "08039", "08059"]
  },
  {
    "cbsa_name": "Boulder, CO",
    "cbsa_code": "14500",
    "geoids": ["08013"]
  }
]</pre>
                                            <p style="margin-top: 15px; margin-bottom: 10px; font-weight: 600; color: #666;">Alternative Format (with state/county codes - also fast):</p>
                                            <pre style="margin-top: 5px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; overflow-x: auto;">[
  {
    "cbsa_name": "Assessment Area Name",
    "counties": [
      {"state_code": "08", "county_code": "001"},
      {"state_code": "08", "county_code": "005"}
    ]
  }
]</pre>
                                            <p style="margin-top: 15px; margin-bottom: 10px; font-weight: 600; color: #999;">Legacy Format (requires BigQuery lookup - slower):</p>
                                            <pre style="margin-top: 5px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; overflow-x: auto;">[
  {
    "cbsa_name": "Assessment Area Name",
    "counties": [
      "County Name, State",
      "Another County, State"
    ]
  }
]</pre>
                                        </div>
                                    </details>
                                </div>
                            </div>
                            
                            <!-- Manual Entry Option -->
                            <div id="target_manual_section" class="aa-input-section">
                                <div style="margin-bottom: 15px;">
                                    <label>
                                        <i class="fas fa-keyboard"></i>
                                        Enter Assessment Areas Manually
                                    </label>
                                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                        <div id="target_manual_areas" style="margin-bottom: 10px;">
                                            <!-- Assessment areas will be added here dynamically -->
                                        </div>
                                        <button type="button" class="add-aa-btn" data-bank="target" style="padding: 8px 16px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                            <i class="fas fa-plus"></i> Add Assessment Area
                                        </button>
                                    </div>
                                    <small class="help-text" style="display: block; margin-top: 5px;">
                                        <i class="fas fa-info-circle"></i>
                                        Enter assessment area name and list counties (one per line). You can also enter MSA codes like "MSA 14500, 19740" or MSA names like "Denver-Aurora-Lakewood, CO" and counties will be looked up automatically.
                                    </small>
                                </div>
                            </div>
                            <div id="target_aa_status" style="display: none; padding: 12px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 6px; margin-top: 10px;">
                                <strong><i class="fas fa-info-circle"></i> Status:</strong> 
                                <span id="target_aa_status_text"></span>
                            </div>
                            <div id="target_aa_preview" style="display: none; margin-top: 15px; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 6px;">
                                <strong>Parsed Assessment Areas:</strong>
                                <div id="target_aa_list" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Settings Section -->
                    <div class="form-group">
                        <h3 style="margin-bottom: 15px; color: var(--ncrc-dark-blue);">
                            <i class="fas fa-cog"></i> Analysis Filters
                        </h3>

                        <!-- Compact Horizontal Filter Section -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <!-- Year Ranges Row -->
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #ddd;">
                                <div style="flex: 0 0 auto;">
                                    <label for="hmda_start_year" style="font-size: 0.85rem; margin-bottom: 4px; display: block; color: #666;">
                                        HMDA Start
                                    </label>
                                    <select id="hmda_start_year" name="hmda_start_year" required style="padding: 6px 10px; font-size: 0.9rem; min-width: 80px;">
                                        <option value="2020">2020</option>
                                        <option value="2021">2021</option>
                                        <option value="2022">2022</option>
                                        <option value="2023" selected>2023</option>
                                        <option value="2024">2024</option>
                                    </select>
                                </div>
                                <div style="flex: 0 0 auto;">
                                    <label for="hmda_end_year" style="font-size: 0.85rem; margin-bottom: 4px; display: block; color: #666;">
                                        HMDA End
                                    </label>
                                    <select id="hmda_end_year" name="hmda_end_year" required style="padding: 6px 10px; font-size: 0.9rem; min-width: 80px;">
                                        <option value="2020">2020</option>
                                        <option value="2021">2021</option>
                                        <option value="2022">2022</option>
                                        <option value="2023">2023</option>
                                        <option value="2024" selected>2024</option>
                                    </select>
                                </div>
                                <div style="flex: 0 0 auto;">
                                    <label for="sb_start_year" style="font-size: 0.85rem; margin-bottom: 4px; display: block; color: #666;">
                                        SB Start
                                    </label>
                                    <select id="sb_start_year" name="sb_start_year" required style="padding: 6px 10px; font-size: 0.9rem; min-width: 80px;">
                                        <option value="2019">2019</option>
                                        <option value="2020">2020</option>
                                        <option value="2021">2021</option>
                                        <option value="2022">2022</option>
                                        <option value="2023" selected>2023</option>
                                        <option value="2024">2024</option>
                                    </select>
                                </div>
                                <div style="flex: 0 0 auto;">
                                    <label for="sb_end_year" style="font-size: 0.85rem; margin-bottom: 4px; display: block; color: #666;">
                                        SB End
                                    </label>
                                    <select id="sb_end_year" name="sb_end_year" required style="padding: 6px 10px; font-size: 0.9rem; min-width: 80px;">
                                        <option value="2019">2019</option>
                                        <option value="2020">2020</option>
                                        <option value="2021">2021</option>
                                        <option value="2022">2022</option>
                                        <option value="2023">2023</option>
                                        <option value="2024" selected>2024</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Loan Purpose Row -->
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #ddd;">
                                <label for="loan_purpose" style="font-size: 0.85rem; color: #666; margin-right: 8px; font-weight: 600;">Loan Purpose:</label>
                                <select id="loan_purpose" name="loan_purpose" style="padding: 8px 12px; font-size: 0.85rem; border: 2px solid var(--ncrc-secondary-blue); border-radius: 6px; background: #f0f7fa; min-width: 180px;">
                                    <option value="" selected>All Loan Purposes</option>
                                    <option value="1">Home Purchase Only</option>
                                    <option value="31,32">Refinance Only</option>
                                    <option value="2">Home Improvement Only</option>
                                </select>
                            </div>

                            <!-- HMDA Filters Row -->
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; margin-bottom: 8px;">
                                <span style="font-size: 0.85rem; color: #666; margin-right: 8px; font-weight: 600; align-self: flex-start; padding-top: 24px;">HMDA Filters:</span>
                                
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="action_taken" style="font-size: 0.75rem; color: #666;">Action Taken:</label>
                                    <select id="action_taken" name="action_taken" multiple style="min-width: 180px;">
                                        <option value="1" selected>Originations (1)</option>
                                        <option value="2">Approved but not accepted (2)</option>
                                        <option value="3">Denied (3)</option>
                                        <option value="4">Withdrawn (4)</option>
                                        <option value="5">Closed for incompleteness (5)</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="occupancy_type" style="font-size: 0.75rem; color: #666;">Occupancy:</label>
                                    <select id="occupancy_type" name="occupancy_type" multiple style="min-width: 180px;">
                                        <option value="1" selected>Owner-Occupied (1)</option>
                                        <option value="2">Not Owner-Occupied (2)</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="total_units" style="font-size: 0.75rem; color: #666;">Units:</label>
                                    <select id="total_units" name="total_units" multiple style="min-width: 180px;">
                                        <option value="1" selected>1 Unit</option>
                                        <option value="2" selected>2 Units</option>
                                        <option value="3" selected>3 Units</option>
                                        <option value="4" selected>4 Units</option>
                                        <option value="5">5+ Units</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="construction_method" style="font-size: 0.75rem; color: #666;">Construction:</label>
                                    <select id="construction_method" name="construction_method" multiple style="min-width: 180px;">
                                        <option value="1" selected>Site-Built (1)</option>
                                        <option value="2" selected>Manufactured Home (2)</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <label for="not_reverse" style="font-size: 0.75rem; color: #666;">Reverse Mortgage:</label>
                                    <select id="not_reverse" name="not_reverse" multiple style="min-width: 180px;">
                                        <option value="1" selected>Not Reverse (1)</option>
                                        <option value="2">Reverse Mortgage (2)</option>
                                    </select>
                                </div>
                            </div>
                            <small class="help-text" style="display: block; margin-top: 8px; font-size: 0.75rem; color: #666;">
                                <i class="fas fa-info-circle"></i>
                                Note: The Goals sheet includes all loan types. Loan Purpose selection applies to Mortgage Data sheets only.
                            </small>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn" data-tooltip="Click to generate your merger analysis. Make sure you've entered bank information and uploaded the required files.">
                        <i class="fas fa-magic"></i>
                        <span>Generate Merger Analysis</span>
                    </button>
                    <small class="submit-info">
                        <i class="fas fa-clock"></i>
                        Analysis typically takes 5-10 minutes
                    </small>
                </form>

                <!-- Progress Section -->
                <div id="progressSection" class="progress-section" style="display: none;">
                    <div class="progress-card">
                        <div class="progress-header">
                            <i class="fas fa-cog fa-spin"></i>
                            <h3>Analyzing Merger Data...</h3>
                        </div>
                        <div class="progress-steps" id="progressSteps" style="margin-bottom: 15px; text-align: left;">
                            <!-- Progress steps will be populated by JavaScript -->
                        </div>
                        <div class="progress-bar" style="margin-bottom: 20px;">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>
                        <p class="progress-text" id="progressText" style="font-weight: 500; margin-bottom: 10px;">Initializing analysis...</p>
                        <div class="progress-info" style="text-align: center; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <i class="fas fa-clock" style="margin-right: 5px;"></i>
                            <small style="color: #666;">Analysis typically takes 5-10 minutes depending on the data volume. Please keep this window open.</small>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="results-section" style="display: none;">
                    <div class="results-card">
                        <div class="results-header">
                            <i class="fas fa-check-circle"></i>
                            <h3>Analysis Complete!</h3>
                        </div>
                        <div class="results-content">
                            <p>Your merger impact analysis has been generated successfully.</p>
                            <div class="download-options">
                                <button class="download-btn" id="viewReportBtn">
                                    <i class="fas fa-chart-bar"></i>
                                    View Web Report
                                </button>
                                <button class="download-btn secondary" id="downloadBtn">
                                    <i class="fas fa-download"></i>
                                    Export Data
                                </button>
                                <small class="download-info">
                                    <i class="fas fa-globe"></i>
                                    Interactive web report with export options
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="error-section" style="display: none;">
                    <div class="error-card">
                        <div class="error-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Analysis Failed</h3>
                        </div>
                        <div class="error-content">
                            <p id="errorMessage"></p>
                            <button class="retry-btn" onclick="resetForm()">
                                <i class="fas fa-redo"></i>
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        </div> <!-- End content-wrapper -->
    </div> <!-- End container -->

    <!-- Footer (matches landing page) -->
    <footer class="footer" style="background: #1E3D5C; color: white; padding: 0; margin-top: 40px;">
        <div class="footer-container" style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 24px;">
            <div style="text-align: left;">
                <p style="margin: 0 0 8px 0; font-size: 13px; color: rgba(255,255,255,0.9);">&copy; 2026 National Community Reinvestment Coalition</p>
                <div style="display: flex; gap: 16px; font-size: 13px;">
                    <a href="mailto:research@ncrc.org" style="color: #8bb8ff; text-decoration: none;">research@ncrc.org</a>
                    <span style="color: rgba(255,255,255,0.5);">|</span>
                    <a href="tel:+12024644600" style="color: #8bb8ff; text-decoration: none;">(202) 464-4600</a>
                    <span style="color: rgba(255,255,255,0.5);">|</span>
                    <a href="/privacy" style="color: #8bb8ff; text-decoration: none;">Privacy</a>
                    <span style="color: rgba(255,255,255,0.5);">|</span>
                    <a href="/terms" style="color: #8bb8ff; text-decoration: none;">Terms</a>
                </div>
                <p style="margin: 12px 0 0 0; font-size: 11px; color: rgba(255,255,255,0.6);">
                    Created by Jay Richardson &amp; Jad Edlebi
                </p>
            </div>
            <div style="flex-shrink: 0;">
                <img src="/static/img/ncrc-logo-white.png" alt="NCRC" style="height: 50px; width: auto; opacity: 0.9;">
            </div>
        </div>
    </footer>

    <!-- jQuery (must be first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Your app.js (after dependencies) -->
    <script src="{{ url_for('static', filename='js/app.v2.js') }}"></script>
    <!-- Override progress steps for MergerMeter -->
    <script>
        // Define progress steps for MergerMeter (bank merger analysis)
        window.PROGRESS_STEPS = [
            { id: 'initializing', label: 'Initializing analysis', icon: 'fa-cog' },
            { id: 'parsing_params', label: 'Parsing parameters', icon: 'fa-check-circle' },
            { id: 'preparing_data', label: 'Preparing data', icon: 'fa-database' },
            { id: 'connecting_db', label: 'Connecting to database', icon: 'fa-plug' },
            { id: 'fetching_data', label: 'Fetching bank data', icon: 'fa-download' },
            { id: 'market_analysis', label: 'Market Concentration Analysis', icon: 'fa-chart-pie' },
            { id: 'branch_analysis', label: 'Branch Network Analysis', icon: 'fa-map-marked-alt' },
            { id: 'lending_analysis', label: 'Lending Commitment Analysis', icon: 'fa-hand-holding-usd' },
            { id: 'community_impact', label: 'Community Impact Assessment', icon: 'fa-users' },
            { id: 'generating_ai', label: 'Generating AI insights', icon: 'fa-brain' },
            { id: 'doing_something_cool', label: 'Doing something cool', icon: 'fa-sparkles' },
            { id: 'completed', label: 'Analysis complete', icon: 'fa-check' }
        ];
    </script>
    <script>
        // Setup HTML tooltips for feature cards
        function setupFeatureCardTooltips() {
            featureCards.forEach(card => {
                const tooltipText = card.getAttribute('data-tooltip');
                if (!tooltipText) return;
                
                // Check if tooltip already exists to prevent duplicates
                if (card.querySelector('.feature-card-tooltip')) {
                    return; // Tooltip already exists, skip
                }
                
                // Create tooltip element
                const tooltip = document.createElement('div');
                tooltip.className = 'feature-card-tooltip';
                tooltip.innerHTML = tooltipText;
                tooltip.style.cssText = `
                    position: absolute;
                    right: calc(100% + 15px);
                    top: 50%;
                    transform: translateY(-50%);
                    background: white;
                    color: black;
                    padding: 12px 16px;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    line-height: 1.5;
                    min-width: 250px;
                    max-width: 350px;
                    width: fit-content;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    opacity: 0;
                    visibility: hidden;
                    pointer-events: none;
                    transition: opacity 0.2s ease, visibility 0.2s ease;
                    z-index: 100000;
                    text-align: left;
                    word-wrap: break-word;
                    border: 2px solid black;
                    box-sizing: border-box;
                `;
                
                // Create arrow
                const arrow = document.createElement('div');
                arrow.style.cssText = `
                    position: absolute;
                    right: -8px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 0;
                    height: 0;
                    border-top: 6px solid transparent;
                    border-bottom: 6px solid transparent;
                    border-left: 6px solid white;
                    z-index: 1;
                `;
                
                // Create arrow border
                const arrowBorder = document.createElement('div');
                arrowBorder.style.cssText = `
                    position: absolute;
                    right: -8px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 0;
                    height: 0;
                    border-top: 7px solid transparent;
                    border-bottom: 7px solid transparent;
                    border-left: 7px solid black;
                    z-index: 0;
                `;
                tooltip.appendChild(arrowBorder);
                tooltip.appendChild(arrow);
                
                card.appendChild(tooltip);
                
                // Show/hide on hover
                card.addEventListener('mouseenter', function() {
                    tooltip.style.opacity = '1';
                    tooltip.style.visibility = 'visible';
                });
                
                card.addEventListener('mouseleave', function() {
                    tooltip.style.opacity = '0';
                    tooltip.style.visibility = 'hidden';
                });
            });
        }
        
        // Manual Assessment Area Entry
        let manualAssessmentAreas = {
            acquirer: [],
            target: []
        };
        
        // Toggle between upload and manual entry
        $(document).on('click', '.aa-toggle-btn', function() {
            const bank = $(this).data('bank');
            const mode = $(this).data('mode');
            
            // Update button styles
            $(`.aa-toggle-btn[data-bank="${bank}"]`).removeClass('active')
                .css({'background': '#e0e0e0', 'color': '#333'});
            $(this).addClass('active')
                .css({'background': 'var(--ncrc-secondary-blue)', 'color': 'white'});
            
            // Show/hide sections
            if (mode === 'upload') {
                $(`#${bank}_upload_section`).show();
                $(`#${bank}_manual_section`).hide();
            } else {
                $(`#${bank}_upload_section`).hide();
                $(`#${bank}_manual_section`).show();
            }
        });
        
        // Add new assessment area entry
        $(document).on('click', '.add-aa-btn', function() {
            const bank = $(this).data('bank');
            const areaId = `aa_${bank}_${Date.now()}`;
            
            const areaHtml = `
                <div class="manual-aa-entry" data-id="${areaId}" style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="font-weight: 600; color: var(--ncrc-dark-blue);">Assessment Area Name:</label>
                        <button type="button" class="remove-aa-btn" data-id="${areaId}" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <input type="text" class="aa-name-input" placeholder="e.g., Denver-Boulder-Greeley CSA or MSA 14500, 19740" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <label style="display: block; font-weight: 600; color: var(--ncrc-dark-blue); margin-bottom: 5px;">Counties (one per line) or MSA codes:</label>
                    <textarea class="aa-counties-input" placeholder="Enter counties (e.g., Denver County, Colorado) or MSA codes (e.g., MSA 14500, 19740, 24540)" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit;"></textarea>
                </div>
            `;
            
            $(`#${bank}_manual_areas`).append(areaHtml);
        });
        
        // Remove county from assessment area
        $(document).on('click', '.remove-county-btn', function(e) {
            e.stopPropagation();
            const btn = $(this);
            const aaIndex = parseInt(btn.data('aa-index'));
            const countyIndex = parseInt(btn.data('county-index'));
            const bank = btn.closest('.aa-input-section').data('bank') || 
                        (btn.closest('#acquirer_aa_preview, #acquirer_aa_list').length ? 'acquirer' : 'target');
            const bankType = bank === 'acquirer' ? 'acquirer' : 'target';
            
            // Get stored assessment areas
            const storedAreas = $('#analysisForm').data(`${bankType}_assessment_areas`) || [];
            
            if (storedAreas[aaIndex] && storedAreas[aaIndex].counties) {
                // Remove the county
                storedAreas[aaIndex].counties.splice(countyIndex, 1);
                
                // Update stored data
                $('#analysisForm').data(`${bankType}_assessment_areas`, storedAreas);
                
                // Remove the badge from display
                btn.closest('.county-badge').fadeOut(300, function() {
                    $(this).remove();
                    
                    // If no counties left in this assessment area, show message
                    const remainingCounties = $(`.county-badge[data-aa-index="${aaIndex}"]`).length;
                    if (remainingCounties === 0) {
                        const aaItem = btn.closest('li');
                        aaItem.find('div').html('<small style="color: #999;">No counties remaining</small>');
                    }
                });
            }
        });
        
        // Remove assessment area entry
        $(document).on('click', '.remove-aa-btn', function() {
            const areaId = $(this).data('id');
            $(`.manual-aa-entry[data-id="${areaId}"]`).remove();
        });
        
        // Process manual assessment areas (called before form submission)
        function processManualAssessmentAreas(bank) {
            const areas = [];
            $(`#${bank}_manual_areas .manual-aa-entry`).each(function() {
                const name = $(this).find('.aa-name-input').val().trim();
                const countiesText = $(this).find('.aa-counties-input').val().trim();
                
                if (name && countiesText) {
                    // Check if it contains MSA codes
                    const msaMatch = countiesText.match(/MSA\s+(\d+(?:\s*,\s*\d+)*)/i);
                    if (msaMatch) {
                        // MSA codes - will be looked up on backend
                        areas.push({
                            cbsa_name: name,
                            counties: countiesText.split('\n').map(c => c.trim()).filter(c => c),
                            has_msa_codes: true
                        });
                    } else {
                        // Regular county list
                        areas.push({
                            cbsa_name: name,
                            counties: countiesText.split('\n').map(c => c.trim()).filter(c => c),
                            has_msa_codes: false
                        });
                    }
                }
            });
            
            return areas;
        }
        
        // MergerMeter-specific customizations
        $(document).ready(function() {
            try {
                // Setup feature card tooltips
                setupFeatureCardTooltips();
            } catch (e) {
                console.error('Error setting up tooltips:', e);
            }
            
            try {
                // Initialize Select2 for multi-select HMDA filters
                $('#action_taken, #occupancy_type, #total_units, #construction_method, #not_reverse').select2({
                    placeholder: 'Select options...',
                    allowClear: false,
                    width: '100%',
                    closeOnSelect: false
                });
            } catch (e) {
                console.error('Error initializing Select2:', e);
            }
            
            // Bulk Import Toggle - ensure this always works
            try {
                $('#toggleBulkImport').on('click', function() {
                    const section = $('#bulkImportSection');
                    const isVisible = section.is(':visible');
                    section.slideToggle();
                    $(this).html(isVisible ? '<i class="fas fa-chevron-down"></i> Show' : '<i class="fas fa-chevron-up"></i> Hide');
                });
                console.log('Bulk import toggle handler attached');
            } catch (e) {
                console.error('Error setting up bulk import toggle:', e);
            }
            
            // Helper functions for smart parsing
            function isLEI(str) {
                // LEI is exactly 20 alphanumeric characters
                const cleaned = (str || '').replace(/\s+/g, '').toUpperCase();
                return cleaned.length === 20 && /^[A-Z0-9]{20}$/.test(cleaned);
            }
            
            function isRSSD(str) {
                // RSSD is typically 6-10 digits
                const cleaned = (str || '').replace(/\s+/g, '');
                return /^\d{6,10}$/.test(cleaned);
            }
            
            function cleanResID(str) {
                // Handle Res ID in various formats:
                // 1. Remove prefixes like "1-", "2-", etc.
                // 2. Handle scientific notation (e.g., "1.23E+08" -> "123000000")
                // 3. Ensure result is always 10 digits with leading zeros
                // 4. Preserve leading zeros when possible
                
                // Convert to string first
                let cleaned = String(str || '').trim();
                
                if (!cleaned) return '';
                
                // Remove prefixes like "1-", "2-", "10-", etc. (1-2 digits followed by dash)
                // Pattern: "1-0000004365" or "2-0000785473" -> remove "1-" or "2-"
                cleaned = cleaned.replace(/^\d{1,2}-/, '');
                
                // Check if it's scientific notation
                if (/^[\d.]+[eE][+-]?\d+$/.test(cleaned)) {
                    // Convert scientific notation to regular number
                    const num = parseFloat(cleaned);
                    if (!isNaN(num)) {
                        // Convert to string and pad to 10 digits
                        cleaned = Math.floor(num).toString();
                    }
                }
                
                // Extract only digits (remove any remaining non-digit characters)
                const digitsOnly = cleaned.replace(/\D/g, '');
                
                // Pad to 10 digits with leading zeros
                if (digitsOnly) {
                    return digitsOnly.padStart(10, '0');
                }
                
                return '';
            }
            
            function findInRow(rowParts, searchFunc) {
                // Find the first part that matches the search function
                for (let i = 0; i < rowParts.length; i++) {
                    const cleaned = rowParts[i].replace(/\s+/g, '').trim();
                    if (searchFunc(cleaned)) {
                        return { value: cleaned, index: i };
                    }
                }
                return null;
            }
            
            // Parse and Import Banks
            $('#parseBulkImportBtn').on('click', function() {
                const text = $('#bulkImportText').val().trim();
                if (!text) {
                    alert('Please paste bank data first.');
                    return;
                }
                
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length < 1) {
                    alert('Please paste at least one bank\'s information.');
                    return;
                }
                
                const banks = [];
                
                // First, check if this is labeled format (lines starting with "Acquirer Bank:" or "Target Bank:")
                // If so, skip header detection entirely - labeled format doesn't have headers
                const isLabeledFormat = lines.some(line => {
                    const trimmed = line.trim();
                    return /^(?:acquirer\s*bank|target\s*bank|bank\s*name)\s*:/i.test(trimmed);
                });
                
                // First, try to detect if this is a table format with headers
                // Look for common header keywords (matching the template format: Bank Name, LEI, RSSD, ResID)
                // BUT skip this if we're in labeled format
                const headerKeywords = ['bank', 'name', 'lei', 'rssd', 'resid', 'res-id', 'res id', 'respondent'];
                let hasHeaders = false;
                let headerRowIndex = -1;
                let columnMap = {}; // Map column names to indices
                
                // Only do header detection if NOT labeled format
                if (!isLabeledFormat) {
                    for (let i = 0; i < Math.min(3, lines.length); i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Skip if this looks like labeled format (starts with "Acquirer Bank:" etc.)
                        if (/^(?:acquirer\s*bank|target\s*bank|bank\s*name)\s*:/i.test(line)) {
                            continue; // This is labeled format, not a header
                        }
                        
                        // Try different delimiters to parse header row
                        let headerParts;
                        if (line.includes('\t')) {
                            headerParts = line.split('\t').map(p => p.trim().toLowerCase());
                        } else if (line.includes('|')) {
                            headerParts = line.split('|').map(p => p.trim().toLowerCase());
                        } else if (line.includes(',')) {
                            headerParts = line.split(',').map(p => p.trim().toLowerCase());
                        } else {
                            continue; // Can't parse headers without delimiter
                        }
                        
                        // Check if this looks like a header row (but NOT labeled format)
                        // Header rows typically have short labels like "Bank Name", "LEI", "RSSD" without values
                        const headerCount = headerKeywords.filter(kw => 
                            headerParts.some(h => h.includes(kw))
                        ).length;
                        
                        // A header row should have multiple keywords but NO actual data values (no long strings, no LEI codes, etc.)
                        const hasDataValues = headerParts.some(part => {
                            return part.length > 15 || // Long strings are likely data
                                   /^[A-Z0-9]{18,20}$/i.test(part) || // LEI codes
                                   /^\d{4,}$/.test(part); // Long numbers
                        });
                        
                        if (headerCount >= 2 && !hasDataValues) {
                            hasHeaders = true;
                            headerRowIndex = i;
                            
                            // Map column names to indices
                            // Handle truncated headers (e.g., "Bank Nam" instead of "Bank Name")
                            headerParts.forEach((header, idx) => {
                                const headerLower = header.toLowerCase();
                                // Bank Name - check for "bank" (handles "Bank Name", "Bank Nam", etc.)
                                if (headerLower.includes('bank')) {
                                    columnMap['name'] = idx;
                                } 
                                // LEI - exact match or contains "lei"
                                else if (headerLower === 'lei' || headerLower.includes('lei')) {
                                    columnMap['lei'] = idx;
                                } 
                                // RSSD - exact match or contains "rssd"
                                else if (headerLower === 'rssd' || headerLower.includes('rssd')) {
                                    columnMap['rssd'] = idx;
                                } 
                                // ResID - check for various formats (but not RSSD which also has "res")
                                else if ((headerLower.includes('resid') || headerLower.includes('res-id') || 
                                         headerLower.includes('res id')) && !headerLower.includes('rssd')) {
                                    columnMap['resid'] = idx;
                                }
                            });
                            
                            // If we have 4 columns and detected headers, ensure all columns are mapped
                            // Use standard order as fallback for any unmapped columns
                            if (headerParts.length === 4) {
                                if (!columnMap.hasOwnProperty('name')) columnMap['name'] = 0;
                                if (!columnMap.hasOwnProperty('lei')) columnMap['lei'] = 1;
                                if (!columnMap.hasOwnProperty('rssd')) columnMap['rssd'] = 2;
                                if (!columnMap.hasOwnProperty('resid')) columnMap['resid'] = 3;
                            }
                            
                            // If no explicit mapping found but we have 4 columns, assume standard order: Bank Name, LEI, RSSD, ResID
                            if (Object.keys(columnMap).length === 0 && headerParts.length >= 2) {
                                // If we detected headers but couldn't map them, use standard order
                                if (headerParts.length === 4) {
                                    columnMap['name'] = 0;
                                    columnMap['lei'] = 1;
                                    columnMap['rssd'] = 2;
                                    columnMap['resid'] = 3;
                                }
                            }
                        }
                        break;
                    }
                }
                
                // If no headers detected but we have 4 columns, assume standard order
                // BUT skip this check if it's labeled format
                if (!hasHeaders && !isLabeledFormat && lines.length > 0) {
                    const firstLine = lines[0].trim();
                    // Skip if this is labeled format
                    if (!/^(?:acquirer\s*bank|target\s*bank|bank\s*name)\s*:/i.test(firstLine)) {
                        let testParts;
                        if (firstLine.includes('\t')) {
                            testParts = firstLine.split('\t');
                        } else if (firstLine.includes('|')) {
                            testParts = firstLine.split('|');
                        } else if (firstLine.includes(',')) {
                            testParts = firstLine.split(',');
                        }
                        
                        // If first line has 4 columns and doesn't look like data (has text that's not a code), assume it's headers
                        if (testParts && testParts.length === 4) {
                            const firstPart = testParts[0].trim().toLowerCase();
                            if (firstPart.includes('bank') || firstPart.includes('name')) {
                                hasHeaders = true;
                                headerRowIndex = 0;
                                columnMap = { 'name': 0, 'lei': 1, 'rssd': 2, 'resid': 3 };
                            }
                        }
                    }
                }
                
                // Skip header rows (but not if it's labeled format - all lines are data in labeled format)
                const dataStartIndex = (hasHeaders && !isLabeledFormat) ? headerRowIndex + 1 : 0;
                
                // Debug logging
                console.log('Bulk import parsing:', {
                    isLabeledFormat: isLabeledFormat,
                    hasHeaders: hasHeaders,
                    dataStartIndex: dataStartIndex,
                    totalLines: lines.length
                });
                
                for (let i = dataStartIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Skip lines that look like headers or separators
                    // BUT don't skip lines that are labeled format (they contain "acquirer" or "target" but are actual data)
                    if (line.toLowerCase().includes('bank information') || 
                        (line.toLowerCase().includes('acquirer') && line.toLowerCase().includes('target') && !isLabeledFormat) ||
                        /^[-=]+$/.test(line)) {
                        continue;
                    }
                    
                    let bank = {
                        name: '',
                        lei: '',
                        rssd: '',
                        resid: ''
                    };
                    
                    // Check if this is a labeled format BEFORE splitting (e.g., "Acquirer Bank: 1ST MERCHANTS BANK	LEI: S0Q3AHZRL5K6VQE35M07	RSSD: 17147	SB Respondent ID: 0000004365")
                    // Look for patterns like "LEI:", "RSSD:", "SB Respondent ID:" or "Acquirer Bank:" at the start
                    // Handle both "LEI: VALUE" and "LEI:VALUE" (with or without space after colon)
                    // Must check for at least 2 labels to be sure it's labeled format (not just a column header)
                    // Also check if line starts with "Acquirer Bank:" or "Target Bank:" - that's a strong indicator
                    const startsWithBankLabel = /^(?:acquirer\s*bank|target\s*bank|bank\s*name)\s*:/i.test(line);
                    const labelMatches = line.match(/\b(?:acquirer\s*bank|target\s*bank|bank\s*name|lei|rssd|sb\s*respondent\s*id|resid)\s*:/gi);
                    const labelCount = labelMatches ? labelMatches.length : 0;
                    const hasLabels = startsWithBankLabel || labelCount >= 2; // Start with bank label OR have 2+ labels
                    
                    // Debug logging for labeled format detection
                    console.log('Processing line:', {
                        lineIndex: i,
                        line: line.substring(0, 100),
                        startsWithBankLabel: startsWithBankLabel,
                        labelCount: labelCount,
                        labelMatches: labelMatches,
                        hasLabels: hasLabels,
                        isLabeledFormat: isLabeledFormat
                    });
                    
                    if (hasLabels) {
                        // Parse labeled format
                        // Pattern: "Acquirer Bank: VALUE	LEI: VALUE	RSSD: VALUE	SB Respondent ID: VALUE"
                        // or "Target Bank: VALUE	LEI: VALUE	RSSD: VALUE	SB Respondent ID: VALUE"
                        // or "Bank Name: VALUE	LEI: VALUE	RSSD: VALUE	SB Respondent ID: VALUE"
                        // Also handles "LEI:VALUE" (no space after colon)
                        
                        // Extract bank name (can be "Bank Name:", "Acquirer Bank:", or "Target Bank:")
                        // Match pattern: "Acquirer Bank: 1ST MERCHANTS BANK" or "Target Bank: 1ST" or "Bank Name: VALUE"
                        // Stop at tab, newline, or next label (LEI, RSSD, etc.)
                        // Pattern: Match "Acquirer Bank:" or "Target Bank:" at start, then capture everything until tab
                        // The bank name is everything after the colon until the first tab
                        let nameMatch = line.match(/^(?:acquirer\s*bank|target\s*bank|bank\s*name)\s*:\s*([^\t]+)/i);
                        if (nameMatch) {
                            bank.name = nameMatch[1].trim();
                            console.log('Extracted bank name:', bank.name);
                        } else {
                            console.warn('Could not extract bank name from line:', line.substring(0, 100));
                        }
                        
                        // Extract LEI (pattern: "LEI: S0Q3AHZRL5K6VQE35M07" or "LEI:S0Q3AHZRL5K6VQE35M07" or "LEI S0Q3AHZRL5K6VQE35M07")
                        // LEI is 18-20 alphanumeric characters (handle both with and without space after colon)
                        // Match LEI followed by colon, optional space, then 18-20 alphanumeric chars (may be followed by tab or space)
                        const leiMatch = line.match(/\b(?:lei|LEI)\s*:\s*([A-Z0-9]{18,20})(?:\t|\s|$)/i);
                        if (leiMatch) {
                            bank.lei = leiMatch[1].replace(/\s+/g, '').substring(0, 20).toUpperCase();
                        }
                        
                        // Extract RSSD (pattern: "RSSD: 17147" or "RSSD:17147" or "RSSD 17147")
                        // RSSD is numeric, typically 4-10 digits (may be followed by tab or space)
                        const rssdMatch = line.match(/\b(?:rssd|RSSD)\s*:\s*(\d{4,10})(?:\t|\s|$)/i);
                        if (rssdMatch) {
                            bank.rssd = rssdMatch[1].replace(/\s+/g, '');
                        }
                        
                        // Extract SB Respondent ID (pattern: "SB Respondent ID: 0000004365" or "ResID: 0000004365" or "SB Respondent ID 0000004365")
                        // Can have leading zeros, may have prefix like "0000004365" or "1-0000004365"
                        // Handle both "SB Respondent ID: VALUE" and "SB Respondent ID:VALUE"
                        // Match until tab, space, or end of line
                        const residMatch = line.match(/\b(?:sb\s*respondent\s*id|resid|res\s*id)\s*:\s*([\d-]+)(?:\t|\s|$)/i);
                        if (residMatch) {
                            bank.resid = cleanResID(residMatch[1].trim());
                        }
                        
                        // Debug logging
                        console.log('Parsed bank (labeled format):', {
                            name: bank.name,
                            lei: bank.lei,
                            rssd: bank.rssd,
                            resid: bank.resid,
                            originalLine: line
                        });
                        
                        // Only add if we found at least LEI or RSSD
                        if (bank.lei || bank.rssd) {
                            banks.push(bank);
                        }
                        continue; // Skip the rest of the parsing logic for labeled format
                    }
                    
                    // Standard column-based parsing (original logic)
                    // Try different delimiters: tab, pipe (|), comma, or multiple spaces
                    let parts;
                    let delimiter = 'unknown';
                    if (line.includes('\t')) {
                        parts = line.split('\t');
                        delimiter = 'tab';
                    } else if (line.includes('|')) {
                        parts = line.split('|');
                        delimiter = 'pipe';
                    } else if (line.includes(',')) {
                        parts = line.split(',');
                        delimiter = 'comma';
                    } else {
                        // Try splitting on multiple spaces (for space-separated format)
                        parts = line.split(/\s{2,}/);
                        delimiter = 'space';
                    }
                    
                    // Trim all parts first, but convert to string to preserve leading zeros
                    // This ensures that numbers with leading zeros (like "0000024891") are preserved
                    parts = parts.map(p => String(p || '').trim());
                    
                    // Filter out completely empty parts, but keep parts that are just whitespace as empty strings
                    // This preserves column positions for 4-column format
                    const filteredParts = [];
                    for (let i = 0; i < parts.length; i++) {
                        if (parts[i] !== '' || i < 4) { // Keep first 4 positions even if empty
                            filteredParts.push(parts[i] || '');
                        }
                    }
                    parts = filteredParts;
                    
                    if (parts.length < 2) continue; // Need at least 2 values
                    
                    // ALWAYS use standard order when we have 4+ columns: Bank Name, LEI, RSSD, ResID
                    // This is the most reliable approach and matches the template format exactly
                    // Priority: If we have exactly 4 parts, ALWAYS use standard order (ignore headers)
                    if (parts.length === 4) {
                        // Force standard order for exactly 4 columns, regardless of headers
                        bank.name = (parts[0] || '').trim();
                        // LEI: remove all whitespace, keep full value (will be validated to 20 chars later)
                        // Validate that parts[1] looks like a LEI (20 alphanumeric chars) before assigning
                        const potentialLEI = String(parts[1] || '').replace(/\s+/g, '');
                        if (potentialLEI.length >= 18 && potentialLEI.length <= 20 && /^[A-Z0-9]+$/i.test(potentialLEI)) {
                            bank.lei = potentialLEI.substring(0, 20);
                        } else {
                            bank.lei = '';
                            console.warn('Parts[1] does not look like a valid LEI:', potentialLEI);
                        }
                        // RSSD: remove all whitespace, preserve as string (don't convert to number)
                        bank.rssd = String(parts[2] || '').replace(/\s+/g, '');
                        // ResID: clean and convert scientific notation if needed, but preserve leading zeros
                        // Convert to string first to preserve leading zeros before cleaning
                        // Validate that parts[3] does NOT look like a LEI (to prevent LEI being assigned to ResID)
                        const potentialResID = String(parts[3] || '').trim();
                        if (potentialResID.length >= 18 && potentialResID.length <= 20 && /^[A-Z0-9]+$/i.test(potentialResID) && !/^\d+$/.test(potentialResID)) {
                            // This looks like a LEI, not a ResID - don't assign it
                            console.warn('Parts[3] looks like a LEI, not a ResID:', potentialResID);
                            bank.resid = '';
                        } else {
                            bank.resid = cleanResID(potentialResID);
                        }
                        
                        // Debug logging
                        console.log('Parsed bank (exactly 4 columns, standard order):', {
                            delimiter: delimiter,
                            name: bank.name,
                            lei: bank.lei,
                            rssd: bank.rssd,
                            resid: bank.resid,
                            partsCount: parts.length,
                            allParts: parts
                        });
                    } else if (parts.length >= 4) {
                        bank.name = (parts[0] || '').trim();
                        // LEI: remove all whitespace, keep full value (will be validated to 20 chars later)
                        // Validate that parts[1] looks like a LEI (20 alphanumeric chars) before assigning
                        const potentialLEI = String(parts[1] || '').replace(/\s+/g, '');
                        if (potentialLEI.length >= 18 && potentialLEI.length <= 20 && /^[A-Z0-9]+$/i.test(potentialLEI)) {
                            bank.lei = potentialLEI.substring(0, 20);
                        } else {
                            bank.lei = '';
                            console.warn('Parts[1] does not look like a valid LEI:', potentialLEI);
                        }
                        // RSSD: remove all whitespace, preserve as string (don't convert to number)
                        bank.rssd = String(parts[2] || '').replace(/\s+/g, '');
                        // ResID: clean and convert scientific notation if needed, but preserve leading zeros
                        // Convert to string first to preserve leading zeros before cleaning
                        // Validate that parts[3] does NOT look like a LEI (to prevent LEI being assigned to ResID)
                        const potentialResID = String(parts[3] || '').trim();
                        if (potentialResID.length >= 18 && potentialResID.length <= 20 && /^[A-Z0-9]+$/i.test(potentialResID) && !/^\d+$/.test(potentialResID)) {
                            // This looks like a LEI, not a ResID - don't assign it
                            console.warn('Parts[3] looks like a LEI, not a ResID:', potentialResID);
                            bank.resid = '';
                        } else {
                            bank.resid = cleanResID(potentialResID);
                        }
                        
                        // Debug logging
                        console.log('Parsed bank (4+ columns, standard order):', {
                            delimiter: delimiter,
                            name: bank.name,
                            lei: bank.lei,
                            rssd: bank.rssd,
                            resid: bank.resid,
                            partsCount: parts.length,
                            allParts: parts
                        });
                    } 
                    // If we have column mapping from headers and NOT exactly 4 columns, use mapping
                    else if (parts.length !== 4 && hasHeaders && Object.keys(columnMap).length > 0) {
                        if (columnMap['name'] !== undefined && parts[columnMap['name']]) {
                            bank.name = parts[columnMap['name']].trim();
                        }
                        if (columnMap['lei'] !== undefined && parts[columnMap['lei']]) {
                            bank.lei = parts[columnMap['lei']].replace(/\s+/g, '').trim();
                        }
                        if (columnMap['rssd'] !== undefined && parts[columnMap['rssd']]) {
                            bank.rssd = String(parts[columnMap['rssd']]).replace(/\s+/g, '').trim();
                        }
                        if (columnMap['resid'] !== undefined && parts[columnMap['resid']]) {
                            // Convert to string first to preserve leading zeros
                            bank.resid = cleanResID(String(parts[columnMap['resid']]).trim());
                        }
                    } else {
                        // Fall back to pattern matching if no headers or mapping
                        // Smart detection: find LEI, RSSD, and Res ID by their characteristics
                        const leiMatch = findInRow(parts, isLEI);
                        const rssdMatch = findInRow(parts, isRSSD);
                        
                        // For Res ID, look for patterns that might have prefix or scientific notation
                        let residMatch = null;
                        for (let j = 0; j < parts.length; j++) {
                            const cleaned = parts[j].trim();
                            // Check if it looks like a Res ID:
                            // 1. Prefix format: "1-0000023695"
                            // 2. Long number: "0000023695" (8+ digits)
                            // 3. Scientific notation: "1.23E+08"
                            if (/^\d+-\d+$/.test(cleaned) || 
                                /^\d{8,}$/.test(cleaned.replace(/[^\d]/g, '')) ||
                                /^[\d.]+[eE][+-]?\d+$/.test(cleaned)) {
                                residMatch = { value: cleanResID(cleaned), index: j };
                                break;
                            }
                        }
                        
                        // Bank name is typically the first non-matching field, or a text field that's not LEI/RSSD/ResID
                        for (let j = 0; j < parts.length; j++) {
                            const part = parts[j].trim();
                            // Skip if it's LEI, RSSD, or Res ID
                            if (leiMatch && j === leiMatch.index) continue;
                            if (rssdMatch && j === rssdMatch.index) continue;
                            if (residMatch && j === residMatch.index) continue;
                            // Skip if it looks like a number or code
                            if (/^\d+$/.test(part) || isLEI(part)) continue;
                            // Skip common labels
                            if (['bank', 'lei', 'rssd', 'rss-id', 'respondent', 'location', 'city', 'state'].some(
                                label => part.toLowerCase().includes(label))) continue;
                            
                            // This might be the bank name
                            if (part.length > 2 && !/^[A-Z0-9]{20}$/i.test(part)) {
                                bank.name = part;
                                break;
                            }
                        }
                        
                        bank.lei = leiMatch ? leiMatch.value : '';
                        bank.rssd = rssdMatch ? rssdMatch.value : '';
                        bank.resid = residMatch ? residMatch.value : '';
                    }
                    
                    // Only add if we found at least LEI or RSSD
                    if (bank.lei || bank.rssd) {
                        banks.push(bank);
                    }
                }
                
                if (banks.length === 0) {
                    $('#bulkImportResults').html('<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 4px;">No valid bank data found. Please check the format.</div>').show();
                    return;
                }
                
                // Fill in Bank A (first bank)
                if (banks.length >= 1) {
                    const bankA = banks[0];
                    if (bankA.lei) {
                        // Clean LEI - remove all whitespace and trim to 20 characters (LEI standard length)
                        const cleanLEI = bankA.lei.replace(/\s+/g, '').trim().substring(0, 20);
                        $('#acquirer_lei').val(cleanLEI).trigger('input'); // Trigger input event to update validation
                    }
                    if (bankA.rssd) {
                        const cleanRSSD = bankA.rssd.replace(/\s+/g, '');
                        $('#acquirer_rssd').val(cleanRSSD).trigger('input');
                    }
                    if (bankA.resid) {
                        // Res ID should already be cleaned (prefix removed), but ensure it's clean
                        const cleanedResID = bankA.resid.replace(/\s+/g, '');
                        $('#acquirer_sb_id').val(cleanedResID).trigger('input');
                    }
                    if (bankA.name) {
                        // If bank name was found, we could potentially use it, but for now just log it
                        console.log('Bank A name found:', bankA.name);
                    }
                }
                
                // Fill in Bank B (second bank, if available)
                if (banks.length >= 2) {
                    const bankB = banks[1];
                    if (bankB.lei) {
                        // Clean LEI - remove all whitespace and trim to 20 characters (LEI standard length)
                        const cleanLEI = bankB.lei.replace(/\s+/g, '').trim().substring(0, 20);
                        $('#target_lei').val(cleanLEI).trigger('input'); // Trigger input event to update validation
                    }
                    if (bankB.rssd) {
                        const cleanRSSD = bankB.rssd.replace(/\s+/g, '');
                        $('#target_rssd').val(cleanRSSD).trigger('input');
                    }
                    if (bankB.resid) {
                        // Res ID should already be cleaned (prefix removed), but ensure it's clean
                        const cleanedResID = bankB.resid.replace(/\s+/g, '');
                        $('#target_sb_id').val(cleanedResID).trigger('input');
                    }
                    if (bankB.name) {
                        // If bank name was found, we could potentially use it, but for now just log it
                        console.log('Bank B name found:', bankB.name);
                    }
                }
                
                // Show success message
                let message = `<div style="color: green; padding: 10px; background: #e6ffe6; border-radius: 4px;">`;
                message += `<strong>Successfully imported ${banks.length} bank(s):</strong><ul style="margin: 10px 0 0 20px;">`;
                banks.forEach((bank, idx) => {
                    message += `<li>Bank ${idx + 1}: ${bank.name || 'Unnamed'} (LEI: ${bank.lei || 'N/A'})</li>`;
                });
                message += `</ul>`;
                if (banks.length === 1) {
                    message += `<p style="margin-top: 10px; color: #666;">Only one bank was found. Please add the second bank manually or paste another line.</p>`;
                }
                message += `<p style="margin-top: 10px; color: #0066cc;"><strong>Next step:</strong> Click "Load Bank Names" button below to verify and fetch bank names.</p>`;
                message += `</div>`;
                
                $('#bulkImportResults').html(message).show();
                
                // Auto-collapse after successful import
                setTimeout(() => {
                    $('#bulkImportSection').slideUp();
                    $('#toggleBulkImport').html('<i class="fas fa-chevron-down"></i> Show');
                }, 3000);
            });
            
            // Load Bank Names Handler - ensure this always works
            try {
                $('#loadBanksBtn').on('click', async function() {
                const btn = $(this);
                const originalText = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');
                
                // Get bank identifiers - clean them thoroughly
                const acquirerLEI = $('#acquirer_lei').val().replace(/\s+/g, '').trim();
                const acquirerRSSD = $('#acquirer_rssd').val().replace(/\s+/g, '').trim();
                const acquirerResID = $('#acquirer_sb_id').val().replace(/\s+/g, '').trim();
                
                const targetLEI = $('#target_lei').val().replace(/\s+/g, '').trim();
                const targetRSSD = $('#target_rssd').val().replace(/\s+/g, '').trim();
                const targetResID = $('#target_sb_id').val().replace(/\s+/g, '').trim();
                
                const acquirerData = {
                    lei: acquirerLEI,
                    rssd: acquirerRSSD,
                    sb_respondent_id: acquirerResID
                };
                
                const targetData = {
                    lei: targetLEI,
                    rssd: targetRSSD,
                    sb_respondent_id: targetResID
                };
                
                // Validate LEI number is provided (required for bank name lookup)
                // Clean LEI and check it's exactly 20 characters
                if (!acquirerData.lei || acquirerData.lei.length !== 20) {
                    alert('Please enter a valid LEI number (20 characters) for Bank A (Acquirer). The system uses the LEI number to look up the bank name.\n\nCurrent value: "' + $('#acquirer_lei').val() + '" (length: ' + acquirerData.lei.length + ')');
                    btn.prop('disabled', false).html(originalText);
                    return;
                }
                
                if (!targetData.lei || targetData.lei.length !== 20) {
                    alert('Please enter a valid LEI number (20 characters) for Bank B (Target). The system uses the LEI number to look up the bank name.\n\nCurrent value: "' + $('#target_lei').val() + '" (length: ' + targetData.lei.length + ')');
                    btn.prop('disabled', false).html(originalText);
                    return;
                }
                
                try {
                    // Fetch bank names from backend
                    const response = await fetch('/api/load-bank-names', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            acquirer: acquirerData,
                            target: targetData
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Display confirmed bank names
                        if (result.acquirer_name) {
                            $('#acquirer_name_display').text(result.acquirer_name);
                            $('#acquirer_confirmation').show();
                            // Store for form submission
                            $('#analysisForm').data('acquirer_name', result.acquirer_name);
                        }
                        
                        if (result.target_name) {
                            $('#target_name_display').text(result.target_name);
                            $('#target_confirmation').show();
                            // Store for form submission
                            $('#analysisForm').data('target_name', result.target_name);
                        }
                        
                        // Show success message
                        if (result.acquirer_name && result.target_name) {
                            alert(`Bank names confirmed:\n\nBank A (Acquirer): ${result.acquirer_name}\nBank B (Target): ${result.target_name}`);
                            // Show assessment area section after banks are loaded
                            $('#assessmentAreaSection').slideDown(300, function() {
                                // Initialize the manual sections to be visible by default
                                // (they should already be visible, but ensure they are)
                                $('#acquirer_manual_section').show();
                                $('#target_manual_section').show();
                            });
                        } else if (result.acquirer_name || result.target_name) {
                            // At least one bank name loaded, show the section anyway
                            $('#assessmentAreaSection').slideDown(300, function() {
                                $('#acquirer_manual_section').show();
                                $('#target_manual_section').show();
                            });
                        }
                    } else {
                        alert(`Error loading bank names: ${result.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Network error. Please check your connection and try again.');
                } finally {
                    btn.prop('disabled', false).html(originalText);
                }
                });
                console.log('Load Bank Names handler attached');
            } catch (e) {
                console.error('Error setting up Load Bank Names handler:', e);
            }
            
            // Handle Assessment Area Toggle Buttons
            $('.aa-toggle-btn').on('click', function() {
                const bank = $(this).data('bank');
                const mode = $(this).data('mode');
                
                // Update button styles
                $(`.aa-toggle-btn[data-bank="${bank}"]`).removeClass('active').css({
                    'background': '#e0e0e0',
                    'color': '#333'
                });
                $(this).addClass('active').css({
                    'background': 'var(--ncrc-secondary-blue)',
                    'color': 'white'
                });
                
                // Hide all sections
                $(`#${bank}_upload_section`).hide();
                $(`#${bank}_manual_section`).hide();
                $(`#${bank}_branches_section`).hide();
                
                // Show selected section
                if (mode === 'upload') {
                    $(`#${bank}_upload_section`).show();
                } else if (mode === 'manual') {
                    $(`#${bank}_manual_section`).show();
                } else if (mode === 'branches') {
                    $(`#${bank}_branches_section`).show();
                }
            });
            
            // Update method descriptions when selection changes
            $('#acquirer_aa_method, #target_aa_method').on('change', function() {
                const bank = $(this).attr('id').includes('acquirer') ? 'acquirer' : 'target';
                const method = $(this).val();
                const descElement = $(`#${bank}_method_description`);
                
                const descriptions = {
                    'all_branches': 'Includes all CBSAs where the bank has at least one branch. All counties in those CBSAs are included.',
                    'deposits': 'Includes CBSAs where the bank has at least 1% of its total branch deposits. All counties in qualifying CBSAs are included.',
                    'loans': 'Includes CBSAs where the bank has at least 1% of its total loan applications. All counties in qualifying CBSAs are included.'
                };
                
                descElement.text(descriptions[method] || descriptions['all_branches']);
            });
            
            // Handle Generate from Branches Button
            $('.generate-from-branches-btn').on('click', async function() {
                const bank = $(this).data('bank');
                const bankType = bank === 'acquirer' ? 'acquirer' : 'target';
                const btn = $(this);
                const originalText = btn.html();
                
                // Get RSSD number
                const rssdField = bank === 'acquirer' ? $('#acquirer_rssd') : $('#target_rssd');
                const rssd = rssdField.val().trim();
                
                if (!rssd) {
                    alert(`Please enter the RSSD number for ${bank === 'acquirer' ? 'Bank A (Acquirer)' : 'Bank B (Target)'} to generate assessment areas from branches.`);
                    return;
                }
                
                // Get LEI number (needed for 'loans' method)
                const leiField = bank === 'acquirer' ? $('#acquirer_lei') : $('#target_lei');
                const lei = leiField.val().trim();
                
                // Get selected method
                const methodField = bank === 'acquirer' ? $('#acquirer_aa_method') : $('#target_aa_method');
                const method = methodField.val() || 'all_branches';
                
                // Validate LEI is provided for 'loans' method
                if (method === 'loans' && !lei) {
                    alert(`Please enter the LEI number for ${bank === 'acquirer' ? 'Bank A (Acquirer)' : 'Bank B (Target)'} to use the lending activity method.`);
                    return;
                }
                
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Generating...');
                
                const statusDiv = $(`#${bank}_aa_status`);
                const statusText = $(`#${bank}_aa_status_text`);
                const previewDiv = $(`#${bank}_aa_preview`);
                const listDiv = $(`#${bank}_aa_list`);
                
                statusDiv.show();
                const methodMessages = {
                    'all_branches': 'Querying branch locations...',
                    'deposits': 'Querying branch deposits...',
                    'loans': 'Querying loan applications...'
                };
                statusText.html(`<i class="fas fa-spinner fa-spin"></i> ${methodMessages[method] || 'Querying data...'}`);
                statusDiv.css({
                    'background': '#d1ecf1',
                    'border-color': '#bee5eb'
                });
                
                try {
                    const response = await fetch('/api/generate-assessment-areas-from-branches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            rssd: rssd,
                            lei: lei,  // Include LEI for 'loans' method
                            bank_type: bankType,
                            year: 2025,
                            method: method,
                            min_share: 0.01
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Endpoint not found. Please refresh the page (Ctrl+F5) and try again.');
                        }
                        const errorText = await response.text();
                        throw new Error(`Server error (${response.status}): ${errorText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const methodLabels = {
                            'all_branches': 'branch locations',
                            'deposits': 'branch deposits',
                            'loans': 'loan applications'
                        };
                        const methodLabel = methodLabels[result.method] || 'branch locations';
                        statusText.html(`<i class="fas fa-check-circle"></i> Generated ${result.count || result.assessment_areas?.length || 0} assessment areas from ${methodLabel}.`);
                        statusDiv.css({
                            'background': '#d4edda',
                            'border-color': '#c3e6cb'
                        });
                        
                        // Display generated assessment areas
                        if (result.assessment_areas && result.assessment_areas.length > 0) {
                            let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
                            result.assessment_areas.forEach((aa, aaIndex) => {
                                const countiesList = aa.counties || [];
                                
                                html += `<li style="padding: 12px; margin-bottom: 12px; background: #f8f9fa; border-left: 3px solid var(--ncrc-secondary-blue); border-radius: 4px;">
                                    <strong style="display: block; margin-bottom: 8px; color: var(--ncrc-dark-blue);">${aa.cbsa_name || 'Unnamed'}</strong>`;
                                
                                if (countiesList.length > 0) {
                                    html += '<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">';
                                    countiesList.forEach((c, cIndex) => {
                                        // Get county display name
                                        let countyDisplay = '';
                                        if (typeof c === 'object' && c !== null) {
                                            if (c.county_name && c.state_name) {
                                                countyDisplay = `${c.county_name}, ${c.state_name}`;
                                            } else if (c.county_name) {
                                                countyDisplay = c.county_name;
                                            } else if (c.state_code && c.county_code) {
                                                countyDisplay = `${c.state_code}${c.county_code}`;
                                            } else if (c.geoid5) {
                                                countyDisplay = `GEOID5: ${c.geoid5}`;
                                            } else {
                                                countyDisplay = JSON.stringify(c);
                                            }
                                        } else {
                                            countyDisplay = String(c);
                                        }
                                        
                                        // Create unique ID for this county
                                        const countyId = `county_${bankType}_${aaIndex}_${cIndex}`;
                                        
                                        html += `<span class="county-badge" data-aa-index="${aaIndex}" data-county-index="${cIndex}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;">
                                            <span>${countyDisplay}</span>
                                            <button type="button" class="remove-county-btn" data-aa-index="${aaIndex}" data-county-index="${cIndex}" style="padding: 2px 6px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem; line-height: 1;" title="Remove county">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </span>`;
                                    });
                                    html += '</div>';
                                } else {
                                    html += '<small style="color: #999;">No counties found</small>';
                                }
                                
                                html += '</li>';
                            });
                            html += '</ul>';
                            listDiv.html(html);
                            previewDiv.show();
                            
                            // Store assessment areas for form submission
                            $('#analysisForm').data(`${bankType}_assessment_areas`, result.assessment_areas);
                        }
                    } else {
                        const errorMsg = result.error || 'Failed to generate assessment areas';
                        statusText.html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                        statusDiv.css({
                            'background': '#f8d7da',
                            'border-color': '#f5c6cb'
                        });
                    }
                } catch (error) {
                    console.error('Error generating assessment areas:', error);
                    statusText.html(`<i class="fas fa-times-circle"></i> Network error. Please check your connection and try again.`);
                    statusDiv.css({
                        'background': '#f8d7da',
                        'border-color': '#f5c6cb'
                    });
                } finally {
                    btn.prop('disabled', false).html(originalText);
                }
            });
            
            // Handle Assessment Area File Uploads
            $('#acquirer_assessment_areas').on('change', async function() {
                const file = this.files[0];
                if (!file) return;
                
                await uploadAssessmentArea(file, 'acquirer');
            });
            
            $('#target_assessment_areas').on('change', async function() {
                const file = this.files[0];
                if (!file) return;
                
                await uploadAssessmentArea(file, 'target');
            });
            
            async function uploadAssessmentArea(file, bankType) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('bank_type', bankType);
                
                const statusDiv = $(`#${bankType}_aa_status`);
                const statusText = $(`#${bankType}_aa_status_text`);
                const previewDiv = $(`#${bankType}_aa_preview`);
                const listDiv = $(`#${bankType}_aa_list`);
                
                statusDiv.show();
                statusText.html('<i class="fas fa-spinner fa-spin"></i> Uploading and parsing file...');
                previewDiv.hide();
                
                try {
                    const response = await fetch('/api/upload-assessment-areas', {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Check if response is OK before trying to parse JSON
                    if (!response.ok) {
                        // Try to get error message from response
                        let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) {
                            // If we can't parse JSON, use the status text
                        }
                        throw new Error(errorMsg);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        statusText.html(`<i class="fas fa-check-circle"></i> File uploaded and parsed successfully. Found ${result.count || result.assessment_areas?.length || 0} assessment areas.`);
                        statusDiv.css({
                            'background': '#d4edda',
                            'border-color': '#c3e6cb'
                        });
                        
                        // Display parsed assessment areas
                        if (result.assessment_areas && result.assessment_areas.length > 0) {
                            let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
                            result.assessment_areas.forEach((aa, aaIndex) => {
                                const countiesList = aa.counties || [];
                                
                                html += `<li style="padding: 12px; margin-bottom: 12px; background: #f8f9fa; border-left: 3px solid var(--ncrc-secondary-blue); border-radius: 4px;">
                                    <strong style="display: block; margin-bottom: 8px; color: var(--ncrc-dark-blue);">${aa.cbsa_name || 'N/A'}</strong>`;
                                
                                if (countiesList.length > 0) {
                                    html += '<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">';
                                    countiesList.forEach((c, cIndex) => {
                                        // Get county display name
                                        let countyDisplay = '';
                                        if (typeof c === 'object' && c !== null) {
                                            if (c.county_name && c.state_name) {
                                                countyDisplay = `${c.county_name}, ${c.state_name}`;
                                            } else if (c.county_name) {
                                                countyDisplay = c.county_name;
                                            } else if (c.state_code && c.county_code) {
                                                countyDisplay = `${c.state_code}${c.county_code}`;
                                            } else if (c.geoid5) {
                                                countyDisplay = `GEOID5: ${c.geoid5}`;
                                            } else {
                                                countyDisplay = JSON.stringify(c);
                                            }
                                        } else {
                                            countyDisplay = String(c);
                                        }
                                        
                                        // Create unique ID for this county
                                        const countyId = `county_${bankType}_${aaIndex}_${cIndex}`;
                                        
                                        html += `<span class="county-badge" data-aa-index="${aaIndex}" data-county-index="${cIndex}" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;">
                                            <span>${countyDisplay}</span>
                                            <button type="button" class="remove-county-btn" data-aa-index="${aaIndex}" data-county-index="${cIndex}" style="padding: 2px 6px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem; line-height: 1;" title="Remove county">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </span>`;
                                    });
                                    html += '</div>';
                                } else {
                                    html += '<small style="color: #999;">No counties found</small>';
                                }
                                
                                html += '</li>';
                            });
                            html += '</ul>';
                            listDiv.html(html);
                            previewDiv.show();
                            
                            // Store assessment areas for form submission
                            $(`#analysisForm`).data(`${bankType}_assessment_areas`, result.assessment_areas);
                        } else {
                            statusText.html(`<i class="fas fa-exclamation-triangle"></i> File uploaded but no assessment areas were found. Please check the file format.`);
                            statusDiv.css({
                                'background': '#fff3cd',
                                'border-color': '#ffeaa7'
                            });
                        }
                    } else {
                        const errorMsg = result.error || 'Failed to parse file';
                        statusText.html(`<i class="fas fa-times-circle"></i> Error: ${errorMsg}`);
                        statusDiv.css({
                            'background': '#f8d7da',
                            'border-color': '#f5c6cb'
                        });
                        console.error('Upload error:', errorMsg);
                    }
                } catch (error) {
                    console.error('Error uploading assessment area:', error);
                    const errorMsg = error.message || 'Network error. Please check your connection and try again.';
                    statusText.html(`<i class="fas fa-times-circle"></i> ${errorMsg}`);
                    statusDiv.css({
                        'background': '#f8d7da',
                        'border-color': '#f5c6cb'
                    });
                }
            }
            
            // Update loan purpose card styles on selection
            $('input[name="loan_purpose"]').on('change', function() {
                $('input[name="loan_purpose"]').each(function() {
                    const card = $(this).closest('label');
                    if ($(this).is(':checked')) {
                        card.css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa'
                        });
                    } else {
                        card.css({
                            'border-color': '#e0e0e0',
                            'background': 'white'
                        });
                    }
                });
            });
            
            // Initialize loan purpose card styles
            $('input[name="loan_purpose"]:checked').each(function() {
                $(this).closest('label').css({
                    'border-color': 'var(--ncrc-secondary-blue)',
                    'background': '#f0f7fa'
                });
            });
            
            // Initialize tour for MergerMeter
            if (typeof window.initializeTour === 'function') {
                const originalInitializeTour = window.initializeTour;
                window.initializeTour = function() {
                    const hasSeenTour = localStorage.getItem('mergermeter_tour_completed');
                    const startTourBtn = document.getElementById('startTourBtn');
                    
                    if (!startTourBtn) return;
                    
                    startTourBtn.addEventListener('click', function() {
                        startTour();
                    });
                    
                    // Auto-start tour disabled - users can click "Take a Tour" button if they want
                    // if (!hasSeenTour) {
                    //     setTimeout(() => {
                    //         const shouldStart = confirm('Welcome to MergerMeter! Would you like to take a quick tour to learn how to use the tool?');
                    //         if (shouldStart) {
                    //             startTour();
                    //         } else {
                    //             localStorage.setItem('mergermeter_tour_completed', 'true');
                    //         }
                    //     }, 1000);
                    // }
                };
            }
            
            // Initialize tour after a short delay
            setTimeout(function() {
                if (typeof window.initializeTour === 'function') {
                    window.initializeTour();
                }
            }, 500);
            
            // Form submission handler
            $('#analysisForm').on('submit', async function(e) {
                e.preventDefault();
                
                // Validate required fields
                const acquirerLei = $('#acquirer_lei').val().trim();
                const targetLei = $('#target_lei').val().trim();
                const acquirerName = $('#analysisForm').data('acquirer_name') || $('#acquirer_name_display').text().trim();
                const targetName = $('#analysisForm').data('target_name') || $('#target_name_display').text().trim();
                
                if (!acquirerLei || acquirerLei.length !== 20) {
                    alert('Please enter a valid LEI number (20 characters) for Bank A (Acquirer) and click "Load Bank Names".');
                    return;
                }
                
                if (!targetLei || targetLei.length !== 20) {
                    alert('Please enter a valid LEI number (20 characters) for Bank B (Target) and click "Load Bank Names".');
                    return;
                }
                
                if (!acquirerName || acquirerName === '') {
                    alert('Please click "Load Bank Names" to confirm Bank A name before submitting.');
                    return;
                }
                
                if (!targetName || targetName === '') {
                    alert('Please click "Load Bank Names" to confirm Bank B name before submitting.');
                    return;
                }
                
                // Collect assessment areas
                let acquirerAA = $('#analysisForm').data('acquirer_assessment_areas') || [];
                let targetAA = $('#analysisForm').data('target_assessment_areas') || [];
                
                // Process manual assessment areas
                const acquirerManual = processManualAssessmentAreas('acquirer');
                const targetManual = processManualAssessmentAreas('target');
                
                if (acquirerManual.length > 0) {
                    acquirerAA = acquirerAA.concat(acquirerManual);
                }
                if (targetManual.length > 0) {
                    targetAA = targetAA.concat(targetManual);
                }
                
                if (acquirerAA.length === 0 && acquirerManual.length === 0) {
                    alert('Please upload or manually enter assessment areas for Bank A (Acquirer).');
                    return;
                }
                
                if (targetAA.length === 0 && targetManual.length === 0) {
                    alert('Please upload or manually enter assessment areas for Bank B (Target).');
                    return;
                }
                
                // Get form data
                const formData = new FormData(this);
                
                // Add bank names
                formData.append('acquirer_name', acquirerName);
                formData.append('target_name', targetName);
                
                // Add assessment areas as JSON
                formData.append('acquirer_assessment_areas', JSON.stringify(acquirerAA));
                formData.append('target_assessment_areas', JSON.stringify(targetAA));
                
                // Get loan purpose from dropdown
                const loanPurpose = $('#loan_purpose').val() || '';
                formData.set('loan_purpose', loanPurpose);
                
                // Get HMDA filter values from multi-select dropdowns (join arrays with commas)
                const actionTaken = $('#action_taken').val() || [];
                const occupancyType = $('#occupancy_type').val() || [];
                const totalUnits = $('#total_units').val() || [];
                const constructionMethod = $('#construction_method').val() || [];
                const notReverse = $('#not_reverse').val() || [];
                
                formData.set('action_taken', Array.isArray(actionTaken) ? actionTaken.join(',') : actionTaken);
                formData.set('occupancy_type', Array.isArray(occupancyType) ? occupancyType.join(',') : occupancyType);
                formData.set('total_units', Array.isArray(totalUnits) ? totalUnits.join(',') : totalUnits);
                formData.set('construction_method', Array.isArray(constructionMethod) ? constructionMethod.join(',') : constructionMethod);
                formData.set('not_reverse', Array.isArray(notReverse) ? notReverse.join(',') : notReverse);
                
                // Get year ranges
                const hmdaStartYear = $('#hmda_start_year').val() || '2023';
                const hmdaEndYear = $('#hmda_end_year').val() || '2024';
                const sbStartYear = $('#sb_start_year').val() || '2023';
                const sbEndYear = $('#sb_end_year').val() || '2024';
                
                // Build year lists
                const hmdaYears = [];
                for (let y = parseInt(hmdaStartYear); y <= parseInt(hmdaEndYear); y++) {
                    hmdaYears.push(y.toString());
                }
                formData.set('hmda_years', hmdaYears.join(','));
                
                const sbYears = [];
                for (let y = parseInt(sbStartYear); y <= parseInt(sbEndYear); y++) {
                    sbYears.push(y.toString());
                }
                formData.set('sb_years', sbYears.join(','));
                
                // Generate job ID
                const jobId = 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                formData.append('job_id', jobId);
                
                // Show progress
                $('#progressSection').show();
                $('#resultsSection').hide();
                $('#errorSection').hide();
                $('#analysisForm').hide();
                
                // Disable submit button
                $('#submitBtn').prop('disabled', true);
                
                try {
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Analysis failed');
                    }

                    // Log analytics event for MergerMeter report
                    if (window.JustDataAnalytics && window.JustDataAnalytics.logMergerMeterReport) {
                        window.JustDataAnalytics.logMergerMeterReport({
                            acquirerName: $('#acquirerName').val() || '',
                            targetName: $('#targetName').val() || '',
                            acquirerCert: $('#acquirerCert').val() || '',
                            targetCert: $('#targetCert').val() || '',
                            mergerType: 'two_bank_merger',
                            reportType: 'merger_analysis'
                        });
                    }

                    // Start listening for progress
                    const jobIdFromResponse = result.job_id || jobId;
                    listenForProgress(jobIdFromResponse);
                    
                } catch (error) {
                    console.error('Error:', error);
                    $('#errorMessage').text(error.message || 'Network error. Please check your connection and try again.');
                    $('#errorSection').show();
                    $('#progressSection').hide();
                    $('#submitBtn').prop('disabled', false);
                }
            });
            
            // Progress tracking function
            function listenForProgress(jobId) {
                const eventSource = new EventSource(`/progress/${jobId}`);
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const progressPercent = document.getElementById('progressPercent');
                
                // Progress steps section was removed, so we only track progress bar
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.done) {
                        eventSource.close();
                        
                        if (data.error) {
                            $('#errorMessage').text(data.error);
                            $('#errorSection').show();
                            $('#progressSection').hide();
                        } else {
                            $('#resultsSection').show();
                            $('#progressSection').hide();
                            
                            // Setup download button
                            $('#downloadBtn').off('click').on('click', function() {
                                window.location.href = `/download?job_id=${jobId}`;
                            });
                            
                            // Setup view report button
                            $('#viewReportBtn').off('click').on('click', function() {
                                window.location.href = `/report?job_id=${jobId}`;
                            });
                        }
                        $('#submitBtn').prop('disabled', false);
                        return;
                    }
                    
                    const percent = data.percent || 0;
                    const stepMessage = data.step || 'Processing...';
                    
                    // Update progress bar and text
                    if (progressFill) progressFill.style.width = percent + '%';
                    if (progressPercent) progressPercent.textContent = percent + '%';
                    if (progressText) progressText.textContent = stepMessage;
                };
                
                eventSource.onerror = function(error) {
                    console.error('Progress tracking error:', error);
                    // Check if connection is closed
                    if (eventSource.readyState === EventSource.CLOSED) {
                        console.log('EventSource connection closed');
                        // Try to reconnect after a delay
                        setTimeout(() => {
                            console.log('Attempting to reconnect to progress stream...');
                            eventSource.close();
                            listenForProgress(jobId);
                        }, 2000);
                    } else if (eventSource.readyState === EventSource.CONNECTING) {
                        console.log('EventSource is connecting...');
                    } else {
                        // Connection might be temporarily interrupted
                        console.log('EventSource connection interrupted, waiting...');
                    }
                };
            }
        });
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics-compat.js"></script>

    <!-- JustData Auth -->
    <script src="/static/js/auth.js"></script>

    <!-- JustData Analytics Event Logging -->
    <script src="/static/js/analytics-events.js"></script>

    {% include 'shared_header_js.html' %}
</body>
</html>

