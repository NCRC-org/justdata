<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizSight - Small Business Lending Report</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    
    <style>
        .report-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--ncrc-dark-blue);
            color: white;
            border-radius: 8px;
        }
        
        .map-and-table-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .map-container {
            position: relative;
            height: 600px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #tractMap {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 200px;
        }
        
        .map-controls h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--ncrc-dark-blue);
        }
        
        .layer-control {
            margin-bottom: 10px;
        }
        
        .layer-control label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .layer-control input[type="checkbox"],
        .layer-control input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .summary-table-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            height: 600px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .summary-table-container h3 {
            margin: 0 0 15px 0;
            color: var(--ncrc-primary-blue);
            font-size: 1.2rem;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .summary-table th {
            background: var(--ncrc-primary-blue);
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .summary-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
        }
        
        .summary-table tr:last-child td {
            border-bottom: none;
        }
        
        .summary-table .label {
            font-weight: 600;
            color: #333;
        }
        
        .summary-table .value {
            text-align: right;
            color: var(--ncrc-dark-blue);
            font-weight: 500;
        }
        
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 250px;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--ncrc-dark-blue);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .report-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            color: var(--ncrc-primary-blue);
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--ncrc-secondary-blue);
            padding-bottom: 10px;
            background: linear-gradient(to right, rgba(47, 173, 227, 0.05), transparent);
            padding: 15px 20px 10px 20px;
            margin-left: -20px;
            margin-right: -20px;
            border-radius: 4px;
        }
        
        .table-introduction {
            margin-bottom: 15px;
            color: #555;
            font-size: 1rem;
            line-height: 1.6;
            padding-left: 15px;
            border-left: 3px solid var(--ncrc-secondary-blue);
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 4px;
        }
        
        .table-container {
            margin-top: 20px;
        }
        
        .table-header {
            margin-bottom: 10px;
            text-align: right;
        }
        
        .expand-btn {
            background: var(--ncrc-secondary-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .expand-btn:hover {
            background: var(--ncrc-primary-blue);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table th {
            padding: 12px 10px;
            text-align: center;
            background: var(--ncrc-primary-blue);
            color: white;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            line-height: 1.5;
        }
        
        .data-table tbody tr:hover {
            background-color: #f0f7ff !important;
            transition: background-color 0.2s ease;
        }
        
        .data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .data-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        
        .data-table tbody tr:nth-child(even):hover {
            background-color: #e8f4ff !important;
        }
        
        .data-table tbody tr:focus {
            outline: 2px solid var(--ncrc-secondary-blue);
            outline-offset: -2px;
        }
        
        .table-narrative {
            margin-top: 20px;
            padding: 18px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid var(--ncrc-secondary-blue);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .table-narrative p {
            margin-bottom: 15px;
        }
        
        .table-narrative p:last-child {
            margin-bottom: 0;
        }
        
        /* Table of Contents */
        .toc-container {
            position: sticky;
            top: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .toc-container h3 {
            margin: 0 0 15px 0;
            color: var(--ncrc-primary-blue);
            font-size: 1.1rem;
            border-bottom: 2px solid var(--ncrc-secondary-blue);
            padding-bottom: 10px;
        }
        
        .toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .toc-list li {
            margin-bottom: 8px;
        }
        
        .toc-list a {
            color: #333;
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .toc-list a:hover {
            background: var(--ncrc-light-blue);
            color: var(--ncrc-primary-blue);
            transform: translateX(5px);
        }
        
        .toc-list a:focus {
            outline: 2px solid var(--ncrc-secondary-blue);
            outline-offset: 2px;
        }
        
        /* Print Styles */
        @media print {
            .toc-container,
            .map-controls,
            .legend,
            .action-btn,
            .expand-btn,
            .tab-button,
            .treemap-toggle-btn {
                display: none !important;
            }
            
            .report-container {
                max-width: 100%;
                padding: 0;
            }
            
            .report-section {
                page-break-inside: avoid;
                margin-bottom: 30px;
            }
            
            .section-title {
                page-break-after: avoid;
            }
            
            .data-table {
                page-break-inside: auto;
            }
            
            .data-table thead {
                display: table-header-group;
            }
            
            .data-table tbody tr {
                page-break-inside: avoid;
            }
            
            .map-and-table-container {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 400px;
                page-break-inside: avoid;
            }
            
            body {
                background: white;
            }
            
            .table-narrative {
                page-break-inside: avoid;
            }
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        .data-table th:focus,
        .tab-button:focus,
        .expand-btn:focus {
            outline: 3px solid var(--ncrc-secondary-blue);
            outline-offset: 2px;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .map-and-table-container {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 500px;
            }
            
            .data-table {
                font-size: 0.85rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }
            
            .toc-container {
                position: relative;
                top: 0;
                margin-bottom: 20px;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 768px) {
            .section-title {
                font-size: 1.3rem;
                padding: 12px 15px 8px 15px;
            }
            
            .data-table {
                font-size: 0.8rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
            
            .table-introduction {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            
            .table-narrative {
                padding: 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body style="background: var(--ncrc-gray-light);">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-layout">
                <div class="logo">
                    <img src="{{ url_for('static', filename='img/ncrc-invert-final@2x.png') }}" alt="NCRC Logo" style="max-height: 90px; width: auto;" onerror="this.style.display='none';">
                </div>
                <div class="header-title-section">
                    <h1><span class="app-name-part1">BIZ</span><span class="app-name-part2">SIGHT</span></h1>
                </div>
                <div class="header-tagline">
                    <p class="tagline-text"><em>Data drives the<br><span class="movement-text">movement</span></em></p>
                </div>
            </div>
        </div>
    </header>

    <div class="report-container">
        <!-- New Analysis Button at Top -->
        <div style="text-align: left; margin-bottom: 20px; padding: 10px 0;">
            <a href="/" class="action-btn" style="text-decoration: none; cursor: pointer; padding: 10px 20px; background: var(--ncrc-dark-blue); color: white; border-radius: 5px; display: inline-block; font-weight: 500;">
                <i class="fas fa-arrow-left"></i> Back to New Analysis
            </a>
        </div>
        
        <!-- Download Actions -->
        <div class="report-actions" style="text-align: right; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <a href="/download?format=pdf&job_id={{ job_id }}" class="action-btn" id="downloadPdfBtn" style="text-decoration: none; cursor: pointer; margin-right: 10px; padding: 10px 20px; background: var(--ncrc-primary-blue); color: white; border-radius: 5px; display: inline-block;">
                <i class="fas fa-file-pdf"></i> Download PDF Report
            </a>
            <div class="dropdown" style="display: inline-block; position: relative;">
                <button class="action-btn primary dropdown-toggle" style="padding: 10px 20px; background: var(--ncrc-secondary-blue); color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-download"></i> Export Data
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 200px; z-index: 1000; margin-top: 5px;">
                    <a href="/download?format=excel&job_id={{ job_id }}" class="dropdown-item" style="display: block; padding: 10px 15px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;">
                        <i class="fas fa-file-excel"></i> Excel (.xlsx)
                    </a>
                    <a href="/download?format=pdf-maps&job_id={{ job_id }}" class="dropdown-item" style="display: block; padding: 10px 15px; color: #333; text-decoration: none;">
                        <i class="fas fa-map"></i> Map PDFs (.zip)
                    </a>
                </div>
            </div>
        </div>
        
        <div class="report-header" style="text-align: center; margin-bottom: 30px; padding: 20px; background: var(--ncrc-dark-blue); color: white; border-radius: 8px;">
            <h1 style="margin: 0 0 10px 0;">Small Business Lending Analysis</h1>
            <p id="reportMetadata" style="margin: 10px 0 0 0; opacity: 0.9;">Loading report data...</p>
        </div>
        
        <div id="reportContent">
        
        <!-- Section 1: Geographic Overview and Tract-Level Analysis -->
        <div class="report-section" id="section1" style="margin-bottom: 30px;">
            <h2 class="section-title">Section 1: Geographic Overview and Tract-Level Analysis</h2>
            <div id="section1Intro" style="margin-bottom: 20px; line-height: 1.8; color: #333;">
                <p>This report provides a comprehensive analysis of small business lending activity in <span id="introCountyName">the selected county</span> for the years 2018 to 2024. The analysis is based on data collected under the Community Reinvestment Act (CRA), which requires financial institutions to report information about small business loan applications and originations.</p>
                
                <p><strong>Data Coverage:</strong> This report includes tract-level and county-level data on small business lending, including loan counts and amounts by loan size categories (under $100K, $100K-$250K, $250K-$1M), lending to businesses with revenues under $1 million, and lending in Low- and Moderate-Income (LMI) census tracts. The data also includes demographic information from the U.S. Census Bureau, including tract-level income, population, and racial/ethnic composition.</p>
                
                <p><strong>Limitations:</strong> The data in this report reflects only lending activity reported by financial institutions subject to Community Reinvestment Act (CRA) reporting requirements. It does not include lending by institutions that are exempt from reporting, nor does it include non-traditional lending sources such as online lenders, fintech companies, or alternative financing providers that may not be subject to CRA reporting requirements. Additionally, the data may not capture the full extent of small business lending activity, particularly for very small loans or loans to businesses that do not meet the reporting thresholds.</p>
                
                <p><strong>Important Note on PPP Lending:</strong> In 2020 and 2021, the Paycheck Protection Program (PPP) significantly impacted small business lending patterns. PPP loans, which were government-guaranteed and designed to help businesses maintain payroll during the COVID-19 pandemic, are included in this data and may distort year-over-year comparisons for those years. The analysis in this report compares 2018 (pre-PPP) to 2024 (post-PPP) to provide a clearer picture of underlying lending trends while avoiding the distortion caused by PPP lending in 2020-2021.</p>
            </div>
        </div>
        
        <div class="map-and-table-container">
            <!-- Map Container -->
            <div class="map-container">
                <div id="tractMap"></div>
                
                <!-- Map Controls -->
                <div class="map-controls">
                    <h4><i class="fas fa-layer-group"></i> Map Layers</h4>
                    <div class="layer-control">
                        <label>
                            <input type="radio" name="mapLayer" value="income" id="incomeLayer" checked>
                            <span>Income Classification</span>
                        </label>
                    </div>
                    <div class="layer-control">
                        <label>
                            <input type="radio" name="mapLayer" value="race" id="raceLayer">
                            <span>Race Demographics</span>
                        </label>
                    </div>
                    <div class="layer-control">
                        <label>
                            <input type="radio" name="mapLayer" value="loanCount" id="loanCountLayer">
                            <span>Number of Loans (Quartiles)</span>
                        </label>
                    </div>
                    <div class="layer-control">
                        <label>
                            <input type="radio" name="mapLayer" value="loanAmount" id="loanAmountLayer">
                            <span>Amount of Loans (Quartiles)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="legend" id="legend">
                    <h4>Legend</h4>
                    <div id="legendContent"></div>
                </div>
            </div>
            
            <!-- Summary Table -->
            <div class="summary-table-container">
                <h3><i class="fas fa-chart-bar"></i> Summary Statistics (2024)</h3>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <tr>
                            <td class="label">Total Loans</td>
                            <td class="value">-</td>
                        </tr>
                        <tr>
                            <td class="label">Total Loan Amount</td>
                            <td class="value">-</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- Treemap Charts Toggle -->
                <div style="margin-top: 15px; text-align: center; flex-shrink: 0;">
                    <div style="display: inline-flex; gap: 10px; background: #f5f5f5; padding: 5px; border-radius: 5px;">
                        <button id="treemapToggleLoans" class="treemap-toggle-btn active" onclick="switchTreemap('loans')" style="padding: 6px 12px; border: none; background: var(--ncrc-primary-blue); color: white; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                            Number of Loans
                        </button>
                        <button id="treemapToggleAmounts" class="treemap-toggle-btn" onclick="switchTreemap('amounts')" style="padding: 6px 12px; border: none; background: #ccc; color: #333; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                            Amount of Loans
                        </button>
                    </div>
                </div>
                
                <!-- Treemap Charts Container -->
                <div style="margin-top: 10px; flex: 1; min-height: 0; display: flex; flex-direction: column;">
                    <div id="treemapLoans" style="width: 100%; flex: 1; min-height: 200px;"></div>
                    <div id="treemapAmounts" style="width: 100%; flex: 1; min-height: 200px; display: none;"></div>
                </div>
            </div>
        </div>
        
        <!-- Section 2: County Summary (2018-2024) -->
        <div class="report-section print-break" id="section2" style="margin-top: 40px;">
            <h2 class="section-title">Section 2: County Summary (2018-2024)</h2>
            <p class="table-introduction" id="countySummaryIntro">
                <!-- 2 sentences will be populated by JavaScript -->
            </p>
            <div class="table-container">
                <!-- Tab Navigation -->
                <div style="display: flex; border-bottom: 2px solid var(--ncrc-primary-blue); margin-bottom: 0;">
                    <button class="tab-button active" id="tabCountySummaryNumber" onclick="switchCountySummaryTab('number')" style="flex: 1; padding: 12px 20px; background: var(--ncrc-primary-blue); color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                        Number of Loans
                    </button>
                    <button class="tab-button" id="tabCountySummaryAmount" onclick="switchCountySummaryTab('amount')" style="flex: 1; padding: 12px 20px; background: #e0e0e0; color: #333; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                        Amount of Loans
                    </button>
                </div>
                
                <!-- Number of Loans Table -->
                <div id="tableCountySummaryNumber" class="tab-content" style="display: block;">
                    <table class="data-table" id="countySummaryTableNumber" role="table" aria-label="County Summary - Number of Loans">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Variable</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2018</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2019</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2020</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2021</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2022</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2023</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2024</th>
                            </tr>
                        </thead>
                        <tbody id="countySummaryTableNumberBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Amount of Loans Table -->
                <div id="tableCountySummaryAmount" class="tab-content" style="display: none;">
                    <table class="data-table" id="countySummaryTableAmount" role="table" aria-label="County Summary - Amount of Loans">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Variable</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2018</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2019</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2020</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2021</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2022</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2023</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2024</th>
                            </tr>
                        </thead>
                        <tbody id="countySummaryTableAmountBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <p class="table-caption" id="countySummaryCaption" style="margin-top: 15px; font-size: 0.85rem; color: #666; font-style: italic;">
                    <!-- Caption will be populated by JavaScript -->
                </p>
            </div>
            <div class="table-narrative" id="countySummaryDiscussion" role="region" aria-label="County Summary Analysis">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Section 3: County, State, and National Comparison (2024) -->
        <div class="report-section print-break" id="section3" style="margin-top: 40px;">
            <h2 class="section-title">Section 3: County, State, and National Comparison (2024)</h2>
            <p class="table-introduction" id="comparisonIntro">
                <!-- Will be populated by JavaScript -->
            </p>
            <div class="table-container">
                <!-- Tab Navigation -->
                <div style="display: flex; border-bottom: 2px solid var(--ncrc-primary-blue); margin-bottom: 0;">
                    <button class="tab-button active" id="tabComparisonNumber" onclick="switchComparisonTab('number')" style="flex: 1; padding: 12px 20px; background: var(--ncrc-primary-blue); color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                        Number of Loans
                    </button>
                    <button class="tab-button" id="tabComparisonAmount" onclick="switchComparisonTab('amount')" style="flex: 1; padding: 12px 20px; background: #e0e0e0; color: #333; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                        Amount of Loans
                    </button>
                </div>
                
                <!-- Number of Loans Table -->
                <div id="tableComparisonNumber" class="tab-content" style="display: block;">
                    <table class="data-table" id="comparisonTableNumber" role="table" aria-label="Comparison - Number of Loans">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Metric</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">County (2024)</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">State (2024)</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">National (2024)</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">% Change Since 2018</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableNumberBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Amount of Loans Table -->
                <div id="tableComparisonAmount" class="tab-content" style="display: none;">
                    <table class="data-table" id="comparisonTableAmount" role="table" aria-label="Comparison - Amount of Loans">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Metric</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">County (2024)</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">State (2024)</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">National (2024)</th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">% Change Since 2018</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableAmountBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <p class="table-caption" id="comparisonCaption" style="margin-top: 15px; font-size: 0.85rem; color: #666; font-style: italic;">
                    <!-- Caption will be populated by JavaScript -->
                </p>
            </div>
            <div class="table-narrative" id="comparisonDiscussion" role="region" aria-label="Comparison Analysis">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Section 4: Top Lenders by Number of Loans (2024) -->
        <div class="report-section print-break" id="section4" style="margin-top: 40px;">
            <h2 class="section-title">Section 4: Top Lenders by Number of Loans (2024)</h2>
            <p class="table-introduction" id="topLendersIntro">
                <!-- 2 sentences will be populated by JavaScript -->
            </p>
            <div class="table-container">
                <!-- Tab Navigation -->
                <div style="display: flex; border-bottom: 2px solid var(--ncrc-primary-blue); margin-bottom: 0;">
                    <button class="tab-button active" id="tabNumber" onclick="switchTopLendersTab('number')" style="flex: 1; padding: 12px 20px; background: var(--ncrc-primary-blue); color: white; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                        Number of Loans
                    </button>
                    <button class="tab-button" id="tabAmount" onclick="switchTopLendersTab('amount')" style="flex: 1; padding: 12px 20px; background: #e0e0e0; color: #333; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                        Amount of Loans
                    </button>
                </div>
                
                <!-- Number of Loans Table -->
                <div id="tableNumber" class="tab-content" style="display: block;">
                    <div class="table-header">
                        <button class="expand-btn" id="expandTopLendersBtnNumber" onclick="expandTopLendersTable('number')" style="display: none;">
                            <i class="fas fa-chevron-down"></i> Show All Lenders
                        </button>
                    </div>
                    <table class="data-table collapsible-table" id="topLendersTableNumber" role="table" aria-label="Top Lenders - Number of Loans">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 0)" aria-label="Sort by Lender Name" tabindex="0" role="button">Lender Name <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 1)" aria-label="Sort by Num Total" tabindex="0" role="button">Num Total <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 2)">Num Under 100K (%) <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 3)">Num 100K 250K (%) <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 4)">Num 250K 1M (%) <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 5)">Numsb Under 1M (%) <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 6)">Low Income (%) <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 7)">Moderate Income (%) <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 8)">Middle Income (%) <i class="fas fa-sort"></i></th>
                                <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableNumber', 9)">Upper Income (%) <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody id="topLendersTableBodyNumber">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Amount of Loans Table -->
                <div id="tableAmount" class="tab-content" style="display: none;">
                    <div class="table-header">
                        <button class="expand-btn" id="expandTopLendersBtnAmount" onclick="expandTopLendersTable('amount')" style="display: none;">
                            <i class="fas fa-chevron-down"></i> Show All Lenders
                        </button>
                    </div>
                    <table class="data-table collapsible-table" id="topLendersTableAmount" role="table" aria-label="Top Lenders - Amount of Loans">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 0)" aria-label="Sort by Lender Name" tabindex="0" role="button">Lender Name <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 1)">Amt Total (in $000s) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 2)">Amt Under 100K (%) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 3)">Amt 100K 250K (%) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 4)">Amt 250K 1M (%) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 5)">Amtsb Under 1M (%) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 6)">Low Income (%) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 7)">Moderate Income (%) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 8)">Middle Income (%) <i class="fas fa-sort"></i></th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white; cursor: pointer;" onclick="sortTable('topLendersTableAmount', 9)">Upper Income (%) <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                        <tbody id="topLendersTableBodyAmount">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <p class="table-caption" id="topLendersCaption" style="margin-top: 15px; font-size: 0.85rem; color: #666; font-style: italic;">
                    <!-- Caption will be populated by JavaScript -->
                </p>
            </div>
            <div class="table-narrative" id="topLendersDiscussion" role="region" aria-label="Top Lenders Analysis">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Section 5: Market Concentration Trends (HHI by Year) -->
        <div class="report-section print-break" id="section5" style="margin-top: 40px;">
            <h2 class="section-title">Section 5: Market Concentration Trends (2018-2024)</h2>
            <p class="table-introduction" id="hhiTrendsIntro" style="margin-bottom: 20px;">
                This chart shows the Herfindahl-Hirschman Index (HHI) for small business lending in the county from 2018 to 2024. The HHI is calculated using the total dollar amount of loans by all lenders in each year, measuring market concentration on a scale from 0 to 10,000. Higher values indicate greater market concentration, while lower values suggest a more competitive market.
            </p>
            <div class="table-container" style="margin-bottom: 20px;">
                <div id="hhiByYearChart" style="width: 100%; height: 400px; margin: 20px 0;">
                    <!-- HHI by year chart will be populated by JavaScript -->
                </div>
            </div>
            <div class="table-narrative" id="hhiTrendsDiscussion" role="region" aria-label="Market Concentration Trends Analysis">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Section 6: Methods, Definitions, and AI Disclosure -->
        <div class="report-section print-break" id="section6" style="margin-top: 40px;">
            <h2 class="section-title">Section 6: Methods, Definitions, and AI Disclosure</h2>
            <div id="methodsContent" style="line-height: 1.8;">
                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Data Sources</h3>
                <p>This report uses data from HMDA Section 1071 Small Business Lending data, which requires financial institutions to report information about small business loan applications and originations. The data used in this report is sourced from NCRC's curated small business lending databases, compiled and maintained by NCRC Research staff. Data is queried from NCRC datasets for the years specified in the analysis.</p>
                
                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Definitions</h3>
                <ul style="padding-left: 20px;">
                    <li><strong>LMI Tract:</strong> Low-to-Moderate Income Census Tract - areas where median income is below 80% of the area median income (AMI).</li>
                    <li><strong>Num Total:</strong> Total number of small business loans.</li>
                    <li><strong>Num Under 100K:</strong> Number of loans under $100,000.</li>
                    <li><strong>Num 100K 250K:</strong> Number of loans between $100,000 and $250,000.</li>
                    <li><strong>Num 250K 1M:</strong> Number of loans between $250,000 and $1,000,000.</li>
                    <li><strong>Numsb Under 1M:</strong> Number of loans to businesses with revenue under $1 million.</li>
                    <li><strong>Amt Total:</strong> Total amount of small business loans (in thousands of dollars).</li>
                    <li><strong>Quartiles:</strong> Data divided into four equal groups (Q1 = lowest 25%, Q2 = 25-50%, Q3 = 50-75%, Q4 = highest 25%).</li>
                </ul>
                
                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Market Concentration (HHI)</h3>
                <p><strong>Herfindahl-Hirschman Index (HHI):</strong> Market concentration is measured using the HHI, calculated as the sum of squared market shares of all lenders in the county based on the dollar amount of small business loans in 2024. Market shares are expressed as percentages, and the HHI scale ranges from 0 to 10,000:</p>
                <ul style="padding-left: 20px;">
                    <li>HHI &lt; 1,500: Low concentration (competitive market)</li>
                    <li>HHI 1,500-2,500: Moderate concentration</li>
                    <li>HHI &gt; 2,500: High concentration</li>
                </ul>
                <p>The HHI calculation uses loan amount data from all lenders that reported small business lending data in 2024, not just the lenders shown in the report tables.</p>
                
                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">AI-Generated Content Disclosure</h3>
                <p>This report includes AI-generated narrative analysis of small business lending data. The AI-generated content provides contextual analysis and interpretation of the data patterns shown in the tables and maps. All data and statistics are sourced from the databases described above. The AI-generated narratives are intended to help readers understand the data and identify trends, but should be read in conjunction with the underlying data tables.</p>
                <p><strong>AI Model:</strong> The narratives in this report were generated using Claude AI (Anthropic) and/or OpenAI GPT models. The AI was provided with the data tables and instructed to write in plain English, avoid jargon, and focus on trends and patterns rather than specific numbers.</p>
                <p><strong>Human Review:</strong> While AI-generated content has been reviewed for accuracy and appropriateness, users should verify any specific claims against the underlying data tables.</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        let map;
        let tractLayer;
        let incomeLayer;
        let raceLayer;
        let tractData = [];
        
        // Get job_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job_id');
        
        // Initialize dropdown functionality
        function initializeDropdowns() {
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            
            if (dropdownToggle && dropdownMenu) {
                dropdownToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isVisible = dropdownMenu.style.display === 'block';
                    dropdownMenu.style.display = isVisible ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                        dropdownMenu.style.display = 'none';
                    }
                });
            }
        }
        
        // Update download links with job_id
        function updateDownloadLinks() {
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job_id');
            
            if (jobId) {
                // Update PDF download link
                const pdfBtn = document.getElementById('downloadPdfBtn');
                if (pdfBtn) {
                    pdfBtn.href = `/download?format=pdf&job_id=${jobId}`;
                }
                
                // Update dropdown download links
                const downloadLinks = document.querySelectorAll('.dropdown-item[href^="/download"]');
                downloadLinks.forEach(link => {
                    const currentHref = link.getAttribute('href');
                    const url = new URL(currentHref, window.location.origin);
                    url.searchParams.set('job_id', jobId);
                    link.href = url.toString();
                });
            }
        }
        
        function loadReportData(jobId, retryCount = 0) {
            const maxRetries = 10;
            const retryDelay = 1000; // 1 second
            
            // Add cache-busting timestamp to force fresh data
            const cacheBuster = new Date().getTime();
            fetch(`/report-data?job_id=${jobId}&_t=${cacheBuster}`)
                .then(r => {
                    if (r.status === 202) {
                        // Analysis still in progress, retry
                        if (retryCount < maxRetries) {
                            console.log(`Analysis still in progress, retrying in ${retryDelay}ms... (attempt ${retryCount + 1}/${maxRetries})`);
                            setTimeout(() => loadReportData(jobId, retryCount + 1), retryDelay);
                            return null;
                        } else {
                            throw new Error('Analysis is taking longer than expected. Please refresh the page.');
                        }
                    }
                    return r.json();
                })
                .then(data => {
                    if (!data) return; // Retry in progress
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load report data');
                    }
                    
                    // Update metadata
                    const metadata = data.metadata;
                    document.getElementById('reportMetadata').textContent = 
                        `${metadata.county_name}  Years: ${metadata.year_range}`;
                    
                    // Update summary table
                    updateSummaryTable(data.summary_table);
                    
                    // Load tract data for map
                    tractData = data.tract_data_for_map || [];
                    console.log('Loaded tract data:', tractData.length, 'tracts');
                    
                    // Initialize map
                    initializeMap(metadata);
                    
                    // Fetch tract boundaries and create layers
                    const geoid5 = metadata.geoid5;
                    if (geoid5) {
                        fetchTractBoundaries(geoid5);
                    } else {
                        console.error('No geoid5 in metadata, cannot fetch tract boundaries');
                    }
                    
                    // Debug: Log data to console
                    console.log('Report data received:', {
                        county_summary_table: data.county_summary_table,
                        top_lenders_table: data.top_lenders_table,
                        tract_data_for_map: data.tract_data_for_map,
                        summary_table: data.summary_table
                    });
                    
                    // Populate county summary table (Section 2)
                    if (data.county_summary_table && data.county_summary_table.length > 0) {
                        console.log('Populating county summary table with', data.county_summary_table.length, 'rows');
                        populateCountySummaryTable(data.county_summary_table, metadata);
                    } else {
                        console.warn('No county_summary_table data found');
                    }
                    
                    // Populate comparison table (Section 3)
                    if (data.comparison_table && data.comparison_table.length > 0) {
                        console.log('Populating comparison table with', data.comparison_table.length, 'rows');
                        console.log('Comparison table data sample:', data.comparison_table[0]);
                        populateComparisonTable(data.comparison_table, metadata);
                    } else {
                        console.warn('No comparison_table data found');
                        console.warn('Available data keys:', Object.keys(data));
                        // Show error message in the table
                        const tbody = document.getElementById('comparisonTableBody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Comparison data not available. Please check that state and national benchmarks are loaded.</td></tr>';
                        }
                    }
                    
                    // Populate top lenders table (Section 4)
                    if (data.top_lenders_table && data.top_lenders_table.length > 0) {
                        console.log('Populating top lenders table with', data.top_lenders_table.length, 'rows');
                        populateTopLendersTable(data.top_lenders_table, metadata);
                        // Table is already sorted by backend (descending by total loans)
                    } else {
                        console.warn('No top_lenders_table data found');
                        console.warn('Available data keys:', Object.keys(data));
                        // Show error message in the table
                        const tbody = document.getElementById('topLendersTableBody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 20px; color: #999;">Top lenders data not available. Please check that disclosure data is loaded.</td></tr>';
                        }
                    }
                    
                    // Populate HHI by year chart (Section 5)
                    if (data.hhi_by_year && data.hhi_by_year.length > 0) {
                        console.log('Populating HHI by year chart with', data.hhi_by_year.length, 'years');
                        populateHHIByYearChart(data.hhi_by_year, metadata);
                    } else {
                        console.warn('No hhi_by_year data found');
                        const chartContainer = document.getElementById('hhiByYearChart');
                        if (chartContainer) {
                            chartContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">HHI trend data not available.</p>';
                        }
                    }
                    
                    // Populate AI narratives
                    if (data.ai_insights) {
                        populateAINarratives(data.ai_insights, metadata);
                    }
                    
                    // Populate Section 1 intro county name
                    const introCountyName = document.getElementById('introCountyName');
                    if (introCountyName && metadata) {
                        introCountyName.textContent = metadata.county_name || 'the selected county';
                    }
                })
                .catch(error => {
                    console.error('Error loading report data:', error);
                    const errorMsg = error.message || 'Unknown error';
                    document.getElementById('reportMetadata').textContent = 'Error: ' + errorMsg;
                    
                    // If it's a 404 and we haven't retried much, try again
                    if (retryCount < 3 && errorMsg.includes('No analysis data found')) {
                        console.log('Retrying after delay...');
                        setTimeout(() => loadReportData(jobId, retryCount + 1), 2000);
                    }
                });
        }
        
        function initializeMap(metadata) {
            // Initialize map with default center - will be adjusted when tract boundaries load
            const defaultCenter = [39.7392, -75.5394]; // Default center (will be updated)
            
            map = L.map('tractMap').setView(defaultCenter, 11);
            
            // Add base tile layer - use CartoDB Positron for simpler, cleaner basemap
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: ' OpenStreetMap contributors,  CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Store metadata for use in layer styling
            window.mapMetadata = metadata;
        }
        
        function fetchTractBoundaries(geoid5) {
            console.log('[DEBUG] Fetching tract boundaries for GEOID5:', geoid5);
            
            fetch(`/api/tract-boundaries/${geoid5}`)
                .then(r => {
                    console.log('[DEBUG] Tract boundaries API response status:', r.status);
                    if (!r.ok) {
                        return r.json().then(err => {
                            throw new Error(err.error || `HTTP ${r.status}: ${r.statusText}`);
                        });
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('[DEBUG] Tract boundaries API response:', data);
                    
                    if (!data.success || !data.geojson) {
                        throw new Error(data.error || 'Failed to fetch tract boundaries');
                    }
                    
                    if (!data.geojson.features || data.geojson.features.length === 0) {
                        console.warn('[WARN] No tract features in GeoJSON');
                        createMapLayers(null);
                        return;
                    }
                    
                    console.log('[DEBUG] Tract boundaries fetched:', data.geojson.features.length, 'tracts');
                    console.log('[DEBUG] Sample tract GEOID:', data.geojson.features[0]?.properties?.GEOID);
                    
                    // Calculate county center from tract boundaries
                    let bounds = L.geoJSON(data.geojson).getBounds();
                    if (bounds.isValid()) {
                        const center = bounds.getCenter();
                        map.setView([center.lat, center.lng], 11);
                        console.log('[DEBUG] Map centered on county:', center.lat, center.lng);
                    }
                    
                    // Merge tract data with boundaries
                    const enrichedGeoJSON = enrichGeoJSONWithTractData(data.geojson);
                    console.log('[DEBUG] Enriched GeoJSON, sample tract data:', enrichedGeoJSON.features[0]?.properties);
                    
                    // Create layers with the actual boundaries
                    createMapLayers(enrichedGeoJSON);
                })
                .catch(error => {
                    console.error('[ERROR] Error fetching tract boundaries:', error);
                    console.error('[ERROR] Error stack:', error.stack);
                    // Still create empty layers so the UI doesn't break
                    createMapLayers(null);
                });
        }
        
        function enrichGeoJSONWithTractData(geojson) {
            console.log('[DEBUG] Enriching GeoJSON with tract data. Tract data count:', tractData.length);
            let matchedCount = 0;
            
            // Add tract data properties to each feature
            geojson.features.forEach((feature, idx) => {
                const geoid = feature.properties.GEOID;
                
                if (!geoid) {
                    console.warn(`[WARN] Feature ${idx} has no GEOID`);
                    return;
                }
                
                // Try to match by full GEOID or just the tract portion
                const tract = tractData.find(t => {
                    const tractGeoid = t.tract_geoid || t.census_tract_geoid;
                    if (!tractGeoid) return false;
                    
                    // Convert both to strings for comparison
                    const geoidStr = String(geoid);
                    const tractGeoidStr = String(tractGeoid);
                    
                    // Match by full GEOID (11 digits) or last 6 digits (tract portion)
                    return tractGeoidStr === geoidStr || tractGeoidStr.endsWith(geoidStr.slice(-6));
                });
                
                if (tract) {
                    // Add all tract data to feature properties
                    Object.assign(feature.properties, tract);
                    matchedCount++;
                } else if (idx < 5) {
                    // Log first few unmatched for debugging
                    console.log(`[DEBUG] No match for GEOID ${geoid}. Sample tract GEOIDs:`, 
                        tractData.slice(0, 3).map(t => t.tract_geoid || t.census_tract_geoid));
                }
            });
            
            console.log(`[DEBUG] Matched ${matchedCount} of ${geojson.features.length} tracts with data`);
            return geojson;
        }
        
        // Helper function to create identical popup for all layers
        function createTractPopup(tract) {
            if (!tract || tract.loan_count === undefined) return null;
            
            const popupId = 'popup-' + (tract.GEOID || tract.tract_geoid || Math.random().toString(36).substr(2, 9));
            
            // Calculate summary statistics
            const totalLoans = tract.loan_count || 0;
            const totalAmount = tract.loan_amount || 0;
            const avgAmountPerLoan = totalLoans > 0 ? (totalAmount / totalLoans) : 0;
            
            // Format amounts
            const formatAmount = (amt) => {
                if (amt >= 1000000) {
                    return '$' + (amt / 1000000).toFixed(1) + 'M';
                } else if (amt >= 1000) {
                    return '$' + (amt / 1000).toFixed(0) + 'K';
                } else {
                    return '$' + amt.toFixed(0);
                }
            };
            
            // Get year amounts for trend calculation
            let yearAmountsData = {};
            if (tract.year_amounts) {
                if (typeof tract.year_amounts === 'string') {
                    try {
                        yearAmountsData = JSON.parse(tract.year_amounts);
                    } catch (e) {
                        yearAmountsData = {};
                    }
                } else if (typeof tract.year_amounts === 'object') {
                    yearAmountsData = tract.year_amounts;
                }
            }
            
            const amounts2018 = (yearAmountsData['2018'] || 0) * 1000;
            const amounts2024 = (yearAmountsData['2024'] || 0) * 1000;
            const trend = amounts2018 > 0 ? ((amounts2024 - amounts2018) / amounts2018 * 100) : 0;
            const trendText = trend > 0 ? `+${trend.toFixed(0)}%` : `${trend.toFixed(0)}%`;
            const trendColor = trend > 0 ? '#28a745' : trend < 0 ? '#dc3545' : '#6c757d';
            
            const popupContent = `
                <div style="min-width: 320px; font-family: Arial, sans-serif;">
                    <div style="border-bottom: 2px solid #2fade3; padding-bottom: 8px; margin-bottom: 12px;">
                        <strong style="font-size: 14px; color: #333;">Tract ${tract.GEOID || tract.tract_geoid}</strong>
                    </div>
                    
                    <div style="margin-bottom: 12px; font-size: 12px; line-height: 1.6;">
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Income Category:</span> 
                            <span style="color: #333;">${tract.income_category || 'Unknown'}</span>
                        </div>
                        ${tract.tract_population ? `
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Population:</span> 
                            <span style="color: #333;">${parseInt(tract.tract_population).toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Total Loans (2018-2024):</span> 
                            <span style="color: #333;">${totalLoans.toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Total Amount:</span> 
                            <span style="color: #333;">${formatAmount(totalAmount * 1000)}</span>
                        </div>
                        ${avgAmountPerLoan > 0 ? `
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Avg per Loan:</span> 
                            <span style="color: #333;">${formatAmount(avgAmountPerLoan * 1000)}</span>
                        </div>
                        ` : ''}
                        ${amounts2018 > 0 ? `
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Change (20182024):</span> 
                            <span style="color: ${trendColor}; font-weight: 600;">${trendText}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 12px; margin-bottom: 8px;">
                        <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 4px;">Loan Amount by Year</div>
                        <div style="font-size: 10px; color: #999; font-style: italic;">Note: 2020-2021 include PPP loans</div>
                    </div>
                    <div id="${popupId}-chart" style="width: 100%; min-width: 300px; height: 280px; margin-top: 8px;"></div>
                </div>
            `;
            
            return {
                content: popupContent,
                popupId: popupId + '-chart',
                tract: tract
            };
        }
        
        function createMapLayers(geojson) {
            console.log('[DEBUG] Creating map layers. GeoJSON:', geojson ? `${geojson.features?.length} features` : 'null');
            
            if (!geojson || !geojson.features || geojson.features.length === 0) {
                console.warn('[WARN] No GeoJSON data, creating empty layers');
                // Create empty layers
                incomeLayer = L.geoJSON([]);
                raceLayer = L.geoJSON([]);
                loanCountLayer = L.geoJSON([]);
                loanAmountLayer = L.geoJSON([]);
            } else {
                // Calculate mean and standard deviation of minority population for the entire county
                const minorityValues = [];
                geojson.features.forEach(feature => {
                    const tract = feature.properties;
                    if (tract && tract.tract_minority_population_percent !== undefined && 
                        tract.tract_minority_population_percent !== null) {
                        minorityValues.push(parseFloat(tract.tract_minority_population_percent));
                    }
                });
                
                let minorityMean = 0;
                let minorityStdDev = 0;
                if (minorityValues.length > 0) {
                    // Calculate mean
                    minorityMean = minorityValues.reduce((sum, val) => sum + val, 0) / minorityValues.length;
                    
                    // Calculate standard deviation
                    const variance = minorityValues.reduce((sum, val) => sum + Math.pow(val - minorityMean, 2), 0) / minorityValues.length;
                    minorityStdDev = Math.sqrt(variance);
                }
                
                console.log(`[DEBUG] Minority population stats: mean=${minorityMean.toFixed(2)}, stdDev=${minorityStdDev.toFixed(2)}`);
                
                // Define category thresholds based on standard deviation
                const lowThreshold = minorityMean - minorityStdDev;
                const moderateThreshold = minorityMean;
                const middleThreshold = minorityMean + minorityStdDev;
                
                console.log(`[DEBUG] Minority thresholds: Low<${lowThreshold.toFixed(2)}, Moderate=${moderateThreshold.toFixed(2)}, Middle=${middleThreshold.toFixed(2)}, Upper>${middleThreshold.toFixed(2)}`);
                // Create income layer
                incomeLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || !tract.tract_to_msa_income_percentage) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const incomePct = tract.tract_to_msa_income_percentage;
                    let color = '#90EE90'; // Default green
                    
                    if (incomePct <= 50) {
                        color = '#FF6B6B'; // Red - Low Income
                    } else if (incomePct <= 80) {
                        color = '#FFD93D'; // Yellow - Moderate Income
                    } else if (incomePct <= 120) {
                        color = '#6BCF7F'; // Light Green - Middle Income
                    } else {
                        color = '#4ECDC4'; // Teal - Upper Income
                    }
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Create race layer with standard deviation categories
            raceLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || tract.tract_minority_population_percent === undefined) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const minorityPct = parseFloat(tract.tract_minority_population_percent || 0);
                    let color = '#E0E0E0'; // Default gray
                    
                    // Categorize based on standard deviation thresholds
                    if (minorityPct < lowThreshold) {
                        color = '#FADBD8'; // Light red - Low minority
                    } else if (minorityPct < moderateThreshold) {
                        color = '#F1948A'; // Medium red - Moderate minority
                    } else if (minorityPct < middleThreshold) {
                        color = '#EC7063'; // Darker red - Middle minority
                    } else {
                        color = '#C0392B'; // Darkest red - Upper minority
                    }
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Create loan count quartile layer
            loanCountLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || tract.loan_count === undefined) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const quartile = tract.loan_count_quartile || 'Q1';
                    let color = '#E8F4F8'; // Q1 - Light blue
                    if (quartile === 'Q2') color = '#AED6F1'; // Q2 - Medium blue
                    else if (quartile === 'Q3') color = '#5DADE2'; // Q3 - Darker blue
                    else if (quartile === 'Q4') color = '#2874A6'; // Q4 - Darkest blue
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Create loan amount quartile layer
            loanAmountLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || tract.loan_amount === undefined) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const quartile = tract.loan_amount_quartile || 'Q1';
                    let color = '#FADBD8'; // Q1 - Light red
                    if (quartile === 'Q2') color = '#F1948A'; // Q2 - Medium red
                    else if (quartile === 'Q3') color = '#EC7063'; // Q3 - Darker red
                    else if (quartile === 'Q4') color = '#C0392B'; // Q4 - Darkest red
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Layer controls (radio buttons - only one active at a time)
            document.querySelectorAll('input[name="mapLayer"]').forEach(radio => {
                radio.addEventListener('change', function(e) {
                    // Remove all layers
                    map.eachLayer(function(layer) {
                        if (layer !== map._layers[Object.keys(map._layers)[0]]) { // Keep base layer
                            map.removeLayer(layer);
                        }
                    });
                    
                    // Add selected layer
                    if (e.target.value === 'income') {
                        incomeLayer.addTo(map);
                        updateLegend('income');
                    } else if (e.target.value === 'race') {
                        raceLayer.addTo(map);
                        updateLegend('race');
                    } else if (e.target.value === 'loanCount') {
                        loanCountLayer.addTo(map);
                        updateLegend('loanCount');
                    } else if (e.target.value === 'loanAmount') {
                        loanAmountLayer.addTo(map);
                        updateLegend('loanAmount');
                    }
                });
            });
            
            // Show income layer by default
            const incomeRadio = document.getElementById('incomeLayer');
            if (incomeRadio && incomeRadio.checked && geojson && geojson.features && geojson.features.length > 0) {
                if (incomeLayer) {
                    incomeLayer.addTo(map);
                    updateLegend('income');
                    console.log('[DEBUG] Income layer added to map');
                }
            }
            
            console.log('[DEBUG] Map layers created successfully');
            } // Close else block
        }
        
        let loanCountLayer;
        let loanAmountLayer;
        
        function updateLegend(type) {
            const legendContent = document.getElementById('legendContent');
            
            if (type === 'income') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>Low Income (50% AMI)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFD93D;"></div>
                        <span>Moderate Income (50-80% AMI)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #6BCF7F;"></div>
                        <span>Middle Income (80-120% AMI)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ECDC4;"></div>
                        <span>Upper Income (>120% AMI)</span>
                    </div>
                `;
            } else if (type === 'race') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FADBD8;"></div>
                        <span>Low Minority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #F1948A;"></div>
                        <span>Moderate Minority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #EC7063;"></div>
                        <span>Middle Minority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #C0392B;"></div>
                        <span>Upper Minority</span>
                    </div>
                `;
            } else if (type === 'loanCount') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #E8F4F8;"></div>
                        <span>Q1 (Lowest 25%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #AED6F1;"></div>
                        <span>Q2 (25-50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #5DADE2;"></div>
                        <span>Q3 (50-75%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2874A6;"></div>
                        <span>Q4 (Highest 25%)</span>
                    </div>
                `;
            } else if (type === 'loanAmount') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FADBD8;"></div>
                        <span>Q1 (Lowest 25%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #F1948A;"></div>
                        <span>Q2 (25-50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #EC7063;"></div>
                        <span>Q3 (50-75%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #C0392B;"></div>
                        <span>Q4 (Highest 25%)</span>
                    </div>
                `;
            }
        }
        
        function switchCountySummaryTab(tab) {
            const numberTab = document.getElementById('tabCountySummaryNumber');
            const amountTab = document.getElementById('tabCountySummaryAmount');
            const numberTable = document.getElementById('tableCountySummaryNumber');
            const amountTable = document.getElementById('tableCountySummaryAmount');
            
            if (tab === 'number') {
                numberTab.style.background = 'var(--ncrc-primary-blue)';
                numberTab.style.color = 'white';
                amountTab.style.background = '#e0e0e0';
                amountTab.style.color = '#333';
                numberTable.style.display = 'block';
                amountTable.style.display = 'none';
            } else {
                numberTab.style.background = '#e0e0e0';
                numberTab.style.color = '#333';
                amountTab.style.background = 'var(--ncrc-primary-blue)';
                amountTab.style.color = 'white';
                numberTable.style.display = 'none';
                amountTable.style.display = 'block';
            }
        }
        
        function populateCountySummaryTable(data, metadata) {
            if (!data || data.length === 0) return;
            
            const tbodyNumber = document.getElementById('countySummaryTableNumberBody');
            const tbodyAmount = document.getElementById('countySummaryTableAmountBody');
            if (!tbodyNumber || !tbodyAmount) return;
            
            // Data is now a DataFrame-like structure with Variable column and year columns
            const years = ['2018', '2019', '2020', '2021', '2022', '2023', '2024'];
            
            // Format value based on variable name
            function formatValue(varName, value) {
                if (value === null || value === undefined || isNaN(value)) return '-';
                
                // Check for percentage indicators FIRST (before other checks)
                if (varName.includes('%') || varName.includes('(% of Total)')) {
                    // Percentage format
                    return parseFloat(value).toFixed(2) + '%';
                } else if (varName === 'Total Loans') {
                    // Integer format for total loans only
                    return parseInt(value).toLocaleString();
                } else if (varName.includes('Total Loan Amount')) {
                    // Dollar format (in millions with 1 decimal place and commas)
                    const amount = parseFloat(value);
                    // Amount is in thousands, convert to millions
                    const millions = amount / 1000;
                    // Format to 1 decimal place with commas for readability
                    if (millions === 0) return '$0.0';
                    const millionsFormatted = millions.toLocaleString('en-US', {
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 1
                    });
                    return '$' + millionsFormatted;
                } else if (varName.includes('Amount') && !varName.includes('%')) {
                    // Other amount fields (in thousands)
                    const amount = parseFloat(value);
                    if (amount >= 1000) {
                        const thousands = amount / 1000;
                        const thousandsFormatted = thousands.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                        return '$' + thousandsFormatted + 'K';
                    } else {
                        return '$' + amount.toLocaleString('en-US', {maximumFractionDigits: 0});
                    }
                } else {
                    // Default: format as number
                    return parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 2});
                }
            }
            
            // Separate data into number and amount rows
            const numberRows = [];
            const amountRows = [];
            
            data.forEach(row => {
                const varName = row['Variable'] || row['variable'] || '';
                // Check if this is a loan count row or amount row
                if (varName.includes('Total Loans') || 
                    (varName.includes('Loans') && !varName.includes('Amount'))) {
                    numberRows.push(row);
                } else if (varName.includes('Amount') || varName.includes('Total Loan Amount')) {
                    amountRows.push(row);
                }
            });
            
            // Build number table rows
            let numberRowsHtml = '';
            numberRows.forEach(row => {
                const varName = row['Variable'] || row['variable'] || '';
                numberRowsHtml += '<tr>';
                numberRowsHtml += `<td style="text-align: left; padding: 12px 10px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">${varName}</td>`;
                
                years.forEach(year => {
                    const value = row[year] !== undefined ? row[year] : (row[year.toLowerCase()] !== undefined ? row[year.toLowerCase()] : null);
                    const formatted = formatValue(varName, value);
                    numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatted}</td>`;
                });
                
                numberRowsHtml += '</tr>';
            });
            
            // Build amount table rows
            let amountRowsHtml = '';
            amountRows.forEach(row => {
                const varName = row['Variable'] || row['variable'] || '';
                amountRowsHtml += '<tr>';
                amountRowsHtml += `<td style="text-align: left; padding: 12px 10px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">${varName}</td>`;
                
                years.forEach(year => {
                    const value = row[year] !== undefined ? row[year] : (row[year.toLowerCase()] !== undefined ? row[year.toLowerCase()] : null);
                    const formatted = formatValue(varName, value);
                    amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatted}</td>`;
                });
                
                amountRowsHtml += '</tr>';
            });
            
            tbodyNumber.innerHTML = numberRowsHtml;
            tbodyAmount.innerHTML = amountRowsHtml;
            
            // Populate table introduction (2 sentences)
            const intro = document.getElementById('countySummaryIntro');
            if (intro && metadata) {
                const yearRange = metadata.year_range || '2018-2024';
                intro.textContent = `This table shows aggregate small business lending data for ${metadata.county_name} across the entire study period (${yearRange}). The data includes total loan counts and amounts by size category, lending to low-to-moderate income tracts, and loans to businesses with revenue under $1 million.`;
            }
            
            // Populate caption
            const caption = document.getElementById('countySummaryCaption');
            if (caption && metadata) {
                let captionText = '<strong>Source:</strong> Community Reinvestment Act (CRA) Small Business Lending data, compiled and maintained in NCRC\'s curated databases. ';
                captionText += `<strong>Years:</strong> ${metadata.year_range || '2018-2024'}. `;
                captionText += `<strong>County:</strong> ${metadata.county_name || 'Unknown'}. `;
                captionText += '<strong>Note:</strong> Data for 2020 and 2021 are distorted by the Paycheck Protection Program (PPP) lending activity.';
                caption.innerHTML = captionText;
            }
        }
        
        function switchComparisonTab(tab) {
            const numberTab = document.getElementById('tabComparisonNumber');
            const amountTab = document.getElementById('tabComparisonAmount');
            const numberTable = document.getElementById('tableComparisonNumber');
            const amountTable = document.getElementById('tableComparisonAmount');
            
            if (tab === 'number') {
                numberTab.style.background = 'var(--ncrc-primary-blue)';
                numberTab.style.color = 'white';
                amountTab.style.background = '#e0e0e0';
                amountTab.style.color = '#333';
                numberTable.style.display = 'block';
                amountTable.style.display = 'none';
            } else {
                numberTab.style.background = '#e0e0e0';
                numberTab.style.color = '#333';
                amountTab.style.background = 'var(--ncrc-primary-blue)';
                amountTab.style.color = 'white';
                numberTable.style.display = 'none';
                amountTable.style.display = 'block';
            }
        }
        
        function populateComparisonTable(data, metadata) {
            if (!data || data.length === 0) {
                console.warn('populateComparisonTable: No data provided');
                return;
            }
            
            const tbodyNumber = document.getElementById('comparisonTableNumberBody');
            const tbodyAmount = document.getElementById('comparisonTableAmountBody');
            if (!tbodyNumber || !tbodyAmount) {
                console.error('populateComparisonTable: comparison table body elements not found');
                return;
            }
            
            console.log('populateComparisonTable: Processing', data.length, 'rows');
            
            // Separate data into number and amount rows
            const numberRows = [];
            const amountRows = [];
            
            data.forEach(row => {
                const metric = row['Metric'] || row['metric'] || '';
                if (metric.includes('Amount') || metric.includes('Total Loan Amount')) {
                    amountRows.push(row);
                } else {
                    numberRows.push(row);
                }
            });
            
            // Format value based on metric type
            function formatComparisonValue(metric, value, column) {
                if (value === null || value === undefined || isNaN(value)) {
                    return column === '% Change Since 2018' ? '-' : '-';
                }
                
                // Check metric type
                if (metric.includes('%') || metric.includes('(% of Total)')) {
                    // Percentage format
                    return parseFloat(value).toFixed(2) + '%';
                } else if (metric === 'Total Loans') {
                    // Integer format
                    return parseInt(value).toLocaleString();
                } else if (metric.includes('Total Loan Amount')) {
                    // Dollar format - amounts are in thousands, so multiply by 1000 to get actual amount
                    const amount = parseFloat(value) * 1000;  // Convert from thousands to actual
                    if (amount >= 1000000) {
                        const millions = amount / 1000000;
                        // Format millions with commas for readability (e.g., 21,087.9M instead of 21087.9M)
                        const millionsFormatted = millions.toLocaleString('en-US', {
                            minimumFractionDigits: 1,
                            maximumFractionDigits: 1
                        });
                        return '$' + millionsFormatted + 'M';
                    } else if (amount >= 1000) {
                        const thousands = amount / 1000;
                        return '$' + thousands.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }) + 'K';
                    } else {
                        return '$' + amount.toLocaleString('en-US', {maximumFractionDigits: 0});
                    }
                } else if (column === '% Change Since 2018') {
                    // Percentage change format
                    if (value === null || value === undefined || isNaN(value)) {
                        return '-';
                    }
                    return (value >= 0 ? '+' : '') + parseFloat(value).toFixed(1) + '%';
                } else {
                    // Default: format as number
                    return parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 2});
                }
            }
            
            // Build number table rows
            let numberRowsHtml = '';
            numberRows.forEach(row => {
                const metric = row['Metric'] || row['metric'] || '';
                numberRowsHtml += '<tr>';
                numberRowsHtml += `<td style="text-align: left; padding: 8px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">${metric}</td>`;
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['County (2024)'], 'County (2024)')}</td>`;
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['State (2024)'], 'State (2024)')}</td>`;
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['National (2024)'], 'National (2024)')}</td>`;
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['% Change Since 2018'], '% Change Since 2018')}</td>`;
                numberRowsHtml += '</tr>';
            });
            
            // Build amount table rows
            let amountRowsHtml = '';
            amountRows.forEach(row => {
                const metric = row['Metric'] || row['metric'] || '';
                amountRowsHtml += '<tr>';
                amountRowsHtml += `<td style="text-align: left; padding: 8px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">${metric}</td>`;
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['County (2024)'], 'County (2024)')}</td>`;
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['State (2024)'], 'State (2024)')}</td>`;
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['National (2024)'], 'National (2024)')}</td>`;
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['% Change Since 2018'], '% Change Since 2018')}</td>`;
                amountRowsHtml += '</tr>';
            });
            
            tbodyNumber.innerHTML = numberRowsHtml;
            tbodyAmount.innerHTML = amountRowsHtml;
            
            // Populate table introduction
            const intro = document.getElementById('comparisonIntro');
            if (intro && metadata) {
                intro.textContent = `This table compares ${metadata.county_name}'s 2024 small business lending data with state and national benchmarks. The final column shows the percentage change for each geography since 2018 (pre-PPP to post-PPP), allowing for a comparison of trends across different levels of aggregation.`;
            }
            
            // Populate caption
            const caption = document.getElementById('comparisonCaption');
            if (caption && metadata) {
                let captionText = '<strong>Source:</strong> Community Reinvestment Act (CRA) Small Business Lending data, compiled and maintained in NCRC\'s curated databases. ';
                captionText += '<strong>Year:</strong> 2024. ';
                captionText += `<strong>County:</strong> ${metadata.county_name || 'Unknown'}. `;
                captionText += `<strong>State:</strong> ${metadata.state_name || 'Unknown'}. `;
                captionText += '<strong>% Change:</strong> For absolute values (loans/dollars), calculated as ((2024 value - 2018 value) / 2018 value)  100. For percentage metrics, calculated as the percentage change in the underlying absolute values (dollars or loans), not the change in percentage shares. Compares pre-PPP (2018) to post-PPP (2024) periods, excluding PPP lending data from 2020-2021.';
                caption.innerHTML = captionText;
            }
        }
        
        function populateAINarratives(aiInsights, metadata) {
            // County Summary Discussion (Section 2)
            if (aiInsights.county_summary_discussion) {
                const discussionEl = document.getElementById('countySummaryDiscussion');
                if (discussionEl) {
                    // Format markdown-like content with proper paragraph breaks
                    // Split by double newlines, single newlines, or periods followed by space and capital letter
                    let text = aiInsights.county_summary_discussion.trim();
                    // First split by double newlines
                    let paragraphs = text.split(/\n\n+/);
                    // If no double newlines, try splitting by periods followed by space and capital
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\.\s+(?=[A-Z])/);
                    }
                    // If still one paragraph, try single newlines
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\n+/);
                    }
                    paragraphs = paragraphs
                        .filter(p => p.trim().length > 0)
                        .map(p => p.trim().replace(/\n/g, ' '));
                    discussionEl.innerHTML = paragraphs.map(p => `<p style="margin-bottom: 15px;">${p}${p.endsWith('.') ? '' : '.'}</p>`).join('');
                }
            }
            
            // Comparison Discussion (Section 3)
            if (aiInsights.comparison_discussion) {
                const discussionEl = document.getElementById('comparisonDiscussion');
                if (discussionEl) {
                    let text = aiInsights.comparison_discussion.trim();
                    let paragraphs = text.split(/\n\n+/);
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\.\s+(?=[A-Z])/);
                    }
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\n+/);
                    }
                    paragraphs = paragraphs
                        .filter(p => p.trim().length > 0)
                        .map(p => p.trim().replace(/\n/g, ' '));
                    discussionEl.innerHTML = paragraphs.map(p => `<p style="margin-bottom: 15px;">${p}${p.endsWith('.') ? '' : '.'}</p>`).join('');
                } else {
                    const discussionEl = document.getElementById('comparisonDiscussion');
                    if (discussionEl) {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this section is not available.</p>';
                    }
                }
            } else {
                const discussionEl = document.getElementById('comparisonDiscussion');
                if (discussionEl) {
                    discussionEl.innerHTML = '<p>AI-generated analysis for this section is not available.</p>';
                }
            }
            
            // HHI Trends Discussion (Section 5)
            if (aiInsights.hhi_trends_discussion) {
                const discussionEl = document.getElementById('hhiTrendsDiscussion');
                if (discussionEl) {
                    let text = aiInsights.hhi_trends_discussion.trim();
                    let paragraphs = text.split(/\n\n+/);
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\.\s+(?=[A-Z])/);
                    }
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\n+/);
                    }
                    paragraphs = paragraphs
                        .filter(p => p.trim().length > 0)
                        .map(p => p.trim().replace(/\n/g, ' '));
                    discussionEl.innerHTML = paragraphs.map(p => `<p style="margin-bottom: 15px;">${p}${p.endsWith('.') ? '' : '.'}</p>`).join('');
                }
            } else {
                const discussionEl = document.getElementById('hhiTrendsDiscussion');
                if (discussionEl) {
                    discussionEl.innerHTML = '<p>AI-generated analysis for this section is not available.</p>';
                }
            }
            
            // Top Lenders Discussion (Section 4)
            if (aiInsights.top_lenders_discussion) {
                const discussionEl = document.getElementById('topLendersDiscussion');
                if (discussionEl) {
                    let text = aiInsights.top_lenders_discussion.trim();
                    let paragraphs = text.split(/\n\n+/);
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\.\s+(?=[A-Z])/);
                    }
                    if (paragraphs.length === 1) {
                        paragraphs = text.split(/\n+/);
                    }
                    paragraphs = paragraphs
                        .filter(p => p.trim().length > 0)
                        .map(p => p.trim().replace(/\n/g, ' '));
                    discussionEl.innerHTML = paragraphs.map(p => `<p style="margin-bottom: 15px;">${p}${p.endsWith('.') ? '' : '.'}</p>`).join('');
                }
            }
            
            // Top Lenders Introduction (2 sentences)
            const topLendersIntro = document.getElementById('topLendersIntro');
            if (topLendersIntro && metadata) {
                topLendersIntro.textContent = `This table shows the top lenders by total number of loans in 2024, displayed in descending order by total loans. For each lender, the table shows loan counts and amounts by size category, LMI tract percentage, and other key metrics.`;
            }
        }
        
        // Tab switching function
        function switchTopLendersTab(tab) {
            const tabNumber = document.getElementById('tabNumber');
            const tabAmount = document.getElementById('tabAmount');
            const tableNumber = document.getElementById('tableNumber');
            const tableAmount = document.getElementById('tableAmount');
            
            if (tab === 'number') {
                tabNumber.classList.add('active');
                tabNumber.style.background = 'var(--ncrc-primary-blue)';
                tabNumber.style.color = 'white';
                tabAmount.classList.remove('active');
                tabAmount.style.background = '#e0e0e0';
                tabAmount.style.color = '#333';
                tableNumber.style.display = 'block';
                tableAmount.style.display = 'none';
            } else {
                tabAmount.classList.add('active');
                tabAmount.style.background = 'var(--ncrc-primary-blue)';
                tabAmount.style.color = 'white';
                tabNumber.classList.remove('active');
                tabNumber.style.background = '#e0e0e0';
                tabNumber.style.color = '#333';
                tableAmount.style.display = 'block';
                tableNumber.style.display = 'none';
            }
        }
        
        function populateTopLendersTable(data, metadata) {
            console.log('populateTopLendersTable called with:', data);
            if (!data || data.length === 0) {
                console.warn('No data provided to populateTopLendersTable');
                return;
            }
            
            const tbodyNumber = document.getElementById('topLendersTableBodyNumber');
            const tbodyAmount = document.getElementById('topLendersTableBodyAmount');
            
            if (!tbodyNumber || !tbodyAmount) {
                console.error('Top lenders table body elements not found');
                return;
            }
            
            // Format helpers
            const formatNumTotal = (val) => {
                if (val === null || val === undefined || isNaN(val)) return '0';
                return parseInt(val).toLocaleString();
            };
            
            const formatPercent = (val) => {
                if (val === null || val === undefined || isNaN(val)) return '0.0%';
                return parseFloat(val).toFixed(1) + '%';
            };
            
            const formatDollarAmount = (val) => {
                if (val === null || val === undefined || isNaN(val)) return '$0';
                // Amount is in thousands, format with commas
                const amount = parseFloat(val);
                return '$' + amount.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            };
            
            // Build Number of Loans table
            tbodyNumber.innerHTML = data.map((row, rowIndex) => {
                const isHidden = (data.length > 10 && rowIndex >= 10) ? 'style="display: none;"' : '';
                const lowIncomeStyle = 'background: #f0f0f0;';
                const moderateIncomeStyle = 'background: #f0f0f0;';
                
                return `
                    <tr data-index="${rowIndex}" ${isHidden}>
                        <td style="text-align: left; padding: 8px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">${row['Lender Name'] || ''}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatNumTotal(row['Num Total'])}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Num Under 100K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Num 100K 250K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Num 250K 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Numsb Under 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; ${lowIncomeStyle}">${formatPercent(row['Low Income %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; ${moderateIncomeStyle}">${formatPercent(row['Moderate Income %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Middle Income %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Upper Income %'] || 0)}</td>
                    </tr>
                `;
            }).join('');
            
            // Build Amount of Loans table
            tbodyAmount.innerHTML = data.map((row, rowIndex) => {
                const isHidden = (data.length > 10 && rowIndex >= 10) ? 'style="display: none;"' : '';
                const lowIncomeStyle = 'background: #f0f0f0;';
                const moderateIncomeStyle = 'background: #f0f0f0;';
                
                return `
                    <tr data-index="${rowIndex}" ${isHidden}>
                        <td style="text-align: left; padding: 8px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">${row['Lender Name'] || ''}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatDollarAmount(row['Amt Total'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Amt Under 100K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Amt 100K 250K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Amt 250K 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Amtsb Under 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; ${lowIncomeStyle}">${formatPercent(row['Low Income Amt %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; ${moderateIncomeStyle}">${formatPercent(row['Moderate Income Amt %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Middle Income Amt %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatPercent(row['Upper Income Amt %'] || 0)}</td>
                    </tr>
                `;
            }).join('');
            
            // Show expand buttons if there are more than 10 lenders
            if (data.length > 10) {
                const expandBtnNumber = document.getElementById('expandTopLendersBtnNumber');
                const expandBtnAmount = document.getElementById('expandTopLendersBtnAmount');
                if (expandBtnNumber) expandBtnNumber.style.display = 'inline-block';
                if (expandBtnAmount) expandBtnAmount.style.display = 'inline-block';
            }
            
            // Populate caption
            const caption = document.getElementById('topLendersCaption');
            if (caption && metadata) {
                let captionText = '<strong>Source:</strong> Community Reinvestment Act (CRA) Small Business Lending data, compiled and maintained in NCRC\'s curated databases. ';
                captionText += '<strong>Year:</strong> 2024. ';
                captionText += '<strong>Methodology:</strong> Lenders are sorted in descending order by total number of loans. ';
                captionText += `County: ${metadata.county_name || 'Unknown'}.`;
                caption.innerHTML = captionText;
            }
        }
        
        // Table sorting function
        let sortDirection = {};
        
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) return;
            
            // Initialize sort direction for this table/column if not set
            const sortKey = `${tableId}_${columnIndex}`;
            if (sortDirection[sortKey] === undefined) {
                sortDirection[sortKey] = 'asc';
            } else {
                sortDirection[sortKey] = sortDirection[sortKey] === 'asc' ? 'desc' : 'asc';
            }
            
            const isAscending = sortDirection[sortKey] === 'asc';
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                if (!aCell || !bCell) return 0;
                
                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();
                
                // Handle special cases
                if (columnIndex === 0) {
                    // Lender Name - string sort
                    return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else {
                    // Numeric columns - extract number from formatted text
                    // Remove $, %, commas, and other non-numeric characters except decimal point
                    aValue = parseFloat(aValue.replace(/[^0-9.-]/g, '')) || 0;
                    bValue = parseFloat(bValue.replace(/[^0-9.-]/g, '')) || 0;
                    
                    return isAscending ? aValue - bValue : bValue - aValue;
                }
            });
            
            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort icons in header
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, idx) => {
                const icon = header.querySelector('i');
                if (icon) {
                    if (idx === columnIndex) {
                        icon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    } else {
                        icon.className = 'fas fa-sort';
                    }
                }
            });
        }
        
        // Function to expand/collapse top lenders table
        function expandTopLendersTable(tab) {
            const tableId = tab === 'number' ? 'topLendersTableNumber' : 'topLendersTableAmount';
            const btnId = tab === 'number' ? 'expandTopLendersBtnNumber' : 'expandTopLendersBtnAmount';
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            const expandBtn = document.getElementById(btnId);
            
            if (!table || !expandBtn) return;
            
            // Check if currently showing all (rows 10+ are visible)
            const isExpanded = rows.length > 10 && rows[10].style.display !== 'none';
            
            if (isExpanded) {
                // Collapse to top 10
                rows.forEach((row, index) => {
                    if (index >= 10) {
                        row.style.display = 'none';
                    }
                });
                expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Show All Lenders';
            } else {
                // Expand to show all
                rows.forEach((row) => {
                    row.style.display = '';
                });
                expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Show Top 10 Only';
            }
        }
        
        function updateSummaryTable(summary) {
            const formatNumber = (num) => {
                if (num === null || num === undefined) return '-';
                return typeof num === 'number' ? num.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }) : num;
            };
            
            const formatPercent = (num) => {
                if (num === null || num === undefined) return '-';
                return typeof num === 'number' ? num.toFixed(1) + '%' : num;
            };
            
            const formatCurrency = (num) => {
                if (num === null || num === undefined) return '-';
                // Amount is in thousands, format with commas
                const amount = typeof num === 'number' ? num : parseFloat(num) || 0;
                return '$' + amount.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            };
            
            const tbody = document.getElementById('summaryTableBody');
            if (!tbody) {
                console.error('summaryTableBody not found');
                return;
            }
            if (!summary) {
                console.error('Summary data is missing');
                return;
            }
            
            console.log('Updating summary table with data:', summary);
            
            tbody.innerHTML = `
                <tr>
                    <td class="label">Total Loans</td>
                    <td class="value">${formatNumber(summary.total_loans || 0)}</td>
                </tr>
                <tr>
                    <td class="label">Total Loan Amount</td>
                    <td class="value">${formatCurrency(summary.total_loan_amount || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Loans to Low Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_loans_low_income || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Loans to Moderate Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_loans_moderate_income || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Loans to Middle Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_loans_middle_income || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Loans to Upper Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_loans_upper_income || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Amount to Low Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_amount_low_income || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Amount to Moderate Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_amount_moderate_income || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Amount to Middle Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_amount_middle_income || 0)}</td>
                </tr>
                <tr>
                    <td class="label">% Amount to Upper Income Tracts</td>
                    <td class="value">${formatPercent(summary.pct_amount_upper_income || 0)}</td>
                </tr>
            `;
            
            // Render treemap charts (with a small delay to ensure DOM is ready)
            setTimeout(() => {
                renderTreemaps(summary);
            }, 100);
        }
        
        // Treemap toggle function
        function switchTreemap(type) {
            const loansBtn = document.getElementById('treemapToggleLoans');
            const amountsBtn = document.getElementById('treemapToggleAmounts');
            const loansDiv = document.getElementById('treemapLoans');
            const amountsDiv = document.getElementById('treemapAmounts');
            
            if (type === 'loans') {
                loansBtn.classList.add('active');
                loansBtn.style.background = 'var(--ncrc-primary-blue)';
                loansBtn.style.color = 'white';
                amountsBtn.classList.remove('active');
                amountsBtn.style.background = '#ccc';
                amountsBtn.style.color = '#333';
                loansDiv.style.display = 'block';
                amountsDiv.style.display = 'none';
            } else {
                amountsBtn.classList.add('active');
                amountsBtn.style.background = 'var(--ncrc-primary-blue)';
                amountsBtn.style.color = 'white';
                loansBtn.classList.remove('active');
                loansBtn.style.background = '#ccc';
                loansBtn.style.color = '#333';
                loansDiv.style.display = 'none';
                amountsDiv.style.display = 'block';
            }
        }
        
        // Render treemap charts with NCRC colors
        function renderTreemaps(summary) {
            if (!summary) {
                console.warn('renderTreemaps: No summary data provided');
                return;
            }
            
            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                console.error('Plotly is not loaded. Please check the CDN link.');
                return;
            }
            
            // NCRC color palette
            const ncrcColors = {
                low: '#e82e2e',        // NCRC red accent (Low Income)
                moderate: '#eb2f89',  // NCRC pink (Moderate Income)
                middle: '#2fade3',    // NCRC secondary blue (Middle Income)
                upper: '#552d87'      // NCRC primary blue/purple (Upper Income)
            };
            
            // Loans treemap data - Plotly treemap format
            const loansData = [{
                type: 'treemap',
                labels: ['Low Income', 'Moderate Income', 'Middle Income', 'Upper Income'],
                values: [
                    summary.pct_loans_low_income || 0,
                    summary.pct_loans_moderate_income || 0,
                    summary.pct_loans_middle_income || 0,
                    summary.pct_loans_upper_income || 0
                ],
                parents: ['', '', '', ''],
                textinfo: 'label+percent entry',
                textfont: {
                    size: 14,
                    color: 'white',
                    family: 'Inter, sans-serif'
                },
                marker: {
                    colors: [ncrcColors.low, ncrcColors.moderate, ncrcColors.middle, ncrcColors.upper],
                    line: {
                        width: 2,
                        color: 'white'
                    }
                },
                hovertemplate: '<b>%{label}</b><br>%{value:.1f}%<extra></extra>'
            }];
            
            // Amounts treemap data
            const amountsData = [{
                type: 'treemap',
                labels: ['Low Income', 'Moderate Income', 'Middle Income', 'Upper Income'],
                values: [
                    summary.pct_amount_low_income || 0,
                    summary.pct_amount_moderate_income || 0,
                    summary.pct_amount_middle_income || 0,
                    summary.pct_amount_upper_income || 0
                ],
                parents: ['', '', '', ''],
                textinfo: 'label+percent entry',
                textfont: {
                    size: 14,
                    color: 'white',
                    family: 'Inter, sans-serif'
                },
                marker: {
                    colors: [ncrcColors.low, ncrcColors.moderate, ncrcColors.middle, ncrcColors.upper],
                    line: {
                        width: 2,
                        color: 'white'
                    }
                },
                hovertemplate: '<b>%{label}</b><br>%{value:.1f}%<extra></extra>'
            }];
            
            const layout = {
                margin: { l: 0, r: 0, t: 0, b: 0 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    family: 'Inter, sans-serif',
                    size: 12
                }
            };
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            // Check if DOM elements exist
            const loansDiv = document.getElementById('treemapLoans');
            const amountsDiv = document.getElementById('treemapAmounts');
            
            if (!loansDiv || !amountsDiv) {
                console.error('Treemap containers not found in DOM');
                return;
            }
            
            try {
                // Render loans treemap
                Plotly.newPlot('treemapLoans', loansData, layout, config);
                
                // Render amounts treemap
                Plotly.newPlot('treemapAmounts', amountsData, layout, config);
                
                console.log('Treemaps rendered successfully');
            } catch (error) {
                console.error('Error rendering treemaps:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }
        
        function populateHHIByYearChart(hhiData, metadata) {
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, skipping HHI chart');
                return;
            }
            
            const container = document.getElementById('hhiByYearChart');
            if (!container) {
                console.warn('HHI chart container not found');
                return;
            }
            
            // Sort data by year
            const sortedData = hhiData.sort((a, b) => parseInt(a.year) - parseInt(b.year));
            
            const years = sortedData.map(d => d.year.toString());
            const hhiValues = sortedData.map(d => parseFloat(d.hhi_value || 0));
            
            const trace = {
                x: years,
                y: hhiValues,
                type: 'bar',
                marker: {
                    color: '#2fade3',  // NCRC color
                    line: {
                        color: 'white',
                        width: 1
                    }
                },
                text: hhiValues.map(v => v.toFixed(0)),
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>HHI: %{text}<extra></extra>'
            };
            
            // Calculate max value for y-axis range
            const maxHHI = Math.max(...hhiValues, 2500); // Ensure we show at least up to 2,500
            const yMax = Math.max(maxHHI * 1.15, 3000); // At least 3,000 to show thresholds clearly
            
            // Add horizontal reference lines for concentration thresholds
            const shapes = [
                // Low concentration threshold (1,500)
                {
                    type: 'line',
                    xref: 'paper',
                    x0: 0,
                    x1: 1,
                    yref: 'y',
                    y0: 1500,
                    y1: 1500,
                    line: {
                        color: '#28a745', // Green for competitive
                        width: 2,
                        dash: 'dash'
                    }
                },
                // High concentration threshold (2,500)
                {
                    type: 'line',
                    xref: 'paper',
                    x0: 0,
                    x1: 1,
                    yref: 'y',
                    y0: 2500,
                    y1: 2500,
                    line: {
                        color: '#dc3545', // Red for high concentration
                        width: 2,
                        dash: 'dash'
                    }
                }
            ];
            
            // Add annotations for threshold labels
            const annotations = [
                {
                    xref: 'paper',
                    x: 0.98, // Right side of chart
                    y: 1500,
                    xanchor: 'right',
                    yanchor: 'middle',
                    text: 'Low Concentration<br>Threshold (1,500)',
                    showarrow: false,
                    font: {
                        color: '#28a745',
                        size: 11,
                        family: 'Inter, sans-serif'
                    },
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#28a745',
                    borderwidth: 1,
                    borderpad: 4
                },
                {
                    xref: 'paper',
                    x: 0.98, // Right side of chart
                    y: 2500,
                    xanchor: 'right',
                    yanchor: 'middle',
                    text: 'High Concentration<br>Threshold (2,500)',
                    showarrow: false,
                    font: {
                        color: '#dc3545',
                        size: 11,
                        family: 'Inter, sans-serif'
                    },
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#dc3545',
                    borderwidth: 1,
                    borderpad: 4
                }
            ];
            
            const layout = {
                margin: { l: 60, r: 120, t: 30, b: 50 }, // Increased right margin for labels
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    title: 'Year',
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    tickfont: { size: 12 }
                },
                yaxis: {
                    title: 'HHI',
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    tickfont: { size: 12 },
                    range: [0, yMax]
                },
                shapes: shapes,
                annotations: annotations,
                showlegend: false,
                height: 400
            };
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            try {
                Plotly.newPlot('hhiByYearChart', [trace], layout, config);
                console.log('HHI by year chart rendered successfully');
            } catch (error) {
                console.error('Error creating HHI chart:', error);
            }
        }
        
        // Create column chart for tract popup
        function createTractPopupChart(containerId, tract) {
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, skipping chart');
                return;
            }
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn('Chart container not found:', containerId);
                return;
            }
            
            // Get year-by-year amounts (in millions)
            const years = ['2018', '2019', '2020', '2021', '2022', '2023', '2024'];
            const yearAmounts = [];
            const yearLabels = [];
            
            // Check if tract has year_amounts object
            let yearAmountsData = {};
            if (tract.year_amounts) {
                // Handle both object and string (if JSON serialized)
                if (typeof tract.year_amounts === 'string') {
                    try {
                        yearAmountsData = JSON.parse(tract.year_amounts);
                    } catch (e) {
                        console.warn('Failed to parse year_amounts:', e);
                        yearAmountsData = {};
                    }
                } else if (typeof tract.year_amounts === 'object') {
                    yearAmountsData = tract.year_amounts;
                }
            }
            
            console.log('Tract year_amounts data:', yearAmountsData);
            
            years.forEach(year => {
                const amount = yearAmountsData[year] || 0;
                // Amounts are in thousands, convert to actual dollars
                const amountDollars = parseFloat(amount) * 1000;
                yearAmounts.push(amountDollars);
                yearLabels.push(year);
            });
            
            console.log('Year amounts (dollars):', yearAmounts);
            
            // Calculate dynamic y-axis range - set to max value across all years
            const maxAmount = Math.max(...yearAmounts, 0);
            const yAxisMax = maxAmount > 0 ? maxAmount * 1.1 : 1000; // Add 10% padding, or 1000 if all zeros
            
            // Format text labels based on value size
            const textLabels = yearAmounts.map(amt => {
                if (amt === 0) return '$0';
                if (amt >= 1000000) {
                    return '$' + (amt / 1000000).toFixed(1) + 'M';
                } else if (amt >= 1000) {
                    return '$' + (amt / 1000).toFixed(0) + 'K';
                } else {
                    return '$' + amt.toFixed(0);
                }
            });
            
            // Color bars differently for PPP years (2020-2021)
            const barColors = yearLabels.map(year => {
                if (year === '2020' || year === '2021') {
                    return '#95a5a6'; // Gray for PPP years
                }
                return '#2fade3'; // NCRC blue for other years
            });
            
            const trace = {
                x: yearLabels,
                y: yearAmounts,
                type: 'bar',
                marker: {
                    color: barColors,
                    line: {
                        color: 'white',
                        width: 1.5
                    },
                    opacity: 0.85
                },
                text: textLabels,
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>Amount: %{text}<extra></extra>',
                textfont: {
                    size: 11,
                    color: '#333'
                }
            };
            
            const layout = {
                margin: { l: 50, r: 40, t: 20, b: 60 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    title: {
                        text: 'Year',
                        font: { size: 12, color: '#666' }
                    },
                    showgrid: false,
                    gridcolor: '#e0e0e0',
                    showticklabels: true,
                    tickfont: { size: 11, color: '#333' },
                    tickmode: 'linear',
                    dtick: 1
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    showticklabels: false,
                    range: [0, yAxisMax],
                    zeroline: true,
                    zerolinecolor: '#ddd',
                    zerolinewidth: 1
                },
                showlegend: false,
                height: 280,
                autosize: true
            };
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            try {
                Plotly.newPlot(containerId, [trace], layout, config);
                console.log('Popup chart rendered successfully');
            } catch (error) {
                console.error('Error creating popup chart:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }
        
        // Smooth scroll to section
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Show/hide table of contents
        function toggleTOC() {
            const toc = document.getElementById('tocContainer');
            if (toc) {
                toc.style.display = toc.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Add ARIA labels and keyboard navigation
        function enhanceAccessibility() {
            // Add ARIA labels to tables
            document.querySelectorAll('.data-table').forEach(table => {
                if (!table.getAttribute('role')) {
                    table.setAttribute('role', 'table');
                    table.setAttribute('aria-label', 'Data table');
                }
            });
            
            // Add ARIA labels to tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                if (!button.getAttribute('aria-label')) {
                    const text = button.textContent.trim();
                    button.setAttribute('aria-label', `Switch to ${text} view`);
                    button.setAttribute('role', 'tab');
                }
            });
            
            // Add keyboard navigation to tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        button.click();
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        const tabs = Array.from(document.querySelectorAll('.tab-button'));
                        const currentIndex = tabs.indexOf(button);
                        const nextIndex = e.key === 'ArrowRight' 
                            ? (currentIndex + 1) % tabs.length
                            : (currentIndex - 1 + tabs.length) % tabs.length;
                        tabs[nextIndex].focus();
                        tabs[nextIndex].click();
                    }
                });
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job_id');
            
            // Show TOC after content loads
            setTimeout(() => {
                const toc = document.getElementById('tocContainer');
                if (toc) {
                    toc.style.display = 'block';
                }
            }, 1000);
            
            // Enhance accessibility
            enhanceAccessibility();
            
            if (jobId) {
                loadReportData(jobId);
                updateDownloadLinks();
            } else {
                console.error('No job_id found in URL');
                document.getElementById('reportMetadata').textContent = 'Error: No job ID provided';
            }
        });
    </script>
</body>
</html>

