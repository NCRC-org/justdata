<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizSight - Small Business Lending Report</title>
    
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Leaflet CSS disabled - map will be added in future version -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /> -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--ncrc-dark-blue);
            color: white;
            border-radius: 8px;
        }
        
        /* Introduction and Summary Layout - Stacked vertically for better readability */
        .intro-and-summary-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-bottom: 30px;
        }

        .intro-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .intro-container h3 {
            margin: 0 0 15px 0;
            color: var(--ncrc-primary-blue);
            font-size: 1.2rem;
        }

        .intro-content {
            line-height: 1.7;
            font-size: 1rem;
            color: #333;
        }

        .intro-content p {
            margin-bottom: 15px;
        }

        .intro-content p:last-child {
            margin-bottom: 0;
        }

        /* Legacy map classes (kept for compatibility) */
        .map-controls {
            display: none; /* Hide if still referenced */
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 200px;
        }
        
        .map-controls h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--ncrc-dark-blue);
        }
        
        .layer-control {
            margin-bottom: 10px;
        }
        
        .layer-control label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .layer-control input[type="checkbox"],
        .layer-control input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .summary-table-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            height: auto;
            overflow-y: visible;
            display: flex;
            flex-direction: column;
            width: 100%;
            min-width: 450px;
        }
        
        .summary-table-container h3 {
            margin: 0 0 20px 0;
            color: var(--ncrc-primary-blue);
            font-size: 1.2rem;
        }
        
        .summary-cards-vertical {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .summary-card-vertical {
            background: white;
            padding: 18px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .summary-card-vertical .label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .summary-card-vertical .value {
            font-size: 1.5rem;
            color: var(--ncrc-dark-blue);
            font-weight: 700;
            margin-bottom: 6px;
            word-break: break-word;
            line-height: 1.2;
        }
        
        .summary-card-vertical .change {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }
        
        .summary-card-vertical .change.positive {
            color: #28a745;
        }
        
        .summary-card-vertical .change.negative {
            color: #dc3545;
        }
        
        .summary-boxes-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            align-items: stretch;
        }

        .summary-box {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 18px 20px;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s ease;
            min-height: 100px;
        }

        .summary-box:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .summary-box-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
            line-height: 1.4;
        }

        .summary-box-value {
            font-size: 1.6rem;
            color: var(--ncrc-primary-blue);
            font-weight: 700;
            line-height: 1.2;
        }

        .summary-box-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        /* Info Tooltips */
        .info-tooltips-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-tooltip-item {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #555;
            cursor: help;
            transition: background 0.2s ease;
        }

        .info-tooltip-item:hover {
            background: #e0e0e0;
        }

        .info-tooltip-item i {
            font-size: 0.75rem;
        }

        .info-tooltip-item.info { color: #2fade3; }
        .info-tooltip-item.warning { color: #ffc107; }
        .info-tooltip-item.alert { color: #dc3545; }

        .info-tooltip-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 350px;
            padding: 12px 15px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 0.85rem;
            line-height: 1.6;
            color: #333;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .info-tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: white;
        }

        .info-tooltip-item:hover .info-tooltip-content {
            display: block;
        }

        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 250px;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--ncrc-dark-blue);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .report-section {
            margin-bottom: 40px;
            display: block; /* Ensure sections stack vertically */
            width: 100%; /* Full width */
            clear: both; /* Prevent floating */
        }
        
        /* Removed .sections-row-container CSS - sections should stack vertically, not horizontally */
        
        .section-title {
            color: var(--ncrc-primary-blue);
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--ncrc-secondary-blue);
            padding-bottom: 10px;
            background: linear-gradient(to right, rgba(47, 173, 227, 0.05), transparent);
            padding: 15px 20px 10px 20px;
            margin-left: -20px;
            margin-right: -20px;
            border-radius: 4px;
        }
        
        .table-introduction {
            margin-bottom: 15px;
            color: #555;
            font-size: 1rem;
            line-height: 1.6;
            padding-left: 15px;
            border-left: 3px solid var(--ncrc-secondary-blue);
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 4px;
        }
        
        .intro-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.8;
            color: #333;
        }
        
        .callouts-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .callout-box {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s ease;
        }
        
        .callout-box:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .callout-box h3 {
            margin: 0 0 12px 0;
            color: var(--ncrc-primary-blue);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .callout-box p {
            margin: 0;
            color: #555;
            line-height: 1.6;
            flex: 1;
        }
        
        .table-container {
            margin-top: 20px;
            width: 100%;
            overflow-x: hidden;
        }
        
        .table-header {
            margin-bottom: 10px;
            text-align: right;
        }
        
        .expand-btn {
            background: var(--ncrc-secondary-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .expand-btn:hover {
            background: var(--ncrc-primary-blue);
        }
        
        .data-table {
            width: 100%;
            max-width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            table-layout: auto;
        }
        
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table th {
            padding: 12px 10px;
            text-align: center;
            background: var(--ncrc-primary-blue);
            color: white;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            line-height: 1.5;
        }
        
        /* Column width rules for Sections 2-5: First column no-wrap, other columns fixed 100px */
        /* Note: Inline styles in JavaScript override these, matching LendSight approach */
        .data-table th:first-child,
        .data-table td:first-child {
            white-space: nowrap;
            width: auto;
            min-width: 0;
        }
        
        .data-table th:not(:first-child),
        .data-table td:not(:first-child) {
            width: auto;
            min-width: 80px;
            max-width: none;
        }
        
        /* Exception for Section 4 (Top Lenders) - Lender Name column already has special styling */
        #topLendersTableNumber th:first-child,
        #topLendersTableNumber td:first-child,
        #topLendersTableAmount th:first-child,
        #topLendersTableAmount td:first-child {
            white-space: nowrap;
            width: auto;
            min-width: 450px;
        }
        
        .data-table tbody tr:hover {
            background-color: #f0f7ff !important;
            transition: background-color 0.2s ease;
        }
        
        .data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .data-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        
        .data-table tbody tr:nth-child(even):hover {
            background-color: #e8f4ff !important;
        }
        
        .data-table tbody tr:focus {
            outline: 2px solid var(--ncrc-secondary-blue);
            outline-offset: -2px;
        }
        
        .table-narrative {
            margin-top: 20px;
            padding: 18px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid var(--ncrc-secondary-blue);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Section 2 narrative extends to full width */
        #section2 .table-narrative {
            width: 100%;
            margin-left: -20px;
            margin-right: -20px;
            padding-left: 20px;
            padding-right: 20px;
        }
        
        .table-narrative p {
            margin-bottom: 15px;
        }
        
        .table-narrative p:last-child {
            margin-bottom: 0;
        }
        
        /* Table of Contents */
        .toc-container {
            position: sticky;
            top: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .toc-container h3 {
            margin: 0 0 15px 0;
            color: var(--ncrc-primary-blue);
            font-size: 1.1rem;
            border-bottom: 2px solid var(--ncrc-secondary-blue);
            padding-bottom: 10px;
        }
        
        .toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .toc-list li {
            margin-bottom: 8px;
        }
        
        .toc-list a {
            color: #333;
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .toc-list a:hover {
            background: var(--ncrc-light-blue);
            color: var(--ncrc-primary-blue);
            transform: translateX(5px);
        }
        
        .toc-list a:focus {
            outline: 2px solid var(--ncrc-secondary-blue);
            outline-offset: 2px;
        }
        
        /* Print Styles */
        @media print {
            .toc-container,
            .map-controls,
            .legend,
            .action-btn,
            .expand-btn,
            .tab-button,
            .treemap-toggle-btn {
                display: none !important;
            }
            
            .report-container {
                max-width: 100%;
                padding: 0;
            }
            
            .report-section {
                page-break-inside: avoid;
                margin-bottom: 30px;
            }
            
            .section-title {
                page-break-after: avoid;
            }
            
            .data-table {
                page-break-inside: auto;
            }
            
            .data-table thead {
                display: table-header-group;
            }
            
            .data-table tbody tr {
                page-break-inside: avoid;
            }
            
            .intro-and-summary-container {
                grid-template-columns: 1fr;
            }

            .intro-container {
                page-break-inside: avoid;
            }

            body {
                background: white;
            }
            
            .table-narrative {
                page-break-inside: avoid;
            }
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        .data-table th:focus,
        .tab-button:focus,
        .expand-btn:focus {
            outline: 3px solid var(--ncrc-secondary-blue);
            outline-offset: 2px;
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .intro-and-summary-container {
                flex-direction: column;
            }

            .intro-container {
                margin-bottom: 20px;
            }

            .summary-boxes-container {
                grid-template-columns: repeat(3, 1fr);
            }

            .data-table {
                font-size: 0.85rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }

            .toc-container {
                position: relative;
                top: 0;
                margin-bottom: 20px;
            }

            .tab-button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 768px) {
            .section-title {
                font-size: 1.3rem;
                padding: 12px 15px 8px 15px;
            }

            .summary-boxes-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }

            .table-introduction {
                font-size: 0.9rem;
                padding: 10px 12px;
            }

            .table-narrative {
                padding: 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body style="background: var(--ncrc-gray-light);">
    <div class="report-container">
        <!-- Header Actions Row - Back button on left, Export/Print on right -->
        <div class="report-actions-row no-print" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0;">
            <a href="/bizsight" class="action-btn" style="text-decoration: none; cursor: pointer; padding: 10px 20px; background: var(--ncrc-dark-blue); color: white; border-radius: 5px; display: inline-block; font-weight: 500;">
                <i class="fas fa-arrow-left"></i> Back to New Analysis
            </a>
            <div style="display: flex; gap: 10px;">
                <a href="/bizsight/download?format=excel" class="action-btn primary" id="downloadExcelBtn" style="text-decoration: none; cursor: pointer; padding: 10px 20px; background: var(--ncrc-secondary-blue); color: white; border-radius: 5px; display: inline-block;">
                    <i class="fas fa-file-excel"></i> Export Data (Excel)
                </a>
                <button class="action-btn" id="printReportBtn" onclick="window.print()" style="cursor: pointer; padding: 10px 20px; background: var(--ncrc-primary-blue); color: white; border-radius: 5px; border: none; display: inline-block;">
                    <i class="fas fa-print"></i> Print Report
                </button>
            </div>
        </div>

        <div class="report-header" style="text-align: center; margin-bottom: 30px; padding: 20px; background: var(--ncrc-dark-blue); color: white; border-radius: 8px;">
            <h1 style="margin: 0 0 10px 0;">Small Business Lending Analysis</h1>
            <p id="reportMetadata" style="margin: 10px 0 0 0; opacity: 0.9;">Loading report data...</p>
        </div>
        
        <div id="reportContent">
        
        <!-- Section 1: Introduction -->
        <div class="report-section" id="section1" style="margin-bottom: 30px;">
            <h2 class="section-title">Section 1: Introduction</h2>
            <div id="section1Intro" style="margin-bottom: 20px; line-height: 1.8; color: #333;">
                <p>This report provides a comprehensive analysis of small business lending activity in <span id="introCountyName">the selected county</span> for the most recent five years (2020-2024). The analysis is based on data collected under the <a href="https://ncrc.org/communityreinvestmentact" target="_blank" rel="noopener noreferrer">Community Reinvestment Act</a> (CRA), which requires financial institutions to report information about small business loan applications and originations.</p>
            </div>
        </div>
        
        <div class="intro-and-summary-container">
            <!-- Introduction Section -->
            <div class="intro-container">
                <h3><i class="fas fa-info-circle"></i> About This Report</h3>
                <div class="intro-content" id="introContent">
                    <p id="introParagraph1">Loading report introduction...</p>
                    <p id="introParagraph2"></p>
                    <p id="introParagraph3"></p>
                </div>
            </div>

            <!-- Summary Statistics Boxes - All 5 in one row -->
            <div class="summary-table-container">
                <h3><i class="fas fa-chart-bar"></i> Summary Statistics (2024)</h3>
                <div class="summary-boxes-container" id="summaryBoxesContainer">
                    <div class="summary-box">
                        <div class="summary-box-label">Number of Loans</div>
                        <div class="summary-box-value" id="summaryBoxLoans">-</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-label">Amount of Loans</div>
                        <div class="summary-box-value" id="summaryBoxAmount">-</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-label">Average Loan Amount</div>
                        <div class="summary-box-value" id="summaryBoxAvgLoan">-</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-label">Amount to Businesses Under $1M Revenue</div>
                        <div class="summary-box-value" id="summaryBoxUnder1M">-</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-label">Amount in LMI Neighborhoods</div>
                        <div class="summary-box-value" id="summaryBoxLMI">-</div>
                    </div>
                </div>
                <!-- Data Notes -->
                <div class="info-tooltips-container" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                    <div class="info-tooltip-item info">
                        <i class="fas fa-info-circle"></i>
                        <span>Data Coverage</span>
                        <div class="info-tooltip-content">
                            This report includes tract-level and county-level data on small business lending, including loan counts and amounts by loan size categories, lending to businesses with revenues under $1 million, and lending in Low- and Moderate-Income (LMI) census tracts.
                        </div>
                    </div>
                    <div class="info-tooltip-item warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>PPP Impact</span>
                        <div class="info-tooltip-content">
                            In 2020 and 2021, the Paycheck Protection Program (PPP) significantly impacted small business lending patterns. Loan counts and amounts may be elevated during these years.
                        </div>
                    </div>
                    <div class="info-tooltip-item alert">
                        <i class="fas fa-info-circle"></i>
                        <span>Section 1071</span>
                        <div class="info-tooltip-content">
                            Section 1071 of the Dodd-Frank Act has still not been implemented. This report does not include borrower demographics.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: County Summary (2020-2024) -->
        <div class="report-section print-break" id="section2" style="margin-top: 40px;">
            <h2 class="section-title">Section 2: County Summary (2020-2024)</h2>

            <!-- Table 1: Number of Loans -->
            <h3 class="table-number" style="margin: 30px 0 10px 0; font-size: 1rem; color: #333;">Table 1: County Summary - Number of Loans (2020-2024)</h3>
            <div class="table-intro" id="countySummaryNumberIntro" style="margin-bottom: 15px; line-height: 1.6; color: #444;">
                <!-- 2-3 sentences will be populated by JavaScript -->
            </div>
            <div class="table-container">
                <table class="data-table" id="countySummaryTableNumber" role="table" aria-label="County Summary - Number of Loans">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Variable</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2020</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2021</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2022</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2023</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2024</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Change (2020→2024)</th>
                        </tr>
                    </thead>
                    <tbody id="countySummaryTableNumberBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p class="table-caption" style="margin-top: 10px; font-size: 0.85rem; color: #666; font-style: italic;">
                Source: FFIEC CRA Small Business Lending Data, compiled by NCRC.
            </p>
            <div class="table-narrative" id="countySummaryNumberNarrative" role="region" aria-label="County Summary Number Analysis" style="margin-top: 15px;">
                <!-- AI narrative will be populated by JavaScript -->
            </div>

            <!-- Table 2: Amount of Loans -->
            <h3 class="table-number" style="margin: 40px 0 10px 0; font-size: 1rem; color: #333;">Table 2: County Summary - Amount of Loans (2020-2024)</h3>
            <div class="table-intro" id="countySummaryAmountIntro" style="margin-bottom: 15px; line-height: 1.6; color: #444;">
                <!-- 2-3 sentences will be populated by JavaScript -->
            </div>
            <div class="table-container">
                <table class="data-table" id="countySummaryTableAmount" role="table" aria-label="County Summary - Amount of Loans">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Variable</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2020</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2021</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2022</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2023</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">2024</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Change (2020→2024)</th>
                        </tr>
                    </thead>
                    <tbody id="countySummaryTableAmountBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p class="table-caption" style="margin-top: 10px; font-size: 0.85rem; color: #666; font-style: italic;">
                Source: FFIEC CRA Small Business Lending Data, compiled by NCRC. Amounts in thousands of dollars.
            </p>
            <div class="table-narrative" id="countySummaryAmountNarrative" role="region" aria-label="County Summary Amount Analysis" style="margin-top: 15px;">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
            <p id="countySummaryAICaption" style="display: none; margin-top: 10px; font-size: 0.85em; font-style: italic; color: #666;">
                Above text is AI generated from NCRC data and analysis
            </p>
        </div>
        
        <!-- Section 3: County, State, and National Comparison (2024) -->
        <div class="report-section print-break" id="section3">
            <h2 class="section-title">Section 3: County, State, and National Comparison (2024)</h2>

            <!-- Table 1: Comparison - Number of Loans -->
            <h3 class="table-number" style="margin: 30px 0 10px 0; font-size: 1rem; color: #333;">Table 1: Geographic Comparison - Number of Loans (2024)</h3>
            <div class="table-intro" id="comparisonNumberIntro" style="margin-bottom: 15px; line-height: 1.6; color: #444;">
                <!-- 2-3 sentences will be populated by JavaScript -->
            </div>
            <div class="table-container">
                <table class="data-table" id="comparisonTableNumber" role="table" aria-label="Comparison - Number of Loans">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Metric</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">County (2024)</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">State (2024)</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">National (2024)</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableNumberBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p class="table-caption" style="margin-top: 10px; font-size: 0.85rem; color: #666; font-style: italic;">
                Source: FFIEC CRA Small Business Lending Data, compiled by NCRC.
            </p>
            <div class="table-narrative" id="comparisonNumberNarrative" role="region" aria-label="Comparison Number Analysis" style="margin-top: 15px;">
                <!-- AI narrative will be populated by JavaScript -->
            </div>

            <!-- Table 2: Comparison - Amount of Loans -->
            <h3 class="table-number" style="margin: 40px 0 10px 0; font-size: 1rem; color: #333;">Table 2: Geographic Comparison - Amount of Loans (2024)</h3>
            <div class="table-intro" id="comparisonAmountIntro" style="margin-bottom: 15px; line-height: 1.6; color: #444;">
                <!-- 2-3 sentences will be populated by JavaScript -->
            </div>
            <div class="table-container">
                <table class="data-table" id="comparisonTableAmount" role="table" aria-label="Comparison - Amount of Loans">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">Metric</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">County (2024)</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">State (2024)</th>
                            <th style="text-align: center; padding: 12px 10px; background: var(--ncrc-primary-blue); color: white;">National (2024)</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableAmountBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p class="table-caption" style="margin-top: 10px; font-size: 0.85rem; color: #666; font-style: italic;">
                Source: FFIEC CRA Small Business Lending Data, compiled by NCRC. Amounts in thousands of dollars.
            </p>
            <div class="table-narrative" id="comparisonAmountNarrative" role="region" aria-label="Comparison Amount Analysis" style="margin-top: 15px;">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
            <p id="comparisonAICaption" style="display: none; margin-top: 10px; font-size: 0.85em; font-style: italic; color: #666;">
                Above text is AI generated from NCRC data and analysis
            </p>
        </div>
        
        <!-- Section 4: Top Lenders (2024) -->
        <div class="report-section print-break" id="section4">
            <h2 class="section-title">Section 4: Top Lenders (2024)</h2>

            <!-- Table 1: Top Lenders - Number of Loans -->
            <h3 class="table-number" style="margin: 30px 0 10px 0; font-size: 1rem; color: #333;">Table 1: Top Lenders - Number of Loans (2024)</h3>
            <div class="table-intro" id="topLendersNumberIntro" style="margin-bottom: 15px; line-height: 1.6; color: #444;">
                <!-- 2-3 sentences will be populated by JavaScript -->
            </div>
            <div class="table-container">
                <div class="table-header">
                    <button class="expand-btn" id="expandTopLendersBtnNumber" onclick="expandTopLendersTable('number')" style="display: none;">
                        <i class="fas fa-chevron-down"></i> Show All Lenders
                    </button>
                </div>
                <table class="data-table collapsible-table" id="topLendersTableNumber" role="table" aria-label="Top Lenders - Number of Loans" style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap; min-width: 180px;" onclick="sortTable('topLendersTableNumber', 0)">Lender Name</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 1)">Total</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 2)">&lt;100K</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 3)">100-250K</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 4)">250K-1M</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 5)">Sm Biz</th>
                            <th id="headerLowNumber" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 6)">Low</th>
                            <th id="headerModNumber" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 7)">Mod</th>
                            <th id="headerMidNumber" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 8)">Mid</th>
                            <th id="headerUpperNumber" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableNumber', 9)">Upper</th>
                        </tr>
                    </thead>
                    <tbody id="topLendersTableBodyNumber">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p class="table-caption" style="margin-top: 10px; font-size: 0.85rem; color: #666; font-style: italic;">
                Source: FFIEC CRA Small Business Lending Data. Column key: &lt;100K/100-250K/250K-1M = loan size categories; Sm Biz = loans to businesses with &lt;$1M revenue; Low/Mod/Mid/Upper = census tract income levels.
            </p>
            <div class="table-narrative" id="topLendersNumberNarrative" role="region" aria-label="Top Lenders Number Analysis" style="margin-top: 15px;">
                <!-- AI narrative will be populated by JavaScript -->
            </div>

            <!-- Table 2: Top Lenders - Amount of Loans -->
            <h3 class="table-number" style="margin: 40px 0 10px 0; font-size: 1rem; color: #333;">Table 2: Top Lenders - Amount of Loans (2024)</h3>
            <div class="table-intro" id="topLendersAmountIntro" style="margin-bottom: 15px; line-height: 1.6; color: #444;">
                <!-- 2-3 sentences will be populated by JavaScript -->
            </div>
            <div class="table-container">
                <div class="table-header">
                    <button class="expand-btn" id="expandTopLendersBtnAmount" onclick="expandTopLendersTable('amount')" style="display: none;">
                        <i class="fas fa-chevron-down"></i> Show All Lenders
                    </button>
                </div>
                <table class="data-table collapsible-table" id="topLendersTableAmount" role="table" aria-label="Top Lenders - Amount of Loans" style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th style="text-align: left; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap; min-width: 180px;" onclick="sortTable('topLendersTableAmount', 0)">Lender Name</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 1)">$000s</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 2)">&lt;100K</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 3)">100-250K</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 4)">250K-1M</th>
                            <th style="text-align: center; padding: 8px 6px; background: var(--ncrc-primary-blue); color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 5)">Sm Biz</th>
                            <th id="headerLowAmount" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 6)">Low</th>
                            <th id="headerModAmount" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 7)">Mod</th>
                            <th id="headerMidAmount" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 8)">Mid</th>
                            <th id="headerUpperAmount" style="text-align: center; padding: 8px 6px; background: #6c757d; color: white; cursor: pointer; white-space: nowrap;" onclick="sortTable('topLendersTableAmount', 9)">Upper</th>
                        </tr>
                    </thead>
                    <tbody id="topLendersTableBodyAmount">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p class="table-caption" style="margin-top: 10px; font-size: 0.85rem; color: #666; font-style: italic;">
                Source: FFIEC CRA Small Business Lending Data. $000s = amounts in thousands. Column key: &lt;100K/100-250K/250K-1M = loan size categories; Sm Biz = loans to businesses with &lt;$1M revenue; Low/Mod/Mid/Upper = census tract income levels.
            </p>
            <div class="table-narrative" id="topLendersAmountNarrative" role="region" aria-label="Top Lenders Amount Analysis" style="margin-top: 15px;">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
            <p id="topLendersAICaption" style="display: none; margin-top: 10px; font-size: 0.85em; font-style: italic; color: #666;">
                Above text is AI generated from NCRC data and analysis
            </p>
        </div>
        
        <!-- Section 5: Market Concentration (Moved to end, before Methods) -->
        <div class="report-section print-break" id="section5" style="margin-top: 40px;">
            <h2 class="section-title">Section 5: Market Concentration</h2>
            <div style="display: flex; gap: 20px; align-items: flex-start;">
                <!-- Intro Text - 1/3 width -->
                <div style="flex: 0 0 33.333%;">
                    <div class="ai-insight-card">
                        <div class="ai-content" id="hhiTrendsIntro">
                            <p>The Herfindahl-Hirschman Index (HHI) is a common measure of market concentration and is used to determine market competitiveness. It is calculated by squaring the market share of each firm in the market and then summing the resulting numbers. The HHI can range from 0 to 10,000. A higher HHI indicates greater market concentration and less competition.</p>
                            <p>This chart and table present the HHI for small business lending in the selected counties across the selected years, providing insight into how competitive the small business lending market is.</p>
                        </div>
                    </div>
                    <p class="table-caption" style="margin-top: 15px;">
                        <strong>Source:</strong> FFIEC CRA Small Business Lending data, compiled and maintained in NCRC's curated databases. 
                        <strong>Methodology:</strong> Herfindahl-Hirschman Index (HHI) is calculated as the sum of the squares of the market shares of all lenders in the market based on total loan amounts. 
                        HHI values range from 0 to 10,000. 
                        <strong>Concentration Levels:</strong> HHI &lt; 1,500 = Low concentration; 1,500-2,500 = Moderate concentration; &gt; 2,500 = High concentration.
                    </p>
                </div>
                
                <!-- Chart and Table - 2/3 width -->
                <div style="flex: 0 0 66.667%;">
                    <h3 class="table-number" style="margin-bottom: 10px; font-size: 1rem; color: #333;">Figure 1: Market Concentration (HHI) by Year</h3>
                    <div class="chart-container" style="height: 400px; margin-bottom: 20px;">
                        <canvas id="hhiByYearChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="table-narrative" id="hhiTrendsDiscussion" role="region" aria-label="Market Concentration Trends Analysis">
                <!-- AI narrative will be populated by JavaScript -->
            </div>
            <p id="hhiTrendsAICaption" style="display: none; margin-top: 10px; font-size: 0.85em; font-style: italic; color: #666;">
                Above text is AI generated from NCRC data and analysis
            </p>
        </div>
        
        <!-- Section 6: Methods, Definitions, and AI Disclosure -->
        <div class="report-section print-break" id="section6" style="margin-top: 40px;">
            <h2 class="section-title">Section 6: Methods, Definitions, and AI Disclosure</h2>
            <div id="methodsContent" style="line-height: 1.8;">
                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Data Sources</h3>
                <p><strong>CRA Small Business Lending Data:</strong> This report uses data collected under the Community Reinvestment Act (CRA), which requires depository institutions to report information about small business loans. The data is collected by the Federal Financial Institutions Examination Council (FFIEC) and includes lending activity from banks regulated by the Office of the Comptroller of the Currency (OCC), Federal Reserve, and Federal Deposit Insurance Corporation (FDIC). For more information, visit the <a href="https://www.ffiec.gov/cra/craproducts.htm" target="_blank">FFIEC CRA website</a>.</p>

                <p><strong>Data Coverage:</strong> CRA small business lending data includes loans with original amounts of $1 million or less for commercial and industrial purposes. The data is reported at the county level and includes information about loan size categories, loans to businesses with revenues under $1 million, and lending in census tracts of different income levels. All institutions regulated by the OCC, Federal Reserve, and FDIC that meet asset size thresholds are subject to reporting requirements.</p>

                <p><strong>NCRC Data Processing:</strong> The data used in this report is sourced from NCRC's curated small business lending databases, compiled and maintained by NCRC Research staff. State and national benchmark data is aggregated from the same FFIEC source data to enable geographic comparisons.</p>

                <p><strong>Important Notes:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li><strong>PPP Impact (2020-2021):</strong> Small business lending volumes in 2020 and 2021 were significantly influenced by the Paycheck Protection Program (PPP), which may result in elevated loan counts and amounts during those years.</li>
                        <li><strong>Section 1071:</strong> Section 1071 of the Dodd-Frank Act, which will require demographic data on small business loan applicants, has not yet been fully implemented. This report does not include borrower demographic information such as race, ethnicity, or gender of business owners.</li>
                    </ul>
                </p>

                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Definitions</h3>

                <p><strong>Small Business Loan:</strong> A loan with an original amount of $1 million or less made for commercial or industrial purposes to businesses.</p>

                <p><strong>Small Business (Revenue Under $1M):</strong> Businesses with gross annual revenues of less than $1 million. CRA regulations require lenders to report the portion of small business loans made to these smaller enterprises.</p>

                <h4 style="margin-top: 15px; color: #333;">Loan Size Categories</h4>
                <ul style="padding-left: 20px;">
                    <li><strong>Under $100K:</strong> Loans with original amounts less than $100,000</li>
                    <li><strong>$100K-$250K:</strong> Loans with original amounts from $100,000 to $250,000</li>
                    <li><strong>$250K-$1M:</strong> Loans with original amounts from $250,000 to $1,000,000</li>
                </ul>

                <h4 style="margin-top: 15px; color: #333;">Census Tract Income Categories</h4>
                <p>Census tract income levels are determined by comparing the tract's median family income to the Area Median Family Income (AMFI):</p>
                <ul style="padding-left: 20px;">
                    <li><strong>Low Income Tract:</strong> Median family income at or below 50% of AMFI</li>
                    <li><strong>Moderate Income Tract:</strong> Median family income greater than 50% but at or below 80% of AMFI</li>
                    <li><strong>Middle Income Tract:</strong> Median family income greater than 80% but at or below 120% of AMFI</li>
                    <li><strong>Upper Income Tract:</strong> Median family income greater than 120% of AMFI</li>
                    <li><strong>LMI Tract:</strong> Low-to-Moderate Income Census Tract - areas where median family income is at or below 80% of AMFI (combines Low and Moderate income tracts)</li>
                </ul>

                <h4 style="margin-top: 15px; color: #333;">Table Column Definitions</h4>
                <ul style="padding-left: 20px;">
                    <li><strong>Total:</strong> Total number or amount of small business loans</li>
                    <li><strong>&lt;100K / 100-250K / 250K-1M:</strong> Percentage of loans in each size category</li>
                    <li><strong>Sm Biz:</strong> Percentage of loans to businesses with annual revenues under $1 million</li>
                    <li><strong>Low / Mod / Mid / Upper:</strong> Percentage of loans in census tracts of each income level</li>
                    <li><strong>$000s:</strong> Dollar amounts expressed in thousands</li>
                </ul>

                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Calculations</h3>

                <p><strong>Percentage Calculations:</strong> All percentages are calculated as: (category value / total value) × 100. For example, the percentage of loans under $100K equals (number of loans under $100K / total number of loans) × 100.</p>

                <p><strong>Change Over Time (pp):</strong> Change is calculated as the difference between the final year value and the baseline year value. For percentages, change is expressed in percentage points (pp). For example, if loans under $100K increased from 89.1% to 96.7%, the change is +7.6 pp. Positive changes are displayed in blue; negative changes in red.</p>

                <p><strong>Dollar Amount Aggregation:</strong> Loan amounts are aggregated from individual lender reports. All dollar figures in tables are expressed in thousands ($000s) or millions ($M) as noted.</p>

                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Market Concentration (HHI)</h3>
                <p><strong>Herfindahl-Hirschman Index (HHI):</strong> A standard measure of market concentration used by regulators including the Department of Justice and Federal Trade Commission. HHI is calculated as the sum of squared market shares of all firms in a market:</p>
                <p style="text-align: center; font-family: monospace; margin: 15px 0;">HHI = Σ(market share<sub>i</sub>)<sup>2</sup></p>
                <p>Market shares are expressed as percentages (0-100), so HHI ranges from 0 to 10,000. Lower values indicate more competitive markets with many lenders; higher values indicate concentrated markets dominated by few lenders.</p>
                <ul style="padding-left: 20px;">
                    <li><strong>HHI &lt; 1,500:</strong> Low concentration (competitive market)</li>
                    <li><strong>HHI 1,500-2,500:</strong> Moderate concentration</li>
                    <li><strong>HHI &gt; 2,500:</strong> High concentration</li>
                </ul>
                <p>In this report, HHI is calculated using the dollar amount of small business loans from all lenders that reported CRA data for the county, not just the top lenders shown in the tables.</p>

                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Abbreviations</h3>
                <ul style="padding-left: 20px; column-count: 2; column-gap: 40px;">
                    <li><strong>ACS:</strong> American Community Survey</li>
                    <li><strong>AMFI:</strong> Area Median Family Income</li>
                    <li><strong>CRA:</strong> Community Reinvestment Act</li>
                    <li><strong>FDIC:</strong> Federal Deposit Insurance Corporation</li>
                    <li><strong>FFIEC:</strong> Federal Financial Institutions Examination Council</li>
                    <li><strong>FIPS:</strong> Federal Information Processing Standards</li>
                    <li><strong>HHI:</strong> Herfindahl-Hirschman Index</li>
                    <li><strong>LMI:</strong> Low-to-Moderate Income</li>
                    <li><strong>NCRC:</strong> National Community Reinvestment Coalition</li>
                    <li><strong>OCC:</strong> Office of the Comptroller of the Currency</li>
                    <li><strong>pp:</strong> Percentage Points</li>
                    <li><strong>PPP:</strong> Paycheck Protection Program</li>
                    <li><strong>Sm Biz:</strong> Small Business (revenue under $1M)</li>
                </ul>

                <h3 style="color: var(--ncrc-primary-blue); margin-top: 20px;">Data Quality and AI Disclosure</h3>
                <p>All data has been cleaned and validated by NCRC Research staff. Users can download the complete dataset via the Export Data option to verify statistics and conduct additional analysis.</p>

                <p><strong>Use of Artificial Intelligence:</strong> This report includes AI-generated narrative content to help interpret data patterns. AI-generated sections are clearly marked with the notation "Above text is AI generated from NCRC data and analysis" appearing directly below each AI narrative. The following content is AI-generated:</p>
                <ul style="padding-left: 20px;">
                    <li>Section 2: County Summary discussion</li>
                    <li>Section 3: Geographic Comparison analysis</li>
                    <li>Section 4: Top Lenders analysis</li>
                    <li>Section 5: Market Concentration trends discussion</li>
                </ul>

                <p><strong>AI Model:</strong> Narrative content is generated using Claude (Anthropic), a large language model. The AI is provided with the data tables and summary statistics and instructed to write in plain, accessible language while focusing on trends and patterns rather than repeating specific numbers from the tables.</p>

                <p><strong>AI Limitations:</strong> AI-generated content is intended to assist readers in understanding data patterns but has limitations. AI may occasionally misinterpret data relationships or draw conclusions not fully supported by the data. AI narratives should be read in conjunction with the underlying data tables, which represent the authoritative source. Users should verify any specific claims or interpretations against the data before citing in research or policy documents.</p>

                <p><strong>Human Review:</strong> All AI-generated content undergoes review for accuracy and appropriateness. However, NCRC cannot guarantee the accuracy of AI interpretations. For questions about methodology or data, contact NCRC Research.</p>

                <p>For official CRA data and documentation, visit the <a href="https://www.ffiec.gov/cra/craproducts.htm" target="_blank">FFIEC CRA Data Products page</a>.</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS disabled - map will be added in future version -->
    <!-- <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> -->
    <script>
        // Base URL for API calls (detect from current URL path)
        const baseUrl = window.location.pathname.includes('/bizsight') ? '/bizsight' : '';

        // Map variables disabled - map will be added in future version
        // let map;
        // let tractLayer;
        // let incomeLayer;
        // let raceLayer;
        // let tractData = [];

        // Get job_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job_id');
        
        // Initialize dropdown functionality
        function initializeDropdowns() {
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            
            if (dropdownToggle && dropdownMenu) {
                dropdownToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isVisible = dropdownMenu.style.display === 'block';
                    dropdownMenu.style.display = isVisible ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!dropdownToggle.contains(e.target) && !dropdownMenu.contains(e.target)) {
                        dropdownMenu.style.display = 'none';
                    }
                });
            }
        }
        
        // Update download links with job_id
        function updateDownloadLinks() {
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job_id');
            
            if (jobId) {
                // Update PDF download link
                const pdfBtn = document.getElementById('downloadPdfBtn');
                if (pdfBtn) {
                    pdfBtn.href = `${baseUrl}/download?format=pdf&job_id=${jobId}`;
                }

                // Update dropdown download links
                const downloadLinks = document.querySelectorAll('.dropdown-item[href*="/download"]');
                downloadLinks.forEach(link => {
                    const currentHref = link.getAttribute('href');
                    // Extract format parameter if present
                    const formatMatch = currentHref.match(/format=([^&]+)/);
                    const format = formatMatch ? formatMatch[1] : 'excel';
                    link.href = `${baseUrl}/download?format=${format}&job_id=${jobId}`;
                });
            }
        }

        function loadReportData(jobId, retryCount = 0) {
            const maxRetries = 10;
            const retryDelay = 1000; // 1 second

            // Add cache-busting timestamp to force fresh data
            const cacheBuster = new Date().getTime();
            fetch(`${baseUrl}/report-data?job_id=${jobId}&_t=${cacheBuster}`)
                .then(r => {
                    if (r.status === 202) {
                        // Analysis still in progress, retry
                        if (retryCount < maxRetries) {
                            console.log(`Analysis still in progress, retrying in ${retryDelay}ms... (attempt ${retryCount + 1}/${maxRetries})`);
                            setTimeout(() => loadReportData(jobId, retryCount + 1), retryDelay);
                            return null;
                        } else {
                            throw new Error('Analysis is taking longer than expected. Please refresh the page.');
                        }
                    }
                    if (r.status === 404) {
                        // Storage might still be in progress, retry
                        if (retryCount < maxRetries) {
                            console.log(`Data not yet available (storage in progress), retrying in ${retryDelay}ms... (attempt ${retryCount + 1}/${maxRetries})`);
                            setTimeout(() => loadReportData(jobId, retryCount + 1), retryDelay);
                            return null;
                        } else {
                            throw new Error('Report not found. Storage may have failed. Please try running a new analysis.');
                        }
                    }
                    return r.json();
                })
                .then(data => {
                    if (!data) return; // Retry in progress
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load report data');
                    }
                    
                    // Update metadata
                    const metadata = data.metadata;
                    document.getElementById('reportMetadata').textContent = 
                        `${metadata.county_name} • Years: ${metadata.year_range}`;
                    
                    // Update summary cards (pass county summary data for 2020 baseline)
                    updateSummaryTable(data.summary_table, data.county_summary_table);

                    // Map functionality disabled - will be added in future version
                    // tractData = data.tract_data_for_map || [];
                    // console.log('Loaded tract data:', tractData.length, 'tracts');
                    // initializeMap(metadata);
                    // const geoid5 = metadata.geoid5;
                    // if (geoid5) {
                    //     fetchTractBoundaries(geoid5);
                    // }

                    // Debug: Log data to console
                    console.log('Report data received:', {
                        county_summary_table: data.county_summary_table,
                        top_lenders_table: data.top_lenders_table,
                        tract_data_for_map: data.tract_data_for_map,
                        summary_table: data.summary_table
                    });
                    
                    // Populate county summary table (Section 2)
                    if (data.county_summary_table && data.county_summary_table.length > 0) {
                        console.log('Populating county summary table with', data.county_summary_table.length, 'rows');
                        populateCountySummaryTable(data.county_summary_table, metadata);
                    } else {
                        console.warn('No county_summary_table data found');
                    }
                    
                    // Populate comparison table (Section 3)
                    if (data.comparison_table && data.comparison_table.length > 0) {
                        console.log('Populating comparison table with', data.comparison_table.length, 'rows');
                        console.log('Comparison table data sample:', data.comparison_table[0]);
                        populateComparisonTable(data.comparison_table, metadata);
                    } else {
                        console.warn('No comparison_table data found');
                        console.warn('Available data keys:', Object.keys(data));
                        // Show error message in the table
                        const tbody = document.getElementById('comparisonTableBody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Comparison data not available. Please check that state and national benchmarks are loaded.</td></tr>';
                        }
                    }
                    
                    // Populate top lenders table (Section 4)
                    if (data.top_lenders_table && data.top_lenders_table.length > 0) {
                        console.log('Populating top lenders table with', data.top_lenders_table.length, 'rows');
                        populateTopLendersTable(data.top_lenders_table, metadata);
                        // Table is already sorted by backend (descending by total loans)
                    } else {
                        console.warn('No top_lenders_table data found');
                        console.warn('Available data keys:', Object.keys(data));
                        // Show error message in the table
                        const tbody = document.getElementById('topLendersTableBody');
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 20px; color: #999;">Top lenders data not available. Please check that disclosure data is loaded.</td></tr>';
                        }
                    }
                    
                    // Populate HHI by year chart (Section 5)
                    if (data.hhi_by_year && data.hhi_by_year.length > 0) {
                        console.log('Populating HHI by year chart with', data.hhi_by_year.length, 'years');
                        populateHHIByYearChart(data.hhi_by_year, metadata);
                    } else {
                        console.warn('No hhi_by_year data found');
                        const chartContainer = document.getElementById('hhiByYearChart');
                        if (chartContainer) {
                            chartContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">HHI trend data not available.</p>';
                        }
                    }
                    
                    // Populate AI narratives
                    console.log('[DEBUG] AI Insights check:', {
                        hasAiInsights: !!data.ai_insights,
                        aiInsightsKeys: data.ai_insights ? Object.keys(data.ai_insights) : [],
                        aiInsightsEnabled: metadata?.ai_insights_enabled,
                        metadataKeys: metadata ? Object.keys(metadata) : []
                    });
                    if (data.ai_insights) {
                        populateAINarratives(data.ai_insights, metadata);
                    } else {
                        console.warn('[WARNING] No AI insights data provided');
                    }
                    
                    // Generate intro paragraph and update Section 1 intro county name
                    generateIntroParagraph(metadata, data.summary_table);
                })
                .catch(error => {
                    console.error('Error loading report data:', error);
                    const errorMsg = error.message || 'Unknown error';
                    document.getElementById('reportMetadata').textContent = 'Error: ' + errorMsg;
                    
                    // If it's a 404 and we haven't retried much, try again
                    if (retryCount < 3 && errorMsg.includes('No analysis data found')) {
                        console.log('Retrying after delay...');
                        setTimeout(() => loadReportData(jobId, retryCount + 1), 2000);
                    }
                });
        }
        
        function initializeMap(metadata) {
            // Initialize map with default center - will be adjusted when tract boundaries load
            const defaultCenter = [39.7392, -75.5394]; // Default center (will be updated)
            
            map = L.map('tractMap').setView(defaultCenter, 11);
            
            // Add base tile layer - use CartoDB Positron for simpler, cleaner basemap
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors, © CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Store metadata for use in layer styling
            window.mapMetadata = metadata;
        }
        
        function fetchTractBoundaries(geoid5) {
            console.log('[DEBUG] Fetching tract boundaries for GEOID5:', geoid5);

            fetch(`${baseUrl}/api/tract-boundaries/${geoid5}`)
                .then(r => {
                    console.log('[DEBUG] Tract boundaries API response status:', r.status);
                    if (!r.ok) {
                        return r.json().then(err => {
                            throw new Error(err.error || `HTTP ${r.status}: ${r.statusText}`);
                        });
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('[DEBUG] Tract boundaries API response:', data);
                    
                    if (!data.success || !data.geojson) {
                        throw new Error(data.error || 'Failed to fetch tract boundaries');
                    }
                    
                    if (!data.geojson.features || data.geojson.features.length === 0) {
                        console.warn('[WARN] No tract features in GeoJSON');
                        createMapLayers(null);
                        return;
                    }
                    
                    console.log('[DEBUG] Tract boundaries fetched:', data.geojson.features.length, 'tracts');
                    console.log('[DEBUG] Sample tract GEOID:', data.geojson.features[0]?.properties?.GEOID);
                    
                    // Calculate county center from tract boundaries
                    let bounds = L.geoJSON(data.geojson).getBounds();
                    if (bounds.isValid()) {
                        const center = bounds.getCenter();
                        map.setView([center.lat, center.lng], 11);
                        console.log('[DEBUG] Map centered on county:', center.lat, center.lng);
                    }
                    
                    // Merge tract data with boundaries
                    const enrichedGeoJSON = enrichGeoJSONWithTractData(data.geojson);
                    console.log('[DEBUG] Enriched GeoJSON, sample tract data:', enrichedGeoJSON.features[0]?.properties);
                    
                    // Create layers with the actual boundaries
                    createMapLayers(enrichedGeoJSON);
                })
                .catch(error => {
                    console.error('[ERROR] Error fetching tract boundaries:', error);
                    console.error('[ERROR] Error stack:', error.stack);
                    // Still create empty layers so the UI doesn't break
                    createMapLayers(null);
                });
        }
        
        function enrichGeoJSONWithTractData(geojson) {
            console.log('[DEBUG] Enriching GeoJSON with tract data. Tract data count:', tractData.length);
            if (tractData.length > 0) {
                console.log('[DEBUG] Sample tract data keys:', Object.keys(tractData[0]));
                console.log('[DEBUG] Sample tract_geoid:', tractData[0].tract_geoid || tractData[0].census_tract_geoid);
            }
            let matchedCount = 0;

            // Helper function to normalize GEOID for comparison
            function normalizeGeoid(geoid) {
                if (!geoid) return '';
                // Convert to string and remove any decimal points (in case of float conversion)
                let str = String(geoid).split('.')[0];
                // Pad with leading zeros to 11 characters if shorter
                if (str.length < 11 && str.length >= 6) {
                    str = str.padStart(11, '0');
                }
                return str;
            }

            // Pre-process tract data for faster lookup
            const tractLookup = new Map();
            tractData.forEach(t => {
                const tractGeoid = t.tract_geoid || t.census_tract_geoid;
                if (tractGeoid) {
                    const normalized = normalizeGeoid(tractGeoid);
                    tractLookup.set(normalized, t);
                    // Also store by last 6 digits (tract portion)
                    if (normalized.length >= 6) {
                        tractLookup.set(normalized.slice(-6), t);
                    }
                }
            });

            console.log('[DEBUG] Tract lookup map size:', tractLookup.size);

            // Add tract data properties to each feature
            geojson.features.forEach((feature, idx) => {
                const geoid = feature.properties.GEOID;

                if (!geoid) {
                    console.warn(`[WARN] Feature ${idx} has no GEOID`);
                    return;
                }

                const normalizedGeoid = normalizeGeoid(geoid);

                // Try to match by normalized full GEOID first, then last 6 digits
                let tract = tractLookup.get(normalizedGeoid);
                if (!tract && normalizedGeoid.length >= 6) {
                    tract = tractLookup.get(normalizedGeoid.slice(-6));
                }

                if (tract) {
                    // Add all tract data to feature properties
                    Object.assign(feature.properties, tract);
                    matchedCount++;
                } else if (idx < 5) {
                    // Log first few unmatched for debugging
                    console.log(`[DEBUG] No match for GEOID ${geoid} (normalized: ${normalizedGeoid}). Sample lookups:`,
                        Array.from(tractLookup.keys()).slice(0, 5));
                }
            });

            console.log(`[DEBUG] Matched ${matchedCount} of ${geojson.features.length} tracts with data`);
            return geojson;
        }
        
        // Helper function to create identical popup for all layers
        function createTractPopup(tract) {
            if (!tract || tract.loan_count === undefined) return null;
            
            const popupId = 'popup-' + (tract.GEOID || tract.tract_geoid || Math.random().toString(36).substr(2, 9));
            
            // Calculate summary statistics
            const totalLoans = tract.loan_count || 0;
            const totalAmount = tract.loan_amount || 0;
            const avgAmountPerLoan = totalLoans > 0 ? (totalAmount / totalLoans) : 0;
            
            // Format amounts
            const formatAmount = (amt) => {
                if (amt >= 1000000) {
                    return '$' + (amt / 1000000).toFixed(1) + 'M';
                } else if (amt >= 1000) {
                    return '$' + (amt / 1000).toFixed(0) + 'K';
                } else {
                    return '$' + amt.toFixed(0);
                }
            };
            
            // Get year amounts for trend calculation
            let yearAmountsData = {};
            if (tract.year_amounts) {
                if (typeof tract.year_amounts === 'string') {
                    try {
                        yearAmountsData = JSON.parse(tract.year_amounts);
                    } catch (e) {
                        yearAmountsData = {};
                    }
                } else if (typeof tract.year_amounts === 'object') {
                    yearAmountsData = tract.year_amounts;
                }
            }
            
            const amounts2020 = (yearAmountsData['2020'] || 0) * 1000;
            const amounts2024 = (yearAmountsData['2024'] || 0) * 1000;
            const trend = amounts2020 > 0 ? ((amounts2024 - amounts2020) / amounts2020 * 100) : 0;
            const trendText = trend > 0 ? `+${trend.toFixed(0)}%` : `${trend.toFixed(0)}%`;
            const trendColor = trend > 0 ? '#28a745' : trend < 0 ? '#dc3545' : '#6c757d';
            
            const popupContent = `
                <div style="min-width: 320px; font-family: Arial, sans-serif;">
                    <div style="border-bottom: 2px solid #2fade3; padding-bottom: 8px; margin-bottom: 12px;">
                        <strong style="font-size: 14px; color: #333;">Tract ${tract.GEOID || tract.tract_geoid}</strong>
                    </div>
                    
                    <div style="margin-bottom: 12px; font-size: 12px; line-height: 1.6;">
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Income Category:</span> 
                            <span style="color: #333;">${tract.income_category || 'Unknown'}</span>
                        </div>
                        ${tract.tract_population ? `
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Population:</span> 
                            <span style="color: #333;">${parseInt(tract.tract_population).toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Total Loans (2020-2024):</span> 
                            <span style="color: #333;">${totalLoans.toLocaleString()}</span>
                        </div>
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Total Amount:</span> 
                            <span style="color: #333;">${formatAmount(totalAmount * 1000)}</span>
                        </div>
                        ${avgAmountPerLoan > 0 ? `
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Avg per Loan:</span> 
                            <span style="color: #333;">${formatAmount(avgAmountPerLoan * 1000)}</span>
                        </div>
                        ` : ''}
                        ${amounts2020 > 0 ? `
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666; font-weight: 600;">Change (2020→2024):</span> 
                            <span style="color: ${trendColor}; font-weight: 600;">${trendText}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 12px; margin-bottom: 8px;">
                        <div style="font-size: 11px; color: #666; font-weight: 600; margin-bottom: 4px;">Loan Amount by Year</div>
                        <div style="font-size: 10px; color: #999; font-style: italic;">Note: 2020-2021 include PPP loans</div>
                    </div>
                    <div id="${popupId}-chart" style="width: 100%; min-width: 300px; height: 280px; margin-top: 8px;"></div>
                </div>
            `;
            
            return {
                content: popupContent,
                popupId: popupId + '-chart',
                tract: tract
            };
        }
        
        function createMapLayers(geojson) {
            console.log('[DEBUG] Creating map layers. GeoJSON:', geojson ? `${geojson.features?.length} features` : 'null');
            
            if (!geojson || !geojson.features || geojson.features.length === 0) {
                console.warn('[WARN] No GeoJSON data, creating empty layers');
                // Create empty layers
                incomeLayer = L.geoJSON([]);
                raceLayer = L.geoJSON([]);
                loanCountLayer = L.geoJSON([]);
                loanAmountLayer = L.geoJSON([]);
            } else {
                // Calculate mean and standard deviation of minority population for the entire county
                const minorityValues = [];
                geojson.features.forEach(feature => {
                    const tract = feature.properties;
                    if (tract && tract.tract_minority_population_percent !== undefined && 
                        tract.tract_minority_population_percent !== null) {
                        minorityValues.push(parseFloat(tract.tract_minority_population_percent));
                    }
                });
                
                let minorityMean = 0;
                let minorityStdDev = 0;
                if (minorityValues.length > 0) {
                    // Calculate mean
                    minorityMean = minorityValues.reduce((sum, val) => sum + val, 0) / minorityValues.length;
                    
                    // Calculate standard deviation
                    const variance = minorityValues.reduce((sum, val) => sum + Math.pow(val - minorityMean, 2), 0) / minorityValues.length;
                    minorityStdDev = Math.sqrt(variance);
                }
                
                console.log(`[DEBUG] Minority population stats: mean=${minorityMean.toFixed(2)}, stdDev=${minorityStdDev.toFixed(2)}`);
                
                // Define category thresholds based on standard deviation
                const lowThreshold = minorityMean - minorityStdDev;
                const moderateThreshold = minorityMean;
                const middleThreshold = minorityMean + minorityStdDev;
                
                console.log(`[DEBUG] Minority thresholds: Low<${lowThreshold.toFixed(2)}, Moderate=${moderateThreshold.toFixed(2)}, Middle=${middleThreshold.toFixed(2)}, Upper>${middleThreshold.toFixed(2)}`);
                // Create income layer
                incomeLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || !tract.tract_to_msa_income_percentage) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const incomePct = tract.tract_to_msa_income_percentage;
                    let color = '#90EE90'; // Default green
                    
                    if (incomePct <= 50) {
                        color = '#FF6B6B'; // Red - Low Income
                    } else if (incomePct <= 80) {
                        color = '#FFD93D'; // Yellow - Moderate Income
                    } else if (incomePct <= 120) {
                        color = '#6BCF7F'; // Light Green - Middle Income
                    } else {
                        color = '#4ECDC4'; // Teal - Upper Income
                    }
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Create race layer with standard deviation categories
            raceLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || tract.tract_minority_population_percent === undefined) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const minorityPct = parseFloat(tract.tract_minority_population_percent || 0);
                    let color = '#E0E0E0'; // Default gray
                    
                    // Categorize based on standard deviation thresholds
                    if (minorityPct < lowThreshold) {
                        color = '#FADBD8'; // Light red - Low minority
                    } else if (minorityPct < moderateThreshold) {
                        color = '#F1948A'; // Medium red - Moderate minority
                    } else if (minorityPct < middleThreshold) {
                        color = '#EC7063'; // Darker red - Middle minority
                    } else {
                        color = '#C0392B'; // Darkest red - Upper minority
                    }
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Create loan count quartile layer
            loanCountLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || tract.loan_count === undefined) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const quartile = tract.loan_count_quartile || 'Q1';
                    let color = '#E8F4F8'; // Q1 - Light blue
                    if (quartile === 'Q2') color = '#AED6F1'; // Q2 - Medium blue
                    else if (quartile === 'Q3') color = '#5DADE2'; // Q3 - Darker blue
                    else if (quartile === 'Q4') color = '#2874A6'; // Q4 - Darkest blue
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Create loan amount quartile layer
            loanAmountLayer = L.geoJSON(geojson, {
                style: function(feature) {
                    // Tract data is already in feature.properties from enrichGeoJSONWithTractData
                    const tract = feature.properties;
                    if (!tract || tract.loan_amount === undefined) {
                        return {color: '#ccc', fillOpacity: 0.3, weight: 1};
                    }
                    
                    const quartile = tract.loan_amount_quartile || 'Q1';
                    let color = '#FADBD8'; // Q1 - Light red
                    if (quartile === 'Q2') color = '#F1948A'; // Q2 - Medium red
                    else if (quartile === 'Q3') color = '#EC7063'; // Q3 - Darker red
                    else if (quartile === 'Q4') color = '#C0392B'; // Q4 - Darkest red
                    
                    return {
                        color: '#333',
                        weight: 1,
                        fillColor: color,
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    const tract = feature.properties;
                    const popup = createTractPopup(tract);
                    if (popup) {
                        layer.bindPopup(popup.content, {
                            maxWidth: 450
                        });
                        
                        // Create column chart when popup opens
                        layer.on('popupopen', function() {
                            setTimeout(() => {
                                createTractPopupChart(popup.popupId, popup.tract);
                            }, 100);
                        });
                    }
                }
            });
            
            // Layer controls (radio buttons - only one active at a time)
            document.querySelectorAll('input[name="mapLayer"]').forEach(radio => {
                radio.addEventListener('change', function(e) {
                    // Remove all layers
                    map.eachLayer(function(layer) {
                        if (layer !== map._layers[Object.keys(map._layers)[0]]) { // Keep base layer
                            map.removeLayer(layer);
                        }
                    });
                    
                    // Add selected layer
                    if (e.target.value === 'income') {
                        incomeLayer.addTo(map);
                        updateLegend('income');
                    } else if (e.target.value === 'race') {
                        raceLayer.addTo(map);
                        updateLegend('race');
                    } else if (e.target.value === 'loanCount') {
                        loanCountLayer.addTo(map);
                        updateLegend('loanCount');
                    } else if (e.target.value === 'loanAmount') {
                        loanAmountLayer.addTo(map);
                        updateLegend('loanAmount');
                    }
                });
            });
            
            // Show income layer by default
            const incomeRadio = document.getElementById('incomeLayer');
            if (incomeRadio && incomeRadio.checked && geojson && geojson.features && geojson.features.length > 0) {
                if (incomeLayer) {
                    incomeLayer.addTo(map);
                    updateLegend('income');
                    console.log('[DEBUG] Income layer added to map');
                }
            }
            
            console.log('[DEBUG] Map layers created successfully');
            } // Close else block
        }
        
        let loanCountLayer;
        let loanAmountLayer;
        
        function updateLegend(type) {
            const legendContent = document.getElementById('legendContent');
            
            if (type === 'income') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>Low Income (≤50% AMI)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FFD93D;"></div>
                        <span>Moderate Income (50-80% AMI)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #6BCF7F;"></div>
                        <span>Middle Income (80-120% AMI)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ECDC4;"></div>
                        <span>Upper Income (>120% AMI)</span>
                    </div>
                `;
            } else if (type === 'race') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FADBD8;"></div>
                        <span>Low Minority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #F1948A;"></div>
                        <span>Moderate Minority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #EC7063;"></div>
                        <span>Middle Minority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #C0392B;"></div>
                        <span>Upper Minority</span>
                    </div>
                `;
            } else if (type === 'loanCount') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #E8F4F8;"></div>
                        <span>Q1 (Lowest 25%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #AED6F1;"></div>
                        <span>Q2 (25-50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #5DADE2;"></div>
                        <span>Q3 (50-75%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2874A6;"></div>
                        <span>Q4 (Highest 25%)</span>
                    </div>
                `;
            } else if (type === 'loanAmount') {
                legendContent.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FADBD8;"></div>
                        <span>Q1 (Lowest 25%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #F1948A;"></div>
                        <span>Q2 (25-50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #EC7063;"></div>
                        <span>Q3 (50-75%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #C0392B;"></div>
                        <span>Q4 (Highest 25%)</span>
                    </div>
                `;
            }
        }
        
        function populateCountySummaryTable(data, metadata, summaryTable) {
            if (!data || data.length === 0) return;
            
            const tbodyNumber = document.getElementById('countySummaryTableNumberBody');
            const tbodyAmount = document.getElementById('countySummaryTableAmountBody');
            if (!tbodyNumber || !tbodyAmount) return;
            
            // Data is now a DataFrame-like structure with Variable column and year columns
            const years = ['2020', '2021', '2022', '2023', '2024'];
            
            // Format value based on variable name
            function formatValue(varName, value) {
                if (value === null || value === undefined || isNaN(value)) return '-';
                
                // Check for percentage indicators FIRST (before other checks)
                if (varName.includes('%') || varName.includes('(% of Total)')) {
                    // Percentage format: ##.#%
                    return parseFloat(value).toFixed(1) + '%';
                } else if (varName === 'Total Loans') {
                    // Integer format for total loans only
                    return parseInt(value).toLocaleString();
                } else if (varName.includes('Total Loan Amount')) {
                    // Dollar format (in millions with 1 decimal place and commas)
                    const amount = parseFloat(value);
                    // Amount is in thousands, convert to millions
                    const millions = amount / 1000;
                    // Format to 1 decimal place with commas for readability
                    if (millions === 0) return '$0.0';
                    const millionsFormatted = millions.toLocaleString('en-US', {
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 1
                    });
                    return '$' + millionsFormatted;
                } else if (varName.includes('Amount') && !varName.includes('%')) {
                    // Other amount fields (in thousands)
                    const amount = parseFloat(value);
                    if (amount >= 1000) {
                        const thousands = amount / 1000;
                        const thousandsFormatted = thousands.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                        return '$' + thousandsFormatted + 'K';
                    } else {
                        return '$' + amount.toLocaleString('en-US', {maximumFractionDigits: 0});
                    }
                } else {
                    // Default: format as number
                    return parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 2});
                }
            }
            
            // Separate data into number and amount rows
            const numberRows = [];
            const amountRows = [];
            
            data.forEach(row => {
                const varName = row['Variable'] || row['variable'] || '';
                // Check if this is a loan count row or amount row
                if (varName.includes('Total Loans') || 
                    (varName.includes('Loans') && !varName.includes('Amount'))) {
                    numberRows.push(row);
                } else if (varName.includes('Amount') || varName.includes('Total Loan Amount')) {
                    amountRows.push(row);
                }
            });
            
            // Helper function to calculate change
            const calculateChange = (varName, value2020, value2024) => {
                if (value2020 === null || value2020 === undefined || isNaN(value2020) ||
                    value2024 === null || value2024 === undefined || isNaN(value2024)) {
                    return '-';
                }
                
                const val2020 = parseFloat(value2020);
                const val2024 = parseFloat(value2024);
                
                // For Total Loans (integers), calculate percentage change
                if (varName === 'Total Loans') {
                    if (val2020 === 0) return '-';
                    const pctChange = ((val2024 - val2020) / val2020) * 100;
                    const sign = pctChange >= 0 ? '+' : '';
                    return `${sign}${pctChange.toFixed(1)}%`;
                }
                // For percentage rows, calculate percentage point change
                else if (varName.includes('%') || varName.includes('(% of Total)')) {
                    const ppChange = val2024 - val2020;
                    const sign = ppChange >= 0 ? '+' : '';
                    return `${sign}${ppChange.toFixed(2)} pp`;
                }
                // For other rows (like Total Loan Amount), calculate percentage change
                else {
                    if (val2020 === 0) return '-';
                    const pctChange = ((val2024 - val2020) / val2020) * 100;
                    const sign = pctChange >= 0 ? '+' : '';
                    return `${sign}${pctChange.toFixed(1)}%`;
                }
            };
            
            // Build number table rows
            let numberRowsHtml = '';
            numberRows.forEach(row => {
                const varName = row['Variable'] || row['variable'] || '';
                numberRowsHtml += '<tr>';
                // First column: auto-width, no-wrap (matching LendSight)
                numberRowsHtml += `<td style="text-align: left; padding: 12px 10px; font-weight: 600; border-bottom: 1px solid #e0e0e0; white-space: nowrap; width: auto; min-width: 0; max-width: none;">${varName}</td>`;
                
                years.forEach(year => {
                    const value = row[year] !== undefined ? row[year] : (row[year.toLowerCase()] !== undefined ? row[year.toLowerCase()] : null);
                    const formatted = formatValue(varName, value);
                    // Other columns: fixed 100px width (matching LendSight)
                    numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatted}</td>`;
                });
                
                // Add change column
                const value2020 = row['2020'] !== undefined ? row['2020'] : (row['2020'] !== undefined ? row['2020'] : null);
                const value2024 = row['2024'] !== undefined ? row['2024'] : (row['2024'] !== undefined ? row['2024'] : null);
                const change = calculateChange(varName, value2020, value2024);
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; font-weight: 500;">${change}</td>`;
                
                numberRowsHtml += '</tr>';
            });
            
            // Build amount table rows with proper column widths (matching LendSight)
            let amountRowsHtml = '';
            let totalAmountByYear = {}; // Store total amounts by year for LMI calculation
            
            amountRows.forEach(row => {
                const varName = row['Variable'] || row['variable'] || '';
                
                // Store total amount for LMI calculation
                if (varName.includes('Total Loan Amount')) {
                    years.forEach(year => {
                        const value = row[year] !== undefined ? row[year] : (row[year.toLowerCase()] !== undefined ? row[year.toLowerCase()] : null);
                        if (value !== null && value !== undefined && !isNaN(value)) {
                            totalAmountByYear[year] = parseFloat(value); // in thousands
                        }
                    });
                }
                
                amountRowsHtml += '<tr>';
                // First column: auto-width, no-wrap (matching LendSight)
                amountRowsHtml += `<td style="text-align: left; padding: 12px 10px; font-weight: 600; border-bottom: 1px solid #e0e0e0; white-space: nowrap; width: auto; min-width: 0; max-width: none;">${varName}</td>`;
                
                years.forEach(year => {
                    const value = row[year] !== undefined ? row[year] : (row[year.toLowerCase()] !== undefined ? row[year.toLowerCase()] : null);
                    const formatted = formatValue(varName, value);
                    // Other columns: fixed 100px width (matching LendSight)
                    amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatted}</td>`;
                });
                
                // Add change column
                const value2020 = row['2020'] !== undefined ? row['2020'] : (row['2020'] !== undefined ? row['2020'] : null);
                const value2024 = row['2024'] !== undefined ? row['2024'] : (row['2024'] !== undefined ? row['2024'] : null);
                const change = calculateChange(varName, value2020, value2024);
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; font-weight: 500;">${change}</td>`;
                
                amountRowsHtml += '</tr>';
            });
            
            // Check if LMI Amount row already exists in the data (from backend)
            let hasLMIAmountRow = false;
            amountRows.forEach(row => {
                const varName = row['Variable'] || row['variable'] || '';
                if (varName.includes('Amount to LMI Tracts')) {
                    hasLMIAmountRow = true;
                }
            });
            
            // Add LMI Amount row if it doesn't exist in the data
            // (Backend should now provide this, but add as fallback if missing)
            if (!hasLMIAmountRow) {
                // Try to find it in the data first
                let lmiAmountRow = null;
                data.forEach(row => {
                    const varName = row['Variable'] || row['variable'] || '';
                    if (varName.includes('Amount to LMI Tracts')) {
                        lmiAmountRow = row;
                    }
                });
                
                if (lmiAmountRow) {
                    // Add the row that was found
                    const varName = lmiAmountRow['Variable'] || lmiAmountRow['variable'] || '';
                    amountRowsHtml += '<tr>';
                    amountRowsHtml += `<td style="text-align: left; padding: 12px 10px; font-weight: 600; border-bottom: 1px solid #e0e0e0;">${varName}</td>`;
                    
                    years.forEach(year => {
                        const value = lmiAmountRow[year] !== undefined ? lmiAmountRow[year] : (lmiAmountRow[year.toLowerCase()] !== undefined ? lmiAmountRow[year.toLowerCase()] : null);
                        const formatted = formatValue(varName, value);
                        amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatted}</td>`;
                    });
                    
                    // Add change column for LMI row
                    const value2020 = lmiAmountRow['2020'] !== undefined ? lmiAmountRow['2020'] : (lmiAmountRow['2020'] !== undefined ? lmiAmountRow['2020'] : null);
                    const value2024 = lmiAmountRow['2024'] !== undefined ? lmiAmountRow['2024'] : (lmiAmountRow['2024'] !== undefined ? lmiAmountRow['2024'] : null);
                    const change = calculateChange(varName, value2020, value2024);
                    amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; font-weight: 500;">${change}</td>`;
                    
                    amountRowsHtml += '</tr>';
                }
            }
            
            tbodyNumber.innerHTML = numberRowsHtml;
            tbodyAmount.innerHTML = amountRowsHtml;

            // Populate Table 1 introduction (Number of Loans - 2-3 sentences)
            const introNumber = document.getElementById('countySummaryNumberIntro');
            if (introNumber && metadata) {
                const yearRange = metadata.year_range || '2020-2024';
                introNumber.textContent = `Table 1 presents the number of small business loans originated in ${metadata.county_name} from ${yearRange}. The data is broken down by loan size category and shows lending to businesses with revenue under $1 million. The rightmost column shows the percentage change comparing 2024 to the 2020 baseline.`;
            }

            // Populate Table 2 introduction (Amount of Loans - 2-3 sentences)
            const introAmount = document.getElementById('countySummaryAmountIntro');
            if (introAmount && metadata) {
                const yearRange = metadata.year_range || '2020-2024';
                introAmount.textContent = `Table 2 shows the dollar amount of small business loans (in thousands) originated in ${metadata.county_name} from ${yearRange}. The breakdown by loan size category reveals patterns in how lending volume is distributed. Note that 2020 and 2021 data may be influenced by Paycheck Protection Program (PPP) lending activity.`;
            }
            
            // Populate caption
            const caption = document.getElementById('countySummaryCaption');
            if (caption && metadata) {
                let captionText = '<strong>Source:</strong> Community Reinvestment Act (CRA) Small Business Lending data, compiled and maintained in NCRC\'s curated databases. ';
                captionText += `<strong>Years:</strong> ${metadata.year_range || '2020-2024'}. `;
                captionText += `<strong>County:</strong> ${metadata.county_name || 'Unknown'}. `;
                captionText += '<strong>Note:</strong> Data for 2020 and 2021 are distorted by the Paycheck Protection Program (PPP) lending activity.';
                caption.innerHTML = captionText;
            }
        }
        
        function populateComparisonTable(data, metadata) {
            if (!data || data.length === 0) {
                console.warn('populateComparisonTable: No data provided');
                return;
            }
            
            const tbodyNumber = document.getElementById('comparisonTableNumberBody');
            const tbodyAmount = document.getElementById('comparisonTableAmountBody');
            if (!tbodyNumber || !tbodyAmount) {
                console.error('populateComparisonTable: comparison table body elements not found');
                return;
            }
            
            console.log('populateComparisonTable: Processing', data.length, 'rows');
            
            // Separate data into number and amount rows
            const numberRows = [];
            const amountRows = [];
            
            data.forEach(row => {
                const metric = row['Metric'] || row['metric'] || '';
                if (metric.includes('Amount') || metric.includes('Total Loan Amount')) {
                    amountRows.push(row);
                } else {
                    numberRows.push(row);
                }
            });
            
            // Format value based on metric type
            function formatComparisonValue(metric, value, column) {
                if (value === null || value === undefined || isNaN(value)) {
                    return column === 'Change' ? '-' : '-';
                }
                
                // Check metric type
                if (metric.includes('%') || metric.includes('(% of Total)')) {
                    // Percentage format: ##.#%
                    return parseFloat(value).toFixed(1) + '%';
                } else if (metric === 'Total Loans') {
                    // Integer format
                    return parseInt(value).toLocaleString();
                } else if (metric.includes('Total Loan Amount')) {
                    // Dollar format - amounts are in thousands, so multiply by 1000 to get actual amount
                    const amount = parseFloat(value) * 1000;  // Convert from thousands to actual
                    if (amount >= 1000000) {
                        const millions = amount / 1000000;
                        // Format millions with commas for readability (e.g., 21,087.9M instead of 21087.9M)
                        const millionsFormatted = millions.toLocaleString('en-US', {
                            minimumFractionDigits: 1,
                            maximumFractionDigits: 1
                        });
                        return '$' + millionsFormatted + 'M';
                    } else if (amount >= 1000) {
                        const thousands = amount / 1000;
                        return '$' + thousands.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }) + 'K';
                    } else {
                        return '$' + amount.toLocaleString('en-US', {maximumFractionDigits: 0});
                    }
                } else if (column === 'Change') {
                    // Percentage change format
                    if (value === null || value === undefined || isNaN(value)) {
                        return '-';
                    }
                    return (value >= 0 ? '+' : '') + parseFloat(value).toFixed(1) + '%';
                } else {
                    // Default: format as number
                    return parseFloat(value).toLocaleString('en-US', {maximumFractionDigits: 2});
                }
            }
            
            // Build number table rows (3 columns: County, State, National - no Change column)
            let numberRowsHtml = '';
            numberRows.forEach(row => {
                const metric = row['Metric'] || row['metric'] || '';
                numberRowsHtml += '<tr>';
                numberRowsHtml += `<td style="text-align: left; padding: 12px 10px; font-weight: 600; border-bottom: 1px solid #e0e0e0; white-space: nowrap;">${metric}</td>`;
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['County (2024)'], 'County (2024)')}</td>`;
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['State (2024)'], 'State (2024)')}</td>`;
                numberRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['National (2024)'], 'National (2024)')}</td>`;
                numberRowsHtml += '</tr>';
            });

            // Build amount table rows (3 columns: County, State, National - no Change column)
            let amountRowsHtml = '';
            amountRows.forEach(row => {
                const metric = row['Metric'] || row['metric'] || '';
                amountRowsHtml += '<tr>';
                amountRowsHtml += `<td style="text-align: left; padding: 12px 10px; font-weight: 600; border-bottom: 1px solid #e0e0e0; white-space: nowrap;">${metric}</td>`;
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['County (2024)'], 'County (2024)')}</td>`;
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['State (2024)'], 'State (2024)')}</td>`;
                amountRowsHtml += `<td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0;">${formatComparisonValue(metric, row['National (2024)'], 'National (2024)')}</td>`;
                amountRowsHtml += '</tr>';
            });
            
            tbodyNumber.innerHTML = numberRowsHtml;
            tbodyAmount.innerHTML = amountRowsHtml;

            // Populate Table 1 introduction (Number of Loans - 2-3 sentences)
            const introNumber = document.getElementById('comparisonNumberIntro');
            if (introNumber && metadata) {
                introNumber.textContent = `Table 1 compares the number of small business loans in ${metadata.county_name} with state (${metadata.state_name || 'statewide'}) and national benchmarks for 2024. This comparison helps identify whether local lending patterns are consistent with broader trends or represent unique local market conditions.`;
            }

            // Populate Table 2 introduction (Amount of Loans - 2-3 sentences)
            const introAmount = document.getElementById('comparisonAmountIntro');
            if (introAmount && metadata) {
                introAmount.textContent = `Table 2 compares the dollar amount of small business lending in ${metadata.county_name} with state and national figures for 2024. Loan amounts (in thousands) reveal how local lending volume compares to broader geographic benchmarks.`;
            }
            
            // Populate caption
            const caption = document.getElementById('comparisonCaption');
            if (caption && metadata) {
                let captionText = '<strong>Source:</strong> Community Reinvestment Act (CRA) Small Business Lending data, compiled and maintained in NCRC\'s curated databases. ';
                captionText += '<strong>Year:</strong> 2024. ';
                captionText += `<strong>County:</strong> ${metadata.county_name || 'Unknown'}. `;
                captionText += `<strong>State:</strong> ${metadata.state_name || 'Unknown'}. `;
                captionText += '<strong>% Change:</strong> For absolute values (loans/dollars), calculated as ((2024 value - 2020 value) / 2020 value) × 100. For percentage metrics, calculated as the percentage change in the underlying absolute values (dollars or loans), not the change in percentage shares. Compares 2020 (baseline) to 2024 (most recent) periods.';
                caption.innerHTML = captionText;
            }
        }
        
        function populateAINarratives(aiInsights, metadata) {
            // Check if AI insights are disabled
            const aiDisabled = metadata && metadata.ai_insights_enabled === false;
            const getAIDisabledMessage = () => {
                return '<div class="alert alert-info" style="padding: 15px; margin: 15px 0; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px;"><strong>AI Insights Not Available:</strong> AI-powered analysis is currently disabled. To enable AI insights, please configure the CLAUDE_API_KEY environment variable in your deployment settings.</div>';
            };
            
            // Key Findings Section
            if (aiInsights.key_findings && aiInsights.key_findings.trim().length > 0) {
                const keyFindingsEl = document.getElementById('keyFindingsContent');
                const keyFindingsSection = document.getElementById('keyFindingsSection');
                if (keyFindingsEl && keyFindingsSection) {
                    let text = aiInsights.key_findings.trim();
                    // Split by bullet points or newlines
                    let findings = text.split(/[•\-\*]\s+/).filter(f => f.trim().length > 0);
                    if (findings.length === 0) {
                        // Try splitting by newlines
                        findings = text.split(/\n+/).filter(f => f.trim().length > 0);
                    }
                    // Format as bullet list
                    const findingsHtml = findings.map(f => {
                        const finding = f.trim().replace(/^[•\-\*]\s*/, '');
                        return `<p style="margin-bottom: 12px; padding-left: 1.5em; text-indent: -1.5em;"><strong>•</strong> ${finding}${finding.endsWith('.') ? '' : '.'}</p>`;
                    }).join('');
                    keyFindingsEl.innerHTML = findingsHtml;
                    keyFindingsSection.style.display = 'block';
                }
            } else {
                const keyFindingsEl = document.getElementById('keyFindingsContent');
                const keyFindingsSection = document.getElementById('keyFindingsSection');
                if (keyFindingsEl && keyFindingsSection) {
                    if (aiDisabled) {
                        keyFindingsEl.innerHTML = getAIDisabledMessage();
                        keyFindingsSection.style.display = 'block';
                    }
                }
            }
            
            // County Summary Discussion (Section 2) - goes after Table 2 (Amount)
            // Helper function to format paragraphs
            const formatParagraphs = (text) => {
                let paragraphs = text.split(/\n\n+/);
                if (paragraphs.length === 1) {
                    paragraphs = text.split(/\.\s+(?=[A-Z])/);
                }
                if (paragraphs.length === 1) {
                    paragraphs = text.split(/\n+/);
                }
                return paragraphs
                    .filter(p => p.trim().length > 0)
                    .map(p => p.trim().replace(/\n/g, ' '))
                    .map(p => `<p style="margin-bottom: 15px;">${p}${p.endsWith('.') ? '' : '.'}</p>`)
                    .join('');
            };

            // County Summary Discussion (Section 2) - Table 1 (Number of Loans)
            if (aiInsights.county_summary_number_discussion && aiInsights.county_summary_number_discussion.trim().length > 0) {
                const formattedNarrative = formatParagraphs(aiInsights.county_summary_number_discussion.trim());
                const discussionEl1 = document.getElementById('countySummaryNumberNarrative');
                if (discussionEl1) {
                    discussionEl1.innerHTML = formattedNarrative;
                }
            } else {
                const discussionEl = document.getElementById('countySummaryNumberNarrative');
                if (discussionEl) {
                    if (aiDisabled) {
                        discussionEl.innerHTML = getAIDisabledMessage();
                    } else {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this table is not available.</p>';
                    }
                }
            }

            // County Summary Discussion (Section 2) - Table 2 (Amount of Loans)
            if (aiInsights.county_summary_amount_discussion && aiInsights.county_summary_amount_discussion.trim().length > 0) {
                const formattedNarrative = formatParagraphs(aiInsights.county_summary_amount_discussion.trim());
                const discussionEl2 = document.getElementById('countySummaryAmountNarrative');
                if (discussionEl2) {
                    discussionEl2.innerHTML = formattedNarrative;
                }
                const aiCaption = document.getElementById('countySummaryAICaption');
                if (aiCaption) {
                    aiCaption.style.display = 'block';
                }
            } else {
                const discussionEl = document.getElementById('countySummaryAmountNarrative');
                if (discussionEl) {
                    if (aiDisabled) {
                        discussionEl.innerHTML = getAIDisabledMessage();
                    } else {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this table is not available.</p>';
                    }
                }
            }

            // Comparison Discussion (Section 3) - Table 1 (Number of Loans)
            if (aiInsights.comparison_number_discussion && aiInsights.comparison_number_discussion.trim().length > 0) {
                const formattedNarrative = formatParagraphs(aiInsights.comparison_number_discussion.trim());
                const discussionEl1 = document.getElementById('comparisonNumberNarrative');
                if (discussionEl1) {
                    discussionEl1.innerHTML = formattedNarrative;
                }
            } else {
                const discussionEl = document.getElementById('comparisonNumberNarrative');
                if (discussionEl) {
                    if (aiDisabled) {
                        discussionEl.innerHTML = getAIDisabledMessage();
                    } else {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this table is not available.</p>';
                    }
                }
            }

            // Comparison Discussion (Section 3) - Table 2 (Amount of Loans)
            if (aiInsights.comparison_amount_discussion && aiInsights.comparison_amount_discussion.trim().length > 0) {
                const formattedNarrative = formatParagraphs(aiInsights.comparison_amount_discussion.trim());
                const discussionEl2 = document.getElementById('comparisonAmountNarrative');
                if (discussionEl2) {
                    discussionEl2.innerHTML = formattedNarrative;
                }
                const aiCaption = document.getElementById('comparisonAICaption');
                if (aiCaption) {
                    aiCaption.style.display = 'block';
                }
            } else {
                const discussionEl = document.getElementById('comparisonAmountNarrative');
                if (discussionEl) {
                    if (aiDisabled) {
                        discussionEl.innerHTML = getAIDisabledMessage();
                    } else {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this table is not available.</p>';
                    }
                }
            }
            
            // HHI Trends Discussion (Section 5)
            if (aiInsights.hhi_trends_discussion) {
                const discussionEl = document.getElementById('hhiTrendsDiscussion');
                if (discussionEl) {
                    discussionEl.innerHTML = formatParagraphs(aiInsights.hhi_trends_discussion.trim());
                    discussionEl.style.display = 'block';
                    const aiCaption = document.getElementById('hhiTrendsAICaption');
                    if (aiCaption) {
                        aiCaption.style.display = 'block';
                    }
                }
            } else {
                const discussionEl = document.getElementById('hhiTrendsDiscussion');
                if (discussionEl) {
                    if (aiDisabled) {
                        discussionEl.innerHTML = getAIDisabledMessage();
                    } else {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this section is not available.</p>';
                    }
                    discussionEl.style.display = 'block';
                }
            }
            
            // Top Lenders Discussion (Section 4) - Table 1 (Number of Loans)
            if (aiInsights.top_lenders_number_discussion && aiInsights.top_lenders_number_discussion.trim().length > 0) {
                const formattedNarrative = formatParagraphs(aiInsights.top_lenders_number_discussion.trim());
                const discussionEl1 = document.getElementById('topLendersNumberNarrative');
                if (discussionEl1) {
                    discussionEl1.innerHTML = formattedNarrative;
                }
            } else {
                const discussionEl = document.getElementById('topLendersNumberNarrative');
                if (discussionEl) {
                    if (aiDisabled) {
                        discussionEl.innerHTML = getAIDisabledMessage();
                    } else {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this table is not available.</p>';
                    }
                }
            }

            // Top Lenders Discussion (Section 4) - Table 2 (Amount of Loans)
            if (aiInsights.top_lenders_amount_discussion && aiInsights.top_lenders_amount_discussion.trim().length > 0) {
                const formattedNarrative = formatParagraphs(aiInsights.top_lenders_amount_discussion.trim());
                const discussionEl2 = document.getElementById('topLendersAmountNarrative');
                if (discussionEl2) {
                    discussionEl2.innerHTML = formattedNarrative;
                }
                const aiCaption = document.getElementById('topLendersAICaption');
                if (aiCaption) {
                    aiCaption.style.display = 'block';
                }
            } else {
                const discussionEl = document.getElementById('topLendersAmountNarrative');
                if (discussionEl) {
                    if (aiDisabled) {
                        discussionEl.innerHTML = getAIDisabledMessage();
                    } else {
                        discussionEl.innerHTML = '<p>AI-generated analysis for this table is not available.</p>';
                    }
                }
            }
        }
        
        function populateTopLendersTable(data, metadata) {
            console.log('populateTopLendersTable called with:', data);
            if (!data || data.length === 0) {
                console.warn('No data provided to populateTopLendersTable');
                return;
            }
            
            const tbodyNumber = document.getElementById('topLendersTableBodyNumber');
            const tbodyAmount = document.getElementById('topLendersTableBodyAmount');
            
            if (!tbodyNumber || !tbodyAmount) {
                console.error('Top lenders table body elements not found');
                return;
            }
            
            // Format helpers
            const formatNumTotal = (val) => {
                if (val === null || val === undefined || isNaN(val)) return '0';
                return parseInt(val).toLocaleString();
            };
            
            const formatPercent = (val) => {
                if (val === null || val === undefined || isNaN(val)) return '0.0%';
                // Format: ##.#%
                return parseFloat(val).toFixed(1) + '%';
            };
            
            const formatDollarAmount = (val) => {
                if (val === null || val === undefined || isNaN(val)) return '$0';
                // Amount is in thousands, format with commas
                const amount = parseFloat(val);
                return '$' + amount.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            };
            
            // Build Number of Loans table
            tbodyNumber.innerHTML = data.map((row, rowIndex) => {
                const isHidden = (data.length > 10 && rowIndex >= 10) ? 'style="display: none;"' : '';
                const lowIncomeStyle = 'background: #f0f0f0;';
                const moderateIncomeStyle = 'background: #f0f0f0;';
                
                return `
                    <tr data-index="${rowIndex}" ${isHidden}>
                        <td style="text-align: left; padding: 8px; font-weight: 600; border-bottom: 1px solid #e0e0e0; white-space: nowrap; min-width: 450px; width: auto;">${row['Lender Name'] || ''}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatNumTotal(row['Num Total'])}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Num Under 100K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Num 100K 250K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Num 250K 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Numsb Under 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto; ${lowIncomeStyle}">${formatPercent(row['Low Income %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto; ${moderateIncomeStyle}">${formatPercent(row['Moderate Income %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Middle Income %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Upper Income %'] || 0)}</td>
                    </tr>
                `;
            }).join('');
            
            // Build Amount of Loans table
            tbodyAmount.innerHTML = data.map((row, rowIndex) => {
                const isHidden = (data.length > 10 && rowIndex >= 10) ? 'style="display: none;"' : '';
                const lowIncomeStyle = 'background: #f0f0f0;';
                const moderateIncomeStyle = 'background: #f0f0f0;';
                
                return `
                    <tr data-index="${rowIndex}" ${isHidden}>
                        <td style="text-align: left; padding: 8px; font-weight: 600; border-bottom: 1px solid #e0e0e0; white-space: nowrap; min-width: 450px; width: auto;">${row['Lender Name'] || ''}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatDollarAmount(row['Amt Total'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Amt Under 100K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Amt 100K 250K %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Amt 250K 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Amtsb Under 1M %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto; ${lowIncomeStyle}">${formatPercent(row['Low Income Amt %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto; ${moderateIncomeStyle}">${formatPercent(row['Moderate Income Amt %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Middle Income Amt %'] || 0)}</td>
                        <td style="text-align: center; padding: 12px 10px; border-bottom: 1px solid #e0e0e0; width: auto;">${formatPercent(row['Upper Income Amt %'] || 0)}</td>
                    </tr>
                `;
            }).join('');
            
            // Show expand buttons if there are more than 10 lenders
            if (data.length > 10) {
                const expandBtnNumber = document.getElementById('expandTopLendersBtnNumber');
                const expandBtnAmount = document.getElementById('expandTopLendersBtnAmount');
                if (expandBtnNumber) expandBtnNumber.style.display = 'inline-block';
                if (expandBtnAmount) expandBtnAmount.style.display = 'inline-block';
            }
            
            // Check which income categories exist and add asterisks to headers
            const incomeCategories = metadata.income_categories_exist || {};
            const missingCategories = [];
            
            // Update headers with asterisks for missing categories
            if (!incomeCategories.low_income) {
                const headerLowNumber = document.getElementById('headerLowIncomeNumber');
                const headerLowAmount = document.getElementById('headerLowIncomeAmount');
                if (headerLowNumber) headerLowNumber.innerHTML = 'Low Income (%)* <i class="fas fa-sort"></i>';
                if (headerLowAmount) headerLowAmount.innerHTML = 'Low Income (%)* <i class="fas fa-sort"></i>';
                missingCategories.push('Low Income');
            }
            if (!incomeCategories.moderate_income) {
                const headerModNumber = document.getElementById('headerModerateIncomeNumber');
                const headerModAmount = document.getElementById('headerModerateIncomeAmount');
                if (headerModNumber) headerModNumber.innerHTML = 'Moderate Income (%)* <i class="fas fa-sort"></i>';
                if (headerModAmount) headerModAmount.innerHTML = 'Moderate Income (%)* <i class="fas fa-sort"></i>';
                missingCategories.push('Moderate Income');
            }
            if (!incomeCategories.middle_income) {
                const headerMidNumber = document.getElementById('headerMiddleIncomeNumber');
                const headerMidAmount = document.getElementById('headerMiddleIncomeAmount');
                if (headerMidNumber) headerMidNumber.innerHTML = 'Middle Income (%)* <i class="fas fa-sort"></i>';
                if (headerMidAmount) headerMidAmount.innerHTML = 'Middle Income (%)* <i class="fas fa-sort"></i>';
                missingCategories.push('Middle Income');
            }
            if (!incomeCategories.upper_income) {
                const headerUpperNumber = document.getElementById('headerUpperIncomeNumber');
                const headerUpperAmount = document.getElementById('headerUpperIncomeAmount');
                if (headerUpperNumber) headerUpperNumber.innerHTML = 'Upper Income (%)* <i class="fas fa-sort"></i>';
                if (headerUpperAmount) headerUpperAmount.innerHTML = 'Upper Income (%)* <i class="fas fa-sort"></i>';
                missingCategories.push('Upper Income');
            }
            
            // Populate Table 1 introduction (Number of Loans - 2-3 sentences)
            const introNumber = document.getElementById('topLendersNumberIntro');
            if (introNumber && metadata) {
                const lenderCount = data.length;
                introNumber.textContent = `Table 1 ranks the top ${Math.min(lenderCount, 10)} small business lenders in ${metadata.county_name} by number of loans originated in 2024. The table shows each lender's total loan count and the percentage distribution across loan size categories. The Small Biz column indicates the share of loans going to businesses with under $1 million in revenue.`;
            }

            // Populate Table 2 introduction (Amount of Loans - 2-3 sentences)
            const introAmount = document.getElementById('topLendersAmountIntro');
            if (introAmount && metadata) {
                const lenderCount = data.length;
                introAmount.textContent = `Table 2 shows the same top lenders ranked by loan amounts (in thousands of dollars) for 2024. Comparing this table to Table 1 reveals differences in lending patterns - some lenders may originate many small loans while others focus on fewer, larger transactions.`;
            }
        }
        
        // Table sorting function
        let sortDirection = {};
        
        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) return;
            
            // Initialize sort direction for this table/column if not set
            const sortKey = `${tableId}_${columnIndex}`;
            if (sortDirection[sortKey] === undefined) {
                sortDirection[sortKey] = 'asc';
            } else {
                sortDirection[sortKey] = sortDirection[sortKey] === 'asc' ? 'desc' : 'asc';
            }
            
            const isAscending = sortDirection[sortKey] === 'asc';
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.cells[columnIndex];
                const bCell = b.cells[columnIndex];
                
                if (!aCell || !bCell) return 0;
                
                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();
                
                // Handle special cases
                if (columnIndex === 0) {
                    // Lender Name - string sort
                    return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else {
                    // Numeric columns - extract number from formatted text
                    // Remove $, %, commas, and other non-numeric characters except decimal point
                    aValue = parseFloat(aValue.replace(/[^0-9.-]/g, '')) || 0;
                    bValue = parseFloat(bValue.replace(/[^0-9.-]/g, '')) || 0;
                    
                    return isAscending ? aValue - bValue : bValue - aValue;
                }
            });
            
            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort icons in header
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, idx) => {
                const icon = header.querySelector('i');
                if (icon) {
                    if (idx === columnIndex) {
                        icon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    } else {
                        icon.className = 'fas fa-sort';
                    }
                }
            });
        }
        
        // Function to expand/collapse top lenders table
        function expandTopLendersTable(tab) {
            const tableId = tab === 'number' ? 'topLendersTableNumber' : 'topLendersTableAmount';
            const btnId = tab === 'number' ? 'expandTopLendersBtnNumber' : 'expandTopLendersBtnAmount';
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            const expandBtn = document.getElementById(btnId);
            
            if (!table || !expandBtn) return;
            
            // Check if currently showing all (rows 10+ are visible)
            const isExpanded = rows.length > 10 && rows[10].style.display !== 'none';
            
            if (isExpanded) {
                // Collapse to top 10
                rows.forEach((row, index) => {
                    if (index >= 10) {
                        row.style.display = 'none';
                    }
                });
                expandBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Show All Lenders';
            } else {
                // Expand to show all
                rows.forEach((row) => {
                    row.style.display = '';
                });
                expandBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Show Top 10 Only';
            }
        }
        
        function updateSummaryTable(summary, countySummaryData) {
            const formatNumber = (num) => {
                if (num === null || num === undefined) return '-';
                return typeof num === 'number' ? num.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }) : num;
            };
            
            const formatCurrency = (num, isAlreadyInDollars = false) => {
                if (num === null || num === undefined) return '-';
                // Amount is in thousands by default, convert to full dollars
                const amount = typeof num === 'number' ? num : parseFloat(num) || 0;
                const fullAmount = isAlreadyInDollars ? amount : (amount * 1000); // Convert from thousands to full dollars if needed
                return '$' + fullAmount.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            };
            
            const calculateChange = (current, baseline) => {
                if (!baseline || baseline === 0) return null;
                return ((current - baseline) / baseline) * 100;
            };
            
            const formatChange = (change) => {
                if (change === null || change === undefined || isNaN(change)) return '';
                const sign = change >= 0 ? '+' : '';
                const className = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
                return `<span class="change ${className}">${sign}${change.toFixed(1)}% since 2020</span>`;
            };
            
            const container = document.getElementById('summaryBoxesContainer');
            if (!container) {
                console.error('summaryBoxesContainer not found');
                return;
            }
            
            if (!summary) {
                console.error('Summary data is missing');
                return;
            }
            
            console.log('Updating summary cards with data:', summary);
            console.log('County summary data:', countySummaryData);
            
            // Extract 2020 values from county summary data if available
            let data2020 = {};
            if (countySummaryData && Array.isArray(countySummaryData)) {
                countySummaryData.forEach(row => {
                    const varName = row['Variable'] || row['variable'] || '';
                    const value2020 = row['2020'] !== undefined ? row['2020'] : null;
                    if (value2020 !== null && value2020 !== undefined && !isNaN(value2020)) {
                        data2020[varName] = parseFloat(value2020);
                    }
                });
            }
            
            // Get 2020 baseline values
            // Note: "Total Loan Amount (in millions)" is actually in thousands in the data
            const totalLoans2020 = data2020['Total Loans'] || null;
            const totalAmount2020Raw = data2020['Total Loan Amount (in millions)'] || null;
            const totalAmount2020 = totalAmount2020Raw !== null ? totalAmount2020Raw : null; // in thousands
            
            // Get percentage values for 2020 to calculate amounts
            const pctUnder1m2020 = data2020['Amount to Businesses Under $1M Revenue (% of Total)'] || null;
            const pctLMI2020 = data2020['Loans to LMI Tracts (% of Total)'] || null;
            
            // Calculate 2020 amounts from percentages (if we have total amount)
            const amtUnder1m2020 = (totalAmount2020 !== null && pctUnder1m2020 !== null) 
                ? (totalAmount2020 * pctUnder1m2020 / 100) 
                : null; // in thousands
            
            // For LMI, we need to calculate from low + moderate income percentages
            // But we only have loan count percentage, not amount percentage
            // So we'll calculate from the summary data percentages for 2024 and apply same ratio
            const pctAmountLow2020 = null; // Not directly available
            const pctAmountModerate2020 = null; // Not directly available
            const amtLMI2020 = null; // Will calculate from 2024 ratio if needed
            
            // Calculate current values (2024)
            const totalLoans2024 = summary.total_loans || 0;
            const totalAmount2024 = summary.total_loan_amount || 0; // in thousands
            const avgLoanAmount2024 = totalLoans2024 > 0 ? (totalAmount2024 * 1000) / totalLoans2024 : 0; // in full dollars
            
            // Calculate amounts for 2024 from percentages
            const pctUnder1m2024 = summary.pct_amount_under_1m || summary.pct_amount_sb_under_1m || 0;
            const amtUnder1m2024 = (totalAmount2024 * pctUnder1m2024 / 100) || 0; // in thousands
            
            // Amount to LMI tracts - calculate from low + moderate income percentages
            const pctLMI2024 = (summary.pct_amount_low_income || 0) + (summary.pct_amount_moderate_income || 0);
            const amtLMI2024 = (totalAmount2024 * pctLMI2024 / 100) || 0; // in thousands
            
            // Calculate average loan amount for 2020
            const avgLoanAmount2020 = (totalLoans2020 !== null && totalAmount2020 !== null && totalLoans2020 > 0) 
                ? (totalAmount2020 * 1000) / totalLoans2020 
                : null; // in full dollars
            
            // For LMI 2020, if we don't have the amount percentage, estimate using the same ratio as 2024
            // This is an approximation but better than nothing
            let amtLMI2020Calculated = null;
            if (totalAmount2020 !== null && pctLMI2024 > 0) {
                // Use 2024 percentage as approximation for 2020 (not ideal but better than null)
                amtLMI2020Calculated = totalAmount2020 * pctLMI2024 / 100;
            }
            
            // Calculate percentage changes
            const changeLoans = calculateChange(totalLoans2024, totalLoans2020);
            const changeAmount = calculateChange(totalAmount2024, totalAmount2020);
            const changeAvgLoan = calculateChange(avgLoanAmount2024, avgLoanAmount2020);
            const changeUnder1m = calculateChange(amtUnder1m2024, amtUnder1m2020);
            const changeLMI = calculateChange(amtLMI2024, amtLMI2020Calculated || amtLMI2020);
            
            // Update individual summary box elements by ID
            const summaryBoxLoans = document.getElementById('summaryBoxLoans');
            if (summaryBoxLoans) {
                summaryBoxLoans.innerHTML = `${formatNumber(totalLoans2024)}<br><span style="font-size: 0.85rem; color: ${changeLoans >= 0 ? '#28a745' : '#dc3545'};">${changeLoans >= 0 ? '+' : ''}${changeLoans.toFixed(1)}% since 2020</span>`;
            }

            const summaryBoxAmount = document.getElementById('summaryBoxAmount');
            if (summaryBoxAmount) {
                summaryBoxAmount.innerHTML = `${formatCurrency(totalAmount2024)}<br><span style="font-size: 0.85rem; color: ${changeAmount >= 0 ? '#28a745' : '#dc3545'};">${changeAmount >= 0 ? '+' : ''}${changeAmount.toFixed(1)}% since 2020</span>`;
            }

            const summaryBoxAvgLoan = document.getElementById('summaryBoxAvgLoan');
            if (summaryBoxAvgLoan) {
                summaryBoxAvgLoan.innerHTML = `${formatCurrency(avgLoanAmount2024, true)}<br><span style="font-size: 0.85rem; color: ${changeAvgLoan >= 0 ? '#28a745' : '#dc3545'};">${changeAvgLoan >= 0 ? '+' : ''}${changeAvgLoan.toFixed(1)}% since 2020</span>`;
            }

            const summaryBoxUnder1M = document.getElementById('summaryBoxUnder1M');
            if (summaryBoxUnder1M) {
                summaryBoxUnder1M.innerHTML = `${formatCurrency(amtUnder1m2024)}<br><span style="font-size: 0.85rem; color: ${changeUnder1m >= 0 ? '#28a745' : '#dc3545'};">${changeUnder1m >= 0 ? '+' : ''}${changeUnder1m.toFixed(1)}% since 2020</span>`;
            }

            const summaryBoxLMI = document.getElementById('summaryBoxLMI');
            if (summaryBoxLMI) {
                if (amtLMI2024 > 0) {
                    summaryBoxLMI.innerHTML = `${formatCurrency(amtLMI2024)}<br><span style="font-size: 0.85rem; color: ${changeLMI >= 0 ? '#28a745' : '#dc3545'};">${changeLMI >= 0 ? '+' : ''}${changeLMI.toFixed(1)}% since 2020</span>`;
                } else {
                    summaryBoxLMI.innerHTML = '<span style="color: #666;">$0</span><br><span style="font-size: 0.85rem; color: #999;">No LMI tracts in county</span>';
                }
            }
        }
        
        // Treemap toggle function
        function switchTreemap(type) {
            const loansBtn = document.getElementById('treemapToggleLoans');
            const amountsBtn = document.getElementById('treemapToggleAmounts');
            const loansDiv = document.getElementById('treemapLoans');
            const amountsDiv = document.getElementById('treemapAmounts');
            
            if (type === 'loans') {
                loansBtn.classList.add('active');
                loansBtn.style.background = 'var(--ncrc-primary-blue)';
                loansBtn.style.color = 'white';
                amountsBtn.classList.remove('active');
                amountsBtn.style.background = '#ccc';
                amountsBtn.style.color = '#333';
                loansDiv.style.display = 'block';
                amountsDiv.style.display = 'none';
            } else {
                amountsBtn.classList.add('active');
                amountsBtn.style.background = 'var(--ncrc-primary-blue)';
                amountsBtn.style.color = 'white';
                loansBtn.classList.remove('active');
                loansBtn.style.background = '#ccc';
                loansBtn.style.color = '#333';
                loansDiv.style.display = 'none';
                amountsDiv.style.display = 'block';
            }
        }
        
        // Render treemap charts with NCRC colors
        function renderTreemaps(summary) {
            if (!summary) {
                console.warn('renderTreemaps: No summary data provided');
                return;
            }
            
            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                console.error('Plotly is not loaded. Please check the CDN link.');
                return;
            }
            
            // NCRC color palette
            const ncrcColors = {
                low: '#e82e2e',        // NCRC red accent (Low Income)
                moderate: '#eb2f89',  // NCRC pink (Moderate Income)
                middle: '#2fade3',    // NCRC secondary blue (Middle Income)
                upper: '#552d87'      // NCRC primary blue/purple (Upper Income)
            };
            
            // Loans treemap data - Plotly treemap format
            const loansData = [{
                type: 'treemap',
                labels: ['Low Income', 'Moderate Income', 'Middle Income', 'Upper Income'],
                values: [
                    summary.pct_loans_low_income || 0,
                    summary.pct_loans_moderate_income || 0,
                    summary.pct_loans_middle_income || 0,
                    summary.pct_loans_upper_income || 0
                ],
                parents: ['', '', '', ''],
                textinfo: 'label+percent entry',
                textfont: {
                    size: 14,
                    color: 'white',
                    family: 'Inter, sans-serif'
                },
                marker: {
                    colors: [ncrcColors.low, ncrcColors.moderate, ncrcColors.middle, ncrcColors.upper],
                    line: {
                        width: 2,
                        color: 'white'
                    }
                },
                hovertemplate: '<b>%{label}</b><br>%{value:.1f}%<extra></extra>'
            }];
            
            // Amounts treemap data
            const amountsData = [{
                type: 'treemap',
                labels: ['Low Income', 'Moderate Income', 'Middle Income', 'Upper Income'],
                values: [
                    summary.pct_amount_low_income || 0,
                    summary.pct_amount_moderate_income || 0,
                    summary.pct_amount_middle_income || 0,
                    summary.pct_amount_upper_income || 0
                ],
                parents: ['', '', '', ''],
                textinfo: 'label+percent entry',
                textfont: {
                    size: 14,
                    color: 'white',
                    family: 'Inter, sans-serif'
                },
                marker: {
                    colors: [ncrcColors.low, ncrcColors.moderate, ncrcColors.middle, ncrcColors.upper],
                    line: {
                        width: 2,
                        color: 'white'
                    }
                },
                hovertemplate: '<b>%{label}</b><br>%{value:.1f}%<extra></extra>'
            }];
            
            const layout = {
                margin: { l: 0, r: 0, t: 0, b: 0 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {
                    family: 'Inter, sans-serif',
                    size: 12
                }
            };
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            // Check if DOM elements exist
            const loansDiv = document.getElementById('treemapLoans');
            const amountsDiv = document.getElementById('treemapAmounts');
            
            if (!loansDiv || !amountsDiv) {
                console.error('Treemap containers not found in DOM');
                return;
            }
            
            try {
                // Render loans treemap
                Plotly.newPlot('treemapLoans', loansData, layout, config);
                
                // Render amounts treemap
                Plotly.newPlot('treemapAmounts', amountsData, layout, config);
                
                console.log('Treemaps rendered successfully');
            } catch (error) {
                console.error('Error rendering treemaps:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }
        
        let hhiByYearChartInstance = null;
        
        function populateHHIByYearChart(hhiData, metadata) {
            console.log('[DEBUG HHI] Input hhiData:', JSON.stringify(hhiData));
            console.log('[DEBUG HHI] hhiData length:', hhiData ? hhiData.length : 0);

            if (!hhiData || hhiData.length === 0) {
                console.warn('No HHI by year data available.');
                const section = document.getElementById('section5');
                if (section) {
                    section.style.display = 'none';
                }
                return;
            }

            const section = document.getElementById('section5');
            if (section) {
                section.style.display = 'block';
            }

            // Filter to only whole years (remove 2020.5, etc.) and sort
            // Use Math.floor to handle float years more reliably
            const wholeYearData = hhiData.filter(d => {
                const year = parseFloat(d.year);
                const isWholeYear = Math.abs(year - Math.round(year)) < 0.01;
                console.log(`[DEBUG HHI] Year ${d.year} -> parsed ${year}, isWhole: ${isWholeYear}`);
                return isWholeYear && year >= 2000 && year <= 2100;
            });

            console.log('[DEBUG HHI] wholeYearData after filter:', wholeYearData.length, 'items');

            const sortedData = wholeYearData.sort((a, b) => parseInt(a.year) - parseInt(b.year));

            const years = sortedData.map(d => d.year.toString());
            const hhiValues = sortedData.map(d => parseFloat(d.hhi_value || 0));

            console.log('[DEBUG HHI] Final years:', years);
            console.log('[DEBUG HHI] Final hhiValues:', hhiValues);

            // Populate table
            const table = document.getElementById('hhiByYearTable');
            if (table) {
                const tbody = table.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = sortedData.map(d => {
                        const hhiValue = parseFloat(d.hhi_value || 0);
                        return `<tr>
                            <td style="text-align: left; font-weight: 600;">${d.year}</td>
                            <td style="text-align: center;">${Math.round(hhiValue).toLocaleString()}</td>
                        </tr>`;
                    }).join('');
                }
            }

            // Create Chart.js line chart (matching Branch Report)
            const canvas = document.getElementById('hhiByYearChart');
            if (canvas && typeof Chart !== 'undefined') {
                const ctx = canvas.getContext('2d');

                // Destroy existing chart if it exists
                if (hhiByYearChartInstance) {
                    hhiByYearChartInstance.destroy();
                }

                // Calculate max value for y-axis range
                const maxHHI = Math.max(...hhiValues, 2500); // Ensure we show at least up to 2,500
                const yMax = Math.max(maxHHI * 1.15, 3000); // At least 3,000 to show thresholds clearly

                hhiByYearChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'HHI',
                            data: hhiValues,
                            backgroundColor: '#034ea0', // NCRC Dark Blue
                            borderColor: '#023c7d',
                            borderWidth: 1,
                            barPercentage: 0.7,
                            categoryPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Market Concentration (HHI) by Year',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        return 'HHI: ' + Math.round(value).toLocaleString();
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    moderateLine: {
                                        type: 'line',
                                        yMin: 1500,
                                        yMax: 1500,
                                        borderColor: 'rgba(255, 165, 0, 0.7)', // Orange for moderate
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            content: 'Moderate Concentration (1,500)',
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: 'rgba(255, 165, 0, 0.8)',
                                            color: 'white',
                                            font: {
                                                size: 10
                                            }
                                        }
                                    },
                                    highLine: {
                                        type: 'line',
                                        yMin: 2500,
                                        yMax: 2500,
                                        borderColor: 'rgba(255, 0, 0, 0.7)', // Red for high
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            content: 'High Concentration (2,500)',
                                            enabled: true,
                                            position: 'start',
                                            backgroundColor: 'rgba(255, 0, 0, 0.8)',
                                            color: 'white',
                                            font: {
                                                size: 10
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: yMax,
                                title: {
                                    display: true,
                                    text: 'HHI',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    },
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Create column chart for tract popup
        function createTractPopupChart(containerId, tract) {
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, skipping chart');
                return;
            }
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn('Chart container not found:', containerId);
                return;
            }
            
            // Get year-by-year amounts (most recent 5 years)
            const years = ['2020', '2021', '2022', '2023', '2024'];
            const yearAmounts = [];
            const yearLabels = [];
            
            // Check if tract has year_amounts object
            let yearAmountsData = {};
            if (tract.year_amounts) {
                // Handle both object and string (if JSON serialized)
                if (typeof tract.year_amounts === 'string') {
                    try {
                        yearAmountsData = JSON.parse(tract.year_amounts);
                    } catch (e) {
                        console.warn('Failed to parse year_amounts:', e);
                        yearAmountsData = {};
                    }
                } else if (typeof tract.year_amounts === 'object') {
                    yearAmountsData = tract.year_amounts;
                }
            }
            
            console.log('Tract year_amounts data:', yearAmountsData);
            
            years.forEach(year => {
                const amount = yearAmountsData[year] || 0;
                // Amounts are in thousands, convert to actual dollars
                const amountDollars = parseFloat(amount) * 1000;
                yearAmounts.push(amountDollars);
                yearLabels.push(year);
            });
            
            console.log('Year amounts (dollars):', yearAmounts);
            
            // Calculate dynamic y-axis range - set to max value across all years
            const maxAmount = Math.max(...yearAmounts, 0);
            const yAxisMax = maxAmount > 0 ? maxAmount * 1.1 : 1000; // Add 10% padding, or 1000 if all zeros
            
            // Format text labels based on value size
            const textLabels = yearAmounts.map(amt => {
                if (amt === 0) return '$0';
                if (amt >= 1000000) {
                    return '$' + (amt / 1000000).toFixed(1) + 'M';
                } else if (amt >= 1000) {
                    return '$' + (amt / 1000).toFixed(0) + 'K';
                } else {
                    return '$' + amt.toFixed(0);
                }
            });
            
            // Color bars differently for PPP years (2020-2021)
            const barColors = yearLabels.map(year => {
                if (year === '2020' || year === '2021') {
                    return '#95a5a6'; // Gray for PPP years
                }
                return '#2fade3'; // NCRC blue for other years
            });
            
            const trace = {
                x: yearLabels,
                y: yearAmounts,
                type: 'bar',
                marker: {
                    color: barColors,
                    line: {
                        color: 'white',
                        width: 1.5
                    },
                    opacity: 0.85
                },
                text: textLabels,
                textposition: 'outside',
                hovertemplate: '<b>%{x}</b><br>Amount: %{text}<extra></extra>',
                textfont: {
                    size: 11,
                    color: '#333'
                }
            };
            
            const layout = {
                margin: { l: 50, r: 40, t: 20, b: 60 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    title: {
                        text: 'Year',
                        font: { size: 12, color: '#666' }
                    },
                    showgrid: false,
                    gridcolor: '#e0e0e0',
                    showticklabels: true,
                    tickfont: { size: 11, color: '#333' },
                    tickmode: 'linear',
                    dtick: 1
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    showticklabels: false,
                    range: [0, yAxisMax],
                    zeroline: true,
                    zerolinecolor: '#ddd',
                    zerolinewidth: 1
                },
                showlegend: false,
                height: 280,
                autosize: true
            };
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            try {
                Plotly.newPlot(containerId, [trace], layout, config);
                console.log('Popup chart rendered successfully');
            } catch (error) {
                console.error('Error creating popup chart:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }
        
        // Smooth scroll to section
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Show/hide table of contents
        function toggleTOC() {
            const toc = document.getElementById('tocContainer');
            if (toc) {
                toc.style.display = toc.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Add ARIA labels and keyboard navigation
        function enhanceAccessibility() {
            // Add ARIA labels to tables
            document.querySelectorAll('.data-table').forEach(table => {
                if (!table.getAttribute('role')) {
                    table.setAttribute('role', 'table');
                    table.setAttribute('aria-label', 'Data table');
                }
            });
            
            // Add ARIA labels to tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                if (!button.getAttribute('aria-label')) {
                    const text = button.textContent.trim();
                    button.setAttribute('aria-label', `Switch to ${text} view`);
                    button.setAttribute('role', 'tab');
                }
            });
            
            // Add keyboard navigation to tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        button.click();
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        const tabs = Array.from(document.querySelectorAll('.tab-button'));
                        const currentIndex = tabs.indexOf(button);
                        const nextIndex = e.key === 'ArrowRight' 
                            ? (currentIndex + 1) % tabs.length
                            : (currentIndex - 1 + tabs.length) % tabs.length;
                        tabs[nextIndex].focus();
                        tabs[nextIndex].click();
                    }
                });
            });
        }

        // Generate intro paragraph dynamically based on metadata
        function generateIntroParagraph(metadata, summaryData) {
            const countyName = metadata.county_name || 'the selected county';
            const stateName = metadata.state_name || '';
            const yearRange = metadata.year_range || '2020-2024';
            const years = metadata.years || [2020, 2021, 2022, 2023, 2024];
            const startYear = Math.min(...years);
            const endYear = Math.max(...years);

            // First paragraph: Overview of the report
            let intro1 = `This report analyzes small business lending in ${countyName}`;
            if (stateName) intro1 += `, ${stateName}`;
            intro1 += ` from ${startYear} to ${endYear}. `;
            intro1 += `The data is collected under the Community Reinvestment Act (CRA), which requires financial institutions to report information about small business loans. `;
            intro1 += `Small business loans are defined as loans with original amounts of $1 million or less for commercial and industrial purposes.`;

            // Second paragraph: Data context and limitations
            let intro2 = `The analysis examines lending patterns by loan size, revenue category of borrowers, and neighborhood income levels. `;
            intro2 += `Low- and Moderate-Income (LMI) tracts are census tracts where the median family income is less than 80% of the area median income. `;
            intro2 += `Loans to businesses with revenues under $1 million are considered lending to small businesses.`;

            // Third paragraph: PPP and Section 1071 notes
            let intro3 = `Note: Small business lending in 2020 and 2021 was significantly impacted by the Paycheck Protection Program (PPP), which may result in elevated loan counts and amounts during those years. `;
            intro3 += `Additionally, Section 1071 of the Dodd-Frank Act has not yet been fully implemented, so this report does not include borrower demographic information such as race, ethnicity, or gender of business owners.`;

            // Update the intro paragraphs
            const p1 = document.getElementById('introParagraph1');
            const p2 = document.getElementById('introParagraph2');
            const p3 = document.getElementById('introParagraph3');

            if (p1) p1.textContent = intro1;
            if (p2) p2.textContent = intro2;
            if (p3) p3.textContent = intro3;

            // Also update the old intro county name for Section 1
            const introCountyNameEl = document.getElementById('introCountyName');
            if (introCountyNameEl) {
                introCountyNameEl.textContent = countyName + (stateName ? `, ${stateName}` : '');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job_id');
            
            // Show TOC after content loads
            setTimeout(() => {
                const toc = document.getElementById('tocContainer');
                if (toc) {
                    toc.style.display = 'block';
                }
            }, 1000);
            
            // Enhance accessibility
            enhanceAccessibility();
            
            if (jobId) {
                loadReportData(jobId);
                updateDownloadLinks();
            } else {
                console.error('No job_id found in URL');
                document.getElementById('reportMetadata').textContent = 'Error: No job ID provided';
            }
        });
    </script>
</body>
</html>

