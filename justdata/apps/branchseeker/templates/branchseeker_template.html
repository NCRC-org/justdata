{% extends "base_app.html" %}

{% set app_name = "BranchSeeker" %}
{% set app_name_part1 = "BRANCH" %}
{% set app_name_part2 = "SEEKER" %}
{% set app_description = "AI-powered banking market intelligence platform" %}

{% block title %}{{ app_title|default('BranchSeeker') }} - AI-Powered Banking Insights{% endblock %}

{% block extra_head %}
    <meta name="description" content="AI-powered bank branch data analyzer with BigQuery integration. Generate comprehensive banking market analysis reports.">
    <meta name="keywords" content="{{ app_title|default('BranchSeeker') }}, banking, branch analysis, AI, BigQuery, market intelligence">
    <meta name="author" content="JustData - National Community Reinvestment Coalition">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://justdata.app/branchseeker/">
    <meta property="og:title" content="BranchSeeker - AI-Powered Banking Insights">
    <meta property="og:description" content="Generate comprehensive banking market analysis reports with AI-powered insights.">
    <meta property="og:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://justdata.app/branchseeker/">
    <meta property="twitter:title" content="BranchSeeker - AI-Powered Banking Insights">
    <meta property="twitter:description" content="Generate comprehensive banking market analysis reports with AI-powered insights.">
    <meta property="twitter:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    <div class="container">

        <!-- Main Content -->
        <div class="content-wrapper">
        <main class="main-content">
            <div class="analysis-card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> Generate Branch Analysis</h2>
                    <p>Enter counties and years to analyze FDIC branch data with AI-powered insights</p>
                </div>

                <form id="analysisForm" class="analysis-form">
                    <!-- Selection Type Radio Buttons -->
                    <div class="form-group" style="text-align: center;">
                        <div style="display: block; margin-bottom: 10px; font-weight: 600;">
                            <i class="fas fa-filter"></i>
                            Select By:
                        </div>
                        <div class="selection-mode-container" style="display: inline-flex; gap: 20px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; justify-content: center;">
                            <label class="radio-option" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="selection_type" id="selection_type_county" value="county" checked style="margin-right: 8px;">
                                <span>County</span>
                            </label>
                            <label class="radio-option" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="selection_type" id="selection_type_state" value="state" style="margin-right: 8px;">
                                <span>State</span>
                            </label>
                        </div>
                        <small class="help-text">
                            <i class="fas fa-info-circle"></i>
                            Choose how you want to select your analysis area. You cannot mix selection types.
                        </small>
                    </div>

                    <!-- County Selection (default, shown when selection_type = 'county') -->
                    <div class="form-group" id="county-selection-group">
                        <label for="state-filter-select" data-tooltip="Narrow the county list to a specific state. This makes it easier to find the counties you're looking for.">
                            <i class="fas fa-map"></i>
                            Filter by State (Optional)
                        </label>
                        <select id="state-filter-select" name="state_filter" style="width: 100%; margin-bottom: 15px;" placeholder="Select a state to filter counties...">
                            <option value="">All States</option>
                        </select>
                        <small class="help-text" style="margin-bottom: 15px; display: block;">
                            <i class="fas fa-info-circle"></i>
                            Optionally select a state to filter the county list below.
                        </small>
                        <label for="county-select" data-tooltip="Select one or more counties to analyze. You can search by typing. For best performance, limit to 3 counties.">
                            <i class="fas fa-map-marker-alt"></i>
                            Counties
                            <span id="county-loading-spinner" style="display: none; margin-left: 10px;">
                                <i class="fas fa-spinner fa-spin" style="color: var(--ncrc-primary-blue);"></i>
                                <span style="font-size: 0.9em; color: #666;">Loading counties...</span>
                            </span>
                        </label>
                        <select id="county-select" name="counties" multiple="multiple" style="width: 100%;" placeholder="Select counties..."></select>
                        <small class="help-text">
                            <i class="fas fa-info-circle"></i>
                            Select one or more counties. For better timing, we recommend limiting to a maximum of three counties selected.
                        </small>
                    </div>

                    <!-- State Selection (shown when selection_type = 'state') -->
                    <div class="form-group" id="state-selection-group" style="display: none;">
                        <label for="state-select">
                            <i class="fas fa-map"></i>
                            State
                        </label>
                        <select id="state-select" name="state_code" style="width: 100%;" placeholder="Select a state...">
                            <option value="">Select a state...</option>
                        </select>
                        <small class="help-text">
                            <i class="fas fa-info-circle"></i>
                            Select a state to analyze all counties within that state.
                        </small>
                    </div>


                    <div class="form-group" style="display: none;">
                        <div style="display: block; margin-bottom: 10px; font-weight: 600;">
                            <i class="fas fa-calendar-alt"></i>
                            Year Range
                        </div>
                        <div class="year-range-container">
                            <div class="year-select-group">
                                <label for="startYear" class="year-label" data-tooltip="The first year of data to include in your analysis.">Start Year:</label>
                                <select id="startYear" name="startYear">
                                    <option value="">Select start year</option>
                                    <option value="2017">2017</option>
                                    <option value="2018">2018</option>
                                    <option value="2019">2019</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            <div class="year-select-group">
                                <label for="endYear" class="year-label" data-tooltip="The last year of data to include. Must be after or equal to the start year.">End Year:</label>
                                <select id="endYear" name="endYear">
                                    <option value="">Select end year</option>
                                    <option value="2017">2017</option>
                                    <option value="2018">2018</option>
                                    <option value="2019">2019</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                        </div>
                        <small class="help-text">
                            <i class="fas fa-info-circle"></i>
                            Select a range of at least 3 years (e.g., 2020-2022)
                        </small>
                    </div>

                    {% if is_staff %}
                    <!-- Clear cache checkbox (staff/admin only) -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.95em; color: #333; padding: 12px 15px; background: #fff8e1; border: 2px solid #ffc107; border-radius: 6px;">
                            <input type="checkbox" id="forceRefreshCheckbox" style="cursor: pointer; width: 18px; height: 18px; accent-color: #ff9800;">
                            <span><i class="fas fa-sync-alt" style="margin-right: 6px; color: #ff9800;"></i><strong>Clear cache and regenerate report</strong></span>
                        </label>
                    </div>
                    {% endif %}

                    <button type="submit" class="submit-btn" id="submitBtn" data-tooltip="Click to generate your analysis. Make sure you've selected counties and a year range first.">
                        <i class="fas fa-magic"></i>
                        <span>Generate Analysis</span>
                    </button>
                    <small class="submit-info">
                        <i class="fas fa-clock"></i>
                        Analysis typically takes a few minutes
                    </small>
                </form>

                <!-- Progress Section -->
                <div id="progressSection" class="progress-section" style="display: none;">
                    <div class="progress-card">
                        <div class="progress-header">
                            <i class="fas fa-cog fa-spin"></i>
                            <h3>Analyzing Data...</h3>
                        </div>
                        <div class="progress-steps" id="progressSteps" style="margin-bottom: 15px; text-align: left;">
                            <!-- Progress steps will be populated by JavaScript -->
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p class="progress-text" id="progressText">Initializing analysis...</p>
                        <div class="progress-info">
                            <i class="fas fa-clock"></i>
                            <small>Analysis typically takes a few minutes depending on the number of counties and years selected.</small>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="results-section" style="display: none;">
                    <div class="results-card">
                        <div class="results-header">
                            <i class="fas fa-check-circle"></i>
                            <h3>Analysis Complete!</h3>
                        </div>
                        <div class="results-content">
                            <p>Your FDIC branch analysis has been generated successfully.</p>
                            <div class="download-options">
                                <button class="download-btn" id="viewReportBtn">
                                    <i class="fas fa-chart-bar"></i>
                                    View Web Report
                                </button>
                                <button class="download-btn secondary" id="downloadBtn">
                                    <i class="fas fa-download"></i>
                                    Export Data
                                </button>
                                <small class="download-info">
                                    <i class="fas fa-globe"></i>
                                    Interactive web report with export options
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="error-section" style="display: none;">
                    <div class="error-card">
                        <div class="error-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Analysis Failed</h3>
                        </div>
                        <div class="error-content">
                            <p id="errorMessage"></p>
                            <button class="retry-btn" onclick="resetForm()">
                                <i class="fas fa-redo"></i>
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </main>
        </div> <!-- End content-wrapper -->
    </div> <!-- End container -->
{% endblock %}

{% block extra_js %}
    <!-- jQuery (must be first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Your app.js (after dependencies) -->
    <script>
        // Set base URL for API calls (with blueprint prefix)
        window.APP_BASE_URL = '{{ app_base_url|default("/branchseeker") }}';
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    
    <!-- BranchSeeker-specific state loading -->
    <script>
        $(document).ready(function() {
            console.log('[DEBUG] BranchSeeker jQuery ready block executing...');
            
            let isLoadingStates = false;
            let statesLoaded = false;
            
            function loadStates() {
                if (isLoadingStates) {
                    console.log('[DEBUG] loadStates: Already loading, skipping...');
                    return;
                }
                
                const stateSelect = $('#state-filter-select');
                if (!stateSelect.length) {
                    console.warn('[WARNING] State select element not found');
                    return;
                }
                
                isLoadingStates = true;
                
                const baseUrl = window.APP_BASE_URL || '/branchseeker';
                console.log(`[DEBUG] loadStates: Fetching from ${baseUrl}/states`);
                fetch(`${baseUrl}/states`)
                    .then(response => {
                        console.log(`[DEBUG] loadStates: Response status: ${response.status}, ok: ${response.ok}`);
                        if (!response.ok) {
                            throw new Error(`Failed to load states: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(states => {
                        console.log('[DEBUG] loadStates: States response received:', states);
                        console.log('[DEBUG] loadStates: States array length:', states ? states.length : 'null');
                        
                        if (stateSelect.hasClass('select2-hidden-accessible')) {
                            stateSelect.select2('destroy');
                        }
                        
                        stateSelect.empty();
                        stateSelect.append('<option value="">All States</option>');
                        
                        if (!states || states.length === 0) {
                            console.warn('[WARNING] loadStates: No states in response!');
                            isLoadingStates = false;
                            return;
                        }
                        
                        let addedCount = 0;
                        states.forEach(state => {
                            const stateName = state.name || state;
                            const stateCode = state.code || state;
                            console.log(`[DEBUG] loadStates: Processing state: name="${stateName}", code="${stateCode}"`);
                            const option = new Option(stateName, stateName);
                            $(option).data('code', stateCode);
                            stateSelect.append(option);
                            addedCount++;
                        });
                        
                        console.log(`[DEBUG] loadStates: Added ${addedCount} states to dropdown`);
                        
                        stateSelect.select2({
                            placeholder: 'All States',
                            allowClear: true,
                            width: '100%'
                        });
                        
                        statesLoaded = true;
                        isLoadingStates = false;
                    })
                    .catch(error => {
                        console.error('[ERROR] loadStates: Error loading states:', error);
                        isLoadingStates = false;
                    });
            }
            
            // Load counties on page load (optionally filtered by state)
            function loadCounties(stateCode = null) {
                const countySelect = $('#county-select');
                if (!countySelect.length) {
                    console.warn('[WARNING] County select element not found');
                    return;
                }
                
                // Show loading spinner
                const loadingSpinner = $('#county-loading-spinner');
                loadingSpinner.show();
                countySelect.prop('disabled', true);
                
                const baseUrl = window.APP_BASE_URL || '/branchseeker';
                let url = `${baseUrl}/counties`;
                if (stateCode) {
                    // Get state code from the selected state option
                    const stateSelect = $('#state-filter-select');
                    const selectedOption = stateSelect.find('option:selected');
                    const actualStateCode = selectedOption.data('code') || stateCode;
                    url = `${baseUrl}/counties-by-state/${encodeURIComponent(actualStateCode)}`;
                    console.log(`[DEBUG] loadCounties: Filtering by state code: ${actualStateCode}`);
                }
                
                console.log(`[DEBUG] loadCounties: Fetching from ${url}`);
                fetch(url)
                    .then(response => {
                        console.log(`[DEBUG] loadCounties: Response status: ${response.status}, ok: ${response.ok}`);
                        if (!response.ok) {
                            throw new Error(`Failed to load counties: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(counties => {
                        console.log('[DEBUG] loadCounties: Counties response received:', counties);
                        console.log('[DEBUG] loadCounties: Counties array length:', counties ? counties.length : 'null');
                        
                        if (!Array.isArray(counties)) {
                            console.error('[ERROR] loadCounties: Invalid response format');
                            return;
                        }
                        
                        // Destroy Select2 if it exists
                        if (countySelect.hasClass('select2-hidden-accessible')) {
                            countySelect.select2('destroy');
                        }
                        
                        countySelect.empty();
                        
                        if (counties.length === 0) {
                            console.warn('[WARNING] loadCounties: No counties in response!');
                            countySelect.append(new Option('No counties available', '', true, true));
                        } else {
                            let addedCount = 0;
                            counties.forEach(county => {
                                const countyName = typeof county === 'string' ? county : (county.name || county);
                                console.log(`[DEBUG] loadCounties: Adding county: ${countyName}`);
                                countySelect.append(new Option(countyName, countyName));
                                addedCount++;
                            });
                            console.log(`[DEBUG] loadCounties: Added ${addedCount} counties to dropdown`);
                        }
                        
                        // Reinitialize Select2 for multi-select
                        countySelect.select2({
                            placeholder: 'Select counties...',
                            allowClear: true,
                            width: '100%'
                        });
                        
                        // Hide loading spinner and re-enable select
                        loadingSpinner.hide();
                        countySelect.prop('disabled', false);
                    })
                    .catch(error => {
                        console.error('[ERROR] loadCounties: Error loading counties:', error);
                        // Hide loading spinner and re-enable select on error
                        loadingSpinner.hide();
                        countySelect.prop('disabled', false);
                    });
            }
            
            // Handle state filter change
            $('#state-filter-select').on('change', function() {
                const selectedState = $(this).val();
                const selectedOption = $(this).find('option:selected');
                const stateCode = selectedOption.data('code');
                
                console.log(`[DEBUG] State filter changed: selectedState="${selectedState}", stateCode="${stateCode}"`);
                
                if (selectedState && stateCode) {
                    // Load counties filtered by state
                    loadCounties(stateCode);
                } else {
                    // Load all counties
                    loadCounties();
                }
            });
            
            if (!statesLoaded) {
                console.log('[DEBUG] Calling loadStates() on page load...');
                loadStates();
            }
            
            // Load counties on page load
            console.log('[DEBUG] Calling loadCounties() on page load...');
            loadCounties();
        });
    </script>
{% endblock %}
