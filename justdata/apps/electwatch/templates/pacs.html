<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACs | ElectWatch - NCRC JustData</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --ew-dark-blue: #1E3D5C;
            --ew-primary: #2D8659;
            --ew-secondary: #3B5998;
            --ew-accent: #D4A017;
            --ew-neutral-900: #1A1A2E;
            --ew-neutral-700: #4A4A5A;
            --ew-neutral-500: #8A8A9A;
            --ew-neutral-200: #E5E5EA;
            --ew-neutral-50: #F8F8FA;
            --party-r: #DC3545;
            --party-d: #2563EB;
            --ncrc-justdata-blue: var(--ew-dark-blue);
            --ncrc-gold: var(--ew-accent);
            --ncrc-gray: var(--ew-neutral-500);
            --ncrc-gray-light: var(--ew-neutral-50);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--ncrc-gray-light);
            color: var(--ew-neutral-900);
            min-height: 100vh;
            line-height: 1.6;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 20px;
        }

        .page-title {
            font-family: Georgia, "Times New Roman", serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--ew-neutral-900);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--ew-neutral-500);
            font-size: 0.9rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--ew-neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select, .search-input {
            padding: 8px 12px;
            border: 1px solid var(--ew-neutral-200);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        .search-input {
            min-width: 200px;
        }

        .filter-select:focus, .search-input:focus {
            outline: none;
            border-color: var(--ew-primary);
        }

        .table-container {
            overflow-x: auto;
        }

        .pacs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pacs-table th {
            background: var(--ew-neutral-50);
            padding: 12px 16px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--ew-neutral-500);
            border-bottom: 2px solid var(--ew-neutral-200);
            white-space: nowrap;
        }

        .pacs-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .pacs-table th.sortable:hover {
            color: var(--ew-primary);
        }

        .pacs-table th.sortable.active {
            color: var(--ew-primary);
        }

        .pacs-table th.sortable::after {
            content: ' \25B2\25BC';
            font-size: 0.6rem;
            opacity: 0.3;
        }

        .pacs-table th.sortable.asc::after {
            content: ' \25B2';
            opacity: 1;
        }

        .pacs-table th.sortable.desc::after {
            content: ' \25BC';
            opacity: 1;
        }

        .pacs-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--ew-neutral-200);
            font-size: 0.9rem;
        }

        .pacs-table tr {
            cursor: pointer;
            transition: background 0.15s;
        }

        .pacs-table tr:hover {
            background: rgba(45, 134, 89, 0.05);
        }

        .pac-name {
            font-weight: 500;
            color: var(--ew-primary);
        }

        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .type-badge.firm {
            background: rgba(45, 134, 89, 0.1);
            color: #2D8659;
        }

        .type-badge.trade-assoc {
            background: rgba(212, 160, 23, 0.1);
            color: #D4A017;
        }

        .ticker {
            font-family: monospace;
            font-weight: 600;
            color: var(--ew-secondary);
        }

        .amount {
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid var(--ew-neutral-200);
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid var(--ew-neutral-200);
            border-radius: 6px;
            background: white;
            color: var(--ew-neutral-700);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--ew-neutral-50);
            border-color: var(--ew-primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: var(--ew-neutral-500);
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--ew-neutral-500);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--ew-neutral-500);
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                width: 100%;
            }
            .filter-select, .search-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    {% include "shared_header.html" %}
    {% include "electwatch_subnav.html" %}

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">PACs & Firms</h1>
            <p class="page-subtitle">Political Action Committees and firms with congressional financial connections</p>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="filters">
                    <input type="text" class="search-input" id="search-pac" placeholder="Search by name...">
                    <select class="filter-select" id="filter-type">
                        <option value="">All Types</option>
                        <option value="firm">Firms Only</option>
                        <option value="trade_association">Trade Associations Only</option>
                    </select>
                    <select class="filter-select" id="filter-industry">
                        <option value="">All Industries</option>
                        <option value="banking">Banking</option>
                        <option value="investment">Investment</option>
                        <option value="insurance">Insurance</option>
                        <option value="mortgage">Mortgage</option>
                        <option value="crypto">Crypto</option>
                        <option value="fintech">Fintech</option>
                        <option value="consumer_lending">Consumer Lending</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="pacs-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="name">Name</th>
                            <th>Type</th>
                            <th>Ticker</th>
                            <th>Industry</th>
                            <th class="sortable" data-sort="pac_amount">PAC $</th>
                            <th class="sortable" data-sort="individual_amount">Individual $</th>
                            <th class="sortable active desc" data-sort="total">Total $</th>
                            <th class="sortable text-center" data-sort="officials_count">Officials</th>
                            <th class="sortable text-center" data-sort="stock_trades">Stock Trades</th>
                        </tr>
                    </thead>
                    <tbody id="pacs-body">
                        <tr><td colspan="9" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading PACs...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <button class="pagination-btn" id="prev-page" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                <span class="pagination-info" id="pagination-info">Page 1 of 1</span>
                <button class="pagination-btn" id="next-page" disabled>Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </main>

    <!-- Firebase Auth Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="/static/js/auth.js"></script>

    <script>
        let allPacs = [];
        let filteredPacs = [];
        let currentPage = 1;
        const pageSize = 50;
        let sortField = 'total';
        let sortOrder = 'desc';

        async function loadPacs() {
            try {
                const response = await fetch('/electwatch/api/firms?limit=1000');
                const data = await response.json();

                if (data.success && data.firms) {
                    allPacs = data.firms.map(f => ({
                        ...f,
                        is_trade_association: f.is_trade_association || false,
                        total: (f.total || 0),
                        pac_amount: (f.pac_contributions || f.contributions || 0),
                        individual_amount: (f.individual_contributions || 0),
                        officials_count: (f.officials_count || f.officials || 0),
                        stock_trades: (f.stock_trades || 0)
                    }));
                    applyFiltersAndSort();
                }
            } catch (e) {
                console.error('Error loading PACs:', e);
                document.getElementById('pacs-body').innerHTML =
                    '<tr><td colspan="9" class="empty-state">Error loading data</td></tr>';
            }
        }

        function applyFiltersAndSort() {
            const searchQuery = document.getElementById('search-pac').value.toLowerCase();
            const typeFilter = document.getElementById('filter-type').value;
            const industryFilter = document.getElementById('filter-industry').value;

            // Filter
            filteredPacs = allPacs.filter(pac => {
                const matchesSearch = !searchQuery ||
                    (pac.name || '').toLowerCase().includes(searchQuery) ||
                    (pac.ticker || '').toLowerCase().includes(searchQuery);

                const matchesType = !typeFilter ||
                    (typeFilter === 'firm' && !pac.is_trade_association) ||
                    (typeFilter === 'trade_association' && pac.is_trade_association);

                const matchesIndustry = !industryFilter ||
                    (pac.industry || '').toLowerCase() === industryFilter ||
                    (pac.sector || '').toLowerCase() === industryFilter;

                return matchesSearch && matchesType && matchesIndustry;
            });

            // Sort
            filteredPacs.sort((a, b) => {
                let aVal = a[sortField] || 0;
                let bVal = b[sortField] || 0;

                if (sortField === 'name') {
                    aVal = (a.name || '').toLowerCase();
                    bVal = (b.name || '').toLowerCase();
                    return sortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }

                return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
            });

            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('pacs-body');
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pagePacs = filteredPacs.slice(start, end);

            if (pagePacs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No PACs found matching your filters</td></tr>';
            } else {
                tbody.innerHTML = pagePacs.map(pac => {
                    const typeClass = pac.is_trade_association ? 'trade-assoc' : 'firm';
                    const typeLabel = pac.is_trade_association ? 'Trade Assoc' : 'Firm';
                    const typeIcon = pac.is_trade_association ? 'fa-landmark' : 'fa-building';
                    const industry = formatIndustry(pac.industry || pac.sector || '');

                    return `
                        <tr onclick="window.location='/electwatch/pac/${encodeURIComponent(pac.name)}'">
                            <td class="pac-name">${cleanName(pac.name)}</td>
                            <td><span class="type-badge ${typeClass}"><i class="fas ${typeIcon}"></i> ${typeLabel}</span></td>
                            <td class="ticker">${pac.ticker || '--'}</td>
                            <td>${industry || '--'}</td>
                            <td class="amount">${formatAmount(pac.pac_amount)}</td>
                            <td class="amount">${formatAmount(pac.individual_amount)}</td>
                            <td class="amount"><strong>${formatAmount(pac.total)}</strong></td>
                            <td class="text-center">${pac.officials_count || 0}</td>
                            <td class="text-center">${pac.stock_trades || 0}</td>
                        </tr>
                    `;
                }).join('');
            }

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredPacs.length / pageSize);
            document.getElementById('pagination-info').textContent =
                `Page ${currentPage} of ${totalPages} (${filteredPacs.length} total)`;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function cleanName(name) {
            if (!name) return 'Unknown';
            // Remove common PAC suffixes for cleaner display
            return name
                .replace(/\s*(PAC|POLITICAL ACTION COMMITTEE|FEDERAL|FEDER)\s*$/gi, '')
                .replace(/\s+/g, ' ')
                .trim() || name;
        }

        function formatAmount(amount) {
            if (!amount || amount === 0) return '--';
            if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;
            if (amount >= 1000) return `$${Math.round(amount / 1000)}K`;
            return `$${amount.toLocaleString()}`;
        }

        function formatIndustry(code) {
            const names = {
                banking: 'Banking',
                investment: 'Investment',
                insurance: 'Insurance',
                mortgage: 'Mortgage',
                crypto: 'Crypto',
                fintech: 'Fintech',
                consumer_lending: 'Consumer Lending',
                payments: 'Payments'
            };
            return names[code?.toLowerCase()] || code || '';
        }

        // Event listeners
        document.getElementById('search-pac').addEventListener('input', applyFiltersAndSort);
        document.getElementById('filter-type').addEventListener('change', applyFiltersAndSort);
        document.getElementById('filter-industry').addEventListener('change', applyFiltersAndSort);

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredPacs.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // Sortable columns
        document.querySelectorAll('.pacs-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;

                // Toggle order if same field, otherwise default to desc
                if (field === sortField) {
                    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortOrder = 'desc';
                }

                // Update UI
                document.querySelectorAll('.pacs-table th.sortable').forEach(t => {
                    t.classList.remove('active', 'asc', 'desc');
                });
                th.classList.add('active', sortOrder);

                applyFiltersAndSort();
            });
        });

        // Initialize
        loadPacs();
    </script>
</body>
</html>
