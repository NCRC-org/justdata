<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectWatch - Financial Influence Monitor | NCRC JustData</title>
    <link rel="icon" type="image/png" href="{{ url_for('electwatch.static', filename='img/favicon.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tippy.js for hover popups -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/shift-away.css">
    <style>
        /* ========================================
           ElectWatch Design System
           ======================================== */
        :root {
            /* Primary Palette */
            --ew-primary: #2D8659;          /* NCRC Green - primary actions, links */
            --ew-secondary: #3B5998;        /* Slate Blue - secondary buttons, headers */
            --ew-accent: #D4A017;           /* Gold - AI content, special callouts */

            /* Neutral Palette */
            --ew-neutral-900: #1A1A2E;      /* Near Black - headings */
            --ew-neutral-700: #4A4A5A;      /* Dark Gray - body text */
            --ew-neutral-500: #8A8A9A;      /* Medium Gray - secondary text */
            --ew-neutral-200: #E5E5EA;      /* Light Gray - borders */
            --ew-neutral-50: #F8F8FA;       /* Off-White - backgrounds */

            /* Status Colors */
            --ew-error: #DC3545;            /* Red - errors, sell */
            --ew-success: #28A745;          /* Green - success, buy */
            --ew-warning: #F59E0B;          /* Amber - warnings */

            /* Industry Category Colors (max 4) */
            --ew-industry-banking: #3B82F6;     /* Blue - Banking/Depository */
            --ew-industry-investment: #8B5CF6;  /* Purple - Investment/Securities */
            --ew-industry-insurance: #14B8A6;   /* Teal - Insurance */
            --ew-industry-other: #6B7280;       /* Gray - All Other Financial */

            /* Party Colors */
            --party-r: #DC3545;
            --party-d: #2563EB;
            --party-i: #6B7280;

            /* Spacing System (8px base) */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-xxl: 48px;

            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 24px;

            /* Legacy mappings for compatibility */
            --ncrc-primary-blue: var(--ew-secondary);
            --ncrc-justdata-blue: var(--ew-primary);
            --ncrc-dark-blue: var(--ew-secondary);
            --ncrc-gold: var(--ew-accent);
            --ncrc-gray: var(--ew-neutral-500);
            --ncrc-gray-light: var(--ew-neutral-50);
            --ncrc-gray-dark: var(--ew-neutral-900);
            --success: var(--ew-success);
            --warning: var(--ew-warning);
            --danger: var(--ew-error);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-sm);
            background: var(--ew-neutral-50);
            color: var(--ew-neutral-700);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Typography Hierarchy - ProPublica-inspired with serif headlines */
        .page-title {
            font-family: Georgia, "Times New Roman", serif;
            font-size: 36px;
            font-weight: 700;
            color: var(--ew-neutral-900);
            margin-bottom: 8px;
        }
        .section-header {
            font-family: Georgia, "Times New Roman", serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--ew-neutral-900);
        }
        .card-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--ew-neutral-900);
        }
        .body-text {
            font-size: var(--font-size-sm);
            color: var(--ew-neutral-700);
        }
        .secondary-text {
            font-size: var(--font-size-xs);
            color: var(--ew-neutral-500);
        }

        /* Tabular numbers for data alignment */
        .numeric, .money, .percentage {
            font-variant-numeric: tabular-nums;
        }

        /* Entity Link Styles - Clickable entities throughout the app */
        .entity-link {
            color: var(--ew-primary);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.15s ease;
        }
        .entity-link:hover {
            color: var(--ew-secondary);
            text-decoration: underline;
        }
        .entity-official {
            font-weight: 500;
        }
        .entity-firm {
            font-weight: 500;
        }
        .entity-committee {
            font-weight: 500;
        }
        .entity-bill {
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Party Badge */
        .party-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: var(--font-size-xs);
            font-weight: 500;
        }
        .party-badge.party-r {
            background: rgba(220, 53, 69, 0.1);
            color: var(--party-r);
        }
        .party-badge.party-d {
            background: rgba(37, 99, 235, 0.1);
            color: var(--party-d);
        }
        .party-badge.party-i {
            background: rgba(107, 114, 128, 0.1);
            color: var(--party-i);
        }

        /* Industry Category Tags */
        .industry-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: var(--font-size-xs);
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.15s ease;
        }
        .industry-tag:hover {
            opacity: 0.8;
        }
        .industry-tag.banking {
            background: rgba(59, 130, 246, 0.1);
            color: var(--ew-industry-banking);
            border-left: 3px solid var(--ew-industry-banking);
        }
        .industry-tag.investment {
            background: rgba(139, 92, 246, 0.1);
            color: var(--ew-industry-investment);
            border-left: 3px solid var(--ew-industry-investment);
        }
        .industry-tag.insurance {
            background: rgba(20, 184, 166, 0.1);
            color: var(--ew-industry-insurance);
            border-left: 3px solid var(--ew-industry-insurance);
        }
        .industry-tag.other {
            background: rgba(107, 114, 128, 0.1);
            color: var(--ew-industry-other);
            border-left: 3px solid var(--ew-industry-other);
        }

        /* Header - Three Zone Layout */
        .header {
            background: var(--ew-secondary);
            color: white;
            padding: var(--space-md) var(--space-lg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: var(--space-lg);
        }

        /* Left Zone: Logo + Title */
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            text-decoration: none;
            color: inherit;
        }

        .logo img {
            height: 40px;
        }

        .logo-text h1 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin: 0;
        }

        .logo-text .tagline {
            font-size: var(--font-size-xs);
            opacity: 0.85;
        }

        /* Center Zone: Navigation Tabs */
        .header-center {
            display: flex;
            justify-content: center;
        }

        /* Right Zone: User Menu */
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        /* User Avatar Dropdown */
        .user-menu {
            position: relative;
        }

        .user-avatar-btn {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            padding: 4px 12px 4px 4px;
            color: white;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .user-avatar-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .user-avatar-btn img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .user-avatar-btn .user-name {
            font-size: var(--font-size-xs);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: var(--space-sm);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            display: none;
            z-index: 1000;
        }

        .user-dropdown.open,
        .user-dropdown.active {
            display: block;
        }

        .user-dropdown-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--ew-neutral-200);
        }

        .user-dropdown-email {
            font-size: var(--font-size-sm);
            color: var(--ew-neutral-900);
            font-weight: 500;
        }

        .user-dropdown-badge {
            display: inline-block;
            margin-top: var(--space-xs);
            padding: 2px 8px;
            background: var(--ew-primary);
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            color: var(--ew-neutral-700);
            text-decoration: none;
            font-size: var(--font-size-sm);
            transition: background 0.15s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-dropdown-item:hover {
            background: var(--ew-neutral-50);
        }

        .user-dropdown-item.admin-only {
            color: var(--ew-accent);
        }

        .user-dropdown-divider {
            height: 1px;
            background: var(--ew-neutral-200);
            margin: var(--space-xs) 0;
        }

        .logo-text h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }

        .logo-text .tagline {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* Navigation Tabs - Centered in Header */
        /* Navigation Tabs - ProPublica-inspired clean underline style */
        .nav-tabs {
            display: flex;
            gap: 0;
            background: transparent;
            padding: 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .nav-tab {
            padding: 14px 20px;
            border-radius: 0;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s ease;
            font-size: 14px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.75);
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
        }

        .nav-tab:hover {
            color: white;
            background: transparent;
        }

        .nav-tab.active {
            background: transparent;
            color: white;
            font-weight: 600;
            border-bottom-color: white;
        }

        .nav-tab i {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .nav-tab.active i {
            opacity: 1;
        }

        /* Admin-only nav tabs */
        .nav-tab.admin-nav-tab {
            border-left: 1px solid rgba(255,255,255,0.2);
            margin-left: 8px;
        }
        .nav-tab.admin-nav-tab i {
            color: var(--ew-accent);
        }
        .nav-tab.admin-nav-tab.active i {
            color: var(--ew-accent);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 32px;
        }

        /* Panels */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, white 100%);
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--ncrc-primary-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header h2 i {
            color: var(--ncrc-gold);
        }

        .card-body {
            padding: 20px 24px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--ncrc-justdata-blue);
            box-shadow: 0 0 0 3px rgba(26, 143, 201, 0.1);
        }

        .search-input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.2s;
            min-width: 180px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--ncrc-justdata-blue);
            box-shadow: 0 0 0 3px rgba(26, 143, 201, 0.1);
        }

        .search-input::placeholder {
            color: #9ca3af;
        }

        /* Reset Sort Button */
        .reset-sort-btn {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: var(--ew-neutral-700);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .reset-sort-btn:hover {
            border-color: var(--ew-primary);
            color: var(--ew-primary);
            background: rgba(45, 134, 89, 0.05);
        }

        .reset-sort-btn.visible {
            display: inline-flex;
        }

        .reset-sort-btn i {
            font-size: 0.85em;
        }

        /* Table Container - Responsive wrapper */
        .table-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .card-body .table-container {
            padding: 0;
            margin: 0;
        }

        /* Table wrapper for horizontal scroll on mobile */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 calc(-1 * var(--space-md));
            padding: 0 var(--space-md);
        }

        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: var(--ew-neutral-200);
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--ew-neutral-500);
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: var(--ew-neutral-700);
        }

        /* Leaderboard Table */
        .leaderboard-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            table-layout: auto;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .leaderboard-table th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--ncrc-gray);
            font-weight: 600;
            background: var(--ncrc-gray-light);
            position: relative;
        }

        .leaderboard-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .leaderboard-table th.sortable:hover {
            background: #e5e7eb;
        }

        .leaderboard-table th.sortable::after {
            content: '\f0dc';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 6px;
            font-size: 0.65rem;
            opacity: 0.4;
        }

        .leaderboard-table th.sortable.sort-asc::after {
            content: '\f0de';
            opacity: 1;
            color: var(--ncrc-justdata-blue);
        }

        .leaderboard-table th.sortable.sort-desc::after {
            content: '\f0dd';
            opacity: 1;
            color: var(--ncrc-justdata-blue);
        }

        /* Header Tooltips */
        .header-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .header-tooltip .tooltip-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            cursor: help;
        }

        .header-tooltip .tooltip-content {
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--ncrc-gray-dark);
            color: white;
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 400;
            text-transform: none;
            white-space: normal;
            width: 320px;
            line-height: 1.5;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        .header-tooltip .tooltip-content::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: var(--ncrc-gray-dark);
        }

        .header-tooltip:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-source {
            display: block;
            margin-top: 6px;
            font-size: 0.65rem;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 6px;
        }

        .leaderboard-table tr:hover {
            background: var(--ncrc-light-blue);
        }

        .leaderboard-table .rank {
            width: 50px;
            text-align: center;
            font-weight: 700;
            color: var(--ncrc-primary-blue);
        }

        .official-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .official-photo-container {
            position: relative;
            flex-shrink: 0;
        }

        .official-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }

        .official-photo.placeholder {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 1rem;
        }

        .party-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            font-size: 0.6rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .party-indicator.R { background: var(--party-r); }
        .party-indicator.D { background: var(--party-d); }
        .party-indicator.I { background: var(--party-i); }

        .party-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
            color: white;
        }

        .party-badge.R { background: var(--party-r); }
        .party-badge.D { background: var(--party-d); }
        .party-badge.I { background: var(--party-i); }

        .official-info {
            display: flex;
            flex-direction: column;
        }

        .official-name {
            font-weight: 600;
            color: var(--ew-primary);
            cursor: pointer;
            text-decoration: none;
            transition: color 0.15s ease;
        }

        .official-name:hover {
            text-decoration: underline;
            color: var(--ew-secondary);
        }

        /* Firm name links in tables */
        .firm-name {
            font-weight: 600;
            color: var(--ew-primary);
            cursor: pointer;
            text-decoration: none;
            transition: color 0.15s ease;
        }

        .firm-name:hover {
            text-decoration: underline;
            color: var(--ew-secondary);
        }

        .official-meta {
            font-size: 0.75rem;
            color: var(--ncrc-gray);
        }

        .amount-cell {
            text-align: right;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.85rem;
            min-width: 90px;
            white-space: nowrap;
        }

        .amount-cell .main {
            font-weight: 600;
            color: var(--ncrc-gray-dark);
        }

        .amount-cell .sub {
            font-size: 0.85rem;
            color: var(--ncrc-gray-dark);
        }

        .amount-cell .buy-amount {
            color: #16a34a;  /* Green for purchases */
        }

        .amount-cell .sell-amount {
            color: #dc2626;  /* Red for sales */
        }

        .score-cell {
            text-align: center;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .score-badge.high { background: #fee2e2; color: #dc2626; }
        .score-badge.medium { background: #fef3c7; color: #d97706; }
        .score-badge.low { background: #d1fae5; color: #059669; }

        /* Header Group Row */
        /* Table Header - ProPublica-inspired clean design */
        .header-group-row th {
            background: var(--ew-neutral-50);
            color: var(--ew-neutral-700);
            padding: 10px 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            border-bottom: 1px solid var(--ew-neutral-200);
        }

        .header-group-row th.financial-sector-group {
            text-align: center;
            color: var(--ew-secondary);
        }

        /* Financial sector column styling - subtle highlight */
        .leaderboard-table th.financial-sector-col {
            background: #fafbfc;
            white-space: nowrap;
        }

        .leaderboard-table th.financial-sector-col:hover {
            background: #f0f4f8;
        }

        .header-group-row .header-tooltip {
            color: var(--ew-secondary);
        }

        .header-group-row .tooltip-icon {
            background: var(--ew-neutral-200);
            color: white;
        }

        /* Industry Chips */
        .industry-chips {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        /* Industry Tags - Muted pastels (ProPublica-inspired) */
        .industry-chip {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Muted color palette - subtle, professional */
        .industry-chip.banking { background: #e8f4fc; color: #1565c0; }
        .industry-chip.crypto { background: #fcf8e8; color: #f57c00; }
        .industry-chip.investment { background: #f3e8fc; color: #7b1fa2; }
        .industry-chip.mortgage { background: #e8f0fc; color: #1976d2; }
        .industry-chip.insurance { background: #e8fcf8; color: #00796b; }
        .industry-chip.fintech { background: #fcf8e8; color: #f57c00; }
        .industry-chip.consumer_lending { background: #fce8e8; color: #c62828; }
        .industry-chip.consumer { background: #fce8e8; color: #c62828; }

        /* Default/fallback */
        .industry-chip:not([class*=" "]) { background: #f0f0f0; color: #555; }

        /* Trend Cell */
        .trend-cell {
            text-align: center;
            padding: 8px;
        }

        .trend-indicators {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: help;
        }

        .trend-arrow {
            font-size: 1.2rem;
            font-weight: bold;
            line-height: 1;
        }

        /* Trend arrow colors based on score change in last 6 months */
        .trend-arrow.up { color: var(--ew-success); }      /* Green - score increased */
        .trend-arrow.down { color: var(--ew-error); }      /* Red - score decreased */
        .trend-arrow.stable { color: var(--ncrc-gray); }   /* Gray - no change */
        .trend-arrow.no-data { color: var(--ncrc-gray); }  /* Gray - no trend data available */

        .stock-indicator {
            font-size: 0.8rem;
            line-height: 1;
        }

        .stock-indicator.buyer { color: var(--ncrc-justdata-blue); }
        .stock-indicator.seller { color: var(--ncrc-gray); }

        /* Donor Chips */
        .donor-chips {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .donor-chip {
            padding: 3px 8px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 500;
            background: var(--ew-secondary);
            color: white;
            cursor: pointer;
            white-space: nowrap;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        }

        .donor-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            background: var(--ew-primary);
        }

        .donor-chip.has-overlap {
            background: linear-gradient(135deg, var(--ew-secondary), var(--ew-accent));
            border: 1px solid var(--ew-accent);
        }

        /* AI Insights Panel */
        .insights-container {
            display: grid;
            gap: 16px;
        }

        .insight-card {
            background: linear-gradient(135deg, var(--ncrc-primary-blue), var(--ncrc-justdata-blue));
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(85, 45, 135, 0.3);
        }

        .insight-card h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .insight-card h3 i {
            color: var(--ncrc-gold);
        }

        .insight-card p {
            font-size: 0.95rem;
            line-height: 1.7;
            opacity: 0.95;
        }

        .insight-card .evidence {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.8rem;
            opacity: 0.75;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Committee Two-Column Layout */
        .committee-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .committee-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .column-header {
            font-size: 1.1rem;
            font-weight: 700;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .column-header.house {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }

        .column-header.senate {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            color: white;
        }

        .committee-leadership {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8rem;
            margin: 8px 0 12px 0;
            padding: 8px 12px;
            background: var(--ncrc-gray-light);
            border-radius: 6px;
        }

        .committee-leadership .chair {
            color: var(--party-r);
        }

        .committee-leadership .ranking {
            color: var(--party-d);
        }

        @media (max-width: 900px) {
            .committee-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Committee/Industry Grid */
        .sector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .sector-card {
            background: white;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .sector-card:hover {
            border-color: var(--ncrc-justdata-blue);
            box-shadow: 0 4px 12px rgba(26, 143, 201, 0.15);
            transform: translateY(-2px);
        }

        .sector-card h4 {
            font-size: 1rem;
            color: var(--ncrc-primary-blue);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sector-card .description {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
            margin-bottom: 16px;
        }

        .sector-stats {
            display: flex;
            gap: 20px;
        }

        .sector-stat {
            text-align: center;
        }

        .sector-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ncrc-justdata-blue);
        }

        .sector-stat .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--ncrc-gray);
            font-weight: 500;
        }

        /* Search Box */
        .search-box {
            position: relative;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--ncrc-justdata-blue);
            box-shadow: 0 0 0 3px rgba(26, 143, 201, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ncrc-gray);
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--ncrc-gray);
            font-weight: 500;
        }

        .loading::after {
            content: "";
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: var(--ncrc-justdata-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Refresh Button */
        .refresh-btn {
            padding: 10px 20px;
            background: var(--ncrc-primary-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: var(--ncrc-justdata-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(85, 45, 135, 0.3);
        }

        /* Footer */
        .footer {
            background: var(--ncrc-justdata-blue);
            padding: 20px;
            margin-top: 40px;
            text-align: center;
            color: white;
        }

        .footer a {
            color: var(--ncrc-gold);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Admin Navigation Buttons */
        .nav-admin-buttons {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .nav-admin-btn {
            background: #ff9800 !important;
            color: white !important;
            opacity: 1 !important;
        }

        .nav-admin-btn:hover {
            background: #f57c00 !important;
        }

        .nav-admin-btn.active {
            background: #e65100 !important;
            color: white !important;
        }

        .nav-admin-btn.refreshing {
            opacity: 0.7 !important;
            cursor: wait;
        }

        .nav-admin-btn.refreshing i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .version {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 8px;
        }

        /* Bill Lookup Styles */
        .bill-search-container {
            margin-bottom: 24px;
        }

        .search-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .bill-search-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .bill-search-input:focus {
            outline: none;
            border-color: var(--ncrc-justdata-blue);
            box-shadow: 0 0 0 3px rgba(26, 143, 201, 0.15);
        }

        .bill-search-btn {
            padding: 14px 24px;
            background: var(--ncrc-justdata-blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bill-search-btn:hover {
            background: var(--ncrc-primary-blue);
            transform: translateY(-1px);
        }

        .search-suggestions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-suggestions span {
            font-size: 0.85rem;
            color: var(--ncrc-gray);
        }

        .search-suggestions button {
            padding: 6px 12px;
            background: var(--ncrc-gray-light);
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-suggestions button:hover {
            background: var(--ncrc-justdata-blue);
            color: white;
            border-color: var(--ncrc-justdata-blue);
        }

        .bill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .bill-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bill-card:hover {
            border-color: var(--ncrc-justdata-blue);
            box-shadow: 0 4px 12px rgba(26, 143, 201, 0.15);
            transform: translateY(-2px);
        }

        .bill-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .remove-key-bill-btn {
            background: transparent;
            border: none;
            color: var(--ncrc-gray);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .remove-key-bill-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .bill-id-badge {
            display: inline-block;
            background: var(--ncrc-primary-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .bill-industries {
            display: flex;
            gap: 4px;
        }

        .bill-card h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--ncrc-gray-dark);
            margin-bottom: 8px;
        }

        .bill-card p {
            font-size: 0.85rem;
            color: var(--ncrc-gray);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .bill-card-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--ncrc-gray);
            padding-top: 12px;
            border-top: 1px solid #f3f4f6;
        }

        .bill-results-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bill-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--ncrc-gray-light);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bill-result-item:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .bill-result-info {
            flex: 1;
        }

        .bill-result-id {
            font-weight: 600;
            color: var(--ncrc-primary-blue);
            margin-right: 12px;
        }

        .bill-result-title {
            font-weight: 500;
            color: var(--ncrc-gray-dark);
        }

        .bill-result-meta {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
            margin-top: 4px;
        }

        /* Responsive Column Visibility Classes */
        .col-hide-xl { } /* visible on all screens */
        .col-hide-lg { } /* visible on large and up */
        .col-hide-md { } /* visible on medium and up */
        .col-hide-sm { } /* visible on small and up */

        /* Large screens (1200px and below) - hide least important columns */
        @media (max-width: 1200px) {
            .col-hide-xl {
                display: none !important;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 8px 10px;
            }
        }

        /* Medium screens (992px and below) */
        @media (max-width: 992px) {
            .col-hide-lg {
                display: none !important;
            }

            .main-content {
                padding: 16px;
            }

            .card-body {
                padding: 16px;
            }

            .leaderboard-table {
                min-width: 700px;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 8px;
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .col-hide-md {
                display: none !important;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            /* Keep auth controls right-aligned on mobile */
            .header-content > div:first-child {
                justify-content: space-between !important;
            }

            .logo {
                justify-content: flex-start;
            }

            .nav-tabs {
                justify-content: flex-start;
                overflow-x: auto;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .nav-tab span {
                display: none;
            }

            .main-content {
                padding: 12px;
            }

            .card-body {
                padding: 12px;
            }

            /* Table responsive wrapper shows scroll indicator */
            .table-responsive {
                margin: 0 -12px;
                padding: 0 12px;
                position: relative;
            }

            .table-responsive::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 24px;
                background: linear-gradient(to right, transparent, rgba(0,0,0,0.05));
                pointer-events: none;
            }

            .leaderboard-table {
                font-size: 0.8rem;
                min-width: 600px;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 6px 8px;
            }

            .card-header {
                flex-direction: column;
                align-items: stretch;
            }

            .filters {
                justify-content: center;
            }

            .sector-grid {
                grid-template-columns: 1fr;
            }

            .official-cell {
                gap: 8px;
            }

            .official-photo {
                width: 32px;
                height: 32px;
            }

            .amount-cell {
                min-width: 70px;
            }
        }

        /* Extra small screens (480px and below) */
        @media (max-width: 480px) {
            .col-hide-sm {
                display: none !important;
            }

            .main-content {
                padding: 8px;
            }

            .card-body {
                padding: 8px;
            }

            .leaderboard-table {
                font-size: 0.75rem;
                min-width: 450px;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 4px 6px;
            }

            .official-photo {
                width: 28px;
                height: 28px;
            }

            .filters {
                flex-direction: column;
            }

            .filter-select,
            .search-input {
                width: 100%;
            }
        }

        /* Print Styles */
        @media print {
            .header, .nav-tabs, .filters, .refresh-btn, .footer, .data-freshness-banner {
                display: none;
            }
            .main-content {
                max-width: 100%;
                padding: 0;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }

        /* Data Freshness Banner */
        .data-freshness-banner {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 12px 20px;
            border-bottom: 3px solid var(--ncrc-gold);
        }

        .data-freshness-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .data-freshness-main {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .freshness-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 194, 58, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .freshness-icon i {
            color: var(--ncrc-gold);
            font-size: 1.1rem;
        }

        .freshness-text {
            display: flex;
            flex-direction: column;
        }

        .freshness-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        .freshness-date {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .data-sources {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .data-source {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .data-source:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .data-source i {
            font-size: 0.9rem;
        }

        .source-name {
            font-weight: 600;
        }

        .source-date {
            opacity: 0.9;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .source-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            margin-left: 4px;
        }

        .source-info-icon {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-left: 4px;
        }

        /* Data Source Info Modal */
        .source-info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .source-info-modal.active {
            display: flex;
        }

        .source-info-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .source-info-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .source-info-header i {
            font-size: 1.5rem;
            color: var(--ncrc-gold);
        }

        .source-info-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .source-info-header .close-btn {
            margin-left: auto;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .source-info-header .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .source-info-body {
            padding: 24px;
        }

        .source-info-section {
            margin-bottom: 20px;
        }

        .source-info-section:last-child {
            margin-bottom: 0;
        }

        .source-info-section h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
            margin: 0 0 8px 0;
        }

        .source-info-section p {
            margin: 0;
            color: #333;
            line-height: 1.5;
        }

        .source-info-section a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .source-info-section a:hover {
            text-decoration: underline;
        }

        .source-info-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .source-meta-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .source-meta-item i {
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .source-meta-item span {
            font-size: 0.85rem;
        }

        .source-status.stale {
            background: var(--warning);
        }

        .source-status.old {
            background: var(--danger);
        }

        @media (max-width: 768px) {
            .data-freshness-content {
                flex-direction: column;
                text-align: center;
            }
            .data-sources {
                justify-content: center;
            }
        }

        /* Insight Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--ncrc-primary-blue), var(--ncrc-justdata-blue));
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal-header h2 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .modal-header h2 i {
            color: var(--ncrc-gold);
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 24px;
        }

        .insight-summary {
            font-size: 1.05rem;
            line-height: 1.8;
            color: var(--ncrc-gray-dark);
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .insight-section {
            margin-bottom: 24px;
        }

        .insight-section h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--ncrc-gray);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-section h3 i {
            color: var(--ncrc-justdata-blue);
        }

        .entity-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .entity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--ncrc-gray-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .entity-item:hover {
            background: var(--ncrc-light-blue);
            transform: translateX(4px);
        }

        .entity-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .entity-badge {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .entity-badge.firm { background: var(--ncrc-justdata-blue); }
        .entity-badge.official { background: var(--ncrc-primary-blue); }
        .entity-badge.industry { background: var(--ncrc-gold); color: var(--ncrc-gray-dark); }

        .entity-name {
            font-weight: 600;
            color: var(--ncrc-gray-dark);
        }

        .entity-meta {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
        }

        .entity-amount {
            font-weight: 700;
            color: var(--ncrc-justdata-blue);
            font-family: monospace;
        }

        .insight-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .insight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(85, 45, 135, 0.4);
        }

        .insight-card::after {
            content: "Click for details";
            display: block;
            margin-top: 12px;
            font-size: 0.75rem;
            opacity: 0.6;
            text-align: right;
        }

        /* Insight summary rich formatting */
        .insight-summary p {
            margin-bottom: 12px;
        }

        .insight-summary p:last-child {
            margin-bottom: 0;
        }

        .insight-summary strong {
            color: var(--ncrc-gray-dark);
            font-weight: 700;
        }

        /* Inline entity links */
        .insight-link {
            color: var(--ncrc-justdata-blue);
            text-decoration: none;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .insight-link:hover {
            text-decoration: underline;
            background: var(--ncrc-light-blue);
        }

        .insight-link-official {
            color: var(--ncrc-primary-blue);
        }

        .insight-link-firm {
            color: var(--ncrc-justdata-blue);
        }

        .insight-link-committee {
            color: #6366f1;
        }

        .insight-link-industry {
            color: #d97706;
        }

        /* Bullet lists in insights */
        .insight-bullets {
            margin: 12px 0;
            padding-left: 24px;
            list-style: none;
        }

        .insight-bullets li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 8px;
        }

        .insight-bullets li::before {
            content: "";
            position: absolute;
            left: -16px;
            color: var(--ncrc-justdata-blue);
            font-weight: bold;
        }

        /* Tables in insights */
        .insight-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 0.9rem;
        }

        .insight-table th,
        .insight-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .insight-table th {
            background: var(--ncrc-gray-light);
            font-weight: 600;
            color: var(--ncrc-gray-dark);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .insight-table tr:hover td {
            background: var(--ncrc-light-blue);
        }

        /* News sources list */
        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .source-item {
            padding: 12px 16px;
            background: var(--ncrc-gray-light);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .source-item:hover {
            background: var(--ncrc-light-blue);
        }

        .source-link {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            color: var(--ncrc-justdata-blue);
            text-decoration: none;
            font-weight: 500;
            line-height: 1.4;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        .source-link i {
            flex-shrink: 0;
            margin-top: 3px;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .source-title {
            flex: 1;
        }

        .source-meta {
            display: flex;
            gap: 12px;
            margin-top: 6px;
            padding-left: 24px;
            font-size: 0.8rem;
            color: var(--ncrc-gray);
        }

        .source-name {
            font-weight: 500;
        }

        .source-date {
            opacity: 0.8;
        }

        /* Admin Panel Styles */
        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--ncrc-gray-light);
            padding-bottom: 12px;
        }

        .admin-tab {
            padding: 10px 16px;
            border: none;
            background: var(--ncrc-gray-light);
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--ncrc-gray);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-tab:hover {
            background: #e0e0e0;
            color: var(--ncrc-gray-dark);
        }

        .admin-tab.active {
            background: var(--ncrc-justdata-blue);
            color: white;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-section {
            background: var(--ncrc-gray-light);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-section h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--ncrc-gray-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-description {
            font-size: 0.9rem;
            color: var(--ncrc-gray);
            margin-bottom: 16px;
        }

        .mapping-form {
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--ncrc-gray-dark);
            margin-bottom: 6px;
        }

        .admin-select, .admin-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .admin-select:focus, .admin-input:focus {
            outline: none;
            border-color: var(--ncrc-justdata-blue);
            box-shadow: 0 0 0 3px rgba(26, 143, 201, 0.1);
        }

        .admin-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .admin-btn.primary {
            background: var(--ncrc-justdata-blue);
            color: white;
        }

        .admin-btn.primary:hover {
            background: #1578a8;
        }

        .admin-btn.danger {
            background: var(--danger);
            color: white;
        }

        .admin-btn.danger:hover {
            background: #dc2626;
        }

        .aliases-list {
            margin: 16px 0;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #bae6fd;
        }

        .aliases-list label {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
            margin-bottom: 8px;
        }

        .alias-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 6px 12px;
            border-radius: 16px;
            margin: 4px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
        }

        .alias-tag .remove-alias {
            cursor: pointer;
            color: var(--ncrc-gray);
            font-size: 0.75rem;
        }

        .alias-tag .remove-alias:hover {
            color: var(--danger);
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            font-size: 0.9rem;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .existing-mappings {
            max-height: 400px;
            overflow-y: auto;
        }

        .mapping-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
        }

        .mapping-item:hover {
            border-color: var(--ncrc-justdata-blue);
        }

        .mapping-item .mapping-info {
            flex: 1;
        }

        .mapping-item .mapping-canonical {
            font-weight: 500;
            color: var(--ncrc-gray-dark);
        }

        .mapping-item .mapping-aliases {
            font-size: 0.85rem;
            color: var(--ncrc-gray);
            margin-top: 4px;
        }

        .mapping-item .mapping-actions {
            display: flex;
            gap: 8px;
        }

        .mapping-item .edit-btn, .mapping-item .delete-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .mapping-item .edit-btn {
            background: var(--ncrc-gray-light);
            color: var(--ncrc-gray-dark);
        }

        .mapping-item .delete-btn {
            background: #fee2e2;
            color: #991b1b;
        }

        .search-results {
            margin: 16px 0;
            padding: 12px;
            background: #fffbeb;
            border-radius: 6px;
            border: 1px solid #fde68a;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .search-result-item:hover {
            border-color: var(--ncrc-justdata-blue);
            background: #f0f9ff;
        }

        .search-result-item.selected {
            border-color: var(--ncrc-justdata-blue);
            background: #e0f2fe;
        }

        .search-result-item .employer-name {
            font-weight: 500;
        }

        .search-result-item .contribution-count {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
        }

        .search-filter {
            margin-bottom: 16px;
        }

        /* Unmatched Entities Styles */
        .unmatched-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--ncrc-justdata-blue);
            background: #f0f9ff;
        }

        .filter-btn.active {
            background: var(--ncrc-justdata-blue);
            color: white;
            border-color: var(--ncrc-justdata-blue);
        }

        .filter-btn .badge {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .filter-btn.active .badge {
            background: rgba(255,255,255,0.2);
        }

        .unmatched-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .unmatched-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
        }

        .unmatched-item:hover {
            border-color: var(--ncrc-orange);
            background: #fff7ed;
        }

        .unmatched-item .entity-name {
            font-weight: 500;
            word-break: break-word;
        }

        .unmatched-item .entity-meta {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
            margin-top: 2px;
        }

        .unmatched-item .action-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            background: var(--ncrc-orange);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .unmatched-item .action-btn:hover {
            background: #c2410c;
        }
    </style>
</head>
<body>
    <!-- Header - Three Zone Layout -->
    <header class="header">
        <div class="header-content">
            <!-- LEFT ZONE: Logo + Title -->
            <div class="header-left">
                <a href="/" class="logo" aria-label="Return to JustData Home">
                    <img src="/static/img/justdata-logo.png" alt="JustData" onerror="this.style.display='none'">
                    <div class="logo-text">
                        <h1>ElectWatch</h1>
                    </div>
                </a>
            </div>

            <!-- CENTER ZONE: Navigation Tabs -->
            <div class="header-center">
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-panel="leaderboard">
                        <i class="fas fa-trophy"></i>
                        <span>Leaderboard</span>
                    </button>
                    <button class="nav-tab" data-panel="committees">
                        <i class="fas fa-building-columns"></i>
                        <span>Committees</span>
                    </button>
                    <button class="nav-tab" data-panel="industries">
                        <i class="fas fa-industry"></i>
                        <span>Industries</span>
                    </button>
                    <button class="nav-tab" data-panel="firms">
                        <i class="fas fa-briefcase"></i>
                        <span>Firms</span>
                    </button>
                    <button class="nav-tab" data-panel="insights">
                        <i class="fas fa-brain"></i>
                        <span>AI Insights</span>
                    </button>
                    <button class="nav-tab" data-panel="bills">
                        <i class="fas fa-scroll"></i>
                        <span>Bill Lookup</span>
                    </button>
                    <!-- Admin-only tabs (hidden by default, shown via JS for admin users) -->
                    <button class="nav-tab admin-nav-tab" data-panel="matching" style="display: none;">
                        <i class="fas fa-link"></i>
                        <span>Matching</span>
                    </button>
                    <button class="nav-tab admin-nav-tab" data-panel="deduplicate" style="display: none;">
                        <i class="fas fa-clone"></i>
                        <span>Deduplicate</span>
                    </button>
                </nav>
            </div>

            <!-- RIGHT ZONE: User Menu -->
            <div class="header-right">
                <!-- User Info (shown when logged in) -->
                <div id="userInfo" style="display: none; align-items: center; gap: 8px;">
                    <img id="userAvatar" src="" alt="User" style="width: 32px; height: 32px; border-radius: 50%; display: none;">
                    <div style="display: flex; flex-direction: column; align-items: flex-start;">
                        <span id="userEmail" style="color: white; font-size: 13px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                        <span id="userTypeBadge" style="color: #90EE90; font-size: 10px; text-transform: uppercase; font-weight: 600;"></span>
                    </div>
                </div>

                <!-- Login Button (shown when NOT logged in) -->
                <button id="loginBtn" onclick="JustDataAuth.signInWithGoogle()" style="display: inline-flex; align-items: center; gap: 6px; background: white; color: var(--ew-secondary, #3B5998); border: none; border-radius: 6px; padding: 8px 14px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.2s;">
                    <i class="fab fa-google" style="font-size: 14px;"></i>
                    <span>Sign In</span>
                </button>

                <!-- Logout Button (shown when logged in) -->
                <button id="logoutBtn" onclick="JustDataAuth.signOut()" style="display: none; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; padding: 8px 14px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.2s;">
                    <i class="fas fa-sign-out-alt" style="font-size: 14px;"></i>
                    <span>Sign Out</span>
                </button>

                <!-- User Options Dropdown (additional options when logged in) -->
                <div id="userMenu" class="user-menu" style="display: none;">
                    <button class="user-avatar-btn" onclick="toggleUserDropdown()" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-ellipsis-v" style="color: white;"></i>
                    </button>
                    <div id="userDropdown" class="user-dropdown">
                        {% if is_staff %}
                        <button class="user-dropdown-item" onclick="refreshElectWatchData(); toggleUserDropdown();">
                            <i class="fas fa-sync-alt"></i>
                            Refresh Data
                        </button>
                        {% endif %}
                        {% if is_admin %}
                        <button class="user-dropdown-item admin-only" onclick="switchToPanel('admin'); toggleUserDropdown();">
                            <i class="fas fa-cog"></i>
                            Data Mapper
                        </button>
                        {% endif %}
                        <a href="/" class="user-dropdown-item">
                            <i class="fas fa-th-large"></i>
                            All JustData Apps
                        </a>
                    </div>
                </div>

                <!-- Hamburger Menu -->
                <button class="hamburger-menu" onclick="toggleNavMenu()" aria-label="Toggle navigation menu" style="background: none; border: none; cursor: pointer; padding: 8px; display: flex; flex-direction: column; gap: 5px;">
                    <span style="display: block; width: 24px; height: 3px; background: white; border-radius: 2px;"></span>
                    <span style="display: block; width: 24px; height: 3px; background: white; border-radius: 2px;"></span>
                    <span style="display: block; width: 24px; height: 3px; background: white; border-radius: 2px;"></span>
                </button>
            </div>
        </div>

        <!-- Mobile Nav Menu (hidden by default) -->
        <nav id="navMenu" class="app-nav-dropdown" style="display: none; position: absolute; top: 100%; right: 20px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; min-width: 220px; z-index: 1000;">
            <a href="/" class="nav-item" style="display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;"><i class="fas fa-home" style="margin-right: 10px;"></i>Home</a>
            <a href="/lendsight" class="nav-item" style="display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;"><i class="fas fa-chart-line" style="margin-right: 10px;"></i>LendSight</a>
            <a href="/bizsight" class="nav-item" style="display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;"><i class="fas fa-briefcase" style="margin-right: 10px;"></i>BizSight</a>
            <a href="/branchsight" class="nav-item" style="display: block; padding: 12px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee;"><i class="fas fa-building" style="margin-right: 10px;"></i>BranchSight</a>
            <a href="/dataexplorer" class="nav-item" style="display: block; padding: 12px 20px; color: #333; text-decoration: none;"><i class="fas fa-search" style="margin-right: 10px;"></i>DataExplorer</a>
        </nav>
    </header>

    <!-- Data Freshness Banner -->
    <div class="data-freshness-banner">
        <div class="data-freshness-content">
            <div class="data-freshness-main">
                <div class="freshness-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="freshness-text">
                    <span class="freshness-label">Data Coverage Period</span>
                    <span id="freshness-date" class="freshness-date">Loading...</span>
                </div>
            </div>
            <div class="data-sources">
                <div class="data-source" onclick="showSourceInfo('fec')" title="Click for details">
                    <i class="fas fa-hand-holding-dollar"></i>
                    <span class="source-name">FEC</span>
                    <span id="fec-date" class="source-date">--</span>
                    <span id="fec-status" class="source-status"></span>
                    <i class="fas fa-info-circle source-info-icon"></i>
                </div>
                <div class="data-source" onclick="showSourceInfo('stock')" title="Click for details">
                    <i class="fas fa-chart-line"></i>
                    <span class="source-name">STOCK Act</span>
                    <span id="stock-date" class="source-date">--</span>
                    <span id="stock-status" class="source-status"></span>
                    <i class="fas fa-info-circle source-info-icon"></i>
                </div>
                <div class="data-source" onclick="showSourceInfo('committee')" title="Click for details">
                    <i class="fas fa-building-columns"></i>
                    <span class="source-name">Committees</span>
                    <span id="committee-date" class="source-date">--</span>
                    <span id="committee-status" class="source-status"></span>
                    <i class="fas fa-info-circle source-info-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Source Info Modal -->
    <div id="source-info-modal" class="source-info-modal" onclick="if(event.target === this) closeSourceInfo()">
        <div class="source-info-content">
            <div class="source-info-header">
                <i id="source-info-icon" class="fas fa-hand-holding-dollar"></i>
                <h3 id="source-info-title">Data Source</h3>
                <button class="close-btn" onclick="closeSourceInfo()"><i class="fas fa-times"></i></button>
            </div>
            <div class="source-info-body">
                <div class="source-info-section">
                    <h4>Description</h4>
                    <p id="source-info-description">Loading...</p>
                </div>
                <div class="source-info-section">
                    <h4>Data Source</h4>
                    <p id="source-info-origin">Loading...</p>
                </div>
                <div class="source-info-section">
                    <h4>Update Frequency</h4>
                    <div class="source-info-meta">
                        <div class="source-meta-item">
                            <i class="fas fa-sync"></i>
                            <span id="source-info-frequency">--</span>
                        </div>
                        <div class="source-meta-item">
                            <i class="fas fa-clock"></i>
                            <span id="source-info-delay">--</span>
                        </div>
                    </div>
                </div>
                <div class="source-info-section">
                    <h4>Notes</h4>
                    <p id="source-info-notes">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Leaderboard Panel -->
        <div id="leaderboard" class="panel active">
            <div class="card">
                <div class="card-header" style="flex-direction: column; align-items: stretch; gap: 16px;">
                    <h2 class="page-title" style="margin: 0;">Officials by Financial Involvement</h2>
                    <p class="secondary-text" style="margin: 0;">Campaign contributions and stock trades by members of Congress in financial sector companies</p>
                    <div class="filters">
                        <input type="text" class="search-input" id="search-official" placeholder="Search by name...">
                        <select class="filter-select" id="filter-chamber">
                            <option value="">All Chambers</option>
                            <option value="house">House</option>
                            <option value="senate">Senate</option>
                        </select>
                        <select class="filter-select" id="filter-party">
                            <option value="">All Parties</option>
                            <option value="R">Republican</option>
                            <option value="D">Democrat</option>
                            <option value="I">Independent</option>
                        </select>
                        <select class="filter-select" id="filter-industry">
                            <option value="">All Industries</option>
                            {% for code, info in sectors.items() %}
                            <option value="{{ code }}">{{ info.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="reset-sort-btn" id="reset-sort-btn" title="Reset to default sort (by score)">
                            <i class="fas fa-undo"></i> Reset Sort
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                    <table class="leaderboard-table">
                        <thead>
                            <!-- Group header row -->
                            <tr class="header-group-row">
                                <th colspan="4"></th>
                                <th colspan="5" class="financial-sector-group">
                                    <span class="header-tooltip">
                                        <i class="fas fa-landmark"></i> Financial Sector Involvement
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>What We Track:</strong><br>
                                            PAC + individual contributions and stock trades involving finance/housing sector firms (24 months).<br><br>
                                            <strong>Contributions Include:</strong><br>
                                             PAC contributions from financial firm PACs<br>
                                             Individual contributions from finance/housing employees<br><br>
                                            <strong>Industries Covered:</strong><br>
                                             Banking, Investment, Insurance<br>
                                             Mortgage & Consumer Finance<br>
                                             Real Estate, REITs, Homebuilders<br>
                                             Fintech & Crypto
                                            <span class="tooltip-source">Source: FEC Schedule A, STOCK Act disclosures</span>
                                        </span>
                                    </span>
                                </th>
                            </tr>
                            <!-- Column headers -->
                            <tr>
                                <th class="rank" style="width: 40px;">#</th>
                                <th class="sortable" data-sort="name" data-order="asc" style="width: 200px;">
                                    <span class="header-tooltip">
                                        Official
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            Members of Congress ranked by financial sector involvement score.
                                            <span class="tooltip-source">Source: Congress.gov</span>
                                        </span>
                                    </span>
                                </th>
                                <th style="width: 180px;">
                                    <span class="header-tooltip">
                                        Top Firms
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            Top financial firms by stock trading activity.<br>
                                            Shows companies this official trades most actively.
                                            <span class="tooltip-source">Source: STOCK Act disclosures</span>
                                        </span>
                                    </span>
                                </th>
                                <th style="width: 100px;">
                                    <span class="header-tooltip">
                                        Trend
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            <strong>Top:</strong> Finance contribution % trend ( increasing,  decreasing)<br>
                                            <strong>Bottom:</strong> Stock activity ( net buyer,  net seller)
                                            <span class="tooltip-source">Hover for detailed history</span>
                                        </span>
                                    </span>
                                </th>
                                <th class="sortable financial-sector-col" data-sort="total_contributions" data-order="desc" style="width: 90px;">
                                    <span class="header-tooltip">
                                        Total $
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            Total contributions (PAC + Individual) from all sources over the last 24 months.
                                            <span class="tooltip-source">Source: FEC Schedule A</span>
                                        </span>
                                    </span>
                                </th>
                                <th class="sortable active financial-sector-col" data-sort="finance_contributions" data-order="desc" style="width: 90px;">
                                    <span class="header-tooltip">
                                        Finance $
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            Contributions from finance/housing sector (PAC + individual employee donations).
                                            <span class="tooltip-source">Source: FEC Schedule A</span>
                                        </span>
                                    </span>
                                </th>
                                <th class="sortable financial-sector-col" data-sort="financial_pct" data-order="desc" style="width: 70px;">
                                    <span class="header-tooltip">
                                        Finance %
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            Finance/housing $ as percentage of total contributions.<br>
                                            Higher % = more reliant on financial industry money.
                                            <span class="tooltip-source">Calculation: Finance $  Total $</span>
                                        </span>
                                    </span>
                                </th>
                                <th class="sortable financial-sector-col" data-sort="buys" data-order="desc" style="width: 80px;">
                                    <span class="header-tooltip">
                                        Buys
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            Stock PURCHASES in finance/housing companies (24 months).
                                            <span class="tooltip-source">Source: STOCK Act disclosures</span>
                                        </span>
                                    </span>
                                </th>
                                <th class="sortable financial-sector-col" data-sort="sells" data-order="desc" style="width: 80px;">
                                    <span class="header-tooltip">
                                        Sells
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">
                                            Stock SALES in finance/housing companies (24 months).
                                            <span class="tooltip-source">Source: STOCK Act disclosures</span>
                                        </span>
                                    </span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                    <div id="leaderboard-loading" class="loading">Loading officials...</div>
                </div>
            </div>
        </div>

        <!-- Committees Panel -->
        <div id="committees" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-gavel"></i> Committee Financial Analysis</h2>
                    <span style="font-size: 0.85rem; color: var(--ncrc-gray);">Finance-related committees monitored by ElectWatch</span>
                </div>
                <div class="card-body">
                    <div class="committee-columns">
                        <!-- House Committees - Left Column -->
                        <div class="committee-column">
                            <div class="column-header house">
                                <i class="fas fa-landmark"></i> House Committees
                            </div>

                            <div class="sector-card" onclick="showCommittee('house_financial_services')">
                                <h4><i class="fas fa-university"></i> Financial Services</h4>
                                <p class="description">Banking, securities, insurance, housing, crypto regulation</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> J. French Hill (R-AR)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Maxine Waters (D-CA)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$4.2M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">71</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">156</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('house_ways_means')">
                                <h4><i class="fas fa-coins"></i> Ways and Means</h4>
                                <p class="description">Tax policy, trade, Social Security, Medicare</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Jason Smith (R-MO)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Richard Neal (D-MA)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$3.1M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">43</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">112</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('house_budget')">
                                <h4><i class="fas fa-calculator"></i> Budget</h4>
                                <p class="description">Federal budget, spending oversight, fiscal policy</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Jodey Arrington (R-TX)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Brendan Boyle (D-PA)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$1.8M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">36</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">67</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('house_small_business')">
                                <h4><i class="fas fa-store"></i> Small Business</h4>
                                <p class="description">Small business lending, SBA oversight, entrepreneurship</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Roger Williams (R-TX)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Nydia Velazquez (D-NY)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$1.2M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">27</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">34</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('house_appropriations')">
                                <h4><i class="fas fa-money-check-alt"></i> Appropriations</h4>
                                <p class="description">Federal spending, agency budgets, financial regulation funding</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Tom Cole (R-OK)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Rosa DeLauro (D-CT)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$2.9M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">51</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">98</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Senate Committees - Right Column -->
                        <div class="committee-column">
                            <div class="column-header senate">
                                <i class="fas fa-building-columns"></i> Senate Committees
                            </div>

                            <div class="sector-card" onclick="showCommittee('senate_banking')">
                                <h4><i class="fas fa-university"></i> Banking, Housing, and Urban Affairs</h4>
                                <p class="description">Banking regulation, housing finance, CFPB oversight</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Tim Scott (R-SC)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Sherrod Brown (D-OH)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$2.8M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">24</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">89</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('senate_finance')">
                                <h4><i class="fas fa-file-invoice-dollar"></i> Finance</h4>
                                <p class="description">Tax policy, trade, health programs, Social Security</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Mike Crapo (R-ID)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Ron Wyden (D-OR)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$2.4M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">28</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">78</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('senate_budget')">
                                <h4><i class="fas fa-calculator"></i> Budget</h4>
                                <p class="description">Federal budget, fiscal policy, debt ceiling</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Lindsey Graham (R-SC)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Sheldon Whitehouse (D-RI)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$1.5M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">22</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">45</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('senate_small_business')">
                                <h4><i class="fas fa-store"></i> Small Business and Entrepreneurship</h4>
                                <p class="description">SBA programs, small business lending, access to capital</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Joni Ernst (R-IA)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Jeanne Shaheen (D-NH)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$0.9M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">19</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">28</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="sector-card" onclick="showCommittee('senate_appropriations')">
                                <h4><i class="fas fa-money-check-alt"></i> Appropriations</h4>
                                <p class="description">Federal spending, agency budgets, discretionary funding</p>
                                <div class="committee-leadership">
                                    <span class="chair"><strong>Chair:</strong> Susan Collins (R-ME)</span>
                                    <span class="ranking"><strong>Ranking:</strong> Patty Murray (D-WA)</span>
                                </div>
                                <div class="sector-stats">
                                    <div class="sector-stat">
                                        <div class="value">$2.2M</div>
                                        <div class="label">Total PAC $</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">30</div>
                                        <div class="label">Members</div>
                                    </div>
                                    <div class="sector-stat">
                                        <div class="value">72</div>
                                        <div class="label">Trades</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Industries Panel -->
        <div id="industries" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-pie"></i> Industry Sector Analysis</h2>
                </div>
                <div class="card-body">
                    <div class="sector-grid">
                        {% for code, info in sectors.items() %}
                        <div class="sector-card" onclick="showIndustryDetail('{{ code }}')">
                            <h4>
                                {% if code == 'banking' %}<i class="fas fa-university"></i>
                                {% elif code == 'crypto' %}<i class="fab fa-bitcoin"></i>
                                {% elif code == 'mortgage' %}<i class="fas fa-home"></i>
                                {% elif code == 'investment' %}<i class="fas fa-chart-line"></i>
                                {% elif code == 'insurance' %}<i class="fas fa-shield-alt"></i>
                                {% elif code == 'fintech' %}<i class="fas fa-mobile-alt"></i>
                                {% elif code == 'consumer_lending' %}<i class="fas fa-credit-card"></i>
                                {% else %}<i class="fas fa-industry"></i>
                                {% endif %}
                                {{ info.name }}
                            </h4>
                            <p class="description">{{ info.description }}</p>
                            <div class="sector-stats">
                                <div class="sector-stat">
                                    <div class="value" id="stat-{{ code }}-officials">--</div>
                                    <div class="label">Officials</div>
                                </div>
                                <div class="sector-stat">
                                    <div class="value" id="stat-{{ code }}-total">--</div>
                                    <div class="label">Total $</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Firms Panel -->
        <div id="firms" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-building"></i> Top Firms & PACs by Total Contributions</h2>
                    <div class="search-box" style="max-width: 300px;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="firm-search" placeholder="Filter firms...">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                    <table class="leaderboard-table" id="firms-table">
                        <thead>
                            <tr>
                                <th class="rank">#</th>
                                <th>Firm / PAC</th>
                                <th>Industry</th>
                                <th style="text-align: right;">Total Contributions</th>
                                <th style="text-align: center;">Officials</th>
                                <th style="text-align: center;">Stock Trades</th>
                            </tr>
                        </thead>
                        <tbody id="firms-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                    <div id="firms-loading" class="loading">Loading firms...</div>
                </div>
            </div>
        </div>

        <!-- AI Insights Panel -->
        <div id="insights" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-lightbulb"></i> AI Pattern Detection</h2>
                    <button class="refresh-btn" onclick="refreshInsights(true)">
                        <i class="fas fa-sync-alt"></i> Refresh Analysis
                    </button>
                </div>
                <div class="card-body">
                    <div class="insights-container" id="insights-container">
                        <!-- AI-generated insights -->
                        <div class="insight-card">
                            <h3><i class="fas fa-coins"></i> Crypto Industry Concentration</h3>
                            <p>
                                Coinbase and related crypto firms have contributed $1.2M to Republican members
                                of the House Financial Services Committee in 2025. Simultaneously, 8 of these
                                members have reported COIN stock purchases totaling $180K-$400K.
                            </p>
                            <div class="evidence">
                                <i class="fas fa-database"></i>
                                Based on FEC filings and STOCK Act disclosures through Jan 2026
                            </div>
                        </div>

                        <div class="insight-card">
                            <h3><i class="fas fa-chart-line"></i> Banking PAC Activity Spike</h3>
                            <p>
                                Wells Fargo and JPMorgan PAC contributions to Senate Banking Committee members
                                increased 45% in Q4 2025 compared to Q3, correlating with upcoming CFPB oversight
                                hearings scheduled for February 2026.
                            </p>
                            <div class="evidence">
                                <i class="fas fa-database"></i>
                                FEC data analysis comparing quarterly contribution trends
                            </div>
                        </div>

                        <div class="insight-card">
                            <h3><i class="fas fa-balance-scale"></i> Cross-Party Pattern: Fintech</h3>
                            <p>
                                Fintech firms (PayPal, Block, Stripe) show unusually balanced contributions
                                across party lines, with 52% to Democrats and 48% to Republicanssignificantly
                                more balanced than traditional banking (68% R / 32% D).
                            </p>
                            <div class="evidence">
                                <i class="fas fa-database"></i>
                                Comparative analysis of contribution patterns by industry
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill Lookup Panel -->
        <div id="bills" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-scroll"></i> Bill Lookup & Conflict Analysis</h2>
                    <span style="font-size: 0.85rem; color: var(--ncrc-gray);">Search for any bill to see voting records and financial conflicts</span>
                </div>
                <div class="card-body">
                    <!-- Search Box -->
                    <div class="bill-search-container">
                        <div class="search-input-group">
                            <input type="text" id="bill-search-input" placeholder="Enter bill ID (e.g., H.R. 4763) or search keywords (e.g., cryptocurrency, stablecoin)" class="bill-search-input">
                            <button onclick="searchBills()" class="bill-search-btn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <div class="search-suggestions">
                            <span>Try:</span>
                            <button onclick="searchBills('crypto')">crypto</button>
                            <button onclick="searchBills('stablecoin')">stablecoin</button>
                            <button onclick="searchBills('H.R. 4763')">H.R. 4763</button>
                            <button onclick="searchBills('banking')">banking</button>
                            <button onclick="searchBills('consumer protection')">consumer protection</button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="bill-search-results" style="display: none;">
                        <h3 style="margin: 20px 0 16px; font-size: 1rem; color: var(--ncrc-gray-dark);">
                            <i class="fas fa-list"></i> Search Results
                            <span id="bill-results-count" style="font-weight: 400; color: var(--ncrc-gray);"></span>
                        </h3>
                        <div id="bill-results-list" class="bill-results-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Dynamic Key Bills (loaded from API) -->
                    <div id="staff-key-bills">
                        <h3 style="margin: 30px 0 16px; font-size: 1rem; color: var(--ncrc-gray-dark);">
                            <i class="fas fa-star" style="color: var(--ncrc-gold);"></i> Staff-Curated Key Bills
                        </h3>
                        <div id="dynamic-key-bills" class="bill-grid">
                            <!-- Populated by loadKeyBills() -->
                        </div>
                    </div>

                    <!-- Featured Bills (Static) -->
                    <div id="featured-bills">
                        <h3 style="margin: 30px 0 16px; font-size: 1rem; color: var(--ncrc-gray-dark);">
                            <i class="fas fa-scroll"></i> Notable Finance Bills (119th Congress)
                        </h3>
                        <div class="bill-grid">
                            <div class="bill-card" onclick="window.location='bill/hr4763'">
                                <div class="bill-card-header">
                                    <span class="bill-id-badge">H.R. 4763</span>
                                    <div class="bill-industries">
                                        <span class="industry-chip crypto">crypto</span>
                                        <span class="industry-chip fintech">fintech</span>
                                    </div>
                                </div>
                                <h4>FIT21 Act</h4>
                                <p>Financial Innovation and Technology for the 21st Century Act - establishes regulatory framework for digital assets</p>
                                <div class="bill-card-footer">
                                    <span><i class="fas fa-check-circle" style="color: var(--success);"></i> Passed House 279-136</span>
                                    <span><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> 8 voters with conflicts</span>
                                </div>
                            </div>

                            <div class="bill-card" onclick="window.location='bill/hr5403'">
                                <div class="bill-card-header">
                                    <span class="bill-id-badge">H.R. 5403</span>
                                    <div class="bill-industries">
                                        <span class="industry-chip crypto">crypto</span>
                                        <span class="industry-chip banking">banking</span>
                                    </div>
                                </div>
                                <h4>CBDC Anti-Surveillance Act</h4>
                                <p>Prohibits Federal Reserve from issuing a central bank digital currency directly to individuals</p>
                                <div class="bill-card-footer">
                                    <span><i class="fas fa-check-circle" style="color: var(--success);"></i> Passed House 216-192</span>
                                    <span><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> 6 voters with conflicts</span>
                                </div>
                            </div>

                            <div class="bill-card" onclick="searchBills('stablecoin')">
                                <div class="bill-card-header">
                                    <span class="bill-id-badge">H.R. 4766</span>
                                    <div class="bill-industries">
                                        <span class="industry-chip crypto">crypto</span>
                                        <span class="industry-chip banking">banking</span>
                                    </div>
                                </div>
                                <h4>Stablecoin Act</h4>
                                <p>Clarity for Payment Stablecoins Act - regulatory framework for stablecoin issuers</p>
                                <div class="bill-card-footer">
                                    <span><i class="fas fa-clock" style="color: var(--warning);"></i> In Committee</span>
                                </div>
                            </div>

                            <div class="bill-card" onclick="searchBills('cfpb')">
                                <div class="bill-card-header">
                                    <span class="bill-id-badge">H.R. 1112</span>
                                    <div class="bill-industries">
                                        <span class="industry-chip consumer_lending">consumer</span>
                                        <span class="industry-chip banking">banking</span>
                                    </div>
                                </div>
                                <h4>CFPB Accountability Act</h4>
                                <p>Consumer Financial Protection Bureau Accountability Act - reforms CFPB funding and oversight</p>
                                <div class="bill-card-footer">
                                    <span><i class="fas fa-clock" style="color: var(--warning);"></i> In Committee</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if is_admin %}
        <!-- Admin Matching Panel --><div id="matching" class="panel"><div class="card"><div class="card-header"><h2><i class="fas fa-link"></i> Match Firms & Officials</h2><span style="font-size:0.85rem;color:var(--ncrc-gray);">Link entities across data sources</span></div><div class="card-body"><div class="admin-tabs"><button class="admin-tab active" data-matching-panel="firm-matching"><i class="fas fa-building"></i> Firm Matching</button><button class="admin-tab" data-matching-panel="official-matching"><i class="fas fa-user-tie"></i> Official Matching</button><button class="admin-tab" data-matching-panel="pac-matching"><i class="fas fa-hand-holding-usd"></i> PAC Matching</button></div><div id="matching-firm-matching" class="admin-panel active"><div class="admin-section"><h3><i class="fas fa-building"></i> Match Firm Names</h3><p class="admin-description">Link firm name variations to canonical firm records.</p><div class="mapping-form" style="margin-top:15px;"><div class="form-group"><label>Search:</label><input type="text" id="firm-match-search" class="admin-input" placeholder="e.g., Goldman..." oninput="searchUnmatchedFirmsMatching()"></div><div id="unmatched-firms-results" class="existing-mappings" style="max-height:300px;overflow-y:auto;"><p style="color:var(--ncrc-gray);font-style:italic;">Enter search term</p></div></div><div class="mapping-form" style="margin-top:20px;padding-top:20px;border-top:1px solid var(--ew-neutral-200);"><h4><i class="fas fa-link"></i> Create Match</h4><div class="form-group"><label>Canonical Firm:</label><select id="match-target-firm" class="admin-select"><option value="">-- Select --</option></select></div><div class="form-group"><label>Name Variation:</label><input type="text" id="match-source-name" class="admin-input" placeholder="e.g., GOLDMAN SACHS & CO"></div><div class="form-group"><label>Source:</label><select id="match-source-type" class="admin-select"><option value="fec_employer">FEC Employer</option><option value="fec_pac">FEC PAC</option><option value="sec_filing">SEC Filing</option><option value="other">Other</option></select></div><button onclick="createFirmMatch()" class="admin-btn primary"><i class="fas fa-save"></i> Save</button></div></div></div><div id="matching-official-matching" class="admin-panel"><div class="admin-section"><h3><i class="fas fa-user-tie"></i> Match Official Names</h3><p class="admin-description">Link official name variations to canonical records.</p><div class="mapping-form" style="margin-top:15px;"><div class="form-group"><label>Search:</label><input type="text" id="official-match-search" class="admin-input" placeholder="e.g., Cruz..." oninput="searchUnmatchedOfficialsMatching()"></div><div id="unmatched-officials-results" class="existing-mappings" style="max-height:300px;overflow-y:auto;"><p style="color:var(--ncrc-gray);font-style:italic;">Enter search term</p></div></div><div class="mapping-form" style="margin-top:20px;padding-top:20px;border-top:1px solid var(--ew-neutral-200);"><h4><i class="fas fa-link"></i> Create Match</h4><div class="form-group"><label>Canonical Official:</label><select id="match-target-official" class="admin-select"><option value="">-- Select --</option></select></div><div class="form-group"><label>Name Variation:</label><input type="text" id="match-source-official" class="admin-input" placeholder="e.g., CRUZ, RAFAEL E"></div><button onclick="createOfficialMatch()" class="admin-btn primary"><i class="fas fa-save"></i> Save</button></div></div></div><div id="matching-pac-matching" class="admin-panel"><div class="admin-section"><h3><i class="fas fa-hand-holding-usd"></i> Match PACs to Firms</h3><p class="admin-description">Link PACs to parent companies.</p><div class="mapping-form" style="margin-top:15px;"><div class="form-group"><label>Search PACs:</label><input type="text" id="pac-match-search" class="admin-input" placeholder="e.g., GOLDMAN..." oninput="searchUnmatchedPACsMatching()"></div><div id="unmatched-pacs-results" class="existing-mappings" style="max-height:300px;overflow-y:auto;"><p style="color:var(--ncrc-gray);font-style:italic;">Enter search term</p></div></div><div class="mapping-form" style="margin-top:20px;padding-top:20px;border-top:1px solid var(--ew-neutral-200);"><h4><i class="fas fa-link"></i> Link PAC</h4><div class="form-group"><label>PAC Name:</label><input type="text" id="pac-name-input" class="admin-input"></div><div class="form-group"><label>Parent Firm:</label><select id="pac-parent-firm" class="admin-select"><option value="">-- Select --</option></select></div><div class="form-group"><label>Industry:</label><select id="pac-industry" class="admin-select"><option value="">-- Select --</option><option value="commercial_banking">Commercial Banking</option><option value="investment_banking">Investment Banking</option><option value="insurance">Insurance</option><option value="other_financial">Other Financial</option></select></div><button onclick="createPACMatch()" class="admin-btn primary"><i class="fas fa-save"></i> Save</button></div></div></div></div></div></div>
        <!-- Admin Deduplication Panel --><div id="deduplicate" class="panel"><div class="card"><div class="card-header"><h2><i class="fas fa-clone"></i> Deduplication Tools</h2><span style="font-size:0.85rem;color:var(--ncrc-gray);">Find and merge duplicates</span></div><div class="card-body"><div class="admin-tabs"><button class="admin-tab active" data-dedup-panel="official-dedup"><i class="fas fa-user-friends"></i> Officials</button><button class="admin-tab" data-dedup-panel="firm-dedup"><i class="fas fa-building"></i> Firms</button><button class="admin-tab" data-dedup-panel="transaction-dedup"><i class="fas fa-exchange-alt"></i> Transactions</button></div><div id="dedup-official-dedup" class="admin-panel active"><div class="admin-section"><h3><i class="fas fa-user-friends"></i> Duplicate Officials</h3><p class="admin-description">Detect duplicates by name similarity.</p><div style="margin:15px 0;"><button onclick="scanForDuplicateOfficials()" class="admin-btn primary"><i class="fas fa-search"></i> Scan</button><span id="dedup-official-scan-status" style="margin-left:10px;"></span></div><div id="duplicate-officials-container" class="existing-mappings" style="max-height:400px;overflow-y:auto;"><p style="color:var(--ncrc-gray);font-style:italic;">Click Scan</p></div></div><div class="admin-section" style="margin-top:20px;border-top:1px solid var(--ew-neutral-200);padding-top:20px;"><h3><i class="fas fa-history"></i> Merge History</h3><div id="official-merge-history" class="existing-mappings"><p style="color:var(--ncrc-gray);font-style:italic;">Loading...</p></div></div></div><div id="dedup-firm-dedup" class="admin-panel"><div class="admin-section"><h3><i class="fas fa-building"></i> Duplicate Firms</h3><p class="admin-description">Find duplicates by name/ticker.</p><div style="margin:15px 0;"><button onclick="scanForDuplicateFirms()" class="admin-btn primary"><i class="fas fa-search"></i> Scan</button><span id="dedup-firm-scan-status" style="margin-left:10px;"></span></div><div id="duplicate-firms-container" class="existing-mappings" style="max-height:400px;overflow-y:auto;"><p style="color:var(--ncrc-gray);font-style:italic;">Click Scan</p></div></div><div class="admin-section" style="margin-top:20px;border-top:1px solid var(--ew-neutral-200);padding-top:20px;"><h3><i class="fas fa-history"></i> Merge History</h3><div id="firm-merge-history" class="existing-mappings"><p style="color:var(--ncrc-gray);font-style:italic;">Loading...</p></div></div></div><div id="dedup-transaction-dedup" class="admin-panel"><div class="admin-section"><h3><i class="fas fa-exchange-alt"></i> Duplicate Transactions</h3><p class="admin-description">Find duplicate trades/contributions.</p><div class="mapping-form" style="margin:15px 0;"><div class="form-group"><label>Type:</label><select id="dedup-transaction-type" class="admin-select"><option value="stock_trades">Stock Trades</option><option value="pac_contributions">PAC Contributions</option></select></div><div class="form-group"><label>Range:</label><select id="dedup-date-range" class="admin-select"><option value="90">90 days</option><option value="365" selected>1 year</option><option value="all">All</option></select></div><button onclick="scanForDuplicateTransactions()" class="admin-btn primary"><i class="fas fa-search"></i> Scan</button></div><div id="duplicate-transactions-container" class="existing-mappings" style="max-height:400px;overflow-y:auto;"><p style="color:var(--ncrc-gray);font-style:italic;">Select and scan</p></div></div></div></div></div></div>
        <!-- Admin Data Mapper Panel -->
        <div id="admin" class="panel">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-cog"></i> Data Mapper</h2>
                    <span style="font-size: 0.85rem; color: var(--ncrc-gray);">Admin tools for managing entity mappings and data quality</span>
                </div>
                <div class="card-body">
                    <!-- Admin Sub-tabs -->
                    <div class="admin-tabs">
                        <button class="admin-tab active" data-admin-panel="merge-officials">
                            <i class="fas fa-user-friends"></i> Merge Officials
                        </button>
                        <button class="admin-tab" data-admin-panel="firm-industry">
                            <i class="fas fa-building"></i> Firm  Industry
                        </button>
                        <button class="admin-tab" data-admin-panel="employer-firm">
                            <i class="fas fa-briefcase"></i> Employer  Firm
                        </button>
                        <button class="admin-tab" data-admin-panel="unmatched-entities">
                            <i class="fas fa-question-circle"></i> Unmatched
                        </button>
                    </div>

                    <!-- Merge Officials Panel -->
                    <div id="admin-merge-officials" class="admin-panel active">
                        <!-- Potential Duplicates Section -->
                        <div class="admin-section">
                            <h3><i class="fas fa-user-friends"></i> Potential Duplicate Officials</h3>
                            <p class="admin-description">Officials with the same last name that may be the same person under different name formats (e.g., "Rick Allen" vs "Allen, Rick"). Review each pair and confirm whether they're the same or different people.</p>

                            <div id="potential-duplicates-container" style="margin-top: 15px;">
                                <div class="loading">Loading potential duplicates...</div>
                            </div>

                            <div id="duplicates-status" class="status-message" style="display: none;"></div>
                        </div>

                        <div class="admin-section" style="border-top: 1px solid var(--ncrc-gray-light); padding-top: 20px; margin-top: 20px;">
                            <h3><i class="fas fa-user-check"></i> Manual Merge (Advanced)</h3>
                            <p class="admin-description">Manually merge officials when the same person appears under different names (e.g., "Ted Cruz" and "Rafael Cruz").</p>

                            <div class="mapping-form">
                                <div class="form-group">
                                    <label>Canonical Official (keep this name):</label>
                                    <select id="canonical-official" class="admin-select">
                                        <option value="">-- Select official --</option>
                                    </select>
                                </div>

                                <div id="canonical-aliases" class="aliases-list" style="display: none;">
                                    <label>Currently linked aliases:</label>
                                    <div id="aliases-container">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Add alias (merge this record into canonical):</label>
                                    <select id="alias-official" class="admin-select">
                                        <option value="">-- Select official to merge --</option>
                                    </select>
                                </div>

                                <button onclick="saveOfficialMerge()" class="admin-btn primary">
                                    <i class="fas fa-save"></i> Save Mapping
                                </button>
                            </div>

                            <div id="merge-status" class="status-message" style="display: none;"></div>
                        </div>

                        <div class="admin-section">
                            <h3><i class="fas fa-list"></i> Existing Official Merges</h3>
                            <div id="existing-merges" class="existing-mappings">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Firm to Industry Panel -->
                    <div id="admin-firm-industry" class="admin-panel">
                        <div class="admin-section">
                            <h3><i class="fas fa-industry"></i> Map Firm to Industry</h3>
                            <p class="admin-description">Link firms to their industry classification. This determines how contributions and trades are categorized.</p>

                            <div class="mapping-form">
                                <div class="form-group">
                                    <label>Firm Name:</label>
                                    <input type="text" id="firm-name" class="admin-input" placeholder="e.g., Goldman Sachs">
                                </div>

                                <div class="form-group">
                                    <label>Ticker (optional):</label>
                                    <input type="text" id="firm-ticker" class="admin-input" placeholder="e.g., GS">
                                </div>

                                <div class="form-group">
                                    <label>Industry:</label>
                                    <select id="firm-industry" class="admin-select">
                                        <option value="">-- Select industry --</option>
                                        <option value="banking">Banking & Depository</option>
                                        <option value="investment">Investment & Securities</option>
                                        <option value="insurance">Insurance</option>
                                        <option value="mortgage">Mortgage & Real Estate Finance</option>
                                        <option value="consumer_lending">Consumer Lending</option>
                                        <option value="crypto">Digital Assets & Crypto</option>
                                        <option value="fintech">Financial Technology</option>
                                        <option value="payments">Payments & Processing</option>
                                    </select>
                                </div>

                                <button onclick="saveFirmIndustry()" class="admin-btn primary">
                                    <i class="fas fa-save"></i> Save Firm
                                </button>
                            </div>

                            <div id="firm-status" class="status-message" style="display: none;"></div>
                        </div>

                        <div class="admin-section">
                            <h3><i class="fas fa-list"></i> Existing Firms</h3>
                            <div class="search-filter">
                                <input type="text" id="firm-search" class="admin-input" placeholder="Search firms..." oninput="filterFirms()">
                            </div>
                            <div id="existing-firms" class="existing-mappings">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Employer to Firm Panel -->
                    <div id="admin-employer-firm" class="admin-panel">
                        <div class="admin-section">
                            <h3><i class="fas fa-briefcase"></i> Map Employer Variation to Firm</h3>
                            <p class="admin-description">Link employer name variations from FEC data to canonical firms. Search for variations of a firm name to map them.</p>

                            <div class="mapping-form">
                                <div class="form-group">
                                    <label>Select Canonical Firm:</label>
                                    <select id="employer-canonical-firm" class="admin-select" onchange="loadFirmAliases()">
                                        <option value="">-- Select firm --</option>
                                    </select>
                                </div>

                                <div id="firm-aliases" class="aliases-list" style="display: none;">
                                    <label>Currently linked employer names:</label>
                                    <div id="employer-aliases-container">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Search unmatched employers:</label>
                                    <input type="text" id="employer-search" class="admin-input" placeholder="e.g., goldman" oninput="searchEmployers()">
                                </div>

                                <div id="employer-search-results" class="search-results" style="display: none;">
                                    <label>Matching unmatched employers:</label>
                                    <div id="employer-results-container">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Or enter employer name manually:</label>
                                    <input type="text" id="employer-manual" class="admin-input" placeholder="e.g., GOLDMAN SACHS NYC">
                                </div>

                                <button onclick="saveEmployerMapping()" class="admin-btn primary">
                                    <i class="fas fa-save"></i> Save Mapping
                                </button>
                            </div>

                            <div id="employer-status" class="status-message" style="display: none;"></div>
                        </div>

                        <div class="admin-section">
                            <h3><i class="fas fa-question-circle"></i> Unmatched Employers (Top 50 by frequency)</h3>
                            <div id="unmatched-employers" class="existing-mappings">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Unmatched Entities Panel -->
                    <div id="admin-unmatched-entities" class="admin-panel">
                        <div class="admin-section">
                            <h3><i class="fas fa-exclamation-triangle"></i> Entities Needing Manual Review</h3>
                            <p class="admin-description">These items couldn't be automatically matched to known companies. Review and create mappings as needed.</p>

                            <div class="unmatched-filters">
                                <button class="filter-btn active" data-filter="all" onclick="filterUnmatched('all')">
                                    All <span id="unmatched-count-all" class="badge">0</span>
                                </button>
                                <button class="filter-btn" data-filter="pacs" onclick="filterUnmatched('pacs')">
                                    PACs <span id="unmatched-count-pacs" class="badge">0</span>
                                </button>
                                <button class="filter-btn" data-filter="employers" onclick="filterUnmatched('employers')">
                                    Employers <span id="unmatched-count-employers" class="badge">0</span>
                                </button>
                                <button class="filter-btn" data-filter="tickers" onclick="filterUnmatched('tickers')">
                                    Tickers <span id="unmatched-count-tickers" class="badge">0</span>
                                </button>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h3><i class="fas fa-building"></i> Unmatched PAC Names</h3>
                            <p class="admin-description">Financial PACs that couldn't be matched to a canonical company name.</p>
                            <div id="unmatched-pacs" class="unmatched-list" data-category="pacs">
                                <div class="loading">Loading unmatched PACs...</div>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h3><i class="fas fa-briefcase"></i> Unmatched Employer Names</h3>
                            <p class="admin-description">Employer names from individual contributions that couldn't be matched to a known firm.</p>
                            <div id="unmatched-employer-names" class="unmatched-list" data-category="employers">
                                <div class="loading">Loading unmatched employers...</div>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h3><i class="fas fa-chart-line"></i> Uncategorized Stock Tickers</h3>
                            <p class="admin-description">Stock tickers that haven't been assigned to an industry category.</p>
                            <div id="unmatched-tickers" class="unmatched-list" data-category="tickers">
                                <div class="loading">Loading uncategorized tickers...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </main>

    <!-- Insight Detail Modal -->
    <div id="insight-modal" class="modal-overlay" onclick="closeInsightModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title"><i class="fas fa-lightbulb"></i> <span>Insight Title</span></h2>
                <button class="modal-close" onclick="closeInsightModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="modal-summary" class="insight-summary">
                    Loading...
                </div>

                <div id="modal-firms" class="insight-section">
                    <h3><i class="fas fa-building"></i> Firms Involved</h3>
                    <div class="entity-list" id="modal-firms-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div id="modal-officials" class="insight-section">
                    <h3><i class="fas fa-user-tie"></i> Officials Involved</h3>
                    <div class="entity-list" id="modal-officials-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div id="modal-industries" class="insight-section">
                    <h3><i class="fas fa-industry"></i> Industries</h3>
                    <div class="entity-list" id="modal-industries-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div id="modal-committees" class="insight-section">
                    <h3><i class="fas fa-gavel"></i> Committees</h3>
                    <div class="entity-list" id="modal-committees-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div id="modal-sources" class="insight-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                    <h3><i class="fas fa-newspaper"></i> News & Sources</h3>
                    <div class="sources-list" id="modal-sources-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="insight-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                    <h3><i class="fas fa-database"></i> Data Sources</h3>
                    <p id="modal-evidence" style="font-size: 0.9rem; color: var(--ncrc-gray);">
                        Based on FEC filings and STOCK Act disclosures
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>
            <strong>ElectWatch</strong>  A JustData Tool by
            <a href="https://ncrc.org" target="_blank">NCRC</a>
        </p>
        <p class="version">Version {{ version }}</p>
    </footer>

    <script>
        /**
         * Format official name consistently as "Last, First" format.
         * Handles various input formats:
         * - "First Last" -> "Last, First"
         * - "Last, First" -> "Last, First" (unchanged)
         * - "First Middle Last" -> "Last, First Middle"
         * - "First M. Last" -> "Last, First M."
         */
        function formatDisplayName(name) {
            if (!name) return '';

            // Check if already in "Last, First" format
            if (name.includes(',')) {
                // Already has comma - return as-is (already formatted correctly)
                return name.trim();
            }

            // Split into parts
            const parts = name.trim().split(/\s+/);

            if (parts.length === 1) {
                // Single name, return as-is
                return parts[0];
            }

            // Last name is the final part
            const lastName = parts[parts.length - 1];
            // First/middle names are everything else
            const firstNames = parts.slice(0, -1).join(' ');

            return `${lastName}, ${firstNames}`;
        }

        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const panelId = tab.dataset.panel;
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.getElementById(panelId).classList.add('active');
            });
        });

        // Sorting state - default to score (involvement_score) descending for highest scores first
        const DEFAULT_SORT = { field: 'score', order: 'desc' };
        let currentSort = { field: DEFAULT_SORT.field, order: DEFAULT_SORT.order };
        let allOfficials = [];

        // Load Leaderboard Data
        async function loadLeaderboard() {
            const chamber = document.getElementById('filter-chamber').value;
            const party = document.getElementById('filter-party').value;
            const industry = document.getElementById('filter-industry').value;

            const params = new URLSearchParams();
            params.append('limit', '535');  // Load all members of Congress
            if (chamber) params.append('chamber', chamber);
            if (party) params.append('party', party);
            if (industry) params.append('industry', industry);

            try {
                const response = await fetch(`api/officials?${params}`);
                const data = await response.json();

                if (data.success) {
                    allOfficials = data.officials;
                    sortAndRenderLeaderboard();
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function sortAndRenderLeaderboard() {
            // Get search term
            const searchTerm = (document.getElementById('search-official').value || '').trim().toLowerCase();

            // Filter by search term if provided
            let filtered = allOfficials;
            if (searchTerm.length > 0) {
                filtered = allOfficials.filter(official =>
                    (official.name || '').toLowerCase().includes(searchTerm) ||
                    (official.state || '').toLowerCase().includes(searchTerm)
                );
            }

            const sorted = [...filtered].sort((a, b) => {
                let aVal, bVal;

                switch (currentSort.field) {
                    case 'name':
                        // Sort by last name, handling "Last, First" format and empty names
                        const aName = (a.name || '').trim();
                        const bName = (b.name || '').trim();
                        const aLastName = aName.includes(',') ? aName.split(',')[0].trim().toLowerCase() : aName.split(' ').filter(p => p).pop()?.toLowerCase() || '';
                        const bLastName = bName.includes(',') ? bName.split(',')[0].trim().toLowerCase() : bName.split(' ').filter(p => p).pop()?.toLowerCase() || '';
                        if (!aLastName && bLastName) return 1;
                        if (aLastName && !bLastName) return -1;
                        if (!aLastName && !bLastName) return 0;
                        const nameCompare = aLastName.localeCompare(bLastName);
                        return currentSort.order === 'desc' ? -nameCompare : nameCompare;
                    case 'total_contributions':
                    case 'contributions':
                        // Sort by total contributions (all sources)
                        aVal = a.contributions;
                        bVal = b.contributions;
                        break;
                    case 'finance_contributions':
                    case 'financial_pac':
                        // Sort by financial sector contributions specifically
                        aVal = a.financial_sector_pac;
                        bVal = b.financial_sector_pac;
                        break;
                    case 'financial_pct':
                        // Sort by percentage of contributions from financial sector
                        const aTotalPac = a.contributions || 0;
                        const aFinPac = a.financial_sector_pac || 0;
                        aVal = aTotalPac > 0 ? (aFinPac / aTotalPac) * 100 : null;
                        const bTotalPac = b.contributions || 0;
                        const bFinPac = b.financial_sector_pac || 0;
                        bVal = bTotalPac > 0 ? (bFinPac / bTotalPac) * 100 : null;
                        break;
                    case 'score':
                        aVal = a.involvement_score;
                        bVal = b.involvement_score;
                        break;
                    case 'trades':
                        aVal = a.total_trades;
                        bVal = b.total_trades;
                        break;
                    case 'buys':
                        aVal = a.purchases_max;
                        bVal = b.purchases_max;
                        break;
                    case 'sells':
                        aVal = a.sales_max;
                        bVal = b.sales_max;
                        break;
                    default:
                        // Default sort by score
                        aVal = a.involvement_score;
                        bVal = b.involvement_score;
                }

                // Handle null/undefined/NaN values - always sort them to the end
                const aIsNull = aVal === null || aVal === undefined || (typeof aVal === 'number' && isNaN(aVal));
                const bIsNull = bVal === null || bVal === undefined || (typeof bVal === 'number' && isNaN(bVal));
                if (aIsNull && bIsNull) return 0;
                if (aIsNull) return 1;
                if (bIsNull) return -1;

                return currentSort.order === 'desc' ? bVal - aVal : aVal - bVal;
            });

            // Show top 50 unless searching
            const displayList = searchTerm.length > 0 ? sorted : sorted.slice(0, 50);
            renderLeaderboard(displayList);
            updateSortIndicators();
        }

        function updateSortIndicators() {
            document.querySelectorAll('.leaderboard-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === currentSort.field) {
                    th.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            // Show/hide reset sort button based on whether sort differs from default
            const resetBtn = document.getElementById('reset-sort-btn');
            if (resetBtn) {
                const isDefault = currentSort.field === DEFAULT_SORT.field && currentSort.order === DEFAULT_SORT.order;
                resetBtn.classList.toggle('visible', !isDefault);
            }
        }

        // Reset sort to default
        function resetSort() {
            currentSort.field = DEFAULT_SORT.field;
            currentSort.order = DEFAULT_SORT.order;
            sortAndRenderLeaderboard();
        }

        // Column sort click handler
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.leaderboard-table th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const field = this.dataset.sort;

                    if (currentSort.field === field) {
                        currentSort.order = currentSort.order === 'desc' ? 'asc' : 'desc';
                    } else {
                        currentSort.field = field;
                        currentSort.order = 'desc';
                    }

                    sortAndRenderLeaderboard();
                });
            });

            // Reset sort button click handler
            const resetSortBtn = document.getElementById('reset-sort-btn');
            if (resetSortBtn) {
                resetSortBtn.addEventListener('click', resetSort);
            }
        });

        function renderLeaderboard(officials) {
            const tbody = document.getElementById('leaderboard-body');
            const loading = document.getElementById('leaderboard-loading');

            if (!officials || officials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--ncrc-gray);">No officials found matching filters</td></tr>';
                loading.style.display = 'none';
                return;
            }

            tbody.innerHTML = officials.map((official, index) => `
                <tr>
                    <td class="rank">${index + 1}</td>
                    <td>
                        <div class="official-cell">
                            <div class="official-photo-container">
                                ${(official.photo_url || (official.bioguide_id ? 'https://clerk.house.gov/images/members/' + official.bioguide_id + '.jpg' : null))
                                    ? `<img class="official-photo" src="${official.photo_url || 'https://clerk.house.gov/images/members/' + official.bioguide_id + '.jpg'}" alt="${official.name}" title="${(official.photo_attribution || 'Official portrait').replace(/"/g, '&quot;')}" onerror="this.outerHTML='<div class=\\'official-photo placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`
                                    : `<div class="official-photo placeholder"><i class="fas fa-user"></i></div>`
                                }
                                <div class="party-indicator ${official.party}">${official.party}</div>
                            </div>
                            <div class="official-info">
                                <a href="official/${official.id}" class="official-name">${formatDisplayName(official.name)}</a>
                                <span class="official-meta">${official.chamber === 'house' ? 'Rep' : 'Sen'}. - ${official.state}${official.district ? '-' + official.district : ''}</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="donor-chips">
                            ${formatTopDonors(official)}
                        </div>
                    </td>
                    <td class="trend-cell">
                        ${formatTrendCell(official)}
                    </td>
                    <td class="amount-cell">
                        <div class="sub">${formatTotalContributions(official)}</div>
                    </td>
                    <td class="amount-cell">
                        <div class="sub">${formatFinanceContributions(official)}</div>
                    </td>
                    <td class="amount-cell" style="text-align: center;">
                        <div class="sub">${formatFinancialPct(official)}</div>
                    </td>
                    <td class="amount-cell">
                        <div class="sub buy-amount">${official.purchases_display || formatTradeAmount(official.purchases_min, official.purchases_max)}</div>
                    </td>
                    <td class="amount-cell">
                        <div class="sub sell-amount">${official.sales_display || formatTradeAmount(official.sales_min, official.sales_max)}</div>
                    </td>
                </tr>
            `).join('');

            loading.style.display = 'none';

            // Initialize Tippy tooltips for donor chips
            if (typeof tippy !== 'undefined') {
                tippy('[data-tippy-content]', {
                    animation: 'shift-away',
                    placement: 'top',
                    allowHTML: true
                });
            }
        }

        function formatAmount(amount) {
            if (typeof amount === 'object') {
                return amount.display || `$${(amount.min / 1000).toFixed(0)}K-$${(amount.max / 1000).toFixed(0)}K`;
            }
            if (amount >= 1000000) {
                return `$${(amount / 1000000).toFixed(1)}M`;
            } else if (amount >= 1000) {
                return `$${(amount / 1000).toFixed(0)}K`;
            }
            return `$${amount.toLocaleString()}`;
        }

        function formatPacAmount(official) {
            // Format Financial Sector PAC $ as primary (what we sort by)
            // Show total PAC below for context
            const totalPac = official.contributions || 0;
            // Check for explicit 0 vs undefined/null (0 means confirmed no financial PAC)
            const financialPac = official.financial_sector_pac;
            const hasFinancialPacData = financialPac !== undefined && financialPac !== null;

            // Format helper for full dollar format (e.g., $5,000 not $5K)
            const formatDollars = (amount) => `$${Math.round(amount).toLocaleString()}`;
            // Format helper for abbreviated format (for secondary/total display)
            const formatAbbrev = (amount) => {
                if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;
                if (amount >= 1000) return `$${Math.round(amount / 1000)}K`;
                return `$${Math.round(amount).toLocaleString()}`;
            };

            // If no financial sector PAC data at all (undefined/null), show dash with total
            if (!hasFinancialPacData) {
                if (totalPac === 0) return '<span style="color: var(--ncrc-gray);">-</span>';
                return `<div style="line-height: 1.3;">
                    <div style="color: var(--ncrc-gray);">-</div>
                    <div style="font-size: 0.8em; color: var(--ncrc-gray);">Total: ${formatAbbrev(totalPac)}</div>
                </div>`;
            }

            // If financial_sector_pac is explicitly 0, show $0
            if (financialPac === 0) {
                if (totalPac === 0) return '<span style="color: var(--ncrc-gray);">$0</span>';
                return `<div style="line-height: 1.3;">
                    <div style="font-weight: 600;">$0</div>
                    <div style="font-size: 0.8em; color: var(--ncrc-gray);">of ${formatAbbrev(totalPac)} total</div>
                </div>`;
            }

            // Format financial sector PAC amount (primary) - full dollar format
            const finStr = formatDollars(financialPac);

            return `<div style="line-height: 1.3;">
                <div style="font-weight: 600;">${finStr}</div>
                <div style="font-size: 0.8em; color: var(--ncrc-gray);">of ${formatAbbrev(totalPac)} total</div>
            </div>`;
        }

        function formatFinancialPct(official) {
            // Calculate and display the percentage of total contributions from financial sector
            // Uses new contributions_display structure (PAC + Individual combined)
            const display = official.contributions_display || {};
            const total = display.total || 0;
            const financial = display.financial || 0;

            // No data at all - show dash
            if (total === 0) {
                return '<span style="color: var(--ncrc-gray);">-</span>';
            }

            // If financial is explicitly 0, show 0%
            if (financial === 0) {
                return '<span style="font-weight: 600;">0%</span>';
            }

            const pct = Math.round((financial / total) * 100);

            // Color code based on percentage
            let colorClass = '';
            if (pct >= 50) colorClass = 'style="font-weight: 600; color: var(--ncrc-red);"';
            else if (pct >= 25) colorClass = 'style="font-weight: 600; color: var(--ncrc-orange);"';
            else colorClass = 'style="font-weight: 600;"';

            return `<span ${colorClass}>${pct}%</span>`;
        }

        function formatTradeAmount(min, max) {
            // Format stock trade ranges (min-max STOCK Act buckets)
            if (!min && !max) return '-';
            if (min === 0 && max === 0) return '-';

            const formatK = (val) => {
                if (val >= 1000000) return `$${(val / 1000000).toFixed(1)}M`;
                if (val >= 1000) return `$${Math.round(val / 1000)}K`;
                return `$${val.toLocaleString()}`;
            };

            return `${formatK(min)} - ${formatK(max)}`;
        }

        function formatTrendCell(official) {
            // Format trend cell with trading trend and stock activity indicator
            // Uses BOTH time-series data (trades_by_quarter) and snapshot data (finance_trend)

            // PRIMARY: Use time-series trade trend if available
            const tradeTrend = official.trade_trend || 'stable';
            const hasTrendData = official.has_trend_data || false;

            // FALLBACK: Use finance_trend_direction from weekly snapshots
            const financeTrend = official.finance_trend_direction || 'stable';

            // Determine which trend to display (prioritize actual trade data)
            let trendDirection = hasTrendData ? tradeTrend : financeTrend;
            let trendArrow = '\u2192';  // Unicode RIGHT arrow - stable/no change default

            // For time-series trade data, use arrow based on recent activity
            if (hasTrendData) {
                const tradesByQuarter = official.trades_by_quarter || [];
                if (tradesByQuarter.length >= 2) {
                    const recent = tradesByQuarter.slice(-2);
                    const recentNet = recent.reduce((sum, q) => sum + (q.net || 0), 0);
                    if (recentNet > 10000) {
                        trendDirection = 'increasing';
                        trendArrow = '\u2191';  // Unicode UP arrow
                    } else if (recentNet < -10000) {
                        trendDirection = 'decreasing';
                        trendArrow = '\u2193';  // Unicode DOWN arrow
                    }
                }
            } else {
                // Use snapshot-based arrows - convert to Unicode arrows
                const snapshotArrow = official.finance_trend_arrow;
                if (snapshotArrow === '\u25B2' || snapshotArrow === '') {
                    trendArrow = '\u2191';  // UP arrow
                    trendDirection = 'increasing';
                } else if (snapshotArrow === '\u25BC' || snapshotArrow === '') {
                    trendArrow = '\u2193';  // DOWN arrow
                    trendDirection = 'decreasing';
                } else {
                    trendArrow = '\u2192';  // RIGHT arrow for stable
                }
            }

            const stockDirection = official.stock_trend_direction || 'neutral';
            const stockIcon = official.stock_trend_icon || '';

            // Check if no trend data is available
            const noTrendData = !hasTrendData && !official.finance_trend_direction && !official.finance_pct_change && !official.finance_trend_arrow;

            // Map trend direction to CSS class and set appropriate title
            let trendClass = noTrendData ? 'no-data' : 'stable';
            let trendTitle = noTrendData ? 'No trend data available' : 'No significant change in last 6 months';
            if (noTrendData) { trendArrow = '-'; }
            else if (trendDirection === 'increasing') {
                trendClass = 'up';
                trendTitle = 'Score increased in last 6 months';
            } else if (trendDirection === 'decreasing') {
                trendClass = 'down';
                trendTitle = 'Score decreased in last 6 months';
            }

            // Map stock direction to CSS class
            let stockClass = '';
            if (stockDirection === 'buyer') stockClass = 'buyer';
            else if (stockDirection === 'seller') stockClass = 'seller';

            // Build tooltip content for hover
            const tooltipContent = buildTrendTooltip(official);

            return `
                <div class="trend-indicators" data-tippy-content="${tooltipContent.replace(/"/g, '&quot;')}">
                    <span class="trend-arrow ${trendClass}" title="${trendTitle}">${trendArrow}</span>
                    ${stockIcon && stockDirection !== 'neutral' ? `<span class="stock-indicator ${stockClass}" title="${official.net_stock_label || 'Stock activity'}">${stockIcon}</span>` : ''}
                </div>
            `;
        }

        function buildTrendTooltip(official) {
            const parts = [];

            // NEW: Time-series trade data by quarter
            const tradesByQuarter = official.trades_by_quarter || [];
            if (tradesByQuarter.length > 0) {
                parts.push('<strong>Recent Trading Activity:</strong>');
                // Show last 4 quarters
                const recentQuarters = tradesByQuarter.slice(-4);
                recentQuarters.forEach(q => {
                    const net = q.net >= 0 ? `+$${formatK(q.net)}` : `-$${formatK(Math.abs(q.net))}`;
                    const direction = q.net > 0 ? '(buying)' : q.net < 0 ? '(selling)' : '';
                    parts.push(`&nbsp;&nbsp;${q.quarter}: ${net} ${direction}`);
                });
            }

            // Trade trend indicator
            const tradeTrend = official.trade_trend || 'stable';
            if (tradeTrend !== 'stable') {
                const trendIcon = tradeTrend === 'increasing' ? '' : '';
                parts.push(`<strong>Trading Trend:</strong> ${trendIcon} ${tradeTrend}`);
            }

            // Finance % trend info (from weekly snapshots)
            const pctChange = official.finance_pct_change;
            if (pctChange !== undefined && pctChange !== 0) {
                const changeDir = pctChange > 0 ? '+' : '';
                parts.push(`<strong>Finance % Change:</strong> ${changeDir}${pctChange.toFixed(1)}%`);
            }

            // Stock activity summary
            const netLabel = official.net_stock_label;
            if (netLabel && netLabel !== 'Neutral') {
                parts.push(`<strong>Stock Position:</strong> ${netLabel}`);
            }

            // If no trend data at all
            if (tradesByQuarter.length <= 1 && !pctChange) {
                parts.push('<em>Trend data accumulates over time</em>');
            }

            return parts.join('<br>');
        }

        // Helper for tooltip formatting
        function formatK(amount) {
            if (Math.abs(amount) >= 1000000) {
                return `${(amount / 1000000).toFixed(1)}M`;
            } else if (Math.abs(amount) >= 1000) {
                return `${Math.round(amount / 1000)}K`;
            }
            return Math.round(amount).toLocaleString();
        }

        function formatTotalContributions(official) {
            // Format total contributions (PAC + Individual)
            const display = official.contributions_display || {};
            const total = display.total || 0;

            if (total === 0) {
                return '<span style="color: var(--ncrc-gray);">-</span>';
            }

            return `<span style="font-weight: 600;">${formatDollars(total)}</span>`;
        }

        function formatFinanceContributions(official) {
            // Format finance sector contributions (PAC + Individual)
            const display = official.contributions_display || {};
            const financial = display.financial || 0;
            const total = display.total || 0;

            if (total === 0) {
                return '<span style="color: var(--ncrc-gray);">-</span>';
            }

            if (financial === 0) {
                return '<span style="font-weight: 600;">$0</span>';
            }

            return `<span style="font-weight: 600;">${formatDollars(financial)}</span>`;
        }

        function formatDollars(amount) {
            // Format as full dollar amount with commas
            if (amount >= 1000000) {
                return `$${(amount / 1000000).toFixed(1)}M`;
            } else if (amount >= 100000) {
                return `$${Math.round(amount / 1000)}K`;
            }
            return `$${Math.round(amount).toLocaleString()}`;
        }

        function formatTopDonors(official) {
            // Format top firms as chips with Tippy tooltips
            // Shows firms the official trades stock in (from STOCK Act disclosures)
            const donors = official.top_donors || [];

            if (!donors.length) {
                // No trade data available
                return '<span style="color: var(--ncrc-gray);">-</span>';
            }

            return donors.slice(0, 3).map(donor => {
                const name = donor.name || donor.company || 'Unknown';
                const amount = donor.total || donor.amount || 0;
                const tradeCount = donor.trade_count || 0;
                const ticker = donor.ticker || '';
                const hasOverlap = donor.stock_overlap || false;
                const overlapClass = hasOverlap ? 'has-overlap' : '';

                // Build tooltip with firm/trade details
                let tooltip = `<strong>${name}</strong>`;
                if (ticker) tooltip += ` (${ticker})`;
                tooltip += `<br>Trade Value: ${formatDollars(amount)}`;
                if (tradeCount > 0) tooltip += `<br>Trades: ${tradeCount}`;
                if (donor.pac_amount) tooltip += `<br>PAC Contributions: ${formatDollars(donor.pac_amount)}`;
                if (donor.individual_amount) tooltip += `<br>Individual Contributions: ${formatDollars(donor.individual_amount)}`;
                tooltip += `<br><em>Click to view firm details</em>`;

                return `<a href="firm/${encodeURIComponent(name)}" class="donor-chip ${overlapClass}" data-tippy-content="${tooltip.replace(/"/g, '&quot;')}" onclick="event.stopPropagation();">${truncateName(name)}</a>`;
            }).join('');
        }

        function truncateName(name) {
            // Truncate company names for display in chips
            if (name.length <= 12) return name;
            // Common abbreviations
            const abbrevs = {
                'Bank of America': 'BofA',
                'JPMorgan Chase': 'JPMorgan',
                'Goldman Sachs': 'Goldman',
                'Morgan Stanley': 'Morgan S.',
                'Wells Fargo': 'Wells F.',
                'Citigroup': 'Citi',
                'American Express': 'AmEx',
                'Capital One': 'Cap One'
            };
            if (abbrevs[name]) return abbrevs[name];
            return name.slice(0, 10) + '...';
        }

        function getScoreClass(score) {
            // Normalized Z-score scale: 1-100
            // 75+ = high (top performers), 50-74 = medium (above average), <50 = low
            if (score >= 75) return 'high';
            if (score >= 50) return 'medium';
            return 'low';
        }

        function showIndustryDetail(industryCode) {
            window.location.href = `industry/${industryCode}`;
        }

        function showCommittee(committeeId) {
            // Navigate to committee detail page
            // Convert underscore IDs to hyphenated format
            const formattedId = committeeId.replace(/_/g, '-');
            window.location.href = `committee/${formattedId}`;
        }

        // Store insights globally for click handling
        let insightsData = [];

        async function refreshInsights(forceRegenerate = false) {
            const container = document.getElementById('insights-container');
            container.innerHTML = '<div class="loading">Loading AI insights...</div>';

            try {
                const url = forceRegenerate ? 'api/insights?refresh=true' : 'api/insights';
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.insights) {
                    insightsData = data.insights;
                    container.innerHTML = data.insights.map((insight, index) => `
                        <div class="insight-card" onclick="showInsightDetail(${index})">
                            <h3><i class="fas fa-lightbulb"></i> ${insight.title}</h3>
                            <p>${insight.summary}</p>
                            <div class="evidence">
                                <i class="fas fa-database"></i> ${insight.evidence}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 20px;">Error loading insights. Please try again.</p>';
            }
        }

        // Parse wiki-style links [[type:id|display text]] and convert to HTML links
        function parseInsightLinks(text) {
            if (!text) return '';

            // Convert wiki-style links: [[type:id|display]] -> <a href="/type/id">display</a>
            let parsed = text.replace(/\[\[(official|firm|committee|industry):([^\]|]+)\|([^\]]+)\]\]/g,
                (match, type, id, display) => {
                    let url;
                    switch(type) {
                        case 'official':
                            url = `official/${encodeURIComponent(id)}`;
                            return `<a href="${url}" class="insight-link insight-link-official">${display}</a>`;
                        case 'firm':
                            url = `firm/${encodeURIComponent(id)}`;
                            return `<a href="${url}" class="insight-link insight-link-firm">${display}</a>`;
                        case 'committee':
                            url = `committee/${encodeURIComponent(id)}`;
                            return `<a href="${url}" class="insight-link insight-link-committee">${display}</a>`;
                        case 'industry':
                            url = `industry/${encodeURIComponent(id)}`;
                            return `<a href="${url}" class="insight-link insight-link-industry">${display}</a>`;
                        default:
                            return display;
                    }
                }
            );

            // Convert markdown bold **text** to <strong>
            parsed = parsed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // Convert bullet points ( or - at start of line)
            parsed = parsed.replace(/^[\-]\s+(.+)$/gm, '<li>$1</li>');

            // Wrap consecutive <li> items in <ul>
            parsed = parsed.replace(/(<li>.*<\/li>\n?)+/g, '<ul class="insight-bullets">$&</ul>');

            // Convert markdown tables to HTML (simple implementation)
            const tableRegex = /\|(.+)\|\n\|[-|]+\|\n((?:\|.+\|\n?)+)/g;
            parsed = parsed.replace(tableRegex, (match, header, rows) => {
                const headers = header.split('|').filter(h => h.trim());
                const headerHtml = headers.map(h => `<th>${h.trim()}</th>`).join('');

                const rowsHtml = rows.trim().split('\n').map(row => {
                    const cells = row.split('|').filter(c => c.trim());
                    return `<tr>${cells.map(c => `<td>${c.trim()}</td>`).join('')}</tr>`;
                }).join('');

                return `<table class="insight-table"><thead><tr>${headerHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
            });

            // Convert newlines to paragraphs (but not inside lists or tables)
            parsed = parsed.split('\n\n').map(para => {
                if (para.includes('<ul') || para.includes('<table') || para.includes('<li>')) {
                    return para;
                }
                return `<p>${para}</p>`;
            }).join('');

            return parsed;
        }

        function showInsightDetail(index) {
            const insight = insightsData[index];
            if (!insight) return;

            // Update modal content
            document.querySelector('#modal-title span').textContent = insight.title;

            // Parse and render detailed summary with inline links
            const summaryHtml = parseInsightLinks(insight.detailed_summary || insight.summary);
            document.getElementById('modal-summary').innerHTML = summaryHtml;

            document.getElementById('modal-evidence').textContent = insight.evidence;

            // Render firms
            const firmsHtml = (insight.firms || []).map(firm => `
                <div class="entity-item" onclick="window.location='firm/${encodeURIComponent(firm.name)}'">
                    <div class="entity-info">
                        <div class="entity-badge firm"><i class="fas fa-building"></i></div>
                        <div>
                            <div class="entity-name">${firm.name}</div>
                            <div class="entity-meta">${firm.ticker || ''} - ${firm.detail || ''}</div>
                        </div>
                    </div>
                    <span class="entity-amount">${formatAmount(firm.amount)}</span>
                </div>
            `).join('') || '<p style="color: var(--ncrc-gray);">No specific firms identified</p>';
            document.getElementById('modal-firms-list').innerHTML = firmsHtml;

            // Render officials
            const officialsHtml = (insight.officials || []).map(official => `
                <div class="entity-item" onclick="window.location='official/${official.id}'">
                    <div class="entity-info">
                        <div class="entity-badge official">${official.party}</div>
                        <div>
                            <div class="entity-name">${formatDisplayName(official.name)}</div>
                            <div class="entity-meta">${official.state} - ${official.detail || ''}</div>
                        </div>
                    </div>
                    <span class="entity-amount">${formatAmount(official.amount)}</span>
                </div>
            `).join('') || '<p style="color: var(--ncrc-gray);">No specific officials identified</p>';
            document.getElementById('modal-officials-list').innerHTML = officialsHtml;

            // Render industries
            const industriesHtml = (insight.industries || []).map(ind => `
                <div class="entity-item" onclick="window.location='industry/${ind.code}'">
                    <div class="entity-info">
                        <div class="entity-badge industry"><i class="fas fa-industry"></i></div>
                        <div>
                            <div class="entity-name">${ind.name}</div>
                            <div class="entity-meta">${ind.detail || ''}</div>
                        </div>
                    </div>
                    <span class="entity-amount">${formatAmount(ind.amount)}</span>
                </div>
            `).join('') || '<p style="color: var(--ncrc-gray);">No specific industries identified</p>';
            document.getElementById('modal-industries-list').innerHTML = industriesHtml;

            // Render committees
            const committeesHtml = (insight.committees || []).map(cmte => `
                <div class="entity-item" onclick="window.location='committee/${cmte.id}'">
                    <div class="entity-info">
                        <div class="entity-badge" style="background: ${cmte.chamber === 'senate' ? 'var(--party-d)' : 'var(--party-r)'}">
                            <i class="fas fa-gavel"></i>
                        </div>
                        <div>
                            <div class="entity-name">${cmte.name}</div>
                            <div class="entity-meta">${cmte.chamber === 'senate' ? 'Senate' : 'House'} - ${cmte.detail || ''}</div>
                        </div>
                    </div>
                    <span class="entity-amount">${cmte.members || ''} members</span>
                </div>
            `).join('') || '<p style="color: var(--ncrc-gray);">No specific committees identified</p>';
            document.getElementById('modal-committees-list').innerHTML = committeesHtml;

            // Render news sources
            const sourcesSection = document.getElementById('modal-sources');
            const sourcesList = document.getElementById('modal-sources-list');
            if (insight.sources && insight.sources.length > 0) {
                sourcesSection.style.display = 'block';
                const sourcesHtml = insight.sources.map(source => `
                    <div class="source-item">
                        <a href="${source.url}" target="_blank" rel="noopener noreferrer" class="source-link">
                            <i class="fas fa-external-link-alt"></i>
                            <span class="source-title">${source.title}</span>
                        </a>
                        <div class="source-meta">
                            <span class="source-name">${source.source}</span>
                            ${source.date ? `<span class="source-date">${source.date}</span>` : ''}
                        </div>
                    </div>
                `).join('');
                sourcesList.innerHTML = sourcesHtml;
            } else {
                sourcesSection.style.display = 'none';
            }

            // Show modal
            document.getElementById('insight-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeInsightModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('insight-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeInsightModal();
        });

        // Filter change handlers
        document.getElementById('filter-chamber').addEventListener('change', loadLeaderboard);
        document.getElementById('filter-party').addEventListener('change', loadLeaderboard);
        document.getElementById('filter-industry').addEventListener('change', loadLeaderboard);

        // Official name search - filter the loaded officials list
        document.getElementById('search-official').addEventListener('input', (e) => {
            sortAndRenderLeaderboard();
        });

        // Firm search - filter the loaded firms list
        document.getElementById('firm-search').addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.length === 0) {
                renderFirms(allFirms);
                return;
            }

            const filtered = allFirms.filter(firm =>
                firm.name.toLowerCase().includes(query) ||
                (firm.ticker && firm.ticker.toLowerCase().includes(query)) ||
                firm.industry.toLowerCase().includes(query)
            );
            renderFirms(filtered);
        });

        // Load Data Freshness Info
        async function loadDataFreshness() {
            try {
                const response = await fetch('api/freshness');
                const data = await response.json();

                // Show date range (e.g., "Jan 1, 2025 - Jan 10, 2026")
                if (data.data_window) {
                    document.getElementById('freshness-date').textContent =
                        `${data.data_window.start} - ${data.data_window.end}`;
                } else if (data.last_updated_display) {
                    document.getElementById('freshness-date').textContent = data.last_updated_display;
                } else if (data.last_updated) {
                    document.getElementById('freshness-date').textContent = data.last_updated;
                }

                // Individual sources - map API field names to display
                // API returns: fec, fmp (stock trades), congress (committees)
                // Also pass the specific data windows for date range display
                if (data.sources) {
                    updateSourceStatus('fec', data.sources.fec, data.fec_data_window);
                    updateSourceStatus('stock', data.sources.fmp, data.stock_data_window);  // fmp = STOCK Act trades
                    updateSourceStatus('committee', data.sources.congress);  // congress = committees (no date window)
                }
            } catch (error) {
                console.error('Error loading freshness data:', error);
                document.getElementById('freshness-date').textContent = 'Unable to load';
            }
        }

        function updateSourceStatus(prefix, source, dataWindow) {
            const dateEl = document.getElementById(`${prefix}-date`);
            const statusEl = document.getElementById(`${prefix}-status`);

            // If we have a data window with start and end dates, display the range
            if (dataWindow && dataWindow.start && dataWindow.end) {
                // Format: "Jan 2024 - Jan 2026" (shortened for display)
                const formatShortDate = (dateStr) => {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        const options = { month: 'short', year: 'numeric' };
                        return date.toLocaleDateString('en-US', options);
                    }
                    // Fallback: extract month and year from string like "January 20, 2025"
                    const match = dateStr.match(/(\w+)\s+\d+,\s+(\d{4})/);
                    if (match) {
                        return `${match[1].substring(0, 3)} ${match[2]}`;
                    }
                    return dateStr;
                };

                const startShort = formatShortDate(dataWindow.start);
                const endShort = formatShortDate(dataWindow.end);
                dateEl.textContent = `${startShort} - ${endShort}`;

                // Build detailed tooltip with full dates
                let tooltipParts = [];
                tooltipParts.push(`Data Range: ${dataWindow.start} - ${dataWindow.end}`);
                if (dataWindow.description) {
                    tooltipParts.push(dataWindow.description);
                }
                if (source && source.timestamp) {
                    const timestamp = new Date(source.timestamp);
                    const fullDateOptions = { month: 'long', day: 'numeric', year: 'numeric' };
                    tooltipParts.push(`Last Updated: ${timestamp.toLocaleDateString('en-US', fullDateOptions)}`);
                }
                statusEl.title = tooltipParts.join('\n');

                // Set status indicator based on data freshness
                if (source && source.timestamp) {
                    const now = new Date();
                    const timestamp = new Date(source.timestamp);
                    const daysSince = Math.floor((now - timestamp) / (1000 * 60 * 60 * 24));
                    statusEl.classList.remove('stale', 'old');
                    if (daysSince > 14) {
                        statusEl.classList.add('old');
                    } else if (daysSince > 7) {
                        statusEl.classList.add('stale');
                    }
                }
                return;  // Exit after handling dataWindow
            }

            // Fallback: show single date (last updated)
            if (source && source.timestamp) {
                // Parse timestamp and format as readable date with year
                const timestamp = new Date(source.timestamp);
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                let displayText = timestamp.toLocaleDateString('en-US', options);

                // Add record count if available
                if (source.records && source.records > 0) {
                    displayText = `${displayText} (${source.records.toLocaleString()} records)`;
                }
                dateEl.textContent = displayText;

                // Calculate days since update
                const now = new Date();
                const daysSince = Math.floor((now - timestamp) / (1000 * 60 * 60 * 24));

                // Build detailed tooltip
                let tooltipParts = [];
                const fullDateOptions = { month: 'long', day: 'numeric', year: 'numeric' };
                tooltipParts.push(`Updated: ${timestamp.toLocaleDateString('en-US', fullDateOptions)}`);
                if (source.records && source.records > 0) {
                    tooltipParts.push(`Records: ${source.records.toLocaleString()}`);
                }

                statusEl.classList.remove('stale', 'old');
                if (daysSince > 14) {
                    statusEl.classList.add('old');
                    tooltipParts.push(`Data is ${daysSince} days old - may need refresh`);
                } else if (daysSince > 7) {
                    statusEl.classList.add('stale');
                    tooltipParts.push(`Data is ${daysSince} days old`);
                } else {
                    tooltipParts.push('Data is current');
                }
                statusEl.title = tooltipParts.join('\n');
            } else if (source && source.date) {
                // Fallback if pre-formatted date is provided
                let displayText = source.date;
                if (source.records && source.records > 0) {
                    displayText = `${source.date} (${source.records.toLocaleString()} records)`;
                }
                dateEl.textContent = displayText;

                // Build tooltip for fallback case
                if (source.date_full || source.records) {
                    let tooltipParts = [];
                    if (source.date_full) tooltipParts.push(`Updated: ${source.date_full}`);
                    if (source.records) tooltipParts.push(`Records: ${source.records.toLocaleString()}`);
                    statusEl.title = tooltipParts.join('\n');
                }
            }
        }

        // Refresh Data Function (staff/admin only)
        async function refreshElectWatchData() {
            const btn = document.getElementById('refreshDataBtn');
            if (!btn || btn.classList.contains('refreshing')) return;

            if (!confirm('This will refresh all ElectWatch data from external sources. This process may take several minutes. Continue?')) {
                return;
            }

            btn.classList.add('refreshing');
            btn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Refreshing...</span>';

            try {
                const response = await fetch('api/refresh-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.success) {
                    alert('Data refresh started! This process runs in the background and may take several minutes. The page will update automatically when complete. You can continue using the dashboard.');
                    // Poll for completion and reload freshness data
                    setTimeout(() => {
                        loadDataFreshness();
                        btn.classList.remove('refreshing');
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Refresh Data</span>';
                    }, 5000);
                } else {
                    alert('Error: ' + (data.error || 'Failed to start data refresh'));
                    btn.classList.remove('refreshing');
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Refresh Data</span>';
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Error starting data refresh. Please try again.');
                btn.classList.remove('refreshing');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i><span>Refresh Data</span>';
            }
        }

        // Data Source Info Configuration
        const sourceInfo = {
            fec: {
                title: 'FEC Campaign Finance Data',
                icon: 'fa-hand-holding-dollar',
                description: 'Campaign contributions from Political Action Committees (PACs) and individual donors to elected officials. Includes data on who is contributing to campaigns and how much.',
                origin: 'Data sourced from the <a href="https://www.fec.gov/data/" target="_blank">Federal Election Commission (FEC)</a> public API. The FEC is an independent federal agency that regulates campaign finance in United States elections.',
                frequency: 'Weekly',
                delay: '1-2 days after filing',
                notes: 'FEC data reflects contributions as reported by campaigns. Campaigns must file periodic reports (quarterly for most committees), so some recent contributions may not yet appear. Large contributions ($200+) are itemized with donor details.'
            },
            stock: {
                title: 'STOCK Act Trading Data',
                icon: 'fa-chart-line',
                description: 'Stock trades by members of Congress and their spouses, as required by the Stop Trading on Congressional Knowledge (STOCK) Act of 2012. Shows which stocks officials are buying and selling.',
                origin: 'Data sourced from <a href="https://api.quiverquant.com/" target="_blank">Quiver Quantitative</a>, which aggregates STOCK Act disclosures from the House and Senate Financial Disclosure websites.',
                frequency: 'Daily',
                delay: 'Up to 45 days',
                notes: 'By law, members must report trades within 45 days of the transaction. Trades are reported in value ranges (e.g., $1,001-$15,000) rather than exact amounts. Some trades may be disclosed late or amended after initial filing.'
            },
            committee: {
                title: 'Congressional Committee Data',
                icon: 'fa-building-columns',
                description: 'Committee assignments, membership, and leadership positions for the current Congress. Shows which officials sit on key committees overseeing financial regulation.',
                origin: 'Data sourced from <a href="https://api.congress.gov/" target="_blank">Congress.gov API</a>, the official source for legislative information from the Library of Congress.',
                frequency: 'When Congress updates',
                delay: 'Same day',
                notes: 'Committee assignments are typically set at the beginning of each Congress (every 2 years) but can change mid-session due to resignations, special elections, or reshuffling. Subcommittee assignments may update more frequently.'
            }
        };

        function showSourceInfo(sourceKey) {
            const info = sourceInfo[sourceKey];
            if (!info) return;

            document.getElementById('source-info-icon').className = `fas ${info.icon}`;
            document.getElementById('source-info-title').textContent = info.title;
            document.getElementById('source-info-description').textContent = info.description;
            document.getElementById('source-info-origin').innerHTML = info.origin;
            document.getElementById('source-info-frequency').textContent = info.frequency;
            document.getElementById('source-info-delay').textContent = info.delay;
            document.getElementById('source-info-notes').textContent = info.notes;

            document.getElementById('source-info-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSourceInfo() {
            document.getElementById('source-info-modal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modals on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSourceInfo();
            }
        });

        // Load Firms List
        let allFirms = [];
        async function loadFirms() {
            try {
                const response = await fetch('api/firms?limit=100');
                const data = await response.json();

                if (data.success) {
                    allFirms = data.firms;
                    renderFirms(allFirms);
                }
            } catch (error) {
                console.error('Error loading firms:', error);
            }
        }

        function renderFirms(firms) {
            const tbody = document.getElementById('firms-body');
            const loading = document.getElementById('firms-loading');

            if (!firms || firms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--ncrc-gray);">No firms found</td></tr>';
                loading.style.display = 'none';
                return;
            }

            tbody.innerHTML = firms.map((firm, index) => `
                <tr>
                    <td class="rank">${index + 1}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <a href="firm/${encodeURIComponent(firm.name)}" class="firm-name">${firm.name}</a>
                            ${firm.ticker ? `<span style="font-size: 0.75rem; color: var(--ew-neutral-500); background: var(--ew-neutral-50); padding: 2px 6px; border-radius: 4px;">${firm.ticker}</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <span class="industry-chip ${firm.industry}">${formatIndustryName(firm.industry)}</span>
                    </td>
                    <td class="amount-cell">
                        <div class="main">${formatAmount(firm.total)}</div>
                    </td>
                    <td style="text-align: center; font-weight: 600;">${firm.officials}</td>
                    <td style="text-align: center;">
                        ${firm.stock_trades > 0 ? `<span style="color: var(--ncrc-gold); font-weight: 600;">${firm.stock_trades}</span>` : '<span style="color: var(--ncrc-gray);">0</span>'}
                    </td>
                </tr>
            `).join('');

            loading.style.display = 'none';
        }

        function formatIndustryName(code) {
            const names = {
                banking: 'Banking',
                crypto: 'Crypto',
                investment: 'Investment',
                mortgage: 'Mortgage',
                insurance: 'Insurance',
                fintech: 'Fintech',
                consumer_lending: 'Consumer'
            };
            return names[code] || code;
        }

        // Load Industry Summary Stats
        async function loadIndustrySummary() {
            try {
                const response = await fetch('api/sectors');
                const data = await response.json();

                if (data.success && data.sectors) {
                    for (const [code, info] of Object.entries(data.sectors)) {
                        const officialsEl = document.getElementById(`stat-${code}-officials`);
                        const totalEl = document.getElementById(`stat-${code}-total`);

                        if (officialsEl && info.sample_officials) {
                            officialsEl.textContent = info.sample_officials;
                        }
                        if (totalEl && info.sample_total) {
                            totalEl.textContent = formatAmount(info.sample_total);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading industry summary:', error);
            }
        }

        // Bill Search Functions
        async function searchBills(query) {
            if (!query) {
                query = document.getElementById('bill-search-input').value.trim();
            } else {
                document.getElementById('bill-search-input').value = query;
            }

            if (!query) {
                alert('Please enter a bill ID or search term');
                return;
            }

            // Check if it looks like a bill ID (H.R. 4763, S. 1234, etc.)
            const billIdPattern = /^[HS]\.?\s*R?\.?\s*\d+$/i;
            if (billIdPattern.test(query.replace(/\s/g, ''))) {
                // Use new bill search API for direct lookup
                try {
                    const response = await fetch(`api/bill/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.success && data.bill) {
                        // Navigate to bill page
                        window.location.href = `bill/${data.bill.id}`;
                    } else {
                        // If not found, try keyword search
                        const keywordResponse = await fetch(`api/bills/search?q=${encodeURIComponent(query)}`);
                        const keywordData = await keywordResponse.json();
                        if (keywordData.success) {
                            renderBillSearchResults(keywordData.bills, query);
                        } else {
                            alert(data.error || 'Bill not found');
                        }
                    }
                } catch (error) {
                    console.error('Error searching bill:', error);
                    alert('Error searching bill. Please try again.');
                }
                return;
            }

            // Otherwise, search for bills by keyword
            try {
                const response = await fetch(`api/bills/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success) {
                    renderBillSearchResults(data.bills, query);
                } else {
                    alert(data.error || 'Search failed');
                }
            } catch (error) {
                console.error('Error searching bills:', error);
                alert('Error searching bills. Please try again.');
            }
        }

        // Load and display Key Finance Bills from API
        async function loadKeyBills() {
            const keyBillsContainer = document.getElementById('dynamic-key-bills');
            if (!keyBillsContainer) return;

            try {
                const response = await fetch('api/key-bills');
                const data = await response.json();

                if (data.bills && data.bills.length > 0) {
                    keyBillsContainer.innerHTML = data.bills.map(bill => `
                        <div class="bill-card" onclick="window.location='bill/${bill.id}'">
                            <div class="bill-card-header">
                                <span class="bill-id-badge">${bill.id.toUpperCase().replace(/([A-Z]+)(\d+)/, '$1 $2')}</span>
                                {% if is_staff %}
                                <button class="remove-key-bill-btn" onclick="event.stopPropagation(); removeKeyBill('${bill.id}')" title="Remove from Key Bills">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                            <h4>${bill.title || 'Key Finance Bill'}</h4>
                            <p>${bill.summary ? bill.summary.substring(0, 150) + '...' : 'Click to view bill details'}</p>
                            <div class="bill-card-footer">
                                <span style="font-size: 0.75rem; color: var(--ncrc-gray);">Added ${new Date(bill.added_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    keyBillsContainer.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--ncrc-gray);">
                            <i class="fas fa-star" style="font-size: 1.5rem; opacity: 0.5; margin-bottom: 8px;"></i>
                            <p>No key bills saved yet. Staff can add bills using the bill detail pages.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading key bills:', error);
            }
        }

        {% if is_staff %}
        // Remove a bill from key bills list (staff only)
        async function removeKeyBill(billId) {
            if (!confirm('Remove this bill from Key Finance Bills?')) return;

            try {
                const response = await fetch('api/bill/remove-key-bill', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ bill_id: billId })
                });
                const data = await response.json();

                if (data.success) {
                    loadKeyBills();  // Reload the list
                } else {
                    alert(data.error || 'Failed to remove bill');
                }
            } catch (error) {
                console.error('Error removing key bill:', error);
                alert('Error removing bill. Please try again.');
            }
        }
        {% endif %}

        function renderBillSearchResults(bills, query) {
            const resultsContainer = document.getElementById('bill-search-results');
            const resultsList = document.getElementById('bill-results-list');
            const countSpan = document.getElementById('bill-results-count');

            if (!bills || bills.length === 0) {
                resultsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--ncrc-gray);">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 12px;"></i>
                        <p>No bills found matching "${query}"</p>
                    </div>
                `;
            } else {
                resultsList.innerHTML = bills.map(bill => `
                    <div class="bill-result-item" onclick="window.location='bill/${bill.bill_id.replace(/[.\s]/g, '').toLowerCase()}'">
                        <div class="bill-result-info">
                            <div>
                                <span class="bill-result-id">${bill.bill_id}</span>
                                <span class="bill-result-title">${bill.short_title || bill.title}</span>
                            </div>
                            <div class="bill-result-meta">
                                <span>${bill.sponsor}</span>
                                &bull; <span>${bill.latest_action || 'No action yet'}</span>
                            </div>
                        </div>
                        <div class="bill-industries">
                            ${(bill.industries || []).map(ind =>
                                `<span class="industry-chip ${ind}">${ind}</span>`
                            ).join('')}
                        </div>
                    </div>
                `).join('');
            }

            countSpan.textContent = `(${bills.length} results)`;
            resultsContainer.style.display = 'block';
        }

        // Handle enter key in search input
        document.addEventListener('DOMContentLoaded', function() {
            const billSearchInput = document.getElementById('bill-search-input');
            if (billSearchInput) {
                billSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchBills();
                    }
                });
            }
        });

        // Initial load
        loadDataFreshness();
        loadLeaderboard();
        loadIndustrySummary();
        loadFirms();
        refreshInsights();
        loadKeyBills();

        // =============================================
        // ADMIN PANEL FUNCTIONS
        // =============================================
        {% if is_admin %}

        // Admin sub-tab switching
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                const panelId = 'admin-' + tab.dataset.adminPanel;
                document.getElementById(panelId).classList.add('active');
            });
        });

        // Store for officials list
        let allOfficialsForAdmin = [];

        // Load officials into admin dropdowns
        async function loadOfficialsForAdmin() {
            try {
                const response = await fetch('/electwatch/api/officials?limit=600');
                const data = await response.json();
                allOfficialsForAdmin = data.officials || [];

                const canonicalSelect = document.getElementById('canonical-official');
                const aliasSelect = document.getElementById('alias-official');

                // Clear and populate
                canonicalSelect.innerHTML = '<option value="">-- Select official --</option>';
                aliasSelect.innerHTML = '<option value="">-- Select official to merge --</option>';

                allOfficialsForAdmin.sort((a, b) => a.name.localeCompare(b.name));

                allOfficialsForAdmin.forEach(official => {
                    const formattedName = formatDisplayName(official.name);
                    const displayName = `${formattedName} (${official.state}-${official.chamber === 'senate' ? 'S' : official.district || 'H'})`;
                    canonicalSelect.innerHTML += `<option value="${official.name}">${displayName}</option>`;
                    aliasSelect.innerHTML += `<option value="${official.name}">${displayName}</option>`;
                });

                // Load existing merges and potential duplicates
                loadExistingMerges();
                loadPotentialDuplicates();

            } catch (error) {
                console.error('Error loading officials for admin:', error);
            }
        }

        // When canonical official is selected, show their existing aliases
        document.getElementById('canonical-official')?.addEventListener('change', async function() {
            const canonicalName = this.value;
            const aliasesContainer = document.getElementById('canonical-aliases');
            const aliasesDiv = document.getElementById('aliases-container');

            if (!canonicalName) {
                aliasesContainer.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials');
                const data = await response.json();
                const merges = data.merges || [];

                const existing = merges.find(m => m.canonical === canonicalName);
                if (existing && existing.aliases && existing.aliases.length > 0) {
                    aliasesDiv.innerHTML = existing.aliases.map(alias =>
                        `<span class="alias-tag">
                            ${alias}
                            <span class="remove-alias" onclick="removeOfficialAlias('${canonicalName}', '${alias}')">&times;</span>
                        </span>`
                    ).join('');
                    aliasesContainer.style.display = 'block';
                } else {
                    aliasesDiv.innerHTML = '<em style="color: var(--ncrc-gray); font-size: 0.85rem;">No aliases linked yet</em>';
                    aliasesContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading aliases:', error);
            }
        });

        // Save official merge
        async function saveOfficialMerge() {
            const canonical = document.getElementById('canonical-official').value;
            const alias = document.getElementById('alias-official').value;

            if (!canonical || !alias) {
                showStatus('merge-status', 'Please select both the canonical official and the alias to merge.', 'error');
                return;
            }

            if (canonical === alias) {
                showStatus('merge-status', 'Cannot merge an official with themselves.', 'error');
                return;
            }

            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials/merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ canonical, alias })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('merge-status', `Successfully mapped "${alias}"  "${canonical}"`, 'success');
                    // Reset alias dropdown
                    document.getElementById('alias-official').value = '';
                    // Refresh the aliases display
                    document.getElementById('canonical-official').dispatchEvent(new Event('change'));
                    // Refresh existing merges list
                    loadExistingMerges();
                } else {
                    showStatus('merge-status', data.error || 'Failed to save mapping', 'error');
                }
            } catch (error) {
                showStatus('merge-status', 'Error saving mapping: ' + error.message, 'error');
            }
        }

        // Remove an alias from a canonical official
        async function removeOfficialAlias(canonical, alias) {
            if (!confirm(`Remove "${alias}" from "${canonical}"?`)) return;

            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials/unmerge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ canonical, alias })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('canonical-official').dispatchEvent(new Event('change'));
                    loadExistingMerges();
                }
            } catch (error) {
                console.error('Error removing alias:', error);
            }
        }

        // Load existing official merges
        async function loadExistingMerges() {
            const container = document.getElementById('existing-merges');
            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials');
                const data = await response.json();
                const merges = data.merges || [];

                if (merges.length === 0) {
                    container.innerHTML = '<p style="color: var(--ncrc-gray); font-style: italic;">No official merges defined yet.</p>';
                    return;
                }

                container.innerHTML = merges.map(merge =>
                    `<div class="mapping-item">
                        <div class="mapping-info">
                            <div class="mapping-canonical"><i class="fas fa-user"></i> ${merge.canonical}</div>
                            <div class="mapping-aliases">Aliases: ${merge.aliases.join(', ') || 'None'}</div>
                        </div>
                        <div class="mapping-actions">
                            <button class="delete-btn" onclick="deleteOfficialMerge('${merge.canonical}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`
                ).join('');
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);">Error loading merges.</p>';
            }
        }

        // Delete entire official merge
        async function deleteOfficialMerge(canonical) {
            if (!confirm(`Delete all alias mappings for "${canonical}"?`)) return;

            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ canonical })
                });

                const data = await response.json();
                if (data.success) {
                    loadExistingMerges();
                    document.getElementById('canonical-official').dispatchEvent(new Event('change'));
                }
            } catch (error) {
                console.error('Error deleting merge:', error);
            }
        }

        // Load potential duplicate officials (same last name, different first names)
        async function loadPotentialDuplicates() {
            const container = document.getElementById('potential-duplicates-container');
            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials/potential-duplicates');
                const data = await response.json();
                const duplicates = data.potential_duplicates || [];

                if (duplicates.length === 0) {
                    container.innerHTML = '<p style="color: var(--ncrc-gray); font-style: italic;"><i class="fas fa-check-circle"></i> No unresolved potential duplicates found.</p>';
                    return;
                }

                container.innerHTML = `
                    <p style="margin-bottom: 15px; color: var(--ew-neutral-500);">Found ${duplicates.length} potential duplicate pair(s) to review:</p>
                    ${duplicates.map((pair, idx) => `
                        <div class="potential-duplicate-item" style="background: var(--ew-neutral-50); border-radius: 8px; padding: 15px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: 600;">
                                        <i class="fas fa-user" style="color: var(--ew-neutral-500);"></i>
                                        <a href="official/${pair.official1.id}" class="official-name">${pair.official1.name}</a>
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--ew-neutral-500);">
                                        ${pair.official1.chamber === 'house' ? 'Rep' : 'Sen'}. ${pair.official1.party}-${pair.official1.state}
                                        ${pair.official1.bioguide_id ? `<br>BioGuide: ${pair.official1.bioguide_id}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; font-size: 1.5rem; color: var(--ew-neutral-500);">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: 600;">
                                        <i class="fas fa-user" style="color: var(--ew-neutral-500);"></i>
                                        <a href="official/${pair.official2.id}" class="official-name">${pair.official2.name}</a>
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--ew-neutral-500);">
                                        ${pair.official2.chamber === 'house' ? 'Rep' : 'Sen'}. ${pair.official2.party}-${pair.official2.state}
                                        ${pair.official2.bioguide_id ? `<br>BioGuide: ${pair.official2.bioguide_id}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: ${pair.confidence === 'high' ? 'rgba(16, 185, 129, 0.1)' : pair.confidence === 'medium' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; border-radius: 4px; color: ${pair.confidence === 'high' ? 'var(--ew-success)' : pair.confidence === 'medium' ? '#d97706' : 'var(--ew-neutral-500)'}; font-size: 0.85rem;">
                                <i class="fas ${pair.confidence === 'high' ? 'fa-check-circle' : pair.confidence === 'medium' ? 'fa-exclamation-circle' : 'fa-question-circle'}"></i>
                                <strong>${pair.confidence === 'high' ? 'High' : pair.confidence === 'medium' ? 'Medium' : 'Low'} confidence:</strong> ${pair.reason || (pair.same_bioguide ? 'Same BioGuide ID' : 'Same last name')}
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 12px;">
                                <button onclick="mergeOfficials('${pair.official1.name.replace(/'/g, "\\'")}', '${pair.official2.name.replace(/'/g, "\\'")}')" class="admin-btn primary" style="flex: 1;">
                                    <i class="fas fa-user-check"></i> Same Person - Merge
                                </button>
                                <button onclick="markDistinct('${pair.official1.name.replace(/'/g, "\\'")}', '${pair.official2.name.replace(/'/g, "\\'")}')" class="admin-btn secondary" style="flex: 1;">
                                    <i class="fas fa-user-times"></i> Different People
                                </button>
                            </div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);">Error loading potential duplicates.</p>';
                console.error('Error loading potential duplicates:', error);
            }
        }

        // Merge two officials (from potential duplicates)
        async function mergeOfficials(official1, official2) {
            // Use the first one as canonical (typically the cleaner format)
            const canonical = official1.includes(',') ? official2 : official1;
            const alias = official1.includes(',') ? official1 : official2;

            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials/merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ canonical, alias })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('duplicates-status', `Merged "${alias}" into "${canonical}"`, 'success');
                    loadPotentialDuplicates();
                    loadExistingMerges();
                } else {
                    showStatus('duplicates-status', data.error || 'Failed to merge', 'error');
                }
            } catch (error) {
                showStatus('duplicates-status', 'Error merging officials', 'error');
                console.error('Error merging officials:', error);
            }
        }

        // Mark two officials as distinct (confirmed different people)
        async function markDistinct(official1, official2) {
            try {
                const response = await fetch('/electwatch/api/admin/mappings/officials/mark-distinct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ official1, official2 })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('duplicates-status', `Marked "${official1}" and "${official2}" as different people`, 'success');
                    loadPotentialDuplicates();
                } else {
                    showStatus('duplicates-status', data.error || 'Failed to mark as distinct', 'error');
                }
            } catch (error) {
                showStatus('duplicates-status', 'Error marking as distinct', 'error');
                console.error('Error marking as distinct:', error);
            }
        }

        // Show status message
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
            setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
        }

        // Save firm to industry mapping
        async function saveFirmIndustry() {
            const name = document.getElementById('firm-name').value.trim();
            const ticker = document.getElementById('firm-ticker').value.trim();
            const industry = document.getElementById('firm-industry').value;

            if (!name || !industry) {
                showStatus('firm-status', 'Please enter firm name and select an industry.', 'error');
                return;
            }

            try {
                const response = await fetch('/electwatch/api/admin/mappings/firms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, ticker, industry })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('firm-status', `Saved: "${name}"  ${industry}`, 'success');
                    document.getElementById('firm-name').value = '';
                    document.getElementById('firm-ticker').value = '';
                    loadExistingFirms();
                    loadFirmsForEmployerDropdown();
                } else {
                    showStatus('firm-status', data.error || 'Failed to save', 'error');
                }
            } catch (error) {
                showStatus('firm-status', 'Error: ' + error.message, 'error');
            }
        }

        // Load existing firms
        async function loadExistingFirms() {
            const container = document.getElementById('existing-firms');
            try {
                const response = await fetch('/electwatch/api/admin/mappings/firms');
                const data = await response.json();
                const firms = data.firms || [];

                if (firms.length === 0) {
                    container.innerHTML = '<p style="color: var(--ncrc-gray); font-style: italic;">No custom firms defined. Using built-in firm database.</p>';
                    return;
                }

                container.innerHTML = firms.map(firm =>
                    `<div class="mapping-item">
                        <div class="mapping-info">
                            <div class="mapping-canonical">
                                <i class="fas fa-building"></i> ${firm.name}
                                ${firm.ticker ? `<span style="color: var(--ncrc-gray);">(${firm.ticker})</span>` : ''}
                            </div>
                            <div class="mapping-aliases">Industry: ${firm.industry}</div>
                        </div>
                        <div class="mapping-actions">
                            <button class="delete-btn" onclick="deleteFirm('${firm.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`
                ).join('');
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);">Error loading firms.</p>';
            }
        }

        // Filter firms display
        function filterFirms() {
            const search = document.getElementById('firm-search').value.toLowerCase();
            const items = document.querySelectorAll('#existing-firms .mapping-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'flex' : 'none';
            });
        }

        // Delete firm
        async function deleteFirm(name) {
            if (!confirm(`Delete firm "${name}"?`)) return;

            try {
                const response = await fetch('/electwatch/api/admin/mappings/firms/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    loadExistingFirms();
                }
            } catch (error) {
                console.error('Error deleting firm:', error);
            }
        }

        // Load firms for employer mapping dropdown
        async function loadFirmsForEmployerDropdown() {
            const select = document.getElementById('employer-canonical-firm');
            try {
                const response = await fetch('/electwatch/api/admin/mappings/firms/all');
                const data = await response.json();
                const firms = data.firms || [];

                select.innerHTML = '<option value="">-- Select firm --</option>';
                firms.sort((a, b) => a.name.localeCompare(b.name));
                firms.forEach(firm => {
                    select.innerHTML += `<option value="${firm.id}">${firm.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading firms for dropdown:', error);
            }
        }

        // Load firm aliases when firm is selected
        async function loadFirmAliases() {
            const firmId = document.getElementById('employer-canonical-firm').value;
            const aliasesContainer = document.getElementById('firm-aliases');
            const aliasesDiv = document.getElementById('employer-aliases-container');

            if (!firmId) {
                aliasesContainer.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/electwatch/api/admin/mappings/firms/${firmId}/aliases`);
                const data = await response.json();
                const aliases = data.aliases || [];

                if (aliases.length > 0) {
                    aliasesDiv.innerHTML = aliases.map(alias =>
                        `<span class="alias-tag">
                            ${alias}
                            <span class="remove-alias" onclick="removeEmployerAlias('${firmId}', '${alias}')">&times;</span>
                        </span>`
                    ).join('');
                } else {
                    aliasesDiv.innerHTML = '<em style="color: var(--ncrc-gray); font-size: 0.85rem;">No employer aliases linked yet</em>';
                }
                aliasesContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading firm aliases:', error);
            }
        }

        // Search employers
        let employerSearchTimeout;
        function searchEmployers() {
            clearTimeout(employerSearchTimeout);
            const search = document.getElementById('employer-search').value.trim();
            const resultsContainer = document.getElementById('employer-search-results');
            const resultsDiv = document.getElementById('employer-results-container');

            if (search.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            employerSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/electwatch/api/admin/employers/search?q=${encodeURIComponent(search)}`);
                    const data = await response.json();
                    const employers = data.employers || [];

                    if (employers.length > 0) {
                        resultsDiv.innerHTML = employers.map(emp =>
                            `<div class="search-result-item" onclick="selectEmployer('${emp.name.replace(/'/g, "\\'")}')">
                                <span class="employer-name">${emp.name}</span>
                                <span class="contribution-count">${emp.count} contributions</span>
                            </div>`
                        ).join('');
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsDiv.innerHTML = '<p style="color: var(--ncrc-gray); font-style: italic;">No unmatched employers found matching that search.</p>';
                        resultsContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error searching employers:', error);
                }
            }, 300);
        }

        // Select employer from search results
        function selectEmployer(name) {
            document.getElementById('employer-manual').value = name;
            document.querySelectorAll('.search-result-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.search-result-item').classList.add('selected');
        }

        // Save employer mapping
        async function saveEmployerMapping() {
            const firmId = document.getElementById('employer-canonical-firm').value;
            const employerName = document.getElementById('employer-manual').value.trim();

            if (!firmId || !employerName) {
                showStatus('employer-status', 'Please select a firm and enter/select an employer name.', 'error');
                return;
            }

            try {
                const response = await fetch('/electwatch/api/admin/mappings/employers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firm_id: firmId, employer_name: employerName })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('employer-status', `Mapped "${employerName}"  ${data.firm_name}`, 'success');
                    document.getElementById('employer-manual').value = '';
                    document.getElementById('employer-search').value = '';
                    document.getElementById('employer-search-results').style.display = 'none';
                    loadFirmAliases();
                    loadUnmatchedEmployers();
                } else {
                    showStatus('employer-status', data.error || 'Failed to save', 'error');
                }
            } catch (error) {
                showStatus('employer-status', 'Error: ' + error.message, 'error');
            }
        }

        // Remove employer alias
        async function removeEmployerAlias(firmId, alias) {
            if (!confirm(`Remove "${alias}" from this firm?`)) return;

            try {
                const response = await fetch('/electwatch/api/admin/mappings/employers/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firm_id: firmId, employer_name: alias })
                });

                if (response.ok) {
                    loadFirmAliases();
                }
            } catch (error) {
                console.error('Error removing employer alias:', error);
            }
        }

        // Load unmatched employers
        async function loadUnmatchedEmployers() {
            const container = document.getElementById('unmatched-employers');
            try {
                const response = await fetch('/electwatch/api/admin/employers/unmatched?limit=50');
                const data = await response.json();
                const employers = data.employers || [];

                if (employers.length === 0) {
                    container.innerHTML = '<p style="color: var(--success); font-style: italic;">All employers are matched!</p>';
                    return;
                }

                container.innerHTML = employers.map(emp =>
                    `<div class="mapping-item">
                        <div class="mapping-info">
                            <div class="mapping-canonical">${emp.name}</div>
                            <div class="mapping-aliases">${emp.count} contributions</div>
                        </div>
                        <div class="mapping-actions">
                            <button class="edit-btn" onclick="quickMapEmployer('${emp.name.replace(/'/g, "\\'")}')">
                                <i class="fas fa-link"></i> Map
                            </button>
                        </div>
                    </div>`
                ).join('');
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);">Error loading unmatched employers.</p>';
            }
        }

        // Quick map employer - fills in the employer name
        function quickMapEmployer(name) {
            document.getElementById('employer-manual').value = name;
            document.getElementById('employer-canonical-firm').focus();
        }

        // =============================================
        // UNMATCHED ENTITIES PANEL
        // =============================================

        // Load all unmatched entities for the Unmatched tab
        async function loadUnmatchedEntities() {
            loadUnmatchedPACs();
            loadUnmatchedEmployerNames();
            loadUncategorizedTickers();
        }

        // Load unmatched PAC names
        async function loadUnmatchedPACs() {
            const container = document.getElementById('unmatched-pacs');
            try {
                const response = await fetch('/electwatch/api/admin/unmatched/pacs');
                const data = await response.json();
                const pacs = data.pacs || [];

                document.getElementById('unmatched-count-pacs').textContent = pacs.length;
                updateTotalUnmatchedCount();

                if (pacs.length === 0) {
                    container.innerHTML = '<p style="color: var(--success); font-style: italic;"><i class="fas fa-check-circle"></i> All PACs are mapped!</p>';
                    return;
                }

                container.innerHTML = pacs.map(pac =>
                    `<div class="unmatched-item" data-category="pacs">
                        <div class="entity-info">
                            <div class="entity-name">${pac.name}</div>
                            <div class="entity-meta">$${(pac.total_amount || 0).toLocaleString()} from ${pac.count || 0} contributions</div>
                        </div>
                        <button class="action-btn" onclick="mapPACToFirm('${pac.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-link"></i> Map
                        </button>
                    </div>`
                ).join('');
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error loading PACs.</p>';
                console.error('Error loading unmatched PACs:', error);
            }
        }

        // Load unmatched employer names
        async function loadUnmatchedEmployerNames() {
            const container = document.getElementById('unmatched-employer-names');
            try {
                const response = await fetch('/electwatch/api/admin/employers/unmatched?limit=50');
                const data = await response.json();
                const employers = data.employers || [];

                document.getElementById('unmatched-count-employers').textContent = employers.length;
                updateTotalUnmatchedCount();

                if (employers.length === 0) {
                    container.innerHTML = '<p style="color: var(--success); font-style: italic;"><i class="fas fa-check-circle"></i> All employers are matched!</p>';
                    return;
                }

                container.innerHTML = employers.map(emp =>
                    `<div class="unmatched-item" data-category="employers">
                        <div class="entity-info">
                            <div class="entity-name">${emp.name}</div>
                            <div class="entity-meta">${emp.count} contributions</div>
                        </div>
                        <button class="action-btn" onclick="quickMapEmployer('${emp.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-link"></i> Map
                        </button>
                    </div>`
                ).join('');
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error loading employers.</p>';
            }
        }

        // Load uncategorized stock tickers
        async function loadUncategorizedTickers() {
            const container = document.getElementById('unmatched-tickers');
            try {
                const response = await fetch('/electwatch/api/admin/unmatched/tickers');
                const data = await response.json();
                const tickers = data.tickers || [];

                document.getElementById('unmatched-count-tickers').textContent = tickers.length;
                updateTotalUnmatchedCount();

                if (tickers.length === 0) {
                    container.innerHTML = '<p style="color: var(--success); font-style: italic;"><i class="fas fa-check-circle"></i> All tickers are categorized!</p>';
                    return;
                }

                container.innerHTML = tickers.map(ticker =>
                    `<div class="unmatched-item" data-category="tickers">
                        <div class="entity-info">
                            <div class="entity-name">${ticker.ticker} - ${ticker.company || 'Unknown'}</div>
                            <div class="entity-meta">${ticker.trade_count} trades by ${ticker.official_count} officials</div>
                        </div>
                        <button class="action-btn" onclick="mapTickerToIndustry('${ticker.ticker}')">
                            <i class="fas fa-industry"></i> Categorize
                        </button>
                    </div>`
                ).join('');
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> Error loading tickers.</p>';
            }
        }

        // Update total unmatched count
        function updateTotalUnmatchedCount() {
            const pacs = parseInt(document.getElementById('unmatched-count-pacs').textContent) || 0;
            const employers = parseInt(document.getElementById('unmatched-count-employers').textContent) || 0;
            const tickers = parseInt(document.getElementById('unmatched-count-tickers').textContent) || 0;
            document.getElementById('unmatched-count-all').textContent = pacs + employers + tickers;
        }

        // Filter unmatched items by category
        function filterUnmatched(category) {
            // Update button states
            document.querySelectorAll('.unmatched-filters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === category);
            });

            // Show/hide items
            document.querySelectorAll('.unmatched-item').forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });

            // Show/hide section containers
            document.querySelectorAll('.unmatched-list').forEach(list => {
                if (category === 'all' || list.dataset.category === category) {
                    list.closest('.admin-section').style.display = '';
                } else {
                    list.closest('.admin-section').style.display = 'none';
                }
            });
        }

        // Map PAC to firm - switch to employer-firm tab and fill in
        function mapPACToFirm(pacName) {
            // Switch to employer-firm tab
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.admin-tab[data-admin-panel="employer-firm"]').classList.add('active');
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('admin-employer-firm').classList.add('active');

            // Fill in the manual field
            document.getElementById('employer-manual').value = pacName;
            document.getElementById('employer-canonical-firm').focus();
        }

        // Map ticker to industry - switch to firm-industry tab
        function mapTickerToIndustry(ticker) {
            // Switch to firm-industry tab
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.admin-tab[data-admin-panel="firm-industry"]').classList.add('active');
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('admin-firm-industry').classList.add('active');

            // Fill in the ticker field
            document.getElementById('firm-ticker').value = ticker;
            document.getElementById('firm-name').focus();
        }

        // Initialize admin panel when admin tab is shown
        document.querySelector('.nav-tab[data-panel="admin"]')?.addEventListener('click', () => {
            if (allOfficialsForAdmin.length === 0) {
                loadOfficialsForAdmin();
                loadExistingFirms();
                loadFirmsForEmployerDropdown();
                loadUnmatchedEmployers();
                loadUnmatchedEntities();
            }
        });

        // Load unmatched entities when Unmatched tab is clicked
        document.querySelector('.admin-tab[data-admin-panel="unmatched-entities"]')?.addEventListener('click', () => {
            loadUnmatchedEntities();
        });

        {% endif %}
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

    <!-- JustData Auth -->
    <script src="/static/js/auth.js"></script>

    <!-- Hamburger Menu Toggle & User Dropdown -->
    <script>
        function toggleNavMenu() {
            const menu = document.getElementById('navMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            // Close nav menu
            const menu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger-menu');
            if (menu && hamburger && !menu.contains(event.target) && !hamburger.contains(event.target)) {
                menu.style.display = 'none';
            }

            // Close user dropdown
            const userDropdown = document.getElementById('userDropdown');
            const userMenu = document.getElementById('userMenu');
            if (userDropdown && userMenu && !userMenu.contains(event.target)) {
                userDropdown.classList.remove('active');
            }
        });

        // Show/hide userMenu (options dropdown) based on auth state
        // This supplements auth.js which handles userInfo, loginBtn, logoutBtn
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we have staff/admin options to show
            const userMenu = document.getElementById('userMenu');
            const hasStaffOptions = userMenu && userMenu.querySelector('.user-dropdown-item');

            if (hasStaffOptions) {
                // Monitor userInfo visibility to sync userMenu
                const userInfo = document.getElementById('userInfo');
                if (userInfo) {
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.attributeName === 'style') {
                                const isLoggedIn = userInfo.style.display === 'flex';
                                userMenu.style.display = isLoggedIn ? 'block' : 'none';
                            }
                        });
                    });
                    observer.observe(userInfo, { attributes: true });

                    // Initial state check
                    if (userInfo.style.display === 'flex') {
                        userMenu.style.display = 'block';
                    }
                }
            }
        });
    </script>
    <script>document.addEventListener('DOMContentLoaded',function(){function showAdminTabs(){if(window.justDataUserType==='admin')document.querySelectorAll('.nav-tab.admin-nav-tab').forEach(t=>t.style.display='flex');}function checkAdmin(){if(window.justDataUserType)showAdminTabs();else setTimeout(checkAdmin,500);}checkAdmin();const badge=document.getElementById('userTypeBadge');if(badge)new MutationObserver(showAdminTabs).observe(badge,{childList:true,characterData:true,subtree:true});document.querySelectorAll('[data-matching-panel]').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('[data-matching-panel]').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.querySelectorAll('#matching .admin-panel').forEach(p=>p.classList.remove('active'));const panel=document.getElementById('matching-'+t.dataset.matchingPanel);if(panel)panel.classList.add('active');}));document.querySelectorAll('[data-dedup-panel]').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('[data-dedup-panel]').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.querySelectorAll('#deduplicate .admin-panel').forEach(p=>p.classList.remove('active'));const panel=document.getElementById('dedup-'+t.dataset.dedupPanel);if(panel)panel.classList.add('active');}));window.searchUnmatchedFirmsMatching=function(){const el=document.getElementById('unmatched-firms-results');if(el)el.innerHTML='<p>Searching...</p>';};window.searchUnmatchedOfficialsMatching=function(){const el=document.getElementById('unmatched-officials-results');if(el)el.innerHTML='<p>Searching...</p>';};window.searchUnmatchedPACsMatching=function(){const el=document.getElementById('unmatched-pacs-results');if(el)el.innerHTML='<p>Searching...</p>';};window.createFirmMatch=function(){alert('API not yet implemented');};window.createOfficialMatch=function(){alert('API not yet implemented');};window.createPACMatch=function(){alert('API not yet implemented');};window.scanForDuplicateOfficials=function(){const el=document.getElementById('duplicate-officials-container');if(el)el.innerHTML='<p>Scanning...</p>';};window.scanForDuplicateFirms=function(){const el=document.getElementById('duplicate-firms-container');if(el)el.innerHTML='<p>Scanning...</p>';};window.scanForDuplicateTransactions=function(){const el=document.getElementById('duplicate-transactions-container');if(el)el.innerHTML='<p>Scanning...</p>';};});</script>
</body>
</html>
