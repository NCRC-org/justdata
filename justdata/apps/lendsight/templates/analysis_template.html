<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LendSight - JustData</title>
    <meta name="description" content="AI-powered mortgage lending data analyzer with BigQuery integration. Generate comprehensive mortgage market analysis reports from HMDA data.">
    <meta name="keywords" content="LendSight, mortgage, lending analysis, HMDA, AI, BigQuery, market intelligence">
    <meta name="author" content="JustData - National Community Reinvestment Coalition">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://justdata.app/lendsight/">
    <meta property="og:title" content="LendSight - AI-Powered Mortgage Insights">
    <meta property="og:description" content="Generate comprehensive mortgage market analysis reports with AI-powered insights from HMDA data.">
    <meta property="og:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://justdata.app/lendsight/">
    <meta property="twitter:title" content="LendSight - AI-Powered Mortgage Insights">
    <meta property="twitter:description" content="Generate comprehensive mortgage market analysis reports with AI-powered insights from HMDA data.">
    <meta property="twitter:image" content="https://jadedlebi.github.io/fdic-branch-analyzer/assets/og-image.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body style="background: var(--ncrc-gray-light); min-height: 100vh;">
    {% include "shared_header.html" %}

    <div class="container">
        <!-- Main Content -->
        <div class="content-wrapper">
        <main class="main-content">
            <div class="analysis-card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> Generate Local Market Mortgage Analysis</h2>
                    <p>Enter the state and county to analyze mortgage lending</p>
                </div>

                <form id="analysisForm" class="analysis-form">
                    <!-- State Selection (Required) -->
                    <div class="form-group">
                        <label for="state-filter-select" data-tooltip="Select a state to filter counties. Counties from the selected state will appear below.">
                            <i class="fas fa-map"></i>
                            State <span style="color: red;">*</span>
                        </label>
                        <select id="state-filter-select" name="state_code" required style="width: 100%; margin-bottom: 15px;" placeholder="Select a state...">
                            <option value="">Select a state...</option>
                        </select>
                        <small class="help-text" style="margin-bottom: 15px; display: block;">
                            <i class="fas fa-info-circle"></i>
                            Select a state to filter counties. Counties from the selected state will appear below.
                        </small>
                    </div>

                    <!-- County Selection (Single county from selected state) -->
                    <div class="form-group" id="county-selection-group">
                        <label for="county-select" data-tooltip="Select a single county from the selected state. You can search by typing county names.">
                            <i class="fas fa-map-marker-alt"></i>
                            County <span style="color: red;">*</span>
                        </label>
                        <select id="county-select" name="counties" required disabled style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select a state first...</option>
                        </select>
                        <small class="help-text">
                            <i class="fas fa-info-circle"></i>
                            Select a single county from the selected state. You must select a state first.
                        </small>
                    </div>

                    <!-- Loan Purpose Selection -->
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; font-size: 1rem;">
                            <i class="fas fa-home" style="margin-right: 8px; color: var(--ncrc-dark-blue);"></i>
                            Loan Purpose
                        </label>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                            <label class="loan-purpose-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                <input type="checkbox" name="loan_purpose" id="loan_purpose_purchase" value="purchase" style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">Home Purchase</div>
                                    <div style="font-size: 0.85rem; color: #666;">Primary residence purchases</div>
                                </div>
                            </label>
                            
                            <label class="loan-purpose-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                <input type="checkbox" name="loan_purpose" id="loan_purpose_refinance" value="refinance" style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">Refinance & Cash-Out</div>
                                    <div style="font-size: 0.85rem; color: #666;">Refinancing and cash-out loans</div>
                                </div>
                            </label>
                            
                            <label class="loan-purpose-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                <input type="checkbox" name="loan_purpose" id="loan_purpose_equity" value="equity" style="margin-right: 12px; width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">Home Equity</div>
                                    <div style="font-size: 0.85rem; color: #666;">Home equity lines and loans</div>
                                </div>
                            </label>
                            
                            <!-- Filter Information Card (matches loan purpose card style, positioned below Refinance) -->
                            <div class="filter-info-card-container">
                                <div id="toggleFiltersInfoBtn" class="filter-info-card" style="display: flex; align-items: center; padding: 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                    <i class="fas fa-filter" style="margin-right: 12px; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--ncrc-secondary-blue); font-size: 1.1rem; flex-shrink: 0;"></i>
                                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                        <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--ncrc-gray-dark);">View Applied Data Filters</div>
                                        <div style="font-size: 0.85rem; color: #666; height: 16px; line-height: 16px;">&nbsp;</div>
                                    </div>
                                    <i class="fas fa-chevron-down" id="filtersChevron" style="margin-left: 12px; transition: transform 0.2s ease; color: #666; flex-shrink: 0;"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expanded Filter Content (appears below the grid when expanded) -->
                        <div id="filtersInfoContent" style="display: none; margin-top: 12px; padding: 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 12px; color: var(--ncrc-gray-dark);">
                                All analyses automatically include these filters:
                            </div>
                            <div id="filtersList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px 20px; font-size: 0.9rem; line-height: 1.6;">
                                <!-- Filters will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Year Range (Fixed to 2020-2024) -->
                    <div class="form-group">
                        <div style="padding: 15px; background: var(--ncrc-light-blue); border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #333;">
                                <i class="fas fa-calendar-alt"></i>
                                <strong>Year Range:</strong> This report will analyze data from <strong>2020 to 2024</strong> (Most recent five years).
                            </p>
                        </div>
                    </div>

                    <!-- Force Refresh Option -->
                    <div class="form-group" style="margin-bottom: 20px; margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.95em; color: #333; padding: 12px 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; transition: all 0.2s ease;">
                            <input type="checkbox" id="forceRefreshCheckbox" style="cursor: pointer; width: 18px; height: 18px; accent-color: #0066cc;">
                            <span><i class="fas fa-sync-alt" style="margin-right: 6px; color: #0066cc;"></i>Clear cache and regenerate report</span>
                        </label>
                        <small style="display: block; margin-top: 6px; color: #666; font-size: 0.85em; padding-left: 15px;">Check this box if you want to bypass cached data and fetch fresh results</small>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn" data-tooltip="Click to generate your analysis. Make sure you've selected a state, county, and loan purpose first.">
                        <i class="fas fa-magic"></i>
                        <span>Generate Analysis</span>
                    </button>
                    <small class="submit-info">
                        <i class="fas fa-clock"></i>
                        Analysis typically takes a few minutes
                    </small>
                </form>

                <!-- Progress Section -->
                <div id="progressSection" class="progress-section" style="display: none;">
                    <div class="progress-card">
                        <div class="progress-header">
                            <i class="fas fa-cog fa-spin"></i>
                            <h3>Analyzing Data...</h3>
                        </div>
                        <div class="progress-steps" id="progressSteps" style="margin-bottom: 15px; text-align: left;">
                            <!-- Progress steps will be populated by JavaScript -->
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p class="progress-text" id="progressText">Initializing analysis...</p>
                        <div class="progress-info">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="results-section" style="display: none;">
                    <div class="results-card">
                        <div class="results-header">
                            <i class="fas fa-check-circle"></i>
                            <h3>Analysis Complete!</h3>
                        </div>
                        <div class="results-content">
                            <p>Your mortgage lending analysis has been generated successfully.</p>
                            <div class="download-options">
                                <button class="download-btn" id="viewReportBtn">
                                    <i class="fas fa-chart-bar"></i>
                                    View Web Report
                                </button>
                                <button class="download-btn secondary" id="downloadBtn">
                                    <i class="fas fa-download"></i>
                                    Export Data
                                </button>
                                <small class="download-info">
                                    <i class="fas fa-globe"></i>
                                    Interactive web report with export options
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="error-section" style="display: none;">
                    <div class="error-card">
                        <div class="error-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Analysis Failed</h3>
                        </div>
                        <div class="error-content">
                            <p id="errorMessage"></p>
                            <button class="retry-btn" onclick="resetForm()">
                                <i class="fas fa-redo"></i>
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </main>
        </div> <!-- End content-wrapper -->
    </div> <!-- End container -->

    <!-- Shared Footer -->
    {% set app_name = "LendSight" %}
    {% include "shared_footer.html" %}

    <!-- jQuery (must be first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- app.js is loaded later after all overrides are set up (see line 991) -->
    <!-- LendSight-specific form handler will be attached after shared app.js loads -->
    <script>
        // LendSight-specific customizations
        $(document).ready(function() {
            // Populate loan purpose filters information
            function populateFiltersInfo() {
                const filtersList = document.getElementById('filtersList');
                if (!filtersList) return;
                
                const filters = [
                    'Originations only (action taken = 1)',
                    'Site-built properties (construction method = 1)',
                    'Owner-occupied properties (occupancy type = 1)',
                    'Forward loans (excludes reverse mortgages)',
                    '1-4 unit properties'
                ];
                
                filtersList.innerHTML = filters.map((filter) => 
                    `<div style="display: flex; align-items: flex-start;">
                        <span style="margin-right: 8px; color: var(--ncrc-secondary-blue); font-weight: bold;">â€¢</span>
                        <span>${filter}</span>
                    </div>`
                ).join('');
            }
            
            // Add interactive styles for loan purpose cards
            $(document).ready(function() {
                // Toggle filters info visibility with hover effects matching loan purpose cards
                const filterCard = $('#toggleFiltersInfoBtn');
                const content = $('#filtersInfoContent');
                
                filterCard.on('click', function() {
                    const chevron = $('#filtersChevron');
                    const isCurrentlyHidden = content.is(':hidden');
                    
                    if (isCurrentlyHidden) {
                        content.slideDown(200);
                        chevron.css('transform', 'rotate(180deg)');
                        filterCard.css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa',
                            'box-shadow': '0 2px 4px rgba(0,0,0,0.1)'
                        });
                    } else {
                        content.slideUp(200);
                        chevron.css('transform', 'rotate(0deg)');
                        filterCard.css({
                            'border-color': '#e0e0e0',
                            'background': 'white',
                            'box-shadow': 'none'
                        });
                    }
                });
                
                // Add hover effects for filter info card (only when not expanded)
                filterCard.on('mouseenter', function() {
                    if (content.is(':hidden')) {
                        $(this).css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa',
                            'box-shadow': '0 2px 4px rgba(0,0,0,0.1)'
                        });
                    }
                }).on('mouseleave', function() {
                    if (content.is(':hidden')) {
                        $(this).css({
                            'border-color': '#e0e0e0',
                            'background': 'white',
                            'box-shadow': 'none'
                        });
                    }
                });
                
                $('.loan-purpose-card').on('mouseenter', function() {
                    const checkbox = $(this).find('input[type="checkbox"]');
                    // Only apply hover effect if checkbox is not disabled
                    if (!checkbox.is(':disabled')) {
                        $(this).css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa',
                            'box-shadow': '0 2px 4px rgba(0,0,0,0.1)'
                        });
                    }
                }).on('mouseleave', function() {
                    const checkbox = $(this).find('input[type="checkbox"]');
                    if (checkbox.is(':checked')) {
                        $(this).css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa',
                            'box-shadow': 'none'
                        });
                    } else if (checkbox.is(':disabled')) {
                        $(this).css({
                            'border-color': '#d0d0d0',
                            'background': '#f5f5f5',
                            'opacity': '0.6',
                            'box-shadow': 'none'
                        });
                    } else {
                        $(this).css({
                            'border-color': '#e0e0e0',
                            'background': 'white',
                            'box-shadow': 'none'
                        });
                    }
                });
                
                // Make loan purpose checkboxes mutually exclusive (single selection only)
                function updateLoanPurposeSelection(clickedCheckbox) {
                    const allCheckboxes = $('.loan-purpose-card input[type="checkbox"]');
                    const checkedCount = allCheckboxes.filter(':checked').length;
                    const clickedCard = $(clickedCheckbox).closest('.loan-purpose-card');
                    const isChecked = $(clickedCheckbox).is(':checked');
                    
                    if (isChecked) {
                        // When one is checked, uncheck and disable all others
                        allCheckboxes.not(clickedCheckbox).each(function() {
                            $(this).prop('checked', false).prop('disabled', true);
                            const card = $(this).closest('.loan-purpose-card');
                            card.css({
                                'border-color': '#d0d0d0',
                                'background': '#f5f5f5',
                                'opacity': '0.6',
                                'cursor': 'not-allowed'
                            });
                            card.find('div').css('color', '#999');
                        });
                        
                        // Style the selected card
                        clickedCard.css({
                            'border-color': 'var(--ncrc-secondary-blue)',
                            'background': '#f0f7fa',
                            'opacity': '1',
                            'cursor': 'pointer'
                        });
                        clickedCard.find('div').css('color', '');
                    } else {
                        // When unchecked, enable all others so user can select a different one
                        // Allow unchecking - validation will catch if none are selected on form submit
                        
                        // Enable all others when this one is unchecked
                        allCheckboxes.not(clickedCheckbox).each(function() {
                            $(this).prop('disabled', false);
                            const card = $(this).closest('.loan-purpose-card');
                            const isOtherChecked = $(this).is(':checked');
                            if (isOtherChecked) {
                                card.css({
                                    'border-color': 'var(--ncrc-secondary-blue)',
                                    'background': '#f0f7fa',
                                    'opacity': '1',
                                    'cursor': 'pointer'
                                });
                                card.find('div').css('color', '');
                            } else {
                                card.css({
                                    'border-color': '#e0e0e0',
                                    'background': 'white',
                                    'opacity': '1',
                                    'cursor': 'pointer'
                                });
                                card.find('div').css('color', '');
                            }
                        });
                        
                        // Style the unselected card
                        clickedCard.css({
                            'border-color': '#e0e0e0',
                            'background': 'white',
                            'opacity': '1',
                            'cursor': 'pointer'
                        });
                        clickedCard.find('div').css('color', '');
                    }
                }
                
                // Initialize: no default selection, all options enabled
                // No initialization needed - all checkboxes start unchecked and enabled
                
                // Prevent clicking on disabled cards
                $('.loan-purpose-card').on('click', function(e) {
                    const checkbox = $(this).find('input[type="checkbox"]');
                    if (checkbox.is(':disabled')) {
                        e.preventDefault();
                        return false;
                    }
                });
                
                // Update card style when checkbox is toggled
                $('.loan-purpose-card input[type="checkbox"]').on('change', function() {
                    updateLoanPurposeSelection(this);
                    updateSubmitButtonState();
                });
                
                // Function to enable/disable submit button based on loan purpose selection
                function updateSubmitButtonState() {
                    const checkedCount = $('.loan-purpose-card input[type="checkbox"]:checked').length;
                    const submitBtn = document.getElementById('submitBtn');
                    if (submitBtn) {
                        if (checkedCount === 0) {
                            submitBtn.disabled = true;
                            submitBtn.style.opacity = '0.6';
                            submitBtn.style.cursor = 'not-allowed';
                        } else {
                            submitBtn.disabled = false;
                            submitBtn.style.opacity = '1';
                            submitBtn.style.cursor = 'pointer';
                        }
                    }
                }
                
                // Initialize submit button state on page load
                updateSubmitButtonState();
                
                // Initialize card styles based on checked state
                $('.loan-purpose-card input[type="checkbox"]:checked').each(function() {
                    $(this).closest('.loan-purpose-card').css({
                        'border-color': 'var(--ncrc-secondary-blue)',
                        'background': '#f0f7fa'
                    });
                });
            });
            
            // Call on page load
            populateFiltersInfo();
            
            // Note: loadStates() is defined in the jQuery ready block below
            // This prevents duplicate loading and Select2 initialization conflicts
            
            // Load counties on page load (if not already loaded by shared app.js)
            function loadCountiesForLendSight() {
                const countySelect = document.getElementById('county-select');
                if (!countySelect) return;
                
                // Check if counties are already loaded
                if ($(countySelect).find('option').length > 0) {
                    console.log('Counties already loaded');
                    return;
                }
                
                fetch('/counties')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load counties');
                        }
                        return response.json();
                    })
                    .then(counties => {
                        if (!Array.isArray(counties)) {
                            throw new Error('Invalid response format');
                        }
                        
                        // Clear and populate
                        $(countySelect).empty();
                        counties.forEach(county => {
                            $(countySelect).append(new Option(county, county));
                        });
                        
                        // No Select2 needed - using plain HTML select like BizSight
                        
                        console.log(`Loaded ${counties.length} counties`);
                    })
                    .catch(error => {
                        console.error('Error loading counties:', error);
                    });
            }
            
            // Load counties after a short delay to ensure DOM is ready
            setTimeout(loadCountiesForLendSight, 200);
            
            // Override validation for LendSight (single county, fixed years)
            // This must run BEFORE app.js loads to override the shared validation
            window.validateInput = function(input, type) {
                // Override county-select validation for single county
                if (type === 'county-select') {
                    const countySelect = document.getElementById('county-select');
                    if (!countySelect) return true;
                    
                    const selectedCounty = countySelect.value;
                    if (!selectedCounty || selectedCounty === '') {
                        showValidationMessage(countySelect, 'Please select a county to analyze.', 'error');
                        countySelect.setCustomValidity('Please select a county.');
                        return false;
                    } else {
                        hideValidationMessage(countySelect);
                        countySelect.setCustomValidity('');
                        showValidationMessage(countySelect, 'County selected successfully.', 'success');
                        return true;
                    }
                }
                // For other types, check if original exists and use it
                if (window.originalValidateInput) {
                    return window.originalValidateInput.call(this, input, type);
                }
                return true;
            };});
    </script>
    
    <!-- jQuery (must be first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Override progress steps for LendSight BEFORE app.js loads -->
    <script>
        // Override progress steps for LendSight (consolidated to 10 main steps)
        window.PROGRESS_STEPS = [
            { id: 'initializing', label: 'Initializing', icon: 'fa-cog' },
            { id: 'preparing_data', label: 'Preparing Data', icon: 'fa-database' },
            { id: 'connecting_db', label: 'Connecting to Database', icon: 'fa-plug' },
            { id: 'fetching_data', label: 'Fetching Data', icon: 'fa-download' },
            { id: 'building_report', label: 'Building Report', icon: 'fa-file-alt' },
            { id: 'demographic_overview', label: 'Section 1: Loans by Race & Ethnicity', icon: 'fa-chart-pie' },
            { id: 'income_neighborhood', label: 'Section 2: Income & Neighborhood', icon: 'fa-map-marked-alt' },
            { id: 'top_lenders', label: 'Section 3: Top Lenders', icon: 'fa-building' },
            { id: 'generating_ai', label: 'Generating AI Insights', icon: 'fa-brain' },
            { id: 'completed', label: 'Complete', icon: 'fa-check' }
        ];
        
        // LendSight-specific state and county loading
        $(document).ready(function() {
            // Guard to prevent multiple simultaneous calls to loadStates
            let isLoadingStates = false;
            let statesLoaded = false;
            
            // Store state name to code mapping for reliable lookup
            const stateCodeMap = {};
            
            // Load states on page load
            function loadStates() {
                // Prevent multiple simultaneous calls
                if (isLoadingStates) {
                    console.log('[DEBUG] loadStates: Already loading, skipping...');
                    return;
                }
                
                const stateSelect = $('#state-filter-select');
                if (!stateSelect.length) {
                    console.warn('State select element not found');
                    return;
                }
                
                // Preserve current selection if any
                const currentValue = stateSelect.val();
                console.log(`[DEBUG] loadStates: Current value before load: ${currentValue}`);
                
                isLoadingStates = true;
                
                fetch('/states')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load states');
                        }
                        return response.json();
                    })
                    .then(states => {
                        // Destroy Select2 if it exists to prevent conflicts
                        if (stateSelect.hasClass('select2-hidden-accessible')) {
                            stateSelect.select2('destroy');
                        }
                        
                        stateSelect.empty();
                        stateSelect.append('<option value="">Select a state...</option>');
                        
                        states.forEach(state => {
                            const stateName = state.name || state;
                            const stateCode = state.code || state;
                            // Store in mapping object for reliable lookup
                            stateCodeMap[stateName] = stateCode;
                            // Store both name and code as data attributes, but use name as value
                            const option = new Option(stateName, stateName);
                            // Set data attribute directly on DOM element so it persists with Select2
                            option.setAttribute('data-code', stateCode);
                            $(option).data('code', stateCode); // Also set jQuery data for compatibility
                            stateSelect.append(option);
                        });
                        
                        // Reinitialize Select2 for state dropdown
                        stateSelect.select2({
                            placeholder: 'Select a state...',
                            allowClear: true,
                            width: '100%'
                        });
                        
                        // DON'T restore previous selection - this was causing automatic Arizona loads
                        // Users should select their state fresh each time
                        // if (currentValue && stateSelect.find(`option[value="${currentValue}"]`).length > 0) {
                        //     console.log(`[DEBUG] loadStates: Restoring previous selection: ${currentValue}`);
                        //     // Use setTimeout to ensure Select2 is fully initialized before setting value
                        //     setTimeout(() => {
                        //         stateSelect.val(currentValue).trigger('change');
                        //     }, 100);
                        // }
                        
                        statesLoaded = true;
                        isLoadingStates = false;
                    })
                    .catch(error => {
                        console.error('Error loading states:', error);
                        isLoadingStates = false;
                    });
            }
            
            // Load counties for selected state
            function loadCountiesForState(stateCode) {
                const countySelect = document.getElementById('county-select');
                if (!countySelect) {
                    console.warn('[DEBUG] County select element not found');
                    return;
                }
                
                if (!stateCode) {
                    countySelect.innerHTML = '<option value="">Select a state first...</option>';
                    countySelect.disabled = true;
                    return;
                }
                
                console.log(`[DEBUG] loadCountiesForState called with state code: ${stateCode}`);
                
                // Show loading state
                countySelect.disabled = true;
                countySelect.innerHTML = '<option value="">Loading counties...</option>';
                
                fetch(`/counties-by-state/${encodeURIComponent(stateCode)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load counties: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(counties => {
                        // Clear and enable the select
                        countySelect.disabled = false;
                        countySelect.innerHTML = '<option value="">Select a county...</option>';
                        
                        // Handle both old format (strings) and new format (objects with FIPS codes)
                        counties.forEach(county => {
                            const option = document.createElement('option');
                            if (typeof county === 'string') {
                                // Old format: just county name string
                                option.value = county;
                                option.textContent = county;
                            } else if (county && county.name) {
                                // New format: county object with name, geoid5, state_fips, county_fips
                                option.value = county.name;
                                option.textContent = county.name;
                                option.dataset.county = JSON.stringify(county); // Store full county object
                            }
                            countySelect.appendChild(option);
                        });
                        
                        console.log(`[DEBUG] Loaded ${counties.length} counties for state code ${stateCode}`);
                    })
                    .catch(error => {
                        console.error('Error loading counties:', error);
                        countySelect.innerHTML = '<option value="">Error loading counties. Please try again.</option>';
                        countySelect.disabled = false;
                    });
            }
            
            // Handle state selection change - use event delegation to prevent duplicate handlers
            $(document).off('change', '#state-filter-select').on('change', '#state-filter-select', function(e) {
                // Prevent automatic triggers during initialization
                if (e.originalEvent && e.originalEvent.isTrusted === false) {
                    console.log('[DEBUG] Blocked programmatic state change event');
                    return;
                }
                
                const stateSelect = $(this);
                const selectedState = stateSelect.val();
                
                // Get the state code - try multiple methods for reliability
                let stateCode = null;
                if (selectedState) {
                    // Method 1: Try to get from the mapping object (most reliable)
                    if (stateCodeMap[selectedState]) {
                        stateCode = stateCodeMap[selectedState];
                        console.log(`[DEBUG] Got state code from mapping: ${stateCode}`);
                    } else {
                        // Method 2: Try to get from the option element's data attribute
                        const actualOption = stateSelect.find('option').filter(function() {
                            return $(this).val() === selectedState;
                        });
                        if (actualOption.length > 0) {
                            // Try both data attribute and jQuery data - prioritize DOM attribute
                            stateCode = actualOption.attr('data-code') || actualOption.data('code');
                            console.log(`[DEBUG] Got state code from option element: ${stateCode}`);
                        }
                    }
                }
                
                console.log(`[DEBUG] State filter changed to: ${selectedState}`);
                console.log(`[DEBUG] State code: ${stateCode}`);
                
                if (!stateCode) {
                    console.error(`[DEBUG] ERROR: No state code found for selected state: ${selectedState}`);
                    alert('Error: Could not determine state code. Please try selecting the state again.');
                    return;
                }
                
                // Only load counties if a state is actually selected AND we have a valid state code
                if (selectedState && selectedState.trim() !== '' && stateCode) {
                    console.log(`[DEBUG] Loading counties for state: ${selectedState} (code: ${stateCode})`);
                    loadCountiesForState(stateCode);
                } else {
                    // Clear counties if state is cleared
                    const countySelect = document.getElementById('county-select');
                    if (countySelect) {
                        countySelect.disabled = true;
                        countySelect.innerHTML = '<option value="">Select a state first...</option>';
                    }
                }
            });
            
            // Load states on page load - only once
            if (!statesLoaded) {
                loadStates();
            }
        });
    </script>
    <!-- Your app.js (after dependencies and progress steps override) -->
    <script>
        // Set flag to tell shared app.js to skip state management for LendSight
        window.LENDSIGHT_MODE = true;
        
        // Override loadCounties BEFORE app.js loads to prevent Select2 initialization
        // This prevents the shared app.js from initializing Select2 on county select
        window.loadCounties = function(stateCode = null) {
            // For LendSight, we use our own loadCountiesForState function
            // This override prevents the shared app.js from initializing Select2
            console.log('[LendSight] loadCounties called but overridden - using loadCountiesForState instead');
            // Do nothing - our custom loadCountiesForState will handle it
        };
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Verify the correct app.js loaded
        setTimeout(function() {
            if (window.APP_JS_VERSION) {
                console.log('[VERIFIED] Correct app.js version loaded:', window.APP_JS_VERSION);
            } else {
                console.error('[ERROR] OLD app.js version detected - window.APP_JS_VERSION is undefined!');
                console.error('[ERROR] This means the cached/old version is being served.');
            }
        }, 100);
    </script>
    <script>
        // Override shared app.js functions for LendSight (single county, no Select2)
        $(document).ready(function() {
            // CRITICAL: Remove the shared app.js form submission handler and state change handler
            // The shared app.js attaches handlers that don't work for LendSight's single-county setup
            $('#analysisForm').off('submit'); // Remove shared app.js form handler
            $('#state-filter-select').off('change'); // Remove shared app.js state change handler
            console.log('[LendSight] Removed shared app.js handlers');
            
            // Re-attach our LendSight-specific form handler
            // Use setTimeout to ensure this runs after shared app.js has finished
            let retryCount = 0;
            const maxRetries = 50; // Wait up to 5 seconds (50 * 100ms)
            
            function attachFormHandler() {
                // Verify required functions are available
                if ((typeof showProgress !== 'function' || typeof disableForm !== 'function' || typeof listenForProgress !== 'function') && retryCount < maxRetries) {
                    retryCount++;
                    setTimeout(attachFormHandler, 100);
                    return;
                }
                
                if (retryCount >= maxRetries) {
                    console.error('[LendSight] Functions not available after waiting, attaching handler anyway');
                }
                
                // Functions are available (or we've given up waiting), attach the handler
                $('#analysisForm').off('submit').on('submit', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Clear all previous validation messages first
                document.querySelectorAll('.validation-message').forEach(msg => msg.remove());
                
                const formData = new FormData(this);
                const selectionType = formData.get('selection_type') || 'county';
                
                // Collect all checked loan purpose checkboxes using jQuery
                const loanPurposeCheckboxes = $('input[name="loan_purpose"]:checked').map(function() {
                    return $(this).val();
                }).get();
                
                // Enhanced validation with helpful messages
                let hasErrors = false;
                
                // Validate loan purpose selection
                if (!loanPurposeCheckboxes || loanPurposeCheckboxes.length === 0) {
                    // Find the first loan purpose card to show error
                    const firstCard = document.querySelector('.loan-purpose-card');
                    if (firstCard) {
                        showValidationMessage(firstCard.querySelector('input[type="checkbox"]'), 'Please select one loan purpose.', 'error');
                    }
                    hasErrors = true;
                }
                
                // State selection is required
                const selectedState = $('#state-filter-select').val();
                const selectedStateOption = $('#state-filter-select').find('option:selected');
                // Get the state FIPS code from the data-code attribute (e.g., "24" for Maryland)
                // Try multiple methods for reliability
                let stateFipsCode = selectedStateOption.attr('data-code');
                if (!stateFipsCode && window.stateCodeMap && window.stateCodeMap[selectedState]) {
                    stateFipsCode = window.stateCodeMap[selectedState];
                }

                // Validate state selection (required)
                if (!selectedState || selectedState.trim() === '') {
                    showValidationMessage(document.getElementById('state-filter-select'), 'Please select a state.', 'error');
                    hasErrors = true;
                }

                // Validate county selection (required, single county)
                const countySelect = document.getElementById('county-select');
                const selectedCounty = countySelect ? countySelect.value : '';
                if (!selectedCounty || selectedCounty === '') {
                    showValidationMessage(countySelect, 'Please select a county to analyze.', 'error');
                    hasErrors = true;
                }

                if (hasErrors) {
                    const firstError = document.querySelector('.validation-message.error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return false;
                }

                // Build request data
                const forceRefresh = document.getElementById('forceRefreshCheckbox')?.checked || false;
                let requestData = {
                    selection_type: 'county',
                    state_code: stateFipsCode || selectedState,  // Use FIPS code (e.g., "24") for Census API, fallback to state name
                    years: '2020,2021,2022,2023,2024',  // Fixed years 2020-2024
                    loan_purpose: loanPurposeCheckboxes.length > 0 ? loanPurposeCheckboxes : ['purchase'],  // Default to purchase only
                    force_refresh: forceRefresh
                };

                console.log(`[LendSight] Form submission - State: ${selectedState}, State FIPS code: ${stateFipsCode}`);
                
                // Single county selection
                requestData.counties = selectedCounty;  // Single county, not array
                
                // Also include counties_data with GEOID5 information for BigQuery queries
                const countiesData = [];
                const selectedOption = countySelect.options[countySelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.county) {
                    try {
                        const countyData = JSON.parse(selectedOption.dataset.county);
                        // Include GEOID5, state_fips, and county_fips for BigQuery
                        countiesData.push({
                            name: countyData.name || selectedCounty,
                            geoid5: countyData.geoid5,
                            state_fips: countyData.state_fips,
                            county_fips: countyData.county_fips
                        });
                    } catch (e) {
                        // Fallback: if parsing fails, just use the name
                        countiesData.push({
                            name: selectedCounty
                        });
                    }
                } else {
                    // Fallback: if no county data, just use the name
                    countiesData.push({
                        name: selectedCounty
                    });
                }
                requestData.counties_data = countiesData;
                
                // Show progress and disable form
                // Use fallback implementations if shared functions aren't available
                if (typeof showProgress === 'function') {
                    showProgress();
                } else {
                    // Fallback: Show progress manually
                    const progressSection = document.getElementById('progressSection');
                    const submitBtn = document.getElementById('submitBtn');
                    if (progressSection) progressSection.style.display = 'block';
                    if (submitBtn) submitBtn.disabled = true;
                    console.log('[LendSight] Using fallback showProgress');
                }
                if (typeof disableForm === 'function') {
                    disableForm();
                } else {
                    // Fallback: Disable form manually
                    const form = document.getElementById('analysisForm');
                    if (form) {
                        const inputs = form.querySelectorAll('input, select, button');
                        inputs.forEach(input => {
                            if (input.id !== 'submitBtn') input.disabled = true;
                        });
                    }
                    console.log('[LendSight] Using fallback disableForm');
                }
                
                try {
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error || 'Analysis failed');
                    }
                    const jobId = result.job_id;

                    // Log analytics event for LendSight report
                    if (window.JustDataAnalytics && window.JustDataAnalytics.logLendSightReport) {
                        window.JustDataAnalytics.logLendSightReport({
                            countyFips: requestData.counties_data && requestData.counties_data[0] ? requestData.counties_data[0].geoid5 : '',
                            state: selectedState,
                            year: '2020-2024',
                            reportType: loanPurposeCheckboxes.join(',') || 'purchase'
                        });
                    }

                    if (typeof listenForProgress === 'function') {
                        listenForProgress(jobId);
                    } else {
                        // Fallback: Redirect to report page
                        console.log('[LendSight] Using fallback - redirecting to report page');
                        window.location.href = `/?job_id=${jobId}`;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    if (typeof showError === 'function') {
                        showError(error.message || 'Network error. Please check your connection and try again.');
                    } else {
                        alert('Error: ' + (error.message || 'Network error. Please check your connection and try again.'));
                    }
                    // Fallback: Hide progress and enable form manually
                    if (typeof hideProgress === 'function') {
                        hideProgress();
                    } else {
                        const progressSection = document.getElementById('progressSection');
                        if (progressSection) progressSection.style.display = 'none';
                    }
                    if (typeof enableForm === 'function') {
                        enableForm();
                    } else {
                        const form = document.getElementById('analysisForm');
                        if (form) {
                            const inputs = form.querySelectorAll('input, select, button');
                            inputs.forEach(input => input.disabled = false);
                        }
                    }
                }
                
                return false;
                });
                console.log('[LendSight] Attached LendSight-specific form handler');
            }
            
            // Start trying to attach the handler
            setTimeout(attachFormHandler, 100);
            
            // Also attach a click handler to the submit button as a fallback
            $('#submitBtn').off('click').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('[LendSight] Submit button clicked - triggering form submit');
                $('#analysisForm').trigger('submit');
                return false;
            });
            
            // Make sure Select2 is NOT initialized on county select
            // Destroy any existing Select2 instance immediately
            const countySelectElForLendSight = document.getElementById('county-select');
            if (countySelectElForLendSight) {
                const $countySelect = $('#county-select');
                // Destroy Select2 if it exists
                if ($countySelect.hasClass('select2-hidden-accessible')) {
                    console.log('[LendSight] Destroying Select2 on county select');
                    $countySelect.select2('destroy');
                }
                // Remove multiple attribute if it exists
                countySelectElForLendSight.removeAttribute('multiple');
                // Ensure it's a plain select
                if (countySelectElForLendSight.hasAttribute('multiple')) {
                    countySelectElForLendSight.removeAttribute('multiple');
                }
            }
            
            // Override the validateInput function to handle single county selection
            const originalValidateInput = window.validateInput;
            window.validateInput = function(input, type) {
                // Override county-select validation for single county (LendSight)
                if (type === 'county-select') {
                    const countySelect = document.getElementById('county-select');
                    if (!countySelect) return true;
                    
                    // Get value directly from DOM element (plain select returns string, not array)
                    const selectedCounty = countySelect.value;
                    
                    // Hide any existing validation messages first
                    if (typeof hideValidationMessage === 'function') {
                        hideValidationMessage(countySelect);
                    }
                    
                    if (!selectedCounty || selectedCounty === '') {
                        showValidationMessage(countySelect, 'Please select a county to analyze.', 'error');
                        countySelect.setCustomValidity('Please select a county.');
                        return false;
                    } else {
                        countySelect.setCustomValidity('');
                        // Don't show any message for single county - just clear errors
                        return true;
                    }
                }
                // For other types, use original validation
                if (originalValidateInput) {
                    return originalValidateInput.call(this, input, type);
                }
                return true;
            };
            
            // Remove any existing change handlers from shared app.js and add our own
            $('#county-select').off('change').on('change', function() {
                validateInput(this, 'county-select');
            });
            
            // Monitor for any Select2 initialization attempts and destroy them
            const observer = new MutationObserver(function(mutations) {
                const $countySelect = $('#county-select');
                if ($countySelect.hasClass('select2-hidden-accessible')) {
                    console.log('[LendSight] Select2 detected on county select - destroying it');
                    $countySelect.select2('destroy');
                    const countySelectEl = document.getElementById('county-select');
                    if (countySelectEl) {
                        countySelectEl.removeAttribute('multiple');
                    }
                }
            });
            
            if (countySelectElForLendSight) {
                observer.observe(countySelectElForLendSight, {
                    attributes: true,
                    attributeFilter: ['class']
                });
            }
        });
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics-compat.js"></script>

    <!-- JustData Auth -->
    <script src="/static/js/auth.js"></script>

    <!-- JustData Analytics Event Logging -->
    <script src="/static/js/analytics-events.js"></script>

    {% include 'shared_header_js.html' %}
</body>
</html>

