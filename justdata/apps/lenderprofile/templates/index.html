{% extends "base_app.html" %}

{% set app_name = "LenderProfile" %}
{% set app_name_part1 = "LENDER" %}
{% set app_name_part2 = "PROFILE" %}
{% set app_description = "Comprehensive lender intelligence platform" %}

{% block title %}LenderProfile - NCRC Intelligence Tool{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        max-width: 800px;
        margin: 60px auto;
        padding: 0 20px;
    }
    
    .description-card {
        background: white;
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .description-card p {
        font-size: 16px;
        line-height: 1.7;
        color: #333;
        margin: 0;
    }
    
    .search-card {
        background: white;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .search-form {
        display: flex;
        gap: 10px;
    }
    
    .search-input {
        flex: 1;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        font-family: 'Inter', sans-serif;
        transition: border-color 0.2s;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #1a8fc9;
    }

    .search-btn {
        padding: 14px 32px;
        background: #1a8fc9;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .search-btn:hover {
        background: #1580b5;
    }
    
    .search-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .error-message {
        margin-top: 20px;
        padding: 12px 16px;
        background: #fee;
        border: 1px solid #fcc;
        border-radius: 8px;
        color: #c33;
        display: none;
    }
    
    .error-message.show {
        display: block;
    }
    
    .candidates-list {
        margin-top: 20px;
        display: none;
    }
    
    .candidates-list.show {
        display: block;
    }
    
    .candidate-item {
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .candidate-item:hover {
        border-color: #1a8fc9;
        background: #f8f9fa;
    }

    .candidate-item.selected {
        border-color: #1a8fc9;
        background: #e6f4fa;
    }

    .candidate-name {
        font-weight: 600;
        color: #1a8fc9;
        margin-bottom: 4px;
    }
    
    .candidate-location {
        color: #666;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Description -->
    <div class="description-card">
        <p>
            LenderProfile is an intelligence tool for NCRC staff that generates comprehensive reports on financial institutions. 
            Each report includes corporate structure, financial performance, regulatory compliance history, branch network analysis, 
            SEC filings analysis, analyst ratings, and strategic positioning. Reports are generated using data from multiple sources 
            including FDIC, SEC, GLEIF, and other regulatory databases, and include AI-generated insights and visualizations.
        </p>
    </div>

    <!-- Search -->
    <div class="search-card">
        <form id="search-form" class="search-form">
            <input 
                type="text" 
                id="company-name" 
                class="search-input"
                placeholder="Enter company name (e.g., Fifth Third Bank, JPMorgan Chase)"
                autocomplete="off"
                required
            >
            <button type="submit" class="search-btn" id="search-btn">
                <i class="fas fa-search"></i> Search
            </button>
        </form>
        
        <div id="error-message" class="error-message"></div>
        
        <div id="candidates-list" class="candidates-list">
            <h3 style="margin: 20px 0 10px 0; color: #333;">Select the correct institution:</h3>
            <div id="candidates-container"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const searchForm = document.getElementById('search-form');
    const companyInput = document.getElementById('company-name');
    const searchBtn = document.getElementById('search-btn');
    const errorMessage = document.getElementById('error-message');
    const candidatesList = document.getElementById('candidates-list');
    const candidatesContainer = document.getElementById('candidates-container');
    
    let selectedCandidate = null;
    
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const companyName = companyInput.value.trim();
        if (!companyName) return;
        
        // Reset UI
        errorMessage.classList.remove('show');
        candidatesList.classList.remove('show');
        candidatesContainer.innerHTML = '';
        selectedCandidate = null;
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        
        try {
            const response = await fetch('/lenderprofile/api/search-lender', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: companyName,
                    exclude: []
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || data.message || 'Search failed');
            }
            
            if (data.multiple && data.candidates) {
                // Show candidates for selection
                displayCandidates(data.candidates);
            } else if (data.success) {
                // Single result - proceed directly
                generateReport(data);
            } else {
                throw new Error('No results found');
            }
        } catch (error) {
            errorMessage.textContent = error.message || 'An error occurred. Please try again.';
            errorMessage.classList.add('show');
        } finally {
            searchBtn.disabled = false;
            searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
        }
    });
    
    function displayCandidates(candidates) {
        candidatesContainer.innerHTML = '';
        
        candidates.forEach(candidate => {
            const item = document.createElement('div');
            item.className = 'candidate-item';
            item.innerHTML = `
                <div class="candidate-name">${candidate.name}</div>
                <div class="candidate-location">${candidate.location || 'Location unknown'}</div>
            `;
            
            item.addEventListener('click', () => {
                // Remove previous selection
                document.querySelectorAll('.candidate-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                selectedCandidate = candidate;
                
                // Generate report after short delay
                setTimeout(() => {
                    generateReport({
                        success: true,
                        name: candidate.name,
                        identifiers: {
                            lei: candidate.lei,
                            rssd_id: candidate.rssd_id,
                            fdic_cert: candidate.fdic_cert
                        }
                    });
                }, 300);
            });
            
            candidatesContainer.appendChild(item);
        });
        
        candidatesList.classList.add('show');
    }
    
    function generateReport(lenderData) {
        // Redirect to report generation with progress tracking
        const reportFocus = ''; // Can add optional focus field later
        
        fetch('/lenderprofile/api/generate-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: lenderData.name,
                identifiers: lenderData.identifiers || {},
                report_focus: reportFocus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.report_id) {
                // Redirect to progress page
                window.location.href = `/lenderprofile/report/${data.report_id}`;
            } else {
                throw new Error(data.error || 'Failed to generate report');
            }
        })
        .catch(error => {
            errorMessage.textContent = error.message || 'Failed to generate report. Please try again.';
            errorMessage.classList.add('show');
        });
    }
</script>
{% endblock %}
