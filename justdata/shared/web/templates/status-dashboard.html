<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status - User Analytics Dashboard | JustData</title>
    <meta name="description" content="Analytics dashboard for monitoring user activity and application usage across JustData platform">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* NCRC Brand Colors */
        :root {
            --ncrc-primary-blue: #552d87;
            --ncrc-secondary-blue: #2fade3;
            --ncrc-accent-red: #e82e2e;
            --ncrc-pink: #eb2f89;
            --ncrc-dark-blue: #034ea0;
            --ncrc-light-blue: #E6F2FF;
            --ncrc-gold: #ffc23a;
            --ncrc-gray: #818390;
            --ncrc-white: #FFFFFF;
            --ncrc-black: #000000;
            --ncrc-gray-light: #F5F5F5;
            --ncrc-gray-dark: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--ncrc-gray-light);
            min-height: 100vh;
            color: var(--ncrc-gray-dark);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--ncrc-dark-blue);
            padding: 20px 30px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-role-badge {
            background: var(--ncrc-gold);
            color: var(--ncrc-black);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Main Container */
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--ncrc-gray);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ncrc-primary-blue);
        }

        .stat-card .stat-change {
            font-size: 0.85rem;
            color: #28a745;
            margin-top: 5px;
        }

        /* Dashboard Layout */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        /* Map Section */
        .map-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .map-header {
            padding: 20px;
            border-bottom: 2px solid var(--ncrc-light-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-header h2 {
            font-size: 1.3rem;
            color: var(--ncrc-primary-blue);
            margin: 0;
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-control-btn {
            background: var(--ncrc-light-blue);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .map-control-btn:hover {
            background: var(--ncrc-secondary-blue);
            color: white;
        }

        .map-control-btn.active {
            background: var(--ncrc-primary-blue);
            color: white;
        }

        #userMap {
            width: 100%;
            height: 600px;
        }

        /* Sidebar */
        .sidebar-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .panel-card h3 {
            font-size: 1.1rem;
            color: var(--ncrc-primary-blue);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--ncrc-light-blue);
        }

        /* User List */
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .user-item:hover {
            background: var(--ncrc-light-blue);
        }

        .user-item.active {
            background: var(--ncrc-light-blue);
            border-left: 4px solid var(--ncrc-primary-blue);
        }

        .user-name {
            font-weight: 600;
            color: var(--ncrc-dark-blue);
            margin-bottom: 4px;
        }

        .user-org {
            font-size: 0.85rem;
            color: var(--ncrc-gray);
            margin-bottom: 4px;
        }

        .user-location {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
        }

        .user-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .badge-public { background: #e3f2fd; color: #1976d2; }
        .badge-member { background: #e8f5e9; color: #388e3c; }
        .badge-partner { background: #fff3e0; color: #f57c00; }
        .badge-staff { background: #f3e5f5; color: #7b1fa2; }
        .badge-developer { background: #fce4ec; color: #c2185b; }

        /* User Detail Modal */
        .user-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .user-detail-modal.active {
            display: flex;
        }

        .user-detail-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--ncrc-light-blue);
        }

        .user-detail-header h2 {
            color: var(--ncrc-primary-blue);
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--ncrc-gray);
            cursor: pointer;
            padding: 5px 10px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            font-size: 0.9rem;
            color: var(--ncrc-gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-section p {
            margin: 5px 0;
            color: var(--ncrc-gray-dark);
        }

        .detail-section strong {
            color: var(--ncrc-dark-blue);
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 10px;
            border-left: 3px solid var(--ncrc-primary-blue);
            background: var(--ncrc-light-blue);
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--ncrc-gray);
        }

        /* Filter Section */
        .filter-section {
            margin-bottom: 15px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--ncrc-gray);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            #userMap {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="{{ landing_url or url_for('landing') }}" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    Back to Applications
                </a>
                <div>
                    <h1 class="header-title">Status Dashboard</h1>
                    <span class="user-role-badge" id="userRole">Developer Access</span>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="stat-value">1,247</div>
                <div class="stat-change">+12% this month</div>
            </div>
            <div class="stat-card">
                <h3>Active Today</h3>
                <div class="stat-value">89</div>
                <div class="stat-change">+5 from yesterday</div>
            </div>
            <div class="stat-card">
                <h3>Reports Generated</h3>
                <div class="stat-value">3,421</div>
                <div class="stat-change">+234 this week</div>
            </div>
            <div class="stat-card">
                <h3>Most Used App</h3>
                <div class="stat-value" style="font-size: 1.5rem;">LendSight</div>
                <div class="stat-change">1,892 uses</div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-layout">
            <!-- Map Section -->
            <div class="map-section">
                <div class="map-header">
                    <h2><i class="fas fa-map-marked-alt"></i> User Activity Map</h2>
                    <div class="map-controls">
                        <button class="map-control-btn active" onclick="setMapView('all')">All Users</button>
                        <button class="map-control-btn" onclick="setMapView('active')">Active Now</button>
                        <button class="map-control-btn" onclick="setMapView('today')">Today</button>
                    </div>
                </div>
                <div id="userMap"></div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar-panel">
                <!-- Filters -->
                <div class="panel-card">
                    <h3><i class="fas fa-filter"></i> Filters</h3>
                    <div class="filter-section">
                        <div class="filter-group">
                            <label>User Type</label>
                            <select id="filterUserType" onchange="applyFilters()">
                                <option value="all">All Types</option>
                                <option value="public">Public</option>
                                <option value="member">NCRC Member</option>
                                <option value="partner">NCRC Partner</option>
                                <option value="staff">NCRC Staff</option>
                                <option value="developer">NCRC Developer</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Application</label>
                            <select id="filterApp" onchange="applyFilters()">
                                <option value="all">All Applications</option>
                                <option value="lendsight">LendSight</option>
                                <option value="branchsight">BranchSight</option>
                                <option value="branchmapper">BranchMapper</option>
                                <option value="bizsight">BizSight</option>
                                <option value="mergermeter">MergerMeter</option>
                                <option value="memberview">MemberView</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <select id="filterDateRange" onchange="applyFilters()">
                                <option value="today">Today</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- User List -->
                <div class="panel-card">
                    <h3><i class="fas fa-users"></i> Recent Users</h3>
                    <div class="user-list" id="userList">
                        <!-- Users will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="user-detail-modal" id="userDetailModal">
        <div class="user-detail-content">
            <div class="user-detail-header">
                <h2 id="modalUserName">User Details</h2>
                <button class="close-btn" onclick="closeUserDetail()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="userDetailContent">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Mock user data
        const mockUsers = [
            {
                id: 1,
                name: "Sarah Johnson",
                email: "sarah.johnson@example.org",
                organization: "Community Housing Alliance",
                userType: "member",
                location: { lat: 38.9072, lng: -77.0369, city: "Washington, DC" },
                ipAddress: "192.168.1.45",
                lastActive: "2025-01-27T14:30:00",
                appsUsed: ["LendSight", "BranchSight"],
                totalReports: 23,
                activity: [
                    { app: "LendSight", action: "Generated report", time: "2025-01-27T14:30:00", location: "Montgomery County, MD" },
                    { app: "BranchSight", action: "Analyzed branches", time: "2025-01-27T10:15:00", location: "Washington, DC" }
                ]
            },
            {
                id: 2,
                name: "Michael Chen",
                email: "mchen@bankcorp.com",
                organization: "First National Bank",
                userType: "partner",
                location: { lat: 40.7128, lng: -74.0060, city: "New York, NY" },
                ipAddress: "203.0.113.12",
                lastActive: "2025-01-27T15:45:00",
                appsUsed: ["LendSight", "BranchMapper", "BizSight"],
                totalReports: 67,
                activity: [
                    { app: "BizSight", action: "Exported data", time: "2025-01-27T15:45:00", location: "New York County, NY" },
                    { app: "LendSight", action: "Generated report", time: "2025-01-27T13:20:00", location: "Queens County, NY" }
                ]
            },
            {
                id: 3,
                name: "Emily Rodriguez",
                email: "emily.rodriguez@ncrc.org",
                organization: "NCRC",
                userType: "staff",
                location: { lat: 38.9072, lng: -77.0369, city: "Washington, DC" },
                ipAddress: "10.0.0.42",
                lastActive: "2025-01-27T16:00:00",
                appsUsed: ["MergerMeter", "MemberView", "LendSight"],
                totalReports: 145,
                activity: [
                    { app: "MergerMeter", action: "Analyzed merger", time: "2025-01-27T16:00:00", location: "Cook County, IL" },
                    { app: "MemberView", action: "Viewed member data", time: "2025-01-27T14:00:00", location: "N/A" }
                ]
            },
            {
                id: 4,
                name: "David Thompson",
                email: "david.thompson@publicuser.com",
                organization: null,
                userType: "public",
                location: { lat: 34.0522, lng: -118.2437, city: "Los Angeles, CA" },
                ipAddress: "198.51.100.23",
                lastActive: "2025-01-27T12:30:00",
                appsUsed: ["LendSight"],
                totalReports: 3,
                activity: [
                    { app: "LendSight", action: "Generated report", time: "2025-01-27T12:30:00", location: "Los Angeles County, CA" }
                ]
            },
            {
                id: 5,
                name: "Jennifer Martinez",
                email: "j.martinez@housingadvocacy.org",
                organization: "Housing Advocacy Network",
                userType: "member",
                location: { lat: 41.8781, lng: -87.6298, city: "Chicago, IL" },
                ipAddress: "203.0.113.45",
                lastActive: "2025-01-27T11:15:00",
                appsUsed: ["LendSight", "BranchSight", "BranchMapper"],
                totalReports: 42,
                activity: [
                    { app: "BranchMapper", action: "Viewed map", time: "2025-01-27T11:15:00", location: "Cook County, IL" },
                    { app: "BranchSight", action: "Exported data", time: "2025-01-27T09:00:00", location: "Cook County, IL" }
                ]
            },
            {
                id: 6,
                name: "Robert Kim",
                email: "rkim@communitybank.com",
                organization: "Community First Bank",
                userType: "partner",
                location: { lat: 37.7749, lng: -122.4194, city: "San Francisco, CA" },
                ipAddress: "198.51.100.67",
                lastActive: "2025-01-27T13:45:00",
                appsUsed: ["LendSight", "BizSight"],
                totalReports: 89,
                activity: [
                    { app: "BizSight", action: "Generated report", time: "2025-01-27T13:45:00", location: "San Francisco County, CA" }
                ]
            },
            {
                id: 7,
                name: "Lisa Anderson",
                email: "lisa.anderson@ncrc.org",
                organization: "NCRC",
                userType: "developer",
                location: { lat: 38.9072, lng: -77.0369, city: "Washington, DC" },
                ipAddress: "10.0.0.15",
                lastActive: "2025-01-27T16:30:00",
                appsUsed: ["Status", "MergerMeter", "MemberView"],
                totalReports: 0,
                activity: [
                    { app: "Status", action: "Viewed analytics", time: "2025-01-27T16:30:00", location: "N/A" }
                ]
            }
        ];

        let map;
        let markers = [];
        let currentUserRole = 'developer'; // Change to 'staff' to see limited access

        // Initialize map
        function initMap() {
            map = L.map('userMap').setView([39.8283, -98.5795], 4);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Add user markers
            updateMapMarkers();
        }

        // Update map markers based on filters
        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const filteredUsers = getFilteredUsers();

            filteredUsers.forEach(user => {
                const marker = L.circleMarker([user.location.lat, user.location.lng], {
                    radius: 8,
                    fillColor: getUserTypeColor(user.userType),
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${user.name}</strong><br>
                    ${user.organization || 'Individual'}<br>
                    <small>${user.location.city}</small>
                `);

                marker.on('click', () => showUserDetail(user));
                markers.push(marker);
            });

            // Fit map to show all markers
            if (filteredUsers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Get color for user type
        function getUserTypeColor(userType) {
            const colors = {
                'public': '#1976d2',
                'member': '#388e3c',
                'partner': '#f57c00',
                'staff': '#7b1fa2',
                'developer': '#c2185b'
            };
            return colors[userType] || '#666';
        }

        // Get filtered users
        function getFilteredUsers() {
            const userTypeFilter = document.getElementById('filterUserType').value;
            const appFilter = document.getElementById('filterApp').value;
            
            return mockUsers.filter(user => {
                if (userTypeFilter !== 'all' && user.userType !== userTypeFilter) return false;
                if (appFilter !== 'all' && !user.appsUsed.some(app => app.toLowerCase() === appFilter)) return false;
                return true;
            });
        }

        // Apply filters
        function applyFilters() {
            updateMapMarkers();
            updateUserList();
        }

        // Update user list
        function updateUserList() {
            const userList = document.getElementById('userList');
            const filteredUsers = getFilteredUsers();
            
            userList.innerHTML = filteredUsers.map(user => `
                <div class="user-item" onclick="showUserDetail(${user.id})">
                    <div class="user-name">${user.name}</div>
                    <div class="user-org">${user.organization || 'Individual User'}</div>
                    <div class="user-location">${user.location.city}</div>
                    <span class="user-type-badge badge-${user.userType}">${getUserTypeLabel(user.userType)}</span>
                </div>
            `).join('');
        }

        // Get user type label
        function getUserTypeLabel(userType) {
            const labels = {
                'public': 'Public',
                'member': 'Member',
                'partner': 'Partner',
                'staff': 'Staff',
                'developer': 'Developer'
            };
            return labels[userType] || userType;
        }

        // Show user detail
        function showUserDetail(userOrId) {
            const user = typeof userOrId === 'number' 
                ? mockUsers.find(u => u.id === userOrId)
                : userOrId;
            
            if (!user) return;

            document.getElementById('modalUserName').textContent = user.name;
            
            const isDeveloper = currentUserRole === 'developer';
            const content = `
                <div class="detail-section">
                    <h3>Contact Information</h3>
                    <p><strong>Email:</strong> ${user.email}</p>
                    ${user.organization ? `<p><strong>Organization:</strong> ${user.organization}</p>` : ''}
                    <p><strong>User Type:</strong> <span class="user-type-badge badge-${user.userType}">${getUserTypeLabel(user.userType)}</span></p>
                </div>

                <div class="detail-section">
                    <h3>Location</h3>
                    <p><strong>City:</strong> ${user.location.city}</p>
                    <p><strong>Coordinates:</strong> ${user.location.lat.toFixed(4)}, ${user.location.lng.toFixed(4)}</p>
                    ${isDeveloper ? `<p><strong>IP Address:</strong> ${user.ipAddress}</p>` : ''}
                </div>

                <div class="detail-section">
                    <h3>Activity Summary</h3>
                    <p><strong>Last Active:</strong> ${new Date(user.lastActive).toLocaleString()}</p>
                    <p><strong>Applications Used:</strong> ${user.appsUsed.join(', ')}</p>
                    <p><strong>Total Reports Generated:</strong> ${user.totalReports}</p>
                </div>

                <div class="detail-section">
                    <h3>Recent Activity</h3>
                    <ul class="activity-list">
                        ${user.activity.map(act => `
                            <li class="activity-item">
                                <strong>${act.app}</strong> - ${act.action}<br>
                                <span class="activity-time">${new Date(act.time).toLocaleString()}</span><br>
                                ${act.location !== 'N/A' ? `<small>Location: ${act.location}</small>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;

            document.getElementById('userDetailContent').innerHTML = content;
            document.getElementById('userDetailModal').classList.add('active');
        }

        // Close user detail
        function closeUserDetail() {
            document.getElementById('userDetailModal').classList.remove('active');
        }

        // Set map view
        function setMapView(view) {
            document.querySelectorAll('.map-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            // In real implementation, filter by view type
            updateMapMarkers();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            updateUserList();
            
            // Set user role (for testing - in real app, get from session)
            if (currentUserRole === 'staff') {
                document.getElementById('userRole').textContent = 'Staff Access (Limited)';
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeUserDetail();
            }
        });

        // Close modal when clicking outside
        document.getElementById('userDetailModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeUserDetail();
            }
        });
    </script>
</body>
</html>

