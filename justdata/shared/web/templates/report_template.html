<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BranchSeeker - Analysis Report</title>
    <meta name="description" content="FDIC Bank Branch Analysis Report - Comprehensive banking market intelligence">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="BranchSeeker - Analysis Report">
    <meta property="og:description" content="Comprehensive FDIC bank branch analysis report">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        /* Print-specific styles */
        @media print {
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            body { font-size: 12px; }
            .report-section { margin-bottom: 20px; }
            .data-table { font-size: 10px; }
        }
        
        /* Report-specific styles */
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .report-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        
        .report-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .report-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
            font-size: 0.9rem;
            color: #666;
            text-align: left;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }
        
        .action-btn.primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .action-btn.primary:hover {
            background: #0056b3;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
        }
        
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
            color: #333;
        }
        
        .ai-insights {
            display: grid;
            gap: 20px;
        }
        
        .ai-insight-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: box-shadow 0.2s ease;
        }
        
        .ai-insight-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .ai-insight-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-insight-card h3 i {
            color: #007bff;
        }
        
        .ai-content {
            line-height: 1.6;
            color: #555;
        }
        
        .ai-content p {
            margin: 0 0 15px 0;
        }
        
        .ai-content p:last-child {
            margin-bottom: 0;
        }
        
        .report-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            padding-bottom: 5px;
        }
        
        .table-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
            font-style: italic;
        }
        
        .table-source {
            font-size: 0.75rem;
            color: #888;
            margin-top: 8px;
            font-style: normal;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .summary-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #007bff;
            margin: 0 0 10px 0;
        }
        
        .summary-card p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .table-container {
            position: relative;
        }
        
        .table-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        
        .collapse-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collapse-btn:hover {
            background: #e9ecef;
            border-color: #999;
        }
        
        .collapse-btn i {
            transition: transform 0.2s ease;
        }
        
        .collapse-btn.collapsed i {
            transform: rotate(-90deg);
        }
        
        .collapsible-table {
            transition: all 0.3s ease;
        }
        
        .collapsible-table.collapsed {
            position: relative;
        }
        
        .collapsible-table.collapsed tbody {
            position: relative;
        }
        
        .collapsible-table.collapsed tbody::after {
            content: '... more rows available';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(255,255,255,0.9), white);
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
        }
        
        .collapsible-table.collapsed tbody tr:nth-child(n+4) {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 20px;
            transition: background 0.2s ease;
        }
        
        .back-btn:hover {
            background: #545b62;
            color: white;
        }
        
        @media (max-width: 768px) {
            .report-container {
                padding: 10px;
            }
            
            .report-title {
                font-size: 2rem;
            }
            
            .report-meta {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .data-table {
                font-size: 0.8rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <!-- Back Button -->
        <a href="/" class="back-btn no-print">
            <i class="fas fa-arrow-left"></i>
            Back to Analysis
        </a>
        
        <!-- Report Header -->
        <div class="report-header">
            <h1 class="report-title">Bank Branch Analysis</h1>
            <p class="report-subtitle">Comprehensive Banking Market Intelligence</p>
            <div class="report-meta">
                <div>
                    <strong>Generated:</strong> <span id="generatedAt">Loading...</span><br>
                    <strong>Counties:</strong> <span id="counties">Loading...</span><br>
                    <strong>Years:</strong> <span id="years">Loading...</span><br>
                    <strong>Total Records:</strong> <span id="totalRecords">Loading...</span>
                </div>
                <div class="report-actions no-print">
                    <button class="action-btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <div class="dropdown">
                        <button class="action-btn primary dropdown-toggle">
                            <i class="fas fa-download"></i> Export Data
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/download?format=excel" class="dropdown-item">
                                <i class="fas fa-file-excel"></i> Excel (.xlsx)
                            </a>
                            <a href="/download?format=csv" class="dropdown-item">
                                <i class="fas fa-file-csv"></i> CSV (.csv)
                            </a>
                            <a href="/download?format=json" class="dropdown-item">
                                <i class="fas fa-file-code"></i> JSON (.json)
                            </a>
                            <a href="/download?format=zip" class="dropdown-item">
                                <i class="fas fa-file-archive"></i> ZIP (.zip)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading report data...</p>
        </div>
        
        <!-- Error State -->
        <div id="errorState" class="error" style="display: none;">
            <h3><i class="fas fa-exclamation-triangle"></i> Error Loading Report</h3>
            <p id="errorMessage"></p>
        </div>
        
        <!-- Report Content -->
        <div id="reportContent" style="display: none;">
            <!-- Latest Statistics Section -->
            <div class="report-section">
                <h2 class="section-title" id="latestStatsTitle">Latest Statistics</h2>
                <div class="summary-cards" id="summaryCards">
                    <!-- Summary cards will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- AI Executive Summary -->
            <div class="report-section print-break" id="aiExecutiveSummarySection" style="display: none;">
                <h2 class="section-title">Executive Summary</h2>
                <div class="ai-insight-card">
                    <div class="ai-content" id="executiveSummaryContent">
                        <!-- AI content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Table 1: Summary -->
            <div class="report-section print-break">
                <h3 class="table-title">Table 1: Yearly Breakdown</h3>
                <p class="table-description">Comprehensive overview of branch data across counties and years, including LMI and majority-minority percentages.</p>
                <p class="table-source"><strong>Source:</strong> FDIC Summary of Deposits</p>
                <div class="table-container">
                    <table class="data-table" id="summaryTable">
                        <thead>
                            <tr>
                                <th style="text-align: center;">County</th>
                                <th style="text-align: center;">Year</th>
                                <th style="text-align: center;">Total Branches</th>
                                <th style="text-align: center;">LMI Branches</th>
                                <th style="text-align: center;">Minority Branches</th>
                                <th style="text-align: center;">Number of Banks</th>
                                <th style="text-align: center;">LMI %</th>
                                <th style="text-align: center;">Minority %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- AI Key Findings -->
            <div class="report-section print-break" id="aiKeyFindingsSection" style="display: none;">
                <h2 class="section-title">Key Findings</h2>
                <div class="ai-insight-card">
                    <div class="ai-content" id="keyFindingsContent">
                        <!-- AI content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Table 2: Bank Analysis -->
            <div class="report-section print-break">
                <h3 class="table-title">Table 2: Analysis by Bank</h3>
                <p class="table-description">Detailed breakdown of branches by individual banks.</p>
                <p class="table-source"><strong>Source:</strong> FDIC Summary of Deposits</p>
                <div class="table-container">
                    <div class="table-header">
                        <button class="collapse-btn" onclick="toggleTable('bankTable')">
                            <i class="fas fa-chevron-down"></i> Show/Hide Table
                        </button>
                    </div>
                    <table class="data-table collapsible-table" id="bankTable">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Bank Name</th>
                                <th style="text-align: center;">County</th>
                                <th style="text-align: center;">Year</th>
                                <th style="text-align: center;">Total Branches</th>
                                <th style="text-align: center;">LMI Branches</th>
                                <th style="text-align: center;">Minority Branches</th>
                                <th style="text-align: center;">LMI %</th>
                                <th style="text-align: center;">Minority %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- AI Bank Strategies -->
            <div class="report-section print-break" id="aiBankStrategiesSection" style="display: none;">
                <h2 class="section-title">Bank Strategies Analysis</h2>
                <div class="ai-insight-card">
                    <div class="ai-content" id="bankStrategiesContent">
                        <!-- AI content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Table 3: County Analysis -->
            <div class="report-section print-break">
                <h3 class="table-title">Table 3: Analysis by County</h3>
                <p class="table-description">Geographic distribution of bank branches, highlighting locations existing in LMI and/or majority-minority communities.</p>
                <p class="table-source"><strong>Source:</strong> FDIC Summary of Deposits</p>
                <div class="table-container">
                    <table class="data-table" id="countyTable">
                        <thead>
                            <tr>
                                <th style="text-align: center;">County</th>
                                <th style="text-align: center;">Year</th>
                                <th style="text-align: center;">Total Branches</th>
                                <th style="text-align: center;">LMI Branches</th>
                                <th style="text-align: center;">Minority Branches</th>
                                <th style="text-align: center;">Number of Banks</th>
                                <th style="text-align: center;">LMI %</th>
                                <th style="text-align: center;">Minority %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- AI Community Impact -->
            <div class="report-section print-break" id="aiCommunityImpactSection" style="display: none;">
                <h2 class="section-title">Community Impact Analysis</h2>
                <div class="ai-insight-card">
                    <div class="ai-content" id="communityImpactContent">
                        <!-- AI content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Table 4: Trends Analysis -->
            <div class="report-section print-break" id="trendsSection" style="display: none;">
                <h3 class="table-title">Table 4: Year-over-Year Trends</h3>
                <p class="table-description">Temporal analysis showing growth patterns, market changes, and strategic shifts in branch operations over time.</p>
                <p class="table-source"><strong>Source:</strong> FDIC Summary of Deposits</p>
                <div class="table-container">
                    <div class="table-header">
                        <button class="collapse-btn" onclick="toggleTable('trendsTable')">
                            <i class="fas fa-chevron-down"></i> Show/Hide Table
                        </button>
                    </div>
                    <table class="data-table collapsible-table" id="trendsTable">
                        <thead>
                            <tr>
                                <th style="text-align: center;">Year</th>
                                <th style="text-align: center;">Total Branches</th>
                                <th style="text-align: center;">LMI Branches</th>
                                <th style="text-align: center;">Minority Branches</th>
                                <th style="text-align: center;">Number of Banks</th>
                                <th style="text-align: center;">Total Branches YoY %</th>
                                <th style="text-align: center;">LMI Branches YoY %</th>
                                <th style="text-align: center;">Minority Branches YoY %</th>
                                <th style="text-align: center;">LMI %</th>
                                <th style="text-align: center;">Minority %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- AI Trends Analysis -->
            <div class="report-section print-break" id="aiTrendsAnalysisSection" style="display: none;">
                <h2 class="section-title">Trends Analysis</h2>
                <div class="ai-insight-card">
                    <div class="ai-content" id="trendsAnalysisContent">
                        <!-- AI content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Load and display report data
        async function loadReportData() {
            try {
                const response = await fetch('/report-data');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load report data');
                }
                
                displayReport(result.data, result.metadata);
                
            } catch (error) {
                console.error('Error loading report:', error);
                showError(error.message);
            }
        }
        
        function displayReport(data, metadata) {
            // Hide loading state
            document.getElementById('loadingState').style.display = 'none';
            
            // Show report content
            document.getElementById('reportContent').style.display = 'block';
            
            // Update metadata
            document.getElementById('generatedAt').textContent = 
                new Date(metadata.generated_at).toLocaleString();
            document.getElementById('counties').textContent = metadata.counties.join(', ');
            document.getElementById('years').textContent = metadata.years.join(', ');
            document.getElementById('totalRecords').textContent = metadata.total_records.toLocaleString();
            
            // Populate summary cards using raw_data to ensure unique branch counts by uninumbr
            populateSummaryCards(data.raw_data);
            
            // Populate AI insights if available
            if (metadata.ai_insights) {
                populateAIInsights(metadata.ai_insights);
            }
            
            // Populate tables
            populateTable('summaryTable', data.summary);
            populateTable('bankTable', data.by_bank);
            populateTable('countyTable', data.by_county);
            
            // Show trends if available
            if (data.trends && data.trends.length > 0) {
                document.getElementById('trendsSection').style.display = 'block';
                populateTable('trendsTable', data.trends);
            }
        }
        
        function populateAIInsights(aiInsights) {
            if (!aiInsights) return;
            
            // Populate each AI insight section individually
            if (aiInsights.executive_summary) {
                const content = aiInsights.executive_summary;
                const element = document.getElementById('executiveSummaryContent');
                if (element) {
                    element.innerHTML = formatMarkdownContent(content);
                    document.getElementById('aiExecutiveSummarySection').style.display = 'block';
                }
            }
            
            if (aiInsights.key_findings) {
                const content = aiInsights.key_findings;
                const element = document.getElementById('keyFindingsContent');
                if (element) {
                    element.innerHTML = formatMarkdownContent(content);
                    document.getElementById('aiKeyFindingsSection').style.display = 'block';
                }
            }
            
            if (aiInsights.bank_strategies) {
                const content = aiInsights.bank_strategies;
                const element = document.getElementById('bankStrategiesContent');
                if (element) {
                    element.innerHTML = formatMarkdownContent(content);
                    document.getElementById('aiBankStrategiesSection').style.display = 'block';
                }
            }
            
            if (aiInsights.community_impact) {
                const content = aiInsights.community_impact;
                const element = document.getElementById('communityImpactContent');
                if (element) {
                    element.innerHTML = formatMarkdownContent(content);
                    document.getElementById('aiCommunityImpactSection').style.display = 'block';
                }
            }
            
            if (aiInsights.trends_analysis) {
                const content = aiInsights.trends_analysis;
                const element = document.getElementById('trendsAnalysisContent');
                if (element) {
                    element.innerHTML = formatMarkdownContent(content);
                    document.getElementById('aiTrendsAnalysisSection').style.display = 'block';
                }
            }
        }
        
        function formatMarkdownContent(content) {
            // Split into paragraphs
            const paragraphs = content.split('\n\n').filter(p => p.trim());
            
            return paragraphs.map(paragraph => {
                let formatted = paragraph.trim();
                
                // Remove lines that start with ## (markdown headers) since we already have section titles
                const lines = formatted.split('\n');
                const filteredLines = lines.filter(line => {
                    const trimmed = line.trim();
                    // Skip lines that start with ## (markdown headers)
                    return !trimmed.startsWith('##');
                });
                formatted = filteredLines.join('\n').trim();
                
                // Skip empty paragraphs after filtering
                if (!formatted) {
                    return '';
                }
                
                // Convert **text** to <strong>text</strong>
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Convert bullet points • to proper list items
                if (formatted.includes('•')) {
                    const lines = formatted.split('\n');
                    const listItems = lines.map(line => {
                        if (line.trim().startsWith('•')) {
                            return `<li>${line.trim().substring(1).trim()}</li>`;
                        }
                        return line;
                    });
                    
                    // Check if we have list items
                    const hasListItems = listItems.some(item => item.startsWith('<li>'));
                    if (hasListItems) {
                        // Group consecutive list items
                        let result = '';
                        let inList = false;
                        
                        for (let i = 0; i < listItems.length; i++) {
                            const item = listItems[i];
                            if (item.startsWith('<li>')) {
                                if (!inList) {
                                    result += '<ul>';
                                    inList = true;
                                }
                                result += item;
                            } else {
                                if (inList) {
                                    result += '</ul>';
                                    inList = false;
                                }
                                if (item.trim()) {
                                    result += `<p>${item}</p>`;
                                }
                            }
                        }
                        
                        if (inList) {
                            result += '</ul>';
                        }
                        
                        return result;
                    }
                }
                
                return `<p>${formatted}</p>`;
            }).filter(p => p).join(''); // Filter out empty strings
        }
        
        function populateSummaryCards(rawData) {
            if (!rawData || rawData.length === 0) return;
            
            const cardsContainer = document.getElementById('summaryCards');
            
            // Find the latest year from the data
            const years = [...new Set(rawData.map(row => row['year']))].sort((a, b) => b - a);
            const latestYear = years[0];
            
            // Update the section title with the latest year
            const titleElement = document.getElementById('latestStatsTitle');
            if (titleElement) {
                titleElement.textContent = `Latest Statistics (${latestYear})`;
            }
            
            // Filter data for the latest year only
            const latestYearData = rawData.filter(row => row['year'] === latestYear);
            
            // Compute unique branches by uninumbr for the latest year only
            const uniqueAll = new Set();
            const uniqueLMI = new Set();
            const uniqueMinority = new Set();
            
            latestYearData.forEach(row => {
                const id = row['uninumbr'];
                if (id !== null && id !== undefined) {
                    uniqueAll.add(id);
                    if (row['lmict'] === 1 || row['br_lmi'] === 1) uniqueLMI.add(id);
                    if (row['mmct'] === 1 || row['br_minority'] === 1) uniqueMinority.add(id);
                }
            });
            
            const totalBranches = uniqueAll.size;
            const totalLMI = uniqueLMI.size;
            const totalMinority = uniqueMinority.size;
            const avgLMI = totalBranches > 0 ? ((totalLMI / totalBranches) * 100).toFixed(1) : '0.0';
            const avgMinority = totalBranches > 0 ? ((totalMinority / totalBranches) * 100).toFixed(1) : '0.0';
            
            cardsContainer.innerHTML = `
                <div class="summary-card">
                    <h3>${totalBranches.toLocaleString()}</h3>
                    <p>Total Branches (${latestYear})</p>
                </div>
                <div class="summary-card">
                    <h3>${totalLMI.toLocaleString()}</h3>
                    <p>LMI Branches (${latestYear})</p>
                </div>
                <div class="summary-card">
                    <h3>${totalMinority.toLocaleString()}</h3>
                    <p>Minority Branches (${latestYear})</p>
                </div>
                <div class="summary-card">
                    <h3>${avgLMI}%</h3>
                    <p>LMI % (${latestYear})</p>
                </div>
                <div class="summary-card">
                    <h3>${avgMinority}%</h3>
                    <p>Minority % (${latestYear})</p>
                </div>
            `;
        }
        
        function toggleTable(tableId) {
            const table = document.getElementById(tableId);
            const button = table.previousElementSibling.querySelector('.collapse-btn');
            const icon = button.querySelector('i');
            
            if (table.classList.contains('collapsed')) {
                // Expand table - show all rows
                table.classList.remove('collapsed');
                button.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
                
                // Show all rows
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => row.style.display = '');
            } else {
                // Collapse table - show only first 3 rows with fade
                table.classList.add('collapsed');
                button.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
                
                // Hide rows beyond the first 3
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, index) => {
                    if (index >= 3) {
                        row.style.display = 'none';
                    }
                });
            }
        }
        
        function populateTable(tableId, data) {
            if (!data || data.length === 0) return;
            
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            
            // Get the table headers to determine column order
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            
            tbody.innerHTML = data.map(row => {
                // Map data to columns in the correct order based on table headers
                const cells = headers.map(header => {
                    let value = row[header];
                    if (value === null || value === undefined) {
                        return '';
                    }
                    
                    // Format based on column type
                    if (header.toLowerCase().includes('year')) {
                        // Years should not have commas
                        return value.toString();
                    } else if (header.includes('%') || header.toLowerCase().includes('percent')) {
                        // Percentage fields
                        if (typeof value === 'number') {
                            return value.toFixed(1) + '%';
                        }
                        return value + '%';
                    } else if (header.toLowerCase().includes('yoy') || header.toLowerCase().includes('change')) {
                        // YoY change fields - add + for positive values
                        if (typeof value === 'number') {
                            if (value > 0) {
                                return '+' + value.toFixed(1) + '%';
                            } else {
                                return value.toFixed(1) + '%';
                            }
                        }
                        return value;
                    } else if (typeof value === 'number') {
                        // Regular numbers with commas
                        return value.toLocaleString();
                    }
                    return value;
                });
                
                return `<tr>${cells.map(cell => `<td style="text-align: center;">${cell}</td>`).join('')}</tr>`;
            }).join('');
            
            // Auto-collapse only the bank table if it has more than 10 rows
            if (tableId === 'bankTable' && data.length > 10) {
                table.classList.add('collapsed');
                const button = table.previousElementSibling.querySelector('.collapse-btn');
                const icon = button.querySelector('i');
                button.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
                
                // Hide rows beyond the first 3
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, index) => {
                    if (index >= 3) {
                        row.style.display = 'none';
                    }
                });
            }
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // Load report data when page loads
        document.addEventListener('DOMContentLoaded', loadReportData);
    </script>
</body>
</html>
