name: Deploy ElectWatch Weekly Job

on:
  push:
    branches:
      - main
    paths:
      - 'justdata/apps/electwatch/**'
      - 'Dockerfile.electwatch-job'
      - '.github/workflows/deploy-electwatch-job.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_ID: justdata-ncrc
  REGION: us-east1
  JOB_NAME: electwatch-weekly-update
  IMAGE_REPO: hdma1-242116
  IMAGE_NAME: electwatch-job

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build \
            -f Dockerfile.electwatch-job \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.IMAGE_REPO }}/justdata-repo/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.IMAGE_REPO }}/justdata-repo/${{ env.IMAGE_NAME }}:latest \
            .

      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.IMAGE_REPO }}/justdata-repo/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.IMAGE_REPO }}/justdata-repo/${{ env.IMAGE_NAME }}:latest

      - name: Deploy Cloud Run Job
        run: |
          # Check if job exists
          if gcloud run jobs describe ${{ env.JOB_NAME }} --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }} > /dev/null 2>&1; then
            ACTION="update"
          else
            ACTION="create"
          fi
          
          gcloud run jobs $ACTION ${{ env.JOB_NAME }} \
            --image=${{ env.REGION }}-docker.pkg.dev/${{ env.IMAGE_REPO }}/justdata-repo/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --memory=2Gi \
            --cpu=2 \
            --task-timeout=30m \
            --max-retries=1 \
            --set-env-vars="PYTHONPATH=/app" \
            --set-env-vars="JUSTDATA_PROJECT_ID=justdata-ncrc" \
            --set-secrets="ELECTWATCH_CREDENTIALS_JSON=electwatch-bq-credentials:latest,FEC_API_KEY=fec-api-key:latest,CONGRESS_GOV_API_KEY=congress-gov-api-key:latest,CLAUDE_API_KEY=claude-api-key:latest,FMP_API_KEY=fmp-api-key:latest,QUIVER_API_KEY=quiver-api-key:latest,FINNHUB_API_KEY=finnhub-api-key:latest"

      - name: Deployment Summary
        run: |
          echo "## ElectWatch Job Deployment :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Job Name:** ${{ env.JOB_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGION }}-docker.pkg.dev/${{ env.IMAGE_REPO }}/justdata-repo/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Execution" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gcloud run jobs execute ${{ env.JOB_NAME }} --region=${{ env.REGION }} --project=${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
